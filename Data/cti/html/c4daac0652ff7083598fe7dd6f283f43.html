<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>LSA Secrets in Windows</title>
<meta name="description" content="Details"/>
<meta name="keywords" content="Details"/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="robots" content="index"/>
<link rel="SHORTCUT ICON" href="images/favicon.ico" />
<meta http-equiv="pragma" content="no-cache"/>
<meta http-equiv="cache-control" content="no-cache"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="alternate" type="application/rss+xml" title="Password recovery software" href="https://www.passcape.com/feed/news_headlines_en.xml" />

<link href="themes/passcape_rus/navigation.css" type="text/css" rel="stylesheet" />
<link href="themes/passcape_rus/modules.css" type="text/css" rel="stylesheet" />
<style type="text/css"> html {height: 100%; margin: 0px; padding: 0px;} 
body {margin-left: 0px;	margin-top: 0px; margin-right: 0px; margin-bottom: 0px;	background-color: #F9F9F9; font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif; font-size:0.75em; color:#333333; line-height:1.5;} </style>

<link href="styles/template.css" type="text/css" rel="stylesheet" />			         


</head>

<body class="font-medium width-wide left blue" id="page">
    
<div id="page-body">
<div class="wrapper floatholder">
<div class="wrapper-tl">
<div class="wrapper-tr">
<div id="header">
<div class="header-b">
<div class="header-bl">
<div class="header-br">
<div id="toolbar">
<div class="floatbox ie_fix_floats" >

<div id="topmenu" style="padding-left: 50px;">


<ul class="menu" >
  <li class="level1 item1 first"><a class="level1 item1 first" href="/"><span>Home</span></a> </li>
  <li class="level1 item2"><a class="level1 item2" href="/products"><span>Software</span></a> </li>
  <li class="level1 item3"><a class="level1 item4" href="/index.php?section=blog"><span>Blog</span></a> </li>
  <li class="level1 item4 last"><a class="level1 item5 last" href="/forum"><span>Forum</span></a> </li>
  <li class="level1 item5"><a class="level1 item3" href="/support_en1"><span>Contacts</span></a> </li>
  </ul></div>
<div align="right" class="menu" style="width:130px; float:right; padding-top: 23px;">

<a href="index.php?setLang=2" style="color:#666666; font-size: 11px; font-weight:bold;"><img width="14" height="12" alt="" src="/images/eng.gif" /> English</a> | <a href="index.php?setLang=6" style="color:#666666; font-size: 11px; font-weight:bold;"><img width="14" height="12" alt="" src="/images/rus.gif" /> Russian</a>

</div></div></div>
<div align="center" ><h1>Password Recovery Software</h1>
<div style="color: white; font-size: 11px; letter-spacing: 2px; padding-left: 10px;">The best programs to recover lost and forgotten passwords</div>
</div>
<div id="logo"><a href="/"><img class="correct-png" width="290" height="130" title="Home" alt="Home page" src="styles/logo.png" /></a> </div>

<div id="menu">

<ul>

<li class="level1 item1"><a href="/index.php?section=home" class="level1 item1" title="Main" target="_self" ><b><span>Main</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/products" class="level1 item1" title="Products" target="_self" ><b><span>Products</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/downloads" class="level1 item1" title="Downloads" target="_self" ><b><span>Downloads</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/purchase" class="level1 item1" title="Purchase" target="_self" ><b><span>Purchase</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/news" class="level1 item1" title="News" target="_self" ><b><span>News</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/information" class="level1 item1" title="Information" target="_self" ><b><span>Information</span></b></a>
</li>

<li class="level1 item1"><a href="https://www.passcape.com/about" class="level1 item1" title="About us" target="_self" ><b><span>About us</span></b></a>
</li>

</ul>



</div>


<div id="search">
<form action="index.php" method="get">
<input value="search" name="section" type="hidden" />
<div class="search">
<input name="term" onfocus="this.value=''" class="inputbox" id="mod_search_searchword" value="search..." type="text" style="width: 80px;" />
<input class="button" type="submit" title="Search" value="." /> 
</div>
<input type="hidden" value="com_search" name="option" /> <input type="hidden" value="5" name="Itemid" />
</form></div>
</div></div></div></div><!-- header end -->

<!-- top -->
<div id="right_navtree" style="width: 867px; padding-top:10px; height: 40px; background-image: url('/images/stripe.png'); background-repeat: repeat-x;"><a href="index.php">Home</a>&nbsp;&gt;&nbsp;Details<br />
<span style="color: #5591D7; font-size:large;">LSA Secrets in Windows</span></div>
<!-- top end -->

<div id="middle">
<div class="background">
<div id="left">
<div class="clearfix" id="left_container">

<div class="module-blue">
<div>
<div>
<div>

<div class="content">
<span style="font-weight:bold;">20.05.2021</span><br />
<span style="font-weight:bold;"><a class="headlineLink" href="/index.php?section=news&amp;cmd=details&amp;newsid=694" title="Wireless Password Recovery v6.4.4">Wireless Password Recovery v6.4.4</a><br /></span>
<span>Some improvements and bug fixes</span>
</div>
<div style=" padding-bottom: 5px; border-bottom: 1px dotted #999;"></div>

<div class="content">
<span style="font-weight:bold;">04.05.2021</span><br />
<span style="font-weight:bold;"><a class="headlineLink" href="/index.php?section=news&amp;cmd=details&amp;newsid=692" title="Windows Password Recovery v13.3">Windows Password Recovery v13.3</a><br /></span>
<span>Some improvements in extracting and decrypting Windows PINs</span>
</div>
<div style=" padding-bottom: 5px; border-bottom: 1px dotted #999;"></div>

<div class="content">
<span style="font-weight:bold;">27.04.2021</span><br />
<span style="font-weight:bold;"><a class="headlineLink" href="/index.php?section=news&amp;cmd=details&amp;newsid=690" title="Reset Windows Password  v10.2">Reset Windows Password  v10.2</a><br /></span>
<span>New tools to extract a list of last opened documents and programs</span>
</div>
<div style=" padding-bottom: 5px; border-bottom: 1px dotted #999;"></div>

<div class="content">
<span style="font-weight:bold;">10.03.2021</span><br />
<span style="font-weight:bold;"><a class="headlineLink" href="/index.php?section=news&amp;cmd=details&amp;newsid=688" title="Reset Windows Password  v10.1">Reset Windows Password  v10.1</a><br /></span>
<span>Some minor improvements and bug fixes</span>
</div>
<div style=" padding-bottom: 5px; border-bottom: 1px dotted #999;"></div>

<div class="content">
<p class="more"><a href="feed/news_headlines_en.xml" title="Passcape rss news feed"><img width="16" height="16" src="themes/passcape_rus/images/feed_xml.gif" alt="Passcape RSS news feed" border="0" style="vertical-align:text-bottom" /></a> <a href="index.php?section=news">more news &raquo;</a></p>
</div></div></div></div></div>


<div class="content" style="width: 200px;">
						</div>

    					<div class="content" style="width: 200px;">
							<div><div class="maintopbox width100">
<div class="module">
<div>
<div>
<div>
<h3>Articles and video</h3>
<div style="overflow: hidden;"><span style="font-size: 80%; font-weight:bold; line-height:normal;">You may find it helpful to read <a href="/index.php?section=blog">our articles</a> on Windows security and password recovery examples. <a href="/video">Video</a> section contains a number of movies about our programs in action</span></div>
</div>
</div>
</div>
</div>
</div></div>
						</div>

</div></div><!-- left end -->
<div id="main">
<div class="clearfix" id="main_container">

<!-- maintop end -->
<div class="floatbox" id="mainmiddle">
<div id="content">
<div class="clearfix" id="content_container">

<div class="floatbox">
<!-- <script language="javascript" src="styles/yoo_tooltip.js.php" type="text/javascript"></script> -->


<table class="contentpaneopen">
  <tbody>
  <tr>
    <td valign="top" colspan="2">
    <div id="wrapper_content">
<div id="frame_content" class="clear">
<div id="frame_content_right">
<br />
<div id="fe_PreviewContent"><h2 align="center">Windows LSA secrets</h2>
<p>&nbsp;</p>
<p><a href="#b1">What are LSA secrets?</a><br />
<a href="#b2">What is stored in LSA secrets?</a><br />
<a href="#b3">Where are LSA secrets stored?</a><br />
<a href="#b4">LSA Secrets in detail</a><br />
<a href="#b5">CurrVal and OldVal data structure</a><br />
<a href="#b6">Encrypting LSA secrets in Windows 2000, XP, 2003</a><br />
<a href="#b7">Encrypting secrets in Windows Vista, Windows 7</a><br />
<a href="#b8">Reading and editing secrets</a><br />
<a href="#b9">Appendix</a><br />
&nbsp;</p>
<h3><b><a name="b1"></a>What are LSA secrets?</b></h3>
<p align="justify">LSA secrets is a special protected storage for important data used by the <b>Local Security Authority</b> (LSA) in Windows. LSA is designed for managing a system's local security policy, auditing, authenticating, logging users on to the system, storing private data. Users' and system's sensitive data is stored in secrets. Access to all secret data is available to system only. However, as shown below, some programs, in particular <a href="/windows_password_recovery">Windows Password Recovery</a>, allow to override this restriction.<br />
<br />
&nbsp;</p>
<h3><b><a name="b2"></a>What is stored in LSA secrets?</b></h3>
<p align="justify">Originally, the secrets contained cached domain records. Later, Windows developers expanded the application area for the storage. At this moment, they can store PC users' text passwords, service account passwords (for example, those that must be run by a certain user to perform certain tasks), Internet Explorer passwords, RAS connection passwords, SQL and CISCO passwords, SYSTEM account passwords, private user data like EFS encryption keys, and a lot more. For example, the <em class="box">NL$KM</em> secret contains the cached domain password encryption key. <em class="box">L$RTMTIMEBOMB</em> stores the amount of time left until the expiration of an inactivated copy of Windows. <em class="box">L$HYDRAENCKEY</em> stores the public RSA2 key used in the Remote Desktop Protocol. Incidentally, even despite the fact that the automatic login is not set, in certain versions of Windows 7 secrets can contain the text of the administrator account password, thus compromising the entire target system.<br />
<br />
&nbsp;</p>
<h3><b><a name="b3"></a>Where are LSA secrets stored?</b></h3>
<p align="justify">LSA secrets are stored in an encrypted form in the Windows registry, in the <strong>HKEY_LOCAL_MACHINE/Security/Policy/Secrets</strong> key. The parent key, <strong>HKEY_LOCAL_MACHINE/Security/Policy</strong>, contains the additional data, necessary for accessing and decrypting the secrets. Here are the descriptions of some values of this key.</p>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/SecDesc</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>security descriptor for accessing the registry branch with secrets.</b>
</pre>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/PolState</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>current state of the secrets subsystem.</b>
</pre>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/PolRevesion</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>contains the version of the subsystem.</b>
</pre>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/PolPrDmS</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>domain SID.</b>
</pre>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/PolPrDmN</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>domain name.</b>
</pre>
<pre>
Key:         <b>HKEY_LOCAL_MACHINE/Security/Policy/PolEKList</b>
Value name: 
Data type:   <b>REG_BINARY</b>
Description: <b>contains the list of encryption keys for LSA  secrets.</b>
</pre>
<p align="justify">The value 1.1 in <em class="box">PolRevesion</em> matches the NT operation system, 1.5 &ndash; Windows 2000, 1.7 &ndash; Windows XP and Win2K3, 1.9 &ndash; Windows Vista, 1.10 &ndash; Windows 7. Before Windows Vista, only one encryption key was stored in the registry, in the <em class="box">PolSecretEncryptionKey</em> value. Beginning with Windows Vista, <em class="box">PolEKList</em> can contain several encryption keys.<br />
&nbsp;<br />
&nbsp;</p>
<h3><b><a name="b4"></a>LSA Secrets in detail</b></h3>
<p align="justify">On the physical level, secrets are stored in a binary registry file SECURITY with the secret name for the key. For example, <b>SecurityPolicySecrets$MACHINE.ACC</b>. Each secret in the registry is represented by five values:</p>
<ol>
    <li><em class="box">CurrVal</em> - current encrypted value of the secret.</li>
    <li><em class="box">CupdTime</em> - last update time, as an 8-byte FILETIME structure.</li>
    <li><em class="box">OldVal</em> - previous value of the secret.</li>
    <li><em class="box">OupdTime</em> - previous update time.</li>
    <li><em class="box">SecDesc</em> - &ndash; security descriptor, i.e. which users can access the secret, and which are banned from accessing it.</li>
</ol>
<p align="justify">If the system is unable to read/decrypt one of the secrets, it writes the sixth value in it, <em class="box">PolMod</em>, which indicates that the secret is damaged. For example, if a transaction to the LSA database was not completed due to a power outage or registry file damage.<br />
<br />
&nbsp;</p>
<h3><b><a name="b5"></a>CurrVal and OldVal data structure</b></h3>
<p align="justify">Beginning with version 1.9, the structure of secrets has changed dramatically; therefore, we are not going to cover the old format. Instead of a single encryption key, now you can bind each secret to any value on the encryption key list (<b>PolEKList</b>). There is also an option to select an encryption algorithm! So, the first 4 bytes in the data structure is the version of the data; then there follows a 16-byte encryption key identifier for locating the necessary key on the list. That is followed by a DWORD with an identifier for a list  of encryption algorithms the secret is encrypted with. For example, the value 3 matches a bundle of the SHA-256 hashing algorithm and the AES-256 block encryption algorithm. The algorithm identifier is followed by a 4-byte value with different flags used during the decryption. And, finally, there goes the encrypted data. See the figure.<br />
<img alt="lsa secret" src="/images/lsa_secret.png" /><br />
<br />
&nbsp;<br />
&nbsp;</p>
<h3><b><a name="b6"></a>Encrypting LSA secrets in Windows 2000, XP, 2003</b></h3>
<p align="justify">Up to Windows Vista, the decryption of the secrets looked rather trivial. First, one needed to decrypt the secrets encryption key. Here is what it looked like:<br />
<br />
&nbsp;</p>
<pre>
BOOL CSecrets::DecryptPrimaryKey()<br />{<br />    BYTE rc4key[0x10];<br /><br />    MD5Init();<br />    MD5Update(m_pSyskey,0x10);<br />    for ( int i=0; i&lt;1000; i++)<br />        MD5Update(((LPBYTE)m_pCypherKey)+0x3C,0x10);<br />    MD5Final(rc4key);<br /><br />    RC4SetKey(rc4key,0x10);<br />    RC4Decrypt(((LPBYTE)m_pCypherKey)+0xC,0x30);<br /><br />    return ( memcmp(((LPBYTE)m_pCypherKey)+0xC,CYPHERKEY_AUTHENTIFICATOR,0x10)==0 );<br />}&nbsp;</pre>
<p align="justify">Where <b>m_pSyskey</b> - 16-byte SYSKEY value<br />
<b>m_pCypherKey</b> - value from the registry key HKEY_LOCAL_MACHINE/Security/Policy/PolSecretEncryptionKey<br />
Once the secrets encryption key was obtained, one could proceed to the decryption of the secrets. The secrets were encrypted using DES algorithm.<br />
<br />
&nbsp;</p>
<h3><b><a name="b7"></a>Encrypting secrets in Windows Vista, Windows 7</b></h3>
<p align="justify">Beginning with Windows Vista, the encryption algorithm, as it was mentioned, has become much more sophisticated. First, one still needs to decrypt the list of the encryption keys (yes, now multiple keys are allowed), stored in <b>HKEY_LOCAL_MACHINE/Security/Policy/PolEKList</b>. Then proceed to the actual secrets. Each secret now stores a key identifier, encryption algorithm identifier and the actual encrypted data. A working algorithm for decrypting the key looks like:</p>
<ul>
    <li>Read the key value and find the encryption key identifier.</li>
    <li>On the list of encryption keys (<b>PolEKList</b>)), find the necessary key using the identifier you obtained earlier.</li>
    <li>Decrypt the secret using the algorithm identifier and the found key.</li>
</ul>
<p align="justify">Thus, secrets in the LSA database can now be not only encrypted with different algorithms, but also have different original context. For example, use SYSKEY from other PC.<br />
<br />
&nbsp;</p>
<h3><b><a name="b8"></a>Reading and editing secrets</b></h3>
<p align="justify">There is a set of API for handling secrets available to software developers. Thus, any Windows application can create and read its own secrets, but only within the boundaries of current user context. See application 1 with the source code for reading secrets. If you require viewing or editing LSA secrets, for instance, to delete your account's text password, you can take advantage of <a href="/windows_password_recovery">Windows Password Recover</a>, which has a convenient plugin for handling LSA secrets. By the way, this plugin works with both current operating system's secrets and with external registry files.<br />
<br />
<br />
&nbsp;</p>
<h3><b><a name="b9"></a>Appendix</b></h3>
<p align="justify"><b>1. Source code of the program for reading LSA Secrets.</b> Note that not all secrets can be read under user context. Besides, the Administrator privileges are required. The executable of the program can be downloaded <a href="/download/LsaSecretReader.exe">at the following link</a>.&nbsp;</p>
<pre>
// LsaSecretReader.cpp : Defines the entry point for the console application.<br />#include &quot;stdafx.h&quot;<br />#include &lt;windows.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;ntsecapi.h&gt;<br /><br /><br />#pragma comment (lib, &quot;Advapi32&quot;)<br /><br />PLSA_UNICODE_STRING InitLsaString(IN LPWSTR wszString, OUT PLSA_UNICODE_STRING lsastr)<br />{<br />	if ( !lsastr )<br />		return NULL;<br /><br />	if ( wszString )<br />	{<br />		lsastr-&gt;Buffer=wszString;<br />		lsastr-&gt;Length=(USHORT)lstrlenW(wszString)*sizeof(WCHAR);<br />		lsastr-&gt;MaximumLength=lsastr-&gt;Length+2;<br />	}<br />	else<br />	{<br />		lsastr-&gt;Buffer=L&quot;&quot;;<br />		lsastr-&gt;Length=0;<br />		lsastr-&gt;MaximumLength=2;<br />	}<br /><br />	return lsastr;<br />}<br /><br /><br />int _tmain(int argc, _TCHAR* argv[])<br />{<br />	NTSTATUS status;<br />	LSA_OBJECT_ATTRIBUTES att;<br />	LSA_HANDLE pol;<br />	LSA_UNICODE_STRING secret, *data=NULL;<br /><br />	if ( argc!=2 )<br />	{<br />		_tprintf(TEXT(&quot;Syntax: %s secretnamen&quot;),argv[0]);<br />		return 1;<br />	}<br />	<br />	memset(&amp;att,0,sizeof(att));<br />	<br />	status=LsaOpenPolicy(NULL,&amp;att,0,&amp;pol);<br />	if ( status!=ERROR_SUCCESS )<br />	{<br />		_tprintf(TEXT(&quot;LsaOpenPolicy error: %lXn&quot;),status);<br />		return 2;<br />	}<br /><br />	InitLsaString(argv[1],&amp;secret);<br />	status=LsaRetrievePrivateData(pol,&amp;secret,&amp;data);<br />	if ( status!=ERROR_SUCCESS )<br />	{<br />		_tprintf(TEXT(&quot;LsaRetrievePrivateData error: %lXn&quot;),status);<br />		return 3;<br />	}<br />	LsaClose(pol);<br /><br />	if ( data &amp;&amp; data-&gt;Buffer &amp;&amp; data-&gt;Length )<br />	{<br />		for ( USHORT i=0; i&lt;data-&gt;Length; i+=16 )<br />		{<br />			_tprintf(TEXT(&quot;%04X: &quot;),i);<br />			LPBYTE ptr=(LPBYTE)data-&gt;Buffer;<br />			ptr+=i;<br />			for ( int j=0; j&lt;min(16,data-&gt;Length-i); j++ )<br />				_tprintf(TEXT(&quot;%02X &quot;),ptr[j]);<br />			_tprintf(TEXT(&quot;n&quot;));<br />		}<br />	}<br />	else<br />	{<br />		_tprintf(TEXT(&quot;No datan&quot;));<br />	}<br /><br />	return 0;<br />}<br /></pre>
<p>Example of the output</p>
<pre>
C:&gt;LsaSecretReader.exe DPAPI_SYSTEM
0000: 01 00 00 00 73 4F 19 CF 6B B7 6C 8A BC 6D 35 EF
0010: 19 9C A6 3E 9A 80 A7 0C 9D D4 FD B1 20 C6 B1 A5
0020: 7A 87 5F 2B 51 3E 1D E0 45 9B 99 B2
</pre><br />
<br />
<br />
 <br /> 
<br />
</div><br /><br /><br />
</div>
</div>
</div>

    </td></tr></tbody></table>
    <span class="article_seperator">&nbsp;</span> 
</div></div></div>
<!-- content end --></div>
<!-- mainmiddle end --></div></div>
<!-- main end --></div></div>
<!-- middle end --></div></div></div></div>
<!-- page-body end -->


<div id="page-footer">
<div class="wrapper floatholder">
<div id="bottom">
<div class="floatbox ie_fix_floats">
<div align="center" style="font-size:10px;"><a href="/index.php?section=sitemap">Site map</a>  |  <a href="/terms_of_use">Terms of use</a>  |  <a href="/about">About us</a>  |  <a href="/support_en1">Contacts</a></div>
<div id="footer">All trademarks, logos, product names, pictures, videos, sound or any other information related to the Web site or displayed herein are the property of their respective holders. Passcape is a trademark of Passcape Software.<br />
Copyright &copy; 2021 <a href="/" target="_blank">Passcape Software</a></div>
</div></div>
</div></div>


</body>
</html>
