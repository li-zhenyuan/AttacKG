<!doctype html>

<!--[if lt IE 7]><html lang="en-US"><![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html lang="en-US"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html lang="en-US"><![endif]-->
<!--[if gt IE 8]><!--> <html lang="en-US"><!--<![endif]-->

	<head>
		<meta charset="utf-8">

				<meta http-equiv="X-UA-Compatible" content="IE=edge">

		

		<meta name="HandheldFriendly" content="True">
		<meta name="MobileOptimized" content="320">
		<meta name="viewport" content="width=device-width, initial-scale=1"/>

		<link rel="apple-touch-icon" sizes="57x57" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/favicon-16x16.png">
		<link rel="manifest" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/manifest.json">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff">
		<!--[if IE]>
			<link rel="shortcut icon" href="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/favicon.ico">
		<![endif]-->
		
		<link rel="pingback" href="https://citizenlab.ca/xmlrpc.php">

				<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />

	<!-- This site is optimized with the Yoast SEO plugin v16.1.1 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>It’s Parliamentary: KeyBoy and the targeting of the Tibetan Community - The Citizen Lab</title>
	<meta name="description" content="In this report we track a malware operation targeting members of the Tibetan Parliament that use the custom backdoor know as KeyBoy." />
	<link rel="canonical" href="https://citizenlab.ca/2016/11/parliament-keyboy/" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="It’s Parliamentary: KeyBoy and the targeting of the Tibetan Community - The Citizen Lab" />
	<meta property="og:description" content="In this report we track a malware operation targeting members of the Tibetan Parliament that use the custom backdoor know as KeyBoy." />
	<meta property="og:url" content="https://citizenlab.ca/2016/11/parliament-keyboy/" />
	<meta property="og:site_name" content="The Citizen Lab" />
	<meta property="article:published_time" content="2016-11-17T15:00:03+00:00" />
	<meta property="article:modified_time" content="2020-06-23T23:39:00+00:00" />
	<meta property="og:image" content="https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png" />
	<meta property="og:image:width" content="1029" />
	<meta property="og:image:height" content="619" />
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="Adam Hulcoop">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="34 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://citizenlab.ca/#website","url":"https://citizenlab.ca/","name":"The Citizen Lab","description":"University of Toronto","potentialAction":[{"@type":"SearchAction","target":"https://citizenlab.ca/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://citizenlab.ca/2016/11/parliament-keyboy/#primaryimage","inLanguage":"en-US","url":"https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png","contentUrl":"https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png","width":1029,"height":619,"caption":"Figure 5: The timeline of KeyBoy\u2019s evolution"},{"@type":"WebPage","@id":"https://citizenlab.ca/2016/11/parliament-keyboy/#webpage","url":"https://citizenlab.ca/2016/11/parliament-keyboy/","name":"It\u2019s Parliamentary: KeyBoy and the targeting of the Tibetan Community - The Citizen Lab","isPartOf":{"@id":"https://citizenlab.ca/#website"},"primaryImageOfPage":{"@id":"https://citizenlab.ca/2016/11/parliament-keyboy/#primaryimage"},"datePublished":"2016-11-17T15:00:03+00:00","dateModified":"2020-06-23T23:39:00+00:00","author":{"@id":"https://citizenlab.ca/#/schema/person/93a73872ef5f6f715a0d9fd79b778255"},"description":"In this report we track a malware operation targeting members of the Tibetan Parliament that use the custom backdoor know as KeyBoy.","breadcrumb":{"@id":"https://citizenlab.ca/2016/11/parliament-keyboy/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://citizenlab.ca/2016/11/parliament-keyboy/"]}]},{"@type":"BreadcrumbList","@id":"https://citizenlab.ca/2016/11/parliament-keyboy/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://citizenlab.ca/2016/11/parliament-keyboy/","url":"https://citizenlab.ca/2016/11/parliament-keyboy/","name":"It\u2019s Parliamentary: KeyBoy and the targeting of the Tibetan Community"}}]},{"@type":"Person","@id":"https://citizenlab.ca/#/schema/person/93a73872ef5f6f715a0d9fd79b778255","name":"Adam Hulcoop","image":{"@type":"ImageObject","@id":"https://citizenlab.ca/#personlogo","inLanguage":"en-US","url":"https://secure.gravatar.com/avatar/018db4f9a4377920bab53aa555c26a31?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/018db4f9a4377920bab53aa555c26a31?s=96&d=mm&r=g","caption":"Adam Hulcoop"}}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="The Citizen Lab &raquo; Feed" href="https://citizenlab.ca/feed/" />
<link rel="alternate" type="application/rss+xml" title="The Citizen Lab &raquo; Comments Feed" href="https://citizenlab.ca/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="The Citizen Lab &raquo; It’s Parliamentary: KeyBoy and the targeting of the Tibetan Community Comments Feed" href="https://citizenlab.ca/2016/11/parliament-keyboy/feed/" />
		<!-- This site uses the Google Analytics by MonsterInsights plugin v7.17.0 - Using Analytics tracking - https://www.monsterinsights.com/ -->
							<script src="//www.googletagmanager.com/gtag/js?id=UA-19652411-2"  type="text/javascript" data-cfasync="false"></script>
			<script type="text/javascript" data-cfasync="false">
				var mi_version = '7.17.0';
				var mi_track_user = true;
				var mi_no_track_reason = '';
				
								var disableStr = 'ga-disable-UA-19652411-2';

				/* Function to detect opted out users */
				function __gtagTrackerIsOptedOut() {
					return document.cookie.indexOf( disableStr + '=true' ) > - 1;
				}

				/* Disable tracking if the opt-out cookie exists. */
				if ( __gtagTrackerIsOptedOut() ) {
					window[disableStr] = true;
				}

				/* Opt-out function */
				function __gtagTrackerOptout() {
					document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
					window[disableStr] = true;
				}

				if ( 'undefined' === typeof gaOptout ) {
					function gaOptout() {
						__gtagTrackerOptout();
					}
				}
								window.dataLayer = window.dataLayer || [];
				if ( mi_track_user ) {
					function __gtagTracker() {dataLayer.push( arguments );}
					__gtagTracker( 'js', new Date() );
					__gtagTracker( 'set', {
						'developer_id.dZGIzZG' : true,
						                    });
					__gtagTracker( 'config', 'UA-19652411-2', {
						forceSSL:true,anonymize_ip:true,					} );
										window.gtag = __gtagTracker;										(
						function () {
							/* https://developers.google.com/analytics/devguides/collection/analyticsjs/ */
							/* ga and __gaTracker compatibility shim. */
							var noopfn = function () {
								return null;
							};
							var newtracker = function () {
								return new Tracker();
							};
							var Tracker = function () {
								return null;
							};
							var p = Tracker.prototype;
							p.get = noopfn;
							p.set = noopfn;
							p.send = function (){
								var args = Array.prototype.slice.call(arguments);
								args.unshift( 'send' );
								__gaTracker.apply(null, args);
							};
							var __gaTracker = function () {
								var len = arguments.length;
								if ( len === 0 ) {
									return;
								}
								var f = arguments[len - 1];
								if ( typeof f !== 'object' || f === null || typeof f.hitCallback !== 'function' ) {
									if ( 'send' === arguments[0] ) {
										var hitConverted, hitObject = false, action;
										if ( 'event' === arguments[1] ) {
											if ( 'undefined' !== typeof arguments[3] ) {
												hitObject = {
													'eventAction': arguments[3],
													'eventCategory': arguments[2],
													'eventLabel': arguments[4],
													'value': arguments[5] ? arguments[5] : 1,
												}
											}
										}
										if ( typeof arguments[2] === 'object' ) {
											hitObject = arguments[2];
										}
										if ( typeof arguments[5] === 'object' ) {
											Object.assign( hitObject, arguments[5] );
										}
										if ( 'undefined' !== typeof (
											arguments[1].hitType
										) ) {
											hitObject = arguments[1];
										}
										if ( hitObject ) {
											action = 'timing' === arguments[1].hitType ? 'timing_complete' : hitObject.eventAction;
											hitConverted = mapArgs( hitObject );
											__gtagTracker( 'event', action, hitConverted );
										}
									}
									return;
								}

								function mapArgs( args ) {
									var gaKey, hit = {};
									var gaMap = {
										'eventCategory': 'event_category',
										'eventAction': 'event_action',
										'eventLabel': 'event_label',
										'eventValue': 'event_value',
										'nonInteraction': 'non_interaction',
										'timingCategory': 'event_category',
										'timingVar': 'name',
										'timingValue': 'value',
										'timingLabel': 'event_label',
									};
									for ( gaKey in gaMap ) {
										if ( 'undefined' !== typeof args[gaKey] ) {
											hit[gaMap[gaKey]] = args[gaKey];
										}
									}
									return hit;
								}

								try {
									f.hitCallback();
								} catch ( ex ) {
								}
							};
							__gaTracker.create = newtracker;
							__gaTracker.getByName = newtracker;
							__gaTracker.getAll = function () {
								return [];
							};
							__gaTracker.remove = noopfn;
							__gaTracker.loaded = true;
							window['__gaTracker'] = __gaTracker;
						}
					)();
									} else {
										console.log( "" );
					( function () {
							function __gtagTracker() {
								return null;
							}
							window['__gtagTracker'] = __gtagTracker;
							window['gtag'] = __gtagTracker;
					} )();
									}
			</script>
				<!-- / Google Analytics by MonsterInsights -->
				<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/citizenlab.ca\/wp-includes\/js\/wp-emoji-release.min.js"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='https://citizenlab.ca/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='bigfoot-number-css'  href='https://citizenlab.ca/wp-content/plugins/bigfoot_footnotes/library/bigfoot-number.css' type='text/css' media='all' />
<link rel='stylesheet' id='__EPYT__style-css'  href='https://citizenlab.ca/wp-content/plugins/youtube-embed-plus/styles/ytprefs.min.css' type='text/css' media='all' />
<style id='__EPYT__style-inline-css' type='text/css'>

                .epyt-gallery-thumb {
                        width: 33.333%;
                }
                
</style>
<link rel='stylesheet' id='bones-base-stylesheet-css'  href='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/css/tachyons.css' type='text/css' media='all' />
<link rel='stylesheet' id='bones-stylesheet-css'  href='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/css/style.css' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='bones-ie-only-css'  href='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/css/ie.css' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='sprite-navigation-white-css'  href='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/css/sprite-navigation-white.css' type='text/css' media='all' />
<script type='text/javascript' id='monsterinsights-frontend-script-js-extra'>
/* <![CDATA[ */
var monsterinsights_frontend = {"js_events_tracking":"true","download_extensions":"pdf,doc,ppt,xls,zip,docx,pptx,xlsx","inbound_paths":"[]","home_url":"https:\/\/citizenlab.ca","hash_tracking":"false","ua":"UA-19652411-2"};
/* ]]> */
</script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/google-analytics-for-wordpress/assets/js/frontend-gtag.min.js' id='monsterinsights-frontend-script-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-includes/js/jquery/jquery.min.js' id='jquery-core-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-includes/js/jquery/jquery-migrate.min.js' id='jquery-migrate-js'></script>
<script type='text/javascript' id='__ytprefs__-js-extra'>
/* <![CDATA[ */
var _EPYT_ = {"ajaxurl":"https:\/\/citizenlab.ca\/wp-admin\/admin-ajax.php","security":"cdedaab090","gallery_scrolloffset":"20","eppathtoscripts":"https:\/\/citizenlab.ca\/wp-content\/plugins\/youtube-embed-plus\/scripts\/","eppath":"https:\/\/citizenlab.ca\/wp-content\/plugins\/youtube-embed-plus\/","epresponsiveselector":"[\"iframe.__youtube_prefs__\",\"iframe[src*='youtube.com']\",\"iframe[src*='youtube-nocookie.com']\",\"iframe[data-ep-src*='youtube.com']\",\"iframe[data-ep-src*='youtube-nocookie.com']\",\"iframe[data-ep-gallerysrc*='youtube.com']\"]","epdovol":"1","version":"13.4.2","evselector":"iframe.__youtube_prefs__[src], iframe[src*=\"youtube.com\/embed\/\"], iframe[src*=\"youtube-nocookie.com\/embed\/\"]","ajax_compat":"","ytapi_load":"light","pause_others":"","stopMobileBuffer":"1","vi_active":"","vi_js_posttypes":[]};
/* ]]> */
</script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/youtube-embed-plus/scripts/ytprefs.min.js' id='__ytprefs__-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/js/libs/modernizr.custom.min.js' id='bones-modernizr-js'></script>
<link rel="https://api.w.org/" href="https://citizenlab.ca/wp-json/" /><link rel="alternate" type="application/json" href="https://citizenlab.ca/wp-json/wp/v2/posts/28368" /><link rel='shortlink' href='https://citizenlab.ca/?p=28368' />
<link rel="alternate" type="application/json+oembed" href="https://citizenlab.ca/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://citizenlab.ca/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F&#038;format=xml" />
<!-- Related Posts for WP Premium CSS -->
<style type='text/css'>
.rp4wp-related-posts { width:100%; overflow:hidden;}ul.rp4wp-posts-list {width:100%; margin:0 !important; padding:0 !important; list-style:none !important; float:left;}ul.rp4wp-posts-list .rp4wp-col {width:100% !important;margin-bottom:30px !important;list-style:none !important;box-sizing:border-box;overflow:hidden;float:left;}.rp4wp_component_wrapper {width:100% !important;float:left;}.rp4wp_component {width:100% !important;padding:0 0 5% !important;box-sizing:border-box;float:left;overflow:hidden !important;}.rp4wp_component a {border:0 !important;}.rp4wp_component_image a {display:block; height:100% !important;} .rp4wp_component_image img {width:100% !important;height:100% !important;}.rp4wp_component_title a {text-decoration:none !important; font-weight:bold; border:0 !important;}@media (min-width: 768px) {ul.rp4wp-posts-list .rp4wp-col {width:101% !important;padding:0 2% !important;}ul.rp4wp-posts-list .rp4wp-col-first {width:99% !important;padding-left:0 !important;padding-right:2% !important;}ul.rp4wp-posts-list .rp4wp-col-last {width:99% !important;padding-right:0 !important;padding-left:2% !important;}.rp4wp_component_wrapper {width:50% !important;}.rp4wp_component_wrapper_left {padding-right:5% !important;}.rp4wp_component_wrapper_right {padding-left:5% !important;}}.rp4wp_component_2{height:20% !important;}ul.rp4wp-posts-list .rp4wp-col {padding-left:0 !important; margin:0 !important}.rp4wp_component, .rp4wp_component_2 {height:auto !important; padding:0.1rem 0 !important; margin:0}.rp4wp_component_title a {font-weight:normal; text-decoration: underline}.rp4wp-col {float:none; padding:0;}
</style>
		
				
	</head>

	<body class="bg-white source-sans f4" itemscope itemtype="http://schema.org/WebPage">

		<div class="mw-12 pv3 ph3 pv3-l ph6-l bg-lab-dark-brown">

			<header role="banner" itemscope itemtype="http://schema.org/WPHeader">

				<div id="inner-header" class="mw7 center flex-ns items-center justify-between w-100 tl source-sans mt3 mt0-ns">

										<div class="v-mid flex justify-between items-center">
						<div class="mr-auto">
							<a href="https://citizenlab.ca" rel="nofollow" id="logo" itemscope itemtype="http://schema.org/Organization" class="no-underline ttu">
								<img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/CL-logo-3-headed.png" class="h1-5 pr4-ns pr2" alt="The Citizen Lab"/>
							<!-- <span class="lab-green b-600">The</span><span class="hidden"> </span><span class="lab-orange b-600">Citizen</span><span class="hidden"> </span><span class="lab-green b-600">Lab</span> -->
							</a>
							<img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/MunkSchool-WHT.png" class="munk-logo" />
					</div>
						<!-- Visible on mobile -->
						<a href="#main-menu" class="icon icon-ic_menu_white_24dp dib" id="homepage" aria-label="Open main menu"><span class="screen-reader-text">Open main menu</span></a>
					</div>
										

					<!-- Main navigation menu -->
					<a class="skip-main" href="#main">Skip to main content</a>
					<div class="flex-ns main-menu" id="main-menu">
						
						<a href="#homepage" id="homepage" class="icon icon-ic_close_white_24dp dib menu-close" aria-label="Close main menu"><span class="screen-reader-text">Close main menu</span></a>



						<nav id="nav-main" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="tc tl-l">
							<ul id="menu-top-menu" class="list ma0 mt2 mt0-ns pa0 b dib-ns list pa0"><li id="menu-item-29705" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-29705 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/" class="mr2 white no-underline h-underline ml0">Research</a>
<ul class="sub-menu">
	<li id="menu-item-72358" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-72358 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/targeted-threats/" class="mr2 white no-underline h-underline">Targeted Threats</a></li>
	<li id="menu-item-72357" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72357 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/free-expression-online/" class="mr2 white no-underline h-underline mr0">Free Expression Online</a></li>
	<li id="menu-item-72359" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72359 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/transparency/" class="mr2 white no-underline h-underline">Transparency and Accountability</a></li>
	<li id="menu-item-72360" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72360 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/app-privacy-and-security/" class="mr2 white no-underline h-underline">App Privacy and Controls</a></li>
	<li id="menu-item-72362" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72362 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/global-research-network/" class="mr2 white no-underline h-underline">Global Research Network</a></li>
	<li id="menu-item-72385" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72385 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/research/tools-resources/" class="mr2 white no-underline h-underline">Tools &amp; Resources</a></li>
	<li id="menu-item-72361" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72361 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/publications/" class="mr2 white no-underline h-underline">Publications</a></li>
</ul>
</li>
<li id="menu-item-29706" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-29706 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/lab-news/" class="mr2 white no-underline h-underline">News</a>
<ul class="sub-menu">
	<li id="menu-item-72363" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72363 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/lab-news/mentions/" class="mr2 white no-underline h-underline">In the Media</a></li>
	<li id="menu-item-72364" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72364 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/lab-news/events/" class="mr2 white no-underline h-underline">Events</a></li>
	<li id="menu-item-72365" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72365 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/category/lab-news/opportunities/" class="mr2 white no-underline h-underline">Opportunities</a></li>
</ul>
</li>
<li id="menu-item-29707" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-29707 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/about/" class="mr2 white no-underline h-underline">About</a>
<ul class="sub-menu">
	<li id="menu-item-72367" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72367 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/about/" class="mr2 white no-underline h-underline">About the Citizen Lab</a></li>
	<li id="menu-item-72368" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72368 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/media/" class="mr2 white no-underline h-underline">Media Resources</a></li>
	<li id="menu-item-72369" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72369 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/people/" class="mr2 white no-underline h-underline">People</a></li>
	<li id="menu-item-72370" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72370 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/teaching/" class="mr2 white no-underline h-underline">Teaching</a></li>
	<li id="menu-item-72387" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-72387 dib-ns f5-l f4 ttu pv2"><a href="https://donate.utoronto.ca/give/show/84" class="mr2 white no-underline h-underline">Donate</a></li>
	<li id="menu-item-74537" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-74537 dib-ns f5-l f4 ttu pv2"><a href="https://citizenlab.ca/disclosure-of-security-vulnerabilities/" class="mr2 white no-underline h-underline">Security Vulnerabilities</a></li>
</ul>
</li>
</ul>
						</nav>

						<!-- Search bar -->
						<div class="flex items-center justify-center searchbar">
							<form class="db-l ma0 pa0 b0 lh0 f5" role="search" method="get" id="menuSearchform" action="https://citizenlab.ca/">

								<div id="menuSearchContainer" class="ml3 dib w0 transition-width overflow-hidden">
									<input type="search" id="menuSearch" name="s" value="" class="b--none ma0 pa1 w5" placeholder="Search"/>
								</div>
							</form>
							<div id="menuSearchButton" class="db-l ml3 pointer items-end">
								<img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/iconic/magnifying-glass.svg" class="h1" alt="Search">
							</div>
						</div>

						</div>
						</div>
				</div>
			</header>
    </div>
    <div id="container" class="mw-12 center pa3 pv4-l ph6-l bg-white relative">
		<main id="main" role="main" itemscope itemprop="mainContentOfPage" itemtype="http://schema.org/Blog">
			<section id="content" class="mw7 center">


						
							

     <article id="post-28368" dir="ltr" 28368role="article" itemscope itemprop="blogPost" itemtype="http://schema.org/BlogPosting" class="lh-copy">

        <header>
          <p class="f6 mt0" dir="ltr"><a href="https://citizenlab.ca/category/research/" class="black underline link b f5 underline-hover hover-black hover-bg-lightest-blue">Research<img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/chevron-left.svg" class="chevrons" alt="" /></a><a href="https://citizenlab.ca/category/research/targeted-threats/" class="black underline link b f5 underline-hover hover-black hover-bg-lightest-blue">Targeted Threats</a></p>
            <h1 itemprop="headline" rel="bookmark" class="ma0 mt5 lh-title">
            		<span class="db f2 f1-ns black lh-solid">It’s Parliamentary</span>
		<span class="db f4 f2-ns mid-gray mt2 lh-title oswald-regular"> KeyBoy and the targeting of the Tibetan Community</span>
	            </h1>
            <div dir="ltr" class="mt2">
              
            <div class="f5 mr4 b dark-gray dib">By 
            <a href="https://citizenlab.ca/author/adam-hulcoop/" title="Posts by Adam Hulcoop" class="author url fn" rel="author">Adam Hulcoop</a>, <a href="https://citizenlab.ca/author/mattbrooks/" title="Posts by Matt Brooks" class="author url fn" rel="author">Matt Brooks</a>, <a href="https://citizenlab.ca/author/etiennemaynier/" title="Posts by Etienne Maynier" class="author url fn" rel="author">Etienne Maynier</a>, <a href="https://citizenlab.ca/author/jsrailton/" title="Posts by John Scott-Railton" class="author url fn" rel="author">John Scott-Railton</a>, and <a href="https://citizenlab.ca/author/masashi/" title="Posts by Masashi Crete-Nishihata" class="author url fn" rel="author">Masashi Crete-Nishihata</a></div>          

          <time class="dark-gray dib f5 mr4" datetime="2016-11-17" itemprop="datePublished">November 17, 2016</time>
          <!-- Display other versions of the post -->
                      </div>

          <!-- Display the link for the PDF version of the post -->
                          <div>

                   <a class="f6 link br1 ba ph3 pv2 mb2 mt2 dib black hover-bg-lightest-blue hover-black" href="https://tspace.library.utoronto.ca/bitstream/1807/96989/1/Report%2383--keyboy.pdf" target="" title="Download Download this report">Download this report</a>

                </div>
                
        </header>         
                <section itemprop="articleBody" class="article-body mb4 mt4 pt2 bt b--light-gray">
                  <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><h1 class=" lh-solid mb3">Key Findings</h1>
<ul class="mt0"><li class="mt2">In this report we track a malware operation targeting members of the Tibetan Parliament over August and October 2016.</li>
<li class="mt2">The operation uses known and patched exploits to deliver a custom backdoor known as KeyBoy.</li>
<li class="mt2">We analyze multiple versions of KeyBoy revealing a development cycle focused on avoiding basic antivirus detection.</li>
<li class="mt2">This operation is another example of a threat actor using &ldquo;just enough&rdquo; technical sophistication to exploit a target.</li>
</ul><h1 class=" lh-solid mb3">Introduction</h1>
<p class="mt0">The Tibetan community has been targeted for over a decade by espionage operations that use malware to infiltrate communications and gather information. They are often targeted simultaneously with other ethnic minorities and religious groups in China. Examples as early as 2008 <a href="https://isc.sans.edu/diary/Overview+of+cyber+attacks+against+Tibetan+communities/4177" class="hover-black link underline hover-bg-lightest-blue">document</a> &nbsp;malware operations against Tibetan non-governmental organizations (NGOs) that also targeted Falun Gong and Uyghur groups. More recently in 2016, Arbor Networks reported on connected malware operations <a href="https://www.arbornetworks.com/blog/asert/wp-content/uploads/2016/04/ASERT-Threat-Intelligence-Report-2016-03-The-Four-Element-Sword-Engagement.pdf" class="hover-black link underline hover-bg-lightest-blue">continuing</a> to target these same groups, which the Communist Party of China perceives as a threat to its power.</p>
<p>These types of operations have multiple components, each with their own associated costs to the operator. There is the exploit code and malware used to gain access to systems, the infrastructure that provides command and control to the malware operator, and the human elements &ndash; developers who create the malware, operators who deploy it, and analysts who extract value from the stolen information.</p>
<p>We anticipate that operators will attempt to balance the amount of information they expect to gather with the operational costs and risks of deploying different strategies and technologies. For example, in deploying a particular malware implant against a target the operator will balance the likelihood and cost of discovery with the perceived value of extracting information from that target. If a toolkit is exposed inadvertently, the target may increase defenses and the operator will have to spend more time and resources on development.</p>
<p>Civil society groups, due to their generally limited technical capacity and lack of security expertise and countermeasures, shift the risk/reward ratio in ways favourable to the malware operator. For example, we have observed frequent reuse of older (patched) exploits in malware operations against the Tibetan community. Up-to-date operating systems and software would block these threats, but the operators have probably discovered through experience that the their targets have&nbsp;unpatched systems and a general lack of security controls beyond antivirus programs. The continued use of old exploits is a cost reduction strategy: since they still work, there is little need to use more expensive exploits.</p>
<p>Moreover, many of the malware defenses used by the Tibetan diaspora involve individuals recognizing signs of a malicious email, such as exhortations to open attachments. This kind of behavioral strategy pushes the operators to change their <a href="https://citizenlab.ca/2016/03/shifting-tactics/" class="hover-black link underline hover-bg-lightest-blue">social engineering tactics</a>, but does not provide pressure to radically change their toolkits. This situation is different from a technical-indicator based institutional security environment. In practice, minimal code changes sufficient to bypass signature-based security controls such as antivirus may be all that are necessary.</p>
<p>This report analyzes an operation targeting members of the Tibetan Parliament. The actors used a new version of &ldquo;KeyBoy,&rdquo; a custom backdoor first disclosed by researchers at <a href="https://community.rapid7.com/community/infosec/blog/2013/06/07/keyboy-targeted-attacks-against-vietnam-and-india" class="hover-black link underline hover-bg-lightest-blue">Rapid7</a> in June 2013. Their work outlined the capabilities of the backdoor, and exposed the protocols and algorithms used to hide the network communication and configuration data.</p>
<p>We observed operations in August and October 2016, shortly after an order in June to demolish the <a href="https://en.wikipedia.org/wiki/Larung_Gar_Buddhist_Academy" class="hover-black link underline hover-bg-lightest-blue">Larung Gar Buddhist Academy</a> and days before organized protests on <a href="https://www.facebook.com/events/190950044675347/" class="hover-black link underline hover-bg-lightest-blue">October 19 </a>around the same issue. These operations involved highly targeted email lures with repurposed content and attachments that contained an updated version of KeyBoy. We assess that KeyBoy is the product of a development cycle that is iterated only as much as necessary to ensure the survival of the implant against antivirus detection and basic security controls.</p>
<p>This report is divided into two parts:</p>
<p><b>Part 1: The Parliamentarian Operation</b> Analyzes an operation targeting the members of the Tibetan Parliament by repurposing legitimate content, and&nbsp;documents implanted with Keyboy.</p>
<p><b>Part 2: KeyBoy &ndash; Tracking Evolution</b> Examines the KeyBoy development cycle revealing a focus on avoiding basic antivirus detection.</p>
<p>To assist other researchers, we include appendices and indicators of compromise that detail the KeyBoy samples we analyzed and provide an in-depth analysis of some features of the most recent implant.</p>
<h1 class=" lh-solid mb3">Part 1: The Parliamentarian Operation</h1>
<p class="mt0">In August and October 2016 we observed a malware operation targeting members of the <a href="http://tibetanparliament.org/" class="hover-black link underline hover-bg-lightest-blue">Tibetan Parliament</a> (the highest legislative organ of the Tibetan government in exile, formally known as <a href="http://tibet.net/" class="hover-black link underline hover-bg-lightest-blue">Central Tibetan Administration</a>). We collected two emails sent to Parliamentarians that rapidly repurposed legitimate content in an attempt to entice recipients to open malicious documents. The first attempt leveraged an old vulnerability in the parsing of Rich-text-format (<code>.rtf</code>) files (<a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-0158" class="hover-black link underline hover-bg-lightest-blue">CVE-2012-0158)</a>. The second attempt used a newer, but also patched, <code>.rtf</code> vulnerability (<a href="https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1641" class="hover-black link underline hover-bg-lightest-blue">CVE-2015-1641</a>). Both attempts used versions of KeyBoy and shared the same command and control infrastructure as well as other configuration details.</p>
<h2 class=" lh-solid mb3">Attempt 1</h2>
<p class="mt0">On August 25, 2016, members of the Tibetan Parliament received an email with information on an upcoming conference relevant to the Tibetan community. This email had the same subject and attachment as a legitimate message sent to the same recipients just 15 hours prior, but in this case the attachment was crafted to exploit a frequently targeted vulnerability in Microsoft Office. The accompanying malware was a backdoor implant designed to surveil the computers of the Parliamentarians. This malicious attachment used the original, legitimate filename as a decoy (<b>see: Figure 1</b>).</p>
<figure class="center mw-100 ba b--light-gray" style="width:700px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure1.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28397" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure1.png" alt="Email lure containing malicious document. Note the use of letters &lsquo;r n&rsquo; in an attempt to appear as &lsquo;m&rsquo; in the sender address. " width="700" height="262" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure1.png 1854w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-300x112.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-768x287.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-1024x383.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-180x67.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-605x226.png 605w, https://citizenlab.ca/wp-content/uploads/2016/11/figure1-297x111.png 297w" sizes="(max-width: 700px) 100vw, 700px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 1: Email lure containing malicious document. Note the use of letters &lsquo;r n&rsquo; in an attempt to appear as &lsquo;m&rsquo; in the sender address.</figcaption></figure>
<p>This level of targeting and re-use of a legitimate document sent only hours before shows that the actors behind the operation are closely watching the Tibetan community, and may have already compromised the communications of one or more of the Parliamentarians.</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Document name:</b> <code>theme of the conference.doc</code><br><b>MD5:</b> <code>8307e444cad98b1b59568ad2eba5f201</code></div>
<p>Opening the attachment (an apparently blank document) in Microsoft Word would result in the infection of the target system with the KeyBoy implant.</p>
<h3 class=" lh-solid mb3">The Infection Chain</h3>
<p class="mt0">The email attachment is a <code>.rtf</code> document containing a dropper, delivered using an exploit designed to leverage <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0158" class="hover-black link underline hover-bg-lightest-blue">CVE-2012-0158</a>, a vulnerability in the way that Microsoft Word handles <code>.rtf</code> files. Over the past four years, this vulnerability has been consistently used in malware campaigns against the <a href="https://targetedthreats.net/" class="hover-black link underline hover-bg-lightest-blue">Tibetan community</a> despite having been patched since April 2012.</p>
<p>If the exploit is successful, the following infection chain (see: <strong>Figure 2</strong>) is observed on the system.</p>
<figure class="center mw-100 ba b--light-gray" style="width:684px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament.jpeg" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="size-full wp-image-28398" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament.jpeg" alt="Figure 2: Process chain after exploit is successful " width="684" height="188" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament.jpeg 684w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament-300x82.jpeg 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament-180x49.jpeg 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament-605x166.jpeg 605w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_2_parliament-297x82.jpeg 297w" sizes="(max-width: 684px) 100vw, 684px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 2: Process chain after exploit is successful</figcaption></figure>
<p><span style="font-weight: 400;">The files in this infection chain are outlined below. The exploit launches an executable &lsquo;dropper&rsquo; component which is responsible for placing the malware payload and its configuration file on disk, and finally for launching the main malware code. </span></p>
<p>Note that the dropper and the final (DLL) payload were compiled within seconds of each other.</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>dw20.exe</code><br><b>Size:</b> <code>256512 bytes</code><br><b>Compile Time:</b> <code>09 May 2016 08:41:26 UTC</code><br><b>MD5:</b> <code>0b4d45db323f68b465ae052d3a872068</code><br><b>SHA256:</b> <code>5f24a5ee9ecfd4a8e5f967ffcf24580a83942cd7b09d310b9525962ed2614a49</code><br><b>Purpose:</b> dropper binary, used to install and execute the main implant</div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>wab32res.exe</code><br><b>Size:</b> <code>46080 bytes</code><br><b>Compile Time:</b> <code>13 April 2008 18:30:52 UTC</code><br><b>MD5:</b> <code>8f08609e4e0b3d26814b3073a42df415</code><br><b>SHA256:</b> <code>58105e9772f6befbc319c147a97faded4fbacf839947b34fe3695ae72771da5d</code><br><b>Purpose:</b> legitimate Microsoft Windows Address Book executable, used to load final payload</div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>wab32res.dll</code><br><b>Size:</b> <code>138240 bytes</code><br><b>Compile Time:</b> <code>09 May 2016 08:41:05 UTC</code><br><b>MD5:</b> <code>495adb1b9777002ecfe22aaf52fcee93</code><br><b>SHA256:</b> <code> 9a55577d357922711ab0821bf5379289293c8517ae1d94d48c389f306af57a04</code><br><b>Purpose:</b> malware payload, launched by wab32res.exe via DLL search order hijacking</div>
<p>Next, the dropper places a renamed copy of the legitimate Windows Address Book executable, along with the malware binary, <code>wab32res.dll</code>, in the Local Application Data directory. Notably, the dropper modifies the timestamps of the configuration file and the payload to match those of the <code>\Microsoft\SystemCertificates\My\</code> directory within the user&rsquo;s Local Application Data directory. Once these files are written to disk, the dropper starts the Windows Address Book executable which loads and executes the malicious <code>wab32res.dll</code> file via <a href="https://www.fireeye.com/blog/threat-research/2010/07/malware-persistence-windows-registry.html" class="hover-black link underline hover-bg-lightest-blue">DLL search-order hijacking</a>.</p>
<h2 class=" lh-solid mb3">Attempt 2</h2>
<p class="mt0">On October 11, 2016, the Tibetan Parliamentarians received an email with content repurposed from a Tibetan activism campaign protesting the demolition of a Buddhist monastery in Tibet. The email was sent from the same email address as the previous attempt (<code>tibetanparliarnent[@]yahoo.com</code>) and appears to copy content from the <a href="https://www.facebook.com/events/190950044675347/" class="hover-black link underline hover-bg-lightest-blue">Facebook page </a>of a Tibetan NGO promoting the campaign. The message urges recipients to open an attached <code>.rtf</code> file with further details on the campaign (<b>see: Figure 3</b>).</p>
<figure class="center mw-100 ba b--light-gray" style="width:700px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28399" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament.png" alt="Figure 3: Email lure used in second attempt " width="700" height="324" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament.png 1545w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-300x139.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-768x355.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-1024x474.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-180x83.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-605x280.png 605w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_3_parliament-297x137.png 297w" sizes="(max-width: 700px) 100vw, 700px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 3: Email lure used in second attempt</figcaption></figure>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Document name:</b> <code>urgent action larung gar buddhist academy.rtf</code><br><b>MD5:</b> <code>913b82ff8f090670fc6387e3a7bea12d</code></div>
<p>Opening the attachment (an apparently blank document) in Microsoft Word would, similar to the first attempt, result in the infection of the target system with the KeyBoy implant.</p>
<h3 class=" lh-solid mb3">The Infection Chain</h3>
<p class="mt0">The <code>.rtf</code> document attached to the malicious email was designed to exploit a more recent vulnerability: <a href="https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1641" class="hover-black link underline hover-bg-lightest-blue">CVE-2015-1641</a>. If successful, this exploit launches a newer version of the same malware used in the August attempt outlined above, using a similar infection chain.</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> n/a<br><b>Size:</b> <code>262144 bytes</code><br><b>Compile Time:</b> <code>29 September 2016 00:46:11 UTC</code><br><b>MD5:</b> <code>23d284245e53ae4fe05c517d807ffccf</code><br><b>SHA256:</b> <code>542c85fda8df8510c1b66a122e459aac8c0919f1fe9fa2c43fd87899cffa05bf</code><br><b>Purpose:</b>dropper binary, used to install and execute the main implant</div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>wab32res.exe</code><br><b>Size:</b> <code>46080 bytes</code><br><b>Compile Time:</b> <code>13 April 2008 18:30:52 UTC</code><br><b>MD5:</b> <code>8f08609e4e0b3d26814b3073a42df415</code><br><b>SHA256:</b> <code>58105e9772f6befbc319c147a97faded4fbacf839947b34fe3695ae72771da5d</code><br><b>Purpose:</b>legitimate Microsoft Windows Address Book executable, used to load final payload</div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>wab32res.dll</code><br><b>Size:</b> <code>143872 bytes</code><br><b>Compile Time:</b> <code>29 September 2016 00:21:34 UTC</code><br><b>MD5:</b> <code>087bffa8a570079948310dc9731c5709</code><br><b>SHA256:</b> <code> 5da2f14c382d7cac8dfa6c86e528a646a81f0b40cfee9611c8cfb4b5d589aa88</code><br><b>Purpose:</b>malware payload, launched by wab32res.exe via DLL search order hijacking</div>
<p>As with the first attempt, the resulting dropper installs the malware payload into the <code>Local Application Data</code> directory as <code>wab32res.dll</code> and subsequently launches it using the same method of DLL search-order hijacking against the legitimate Windows Address Book executable.</p>
<h2 class=" lh-solid mb3">A Note on Vulnerabilities</h2>
<p class="mt0">The two <code>.rtf</code> vulnerabilities targeted in these exploitation attempts, <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-0158" class="hover-black link underline hover-bg-lightest-blue">CVE-2012-0158</a> and <a href="https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1641" class="hover-black link underline hover-bg-lightest-blue">CVE-2015-1641</a>, are among a set of four <code>.rtf</code> vulnerabilities discussed in recent <a href="https://www.arbornetworks.com/blog/asert/wp-content/uploads/2016/04/ASERT-Threat-Intelligence-Report-2016-03-The-Four-Element-Sword-Engagement.pdf" class="hover-black link underline hover-bg-lightest-blue">reporting</a> from researchers at Arbor Networks.</p>
<p>The researchers describe the presumed existence of an exploit document &lsquo;builder&rsquo; designed to selectively weaponize <code>.rtf</code> files using four older, patched, vulnerabilities: <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-0158" class="hover-black link underline hover-bg-lightest-blue">CVE-2012-0158</a>, <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-1856" class="hover-black link underline hover-bg-lightest-blue">CVE-2012-1856</a>,<a href="https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1641" class="hover-black link underline hover-bg-lightest-blue"> CVE-2015-1641</a>, and <a href="https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2015-1770" class="hover-black link underline hover-bg-lightest-blue">CVE-2015-1770</a>.</p>
<p>The Arbor report describes the ongoing use of these four vulnerabilities in a series of espionage campaigns against not only Tibetan groups, but also others related to Hong Kong, Taiwan, and Uyghur interests. While we have not connected the campaign targeting the Tibetan Parliamentarians to the campaigns described by Arbor, the continual pairing of these older <code>.rtf</code> vulnerabilities with malware operations against the Tibetan community is noteworthy.</p>
<h2 class=" lh-solid mb3">The Malware</h2>
<p class="mt0">The malware samples deployed in both of these operations are updated versions of the KeyBoy backdoor first discussed in 2013 by <a href="https://community.rapid7.com/community/infosec/blog/2013/06/07/keyboy-targeted-attacks-against-vietnam-and-india" class="hover-black link underline hover-bg-lightest-blue">Rapid7</a>. KeyBoy provides basic backdoor functionality, allowing the operators to select from various capabilities used to surveil and steal information from the victim machine.</p>
<p>KeyBoy functionality:</p>
<ul><li style="font-weight: 400;" class="mt2">Gather system information, including details of the operating system, processor, disk, memory, display, and uptime (<b>see: Figure 4</b>)</li>
<li style="font-weight: 400;" class="mt2">Upload files to the victim computer</li>
<li style="font-weight: 400;" class="mt2">Download files from the victim computer</li>
<li style="font-weight: 400;" class="mt2">Browse the file system, including gathering details about attached drives</li>
<li style="font-weight: 400;" class="mt2">Execute commands and applications</li>
<li style="font-weight: 400;" class="mt2">Launch interactive shell</li>
</ul>
<figure class="center mw-100 ba b--light-gray" style="width:565px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="size-full wp-image-28400" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament.png" alt="Figure 4: Format strings illustrating some of the system information obtained by KeyBoy from an infected machine" width="565" height="327" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament.png 565w, https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament-300x174.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament-180x104.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure-4_parliament-297x172.png 297w" sizes="(max-width: 565px) 100vw, 565px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 4: Format strings illustrating some of the system information obtained by KeyBoy from an infected machine</figcaption></figure>
<p>These updated versions of KeyBoy make use of an encoded configuration file to store their command and control (C2) information along with other required settings. In both cases, the dropper wrote this configuration file in the user&rsquo;s Local Application Data directory as <code>win32res.dat</code>. After analyzing these malware samples, we were able to decode the following configuration parameters, presented in <b>Table 1</b></p>
<figure class="center mw-100" style="min-width: 50%"><table class="mobile-zoomout ba b--light-gray" style="" border="0" cellspacing="0" headerTable="true"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Line</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Description</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">First sample</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Second sample</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 1</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Identity code, used to ensure config was correctly decoded</td>
<td class="tl f6 f5-ns pa1 pa2-ns">9876543210</td>
<td class="tl f6 f5-ns pa1 pa2-ns">9876543210</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 2</td>
<td class="tl f6 f5-ns pa1 pa2-ns">C2 Server #1 (hostname/ip)</td>
<td class="tl f6 f5-ns pa1 pa2-ns">45.125.12[.]147</td>
<td class="tl f6 f5-ns pa1 pa2-ns">45.125.12[.]147</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 3</td>
<td class="tl f6 f5-ns pa1 pa2-ns">C2 Server #2 (hostname/ip)</td>
<td class="tl f6 f5-ns pa1 pa2-ns">103.40.102[.]233</td>
<td class="tl f6 f5-ns pa1 pa2-ns">45.125.12[.]147</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 4</td>
<td class="tl f6 f5-ns pa1 pa2-ns">C2 Server #3 (hostname/ip)</td>
<td class="tl f6 f5-ns pa1 pa2-ns">45.125.12[.]147</td>
<td class="tl f6 f5-ns pa1 pa2-ns">45.125.12[.]147</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 5</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Port used with C2 Server #1</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 6</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Port used with C2 Server #2</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 7</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Port used with C2 Server #3</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
<td class="tl f6 f5-ns pa1 pa2-ns">443</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 8</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Password for operator login</td>
<td class="tl f6 f5-ns pa1 pa2-ns">tibetwoman</td>
<td class="tl f6 f5-ns pa1 pa2-ns">tibetwoman</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Line 9</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Campaign ID, transmitted to C2 during login</td>
<td class="tl f6 f5-ns pa1 pa2-ns">NNNN</td>
<td class="tl f6 f5-ns pa1 pa2-ns">NNNN</td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><strong>Table 1:</strong> Decoded configuration parameters from both KeyBoy samples observed in the Parliamentarian operation</p></figcaption></figure>
<p>A full description of the new algorithm used by KeyBoy to decode its configuration file is presented in Appendix A.</p>
<p>Once the KeyBoy DLL has been executed, it validates that a particular string value (likely identifying the KeyBoy version) is set in the Windows Registry.</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Key</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">First sample</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Second sample</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zonemap\Ver</td>
<td class="tl f6 f5-ns pa1 pa2-ns">20160509</td>
<td class="tl f6 f5-ns pa1 pa2-ns">agewkassif</td>
</tr></tbody></table></figure><p>Additionally, these versions of KeyBoy ensure persistence by setting the <code>wab32res.exe</code> file to be loaded upon login via exploiting the Winlogon Shell key, which in turn loads the malicious <code>wab32res.dll</code> file by the aforementioned DLL search-order hijacking method.</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Key</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Value</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</td>
<td class="tl f6 f5-ns pa1 pa2-ns">explorer.exe, &ldquo;C:\users\&lt;user&gt;\AppData\Local\wab32res.exe&rdquo;</td>
</tr></tbody></table></figure><p>The backdoor then sends a login beacon to the C2 server which, once decoded, looks like:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code>*a*<br>
USER-PC<br>
192.168.100.101<br>
NNNN<br>
2016/09/13 16:11:56<br>
20160509</code></div>
<p>These values are described as follows in <strong>Table 2</strong>:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Value from Example</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Description</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*a*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Data header code for initial check-in beacon</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">USER-PC</td>
<td class="tl f6 f5-ns pa1 pa2-ns">%computername% of victim PC</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">192.168.100.101</td>
<td class="tl f6 f5-ns pa1 pa2-ns">IP address of victim PC</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">NNNN</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Campaign ID from the KeyBoy configuration file</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">2016/09/13 16:11:56</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Timestamp of local PC</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20160509</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Internal version identifier</td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><strong>Table 2:</strong> Descriptions of the login beacon values</p></figcaption></figure>
<p>This login data, as well as all other communication between backdoor and command and control server, is transmitted using an encoding mechanism based on principles from modular arithmetic. We describe this network communication encoding in detail in this <a href="https://citizenlab.ca/wp-content/uploads/2016/11/keyboy-network-comm.pdf" class="hover-black link underline hover-bg-lightest-blue">supplementary document.</a></p>
<p>As can be seen in the login event example above, when sending data to the C2, the KeyBoy implant uses a series of header &lsquo;codes&rsquo; to specify the type of data which is being transmitted, described in <strong>Table 3</strong>:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Header code</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Data being transmitted</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*l*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Heartbeat / Keepalive</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*a*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Initial check-in beacon</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*s*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">System information (drive info, system specifications, interface info)</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*d*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Data from remote commands and shell</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*f*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Data relating to interactions via File Manager</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*g*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Ready to initiate file download</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">*h*</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Ready to initiate file upload or update</td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><strong>Table 3:</strong> KeyBoy header codes for sending data to the C2 server</p></figcaption></figure>
<h2 class=" lh-solid mb3">The Infrastructure</h2>
<p class="mt0">The command and control (C2) servers used in the Tibetan Parliament operation were extracted from the KeyBoy configuration files:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" width="640px" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">C2 Host: 45.125.12[.]147</td>
<td style="border: 1px solid black; padding: 10px;">Desc: Royal Network Technology Co</td>
<td style="border: 1px solid black; padding: 10px;">City: Guangzhou</td>
<td style="border: 1px solid black; padding: 10px;">Country: China</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;" colspan="4" align="center">No relevant data or passive DNS information was available</td>
</tr></tbody></table></figure><p>&nbsp;</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" width="640px" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">C2 Host: 103.40.102[.]233</td>
<td style="border: 1px solid black; padding: 10px;">Desc: Dragon Network Int&rsquo;l Co. Ltd</td>
<td style="border: 1px solid black; padding: 10px;">City: Hong Kong</td>
<td style="border: 1px solid black; padding: 10px;">Country: Hong Kong</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;" colspan="4" align="center">Domain: tibetvoices[.]com
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">Host</td>
<td style="border: 1px solid black; padding: 10px;">First Seen:</td>
<td style="border: 1px solid black; padding: 10px;">Last Seen:</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">127.0.0.1</td>
<td style="border: 1px solid black; padding: 10px;">2016-09-29</td>
<td style="border: 1px solid black; padding: 10px;">Current as of publication</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">103.40.102[.]233</td>
<td style="border: 1px solid black; padding: 10px;">2016-07-15</td>
<td style="border: 1px solid black; padding: 10px;">2016-09-28</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">112.10.117[.]47</td>
<td style="border: 1px solid black; padding: 10px;">2016-05-25</td>
<td style="border: 1px solid black; padding: 10px;">2016-05-26</td>
</tr></tbody></table></figure></td>
</tr></tbody></table></figure><p>We uncovered very little information about the command and control (C2) infrastructure used in this operation. The configuration files referenced hard-coded IP addresses for the C2 servers, as opposed to using domain names as was seen in prior KeyBoy campaigns.</p>
<p>Passive DNS analysis revealed one domain, <code>tibetvoices[.]com</code>, which was briefly pointed to one of the C2 server IP addresses found in the KeyBoy configuration file used in the first attempt against the Parliamentarians. This domain was created in May 2016 (around the time that the KeyBoy sample used in the first attempt was compiled) and was pointed to IP address <code>103.40.102[.]233</code> from July 15 to September 28. Subsequently, this domain was pointed to <code>127.0.0.1</code>, effectively taking it offline.</p>
<p>This behavioural tactic was previously mentioned in relation to KeyBoy in a 2013 blog <a href="http://blogs.cisco.com/security/scope-of-keyboy-targeted-malware-attacks" class="hover-black link underline hover-bg-lightest-blue">post</a> by Cisco. Cisco hypothesized that the actors behind KeyBoy may have been nullifying the DNS records when an active campaign was not underway, in an attempt to stay &ldquo;below the radar&rdquo;. This tactic allows the malware operator to ensure that no command and control traffic will be sent out from the infected system, thus preventing detection via network monitoring.</p>
<p>This tactic, however plausible, would not apply to the KeyBoy samples we analyzed, as the C2 configuration relied upon hard coded IP addresses and did not directly reference the <code>tibetvoices[.]com</code> domain. It is possible that a different campaign was launched which used this domain, but we were unable to find any evidence of such a campaign.</p>
<p>Our analysis provides a cursory look at some of the capabilities and implementation details of the KeyBoy backdoor as used during a malware operation targeting Tibetan Parliamentarians. These versions of KeyBoy differed from the one first described by Rapid7 in several ways, many of which will be described in the sections to follow.</p>
<p>During our research into this operation we were able to uncover two additional samples of KeyBoy which were likely used in previous malware campaigns. These samples were contained in exploit documents containing distinct lure content, one having a Tibetan nexus, the other an Indian nexus.</p>
<p>In Part 2 we present a brief overview of the observable evolution of KeyBoy based upon all of the samples we obtained.</p>
<h1 class=" lh-solid mb3">Part 2: KeyBoy &ndash; Tracking Evolution</h1>
<p class="mt0">Periodic updates are common in the world of software development. Features are added and removed, bugs are patched, and code is written to execute more efficiently. The same holds true for malicious software, but with the additional requirement that the development cycle must always satisfy the operational need for covertness. To be effective, malicious software designed for surveillance must remain undetected. Malware developers are in a constant struggle to avoid the security controls that protect target systems.</p>
<p>We believe the 2013, 2015, and 2016 KeyBoy samples provide evidence of a development effort focused on changing components that would be used by researchers to develop detection signatures. This section outlines how we came to this conclusion.</p>
<p>In building our KeyBoy chronology, we collected several samples and examined three data points from each:</p>
<ul><li style="font-weight: 400;" class="mt2">The compile time of the KeyBoy binary</li>
<li style="font-weight: 400;" class="mt2">A string observed in the KeyBoy binary we refer to as the &lsquo;version identifier&rsquo;</li>
<li style="font-weight: 400;" class="mt2">Elapsed time between compile time and the time of first exposure</li>
</ul><p>Analysis of these data points gave us a moderate to high level of confidence that the binary compile times provided a reliable estimate of the true development timeline.</p>
<h2 class=" lh-solid mb3">An Evolving Implant</h2>
<p class="mt0">In an effort to understand its evolution, we compared the code of several versions of KeyBoy as identified by their &lsquo;version identifier&rsquo; strings, shown in Table 4:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Version Identifier</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Notes</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Proxy 20130401</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Reported by Rapid7 in relation to an Indian nexus</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Proxy 20130401</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Reported by Rapid7 in relation to a Vietnamese nexus</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">P_20150313</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Discovered via hunting; carried Indian lure content</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20151108</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Discovered via hunting; carried Tibetan lure content</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20160509</td>
<td class="tl f6 f5-ns pa1 pa2-ns">First sample of the Parliamentarian operation from August 2016</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20160509</td>
<td class="tl f6 f5-ns pa1 pa2-ns">An alternate sample, using different configuration data</td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">agewkassif</td>
<td class="tl f6 f5-ns pa1 pa2-ns">Second sample of the Parliamentarian operation from October 2016</td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><strong>Table 4:</strong> Version identifier strings analyzed</p></figcaption></figure>
<p>The &lsquo;version identifier&rsquo; is a particular string that appeared in every KeyBoy sample we studied. It is transmitted to the command and control server as part of the login data packet, and, in recent versions, this identifier is written to the Windows registry in a key named &lsquo;Ver&rsquo;. With the exception of the newest (chronologically speaking) KeyBoy version we discovered, this identifier always contained a date-like component which matched the compile date of the KeyBoy binary in every case. In the newest sample, the developers replaced this date-like string with a seemingly random set of letters.</p>
<p>A timeline depicting these KeyBoy versions, along with some important characteristics, is shown in Figure 5.</p>
<figure class="center mw-100 ba b--light-gray" style="width:650px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28401" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png" alt="Figure 5: The timeline of KeyBoy&rsquo;s evolution " width="650" height="391" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament.png 1029w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-300x180.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-768x462.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-1024x616.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-180x108.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-565x340.png 565w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_5_parliament-297x179.png 297w" sizes="(max-width: 650px) 100vw, 650px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 5: The timeline of KeyBoy&rsquo;s evolution</figcaption></figure>
<h2 class=" lh-solid mb3">Noteworthy Modifications</h2>
<p class="mt0">This section describes some of the most significant changes observed across the KeyBoy versions. Each of these components would have been an ideal target for signature-based identification, using either static string or network packet-based detection mechanisms.</p>
<h3 class=" lh-solid mb3">Header Code Evolution</h3>
<p class="mt0">Of the changes we identified one stands out as being an immediate target for an effective antivirus signature &ndash; the evolution of header codes used during communication between the implant and command and control server. As shown in Table 5, these codes changed substantially after the 2013 KeyBoy samples were examined and publically documented by Rapid7. It is reasonable to hypothesize that this significant change in format was in response to the publication of Rapid7&rsquo;s research.</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">2013</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Early 2015</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Late 2015</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">2016</th>
</thead><tbody><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$login$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#l#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*a*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*l*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$sysinfo$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#s#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*s*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*a*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$shell$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#e#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*d*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*s*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$fileManager$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#f#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*f*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*d*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$fileDownload$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#D#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*g*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*f*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns">$fileUpload$</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">#U#</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*h*</td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*g*</td>
</tr><tr class="striped--light-gray"><td align="center" class="tl f6 f5-ns pa1 pa2-ns"></td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns"></td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns"></td>
<td align="center" class="tl f6 f5-ns pa1 pa2-ns">*h*</td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><b>Table 5:</b> Header codes used by KeyBoy during C2 communication</p></figcaption></figure>
<p>In addition, modifying these codes produced a downstream change in the appearance of the network communication traffic produced by an active KeyBoy infection. This change would likely have rendered existing network based signatures ineffective.</p>
<h3 class=" lh-solid mb3">Configuration File Changes</h3>
<p class="mt0">Another major change we first observed in version <code>P_20150313</code> is the complete redesign of the algorithm used to encode the KeyBoy configuration file. In the 2013 samples described by Rapid7, this configuration file was encoded using a simplified static-key based algorithm. This newer encoding algorithm is significantly more involved, removing the use of a static encryption key in favour of a dynamically constructed lookup table. We provide a detailed explanation of this new algorithm in Appendix A.</p>
<h3 class=" lh-solid mb3">Persistence Changes</h3>
<p class="mt0">The method used by the implant for maintaining persistence was also changed several times. The earlier versions used a Windows service to ensure the malware stayed persistent, moving to a more commonly seen tactic of setting the <code>Run</code> key in the Windows registry in the early 2015 sample. This method changed again in late 2015 when the implant migrated from the Run key to using a less frequently observed registry key: <code>Winlogon\Shell</code>. This key stores the list of executables which are to be run once a Windows GUI session is created, and typically holds only the standard user shell, <code>explorer.exe</code>.</p>
<h3 class=" lh-solid mb3">String Obfuscation</h3>
<p class="mt0">In another modification, first observed in the most recent October 11 Parliamentarian operation (version <code>agewkassif</code>), the developer(s) of KeyBoy began using a string obfuscation routine in order to hide many of the critical values referenced within the malware. This introduction of string obfuscation also suggests a development change aimed at evading detection. The header codes, filename references, and all of the operator commands were obfuscated and only decoded during execution of the KeyBoy DLL. <strong>Figure 6</strong> shows a sampling of these strings, after decoding.</p>
<figure class="center mw-100 ba b--light-gray" style="width:600px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28402" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament.png" alt="Figure 6: Header code and command strings after being decoded at run-time " width="600" height="343" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament.png 1200w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-300x172.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-768x439.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-1024x585.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-180x103.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-595x340.png 595w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_6_parliament-297x170.png 297w" sizes="(max-width: 600px) 100vw, 600px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 6: Header code and command strings after being decoded at run-time</figcaption></figure>
<h3 class=" lh-solid mb3">Evidence of Modularity</h3>
<p class="mt0">Finally, there were numerous changes observed that could suggest that KeyBoy was being deployed using a modular or component based mechanism. The <code>GetUp</code> export which is linked to the browser credential theft capability seems to be present in some samples and not others, even for versions within the same development stage. As well, the inconsistent use of a dropper binary during infection is further evidence supporting the modular component theory.</p>
<h3 class=" lh-solid mb3">Additional Details</h3>
<p class="mt0">Beyond the main modifications outlined above, numerous smaller changes were also observed, many of which are described in Table 6 below.</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" headerTable="true" class=" ba b--light-gray"><thead class="bg-dark-gray white"><th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Version Identifier</th>
<th class=" fw6 tl f6 f5-ns pa1 pa2-ns">Key Changes</th>
</thead><tbody><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">Proxy 20130401</td>
<td class="tl f6 f5-ns pa1 pa2-ns">
<ul><li class="mt2">Persistence handled via Windows service</li>
<li class="mt2">One sample contained the &lsquo;GetUP&rsquo; export, the other did not</li>
<li class="mt2">Used full word header codes encapsulated by $ symbols, such as <span class="math inline"><em>$l</em><em>o</em><em>g</em><em>i</em><em>n$</em></span></li>
</ul></td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">P_20150313</td>
<td class="tl f6 f5-ns pa1 pa2-ns">
<ul><li class="mt2">Adopts new algorithm for config file encoding</li>
<li class="mt2">Retained browser credential theft module</li>
<li class="mt2">Moved to persistence via Run key</li>
<li class="mt2">Header codes shift to #-encapsulation</li>
<li class="mt2">Deployed without use of dropper binary</li>
</ul></td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20151108</td>
<td class="tl f6 f5-ns pa1 pa2-ns">
<ul><li class="mt2">Continues use of new config encoding algorithm</li>
<li class="mt2">Migrated to use of WinLogon key for persistence</li>
<li class="mt2">Installation now conducted via VBS scripts</li>
<li class="mt2">Adopted multi-byte strings internally and in C2 communication</li>
<li class="mt2">Header codes move to *-encapsulation</li>
<li class="mt2">64 bit version distributed inside 32 bit payload</li>
<li class="mt2">No evidence of browser credential module</li>
<li class="mt2">Deployed using dropper binary</li>
</ul></td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">20160509</td>
<td class="tl f6 f5-ns pa1 pa2-ns">
<ul><li class="mt2">Continues use of new config encoding algorithm</li>
<li class="mt2">Added AutoUpdate/Upload &amp; Execute function</li>
<li class="mt2">Deployed using dropper binary</li>
<li class="mt2">Header codes retain *-encapsulation, new &lsquo;keep-alive&rsquo; code, *l*</li>
<li class="mt2">Execution via DLL search-order hijacking of legitimate Windows application</li>
<li class="mt2">VBS script traces still present, but no longer used</li>
<li class="mt2">No 64bit version embedded</li>
</ul></td>
</tr><tr class="striped--light-gray"><td class="tl f6 f5-ns pa1 pa2-ns">agewkassif</td>
<td class="tl f6 f5-ns pa1 pa2-ns">
<ul><li class="mt2">Functionally identical to 20160509 sample</li>
<li class="mt2">Continues use of new config encoding algorithm</li>
<li class="mt2">Removed date string from version identifier</li>
<li class="mt2">Added static string obfuscation code. Strings used for C2 commands, header codes, and more are now decoded at runtime</li>
</ul></td>
</tr></tbody></table><figcaption class="f5 pa2 bt b--gray bw2 bg-light-gray"><p class="ma0"><strong>Table 6:</strong> Changes observed between successive versions of KeyBoy</p></figcaption></figure>
<p>Additional technical details relating to several of the KeyBoy samples described in this section are provided in Appendix B.</p>
<h2 class=" lh-solid mb3">Connecting KeyBoy to Other Operations</h2>
<p class="mt0">In their Operation Tropic Trooper <a href="http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-operation-tropic-trooper.pdf" class="hover-black link underline hover-bg-lightest-blue">report</a>, Trend Micro documented the behaviour and functionality of an espionage toolkit with several design similarities to those observed in the various components of KeyBoy. Trend Micro specifically noted that the 2013 versions of KeyBoy used the same algorithm for encoding their configuration files as was observed in the Operation Tropic Trooper malware.</p>
<p>This connection may offer another explanation for the significant change in the configuration file encoding algorithm we described in relation to KeyBoy. If KeyBoy is a single component of a larger espionage toolkit, the developers may have realized that this older, static-key based, configuration encoding algorithm was inadvertently providing a link between disparate components of their malware suite.</p>
<h2 class=" lh-solid mb3">A Note on Samples</h2>
<p class="mt0">We were not able to locate a large sample set for KeyBoy. Though we discussed the development timeline, we have limited insight into the victims targeted by each of these samples. We cannot conclude that all are being deployed by the same group. We provide <a href="https://github.com/citizenlab/malware-indicators/blob/master/201611_KeyBoy/keyboy.yar" class="hover-black link underline hover-bg-lightest-blue">YARA </a>signatures and encourage anyone who can provide additional samples or context to contact us.</p>
<h1 class=" lh-solid mb3">Recent Tibetan Protests</h1>
<p class="mt0">The harm of malware operations against the Tibetan community is <a href="https://targetedthreats.net/" class="hover-black link underline hover-bg-lightest-blue">well-documented</a>, and this latest campaign is no exception. Examining the lure content sent to the Tibetan Parliamentarians sheds light on the oppression faced by the Tibetan community. On October 19, over 180 Tibetan groups protested the ongoing demolitions of the Larung Gar Buddhist Academy, the largest Tibetan Buddhist institute in the world.</p>
<p>The demolitions stem from an order issued by Chinese authorities in June 2016, <a href="https://freetibet.org/news-media/na/over-180-tibet-groups-condemn-larung-gar-demolitions-joint-statement" class="hover-black link underline hover-bg-lightest-blue">according</a> to a joint statement issued by Tibet groups on the date of protest. According to the same joint statement, the order from Chinese authorities said the community was in need of &ldquo;ideological guidance&rdquo; from the Chinese state. In conjunction with the demolitions, residents are being forcefully removed from Larung Gar. To date, the forced removals have led to <a href="http://tchrd.org/nuns-continue-suicide-protest-against-demolition-of-buddhist-institute/" class="hover-black link underline hover-bg-lightest-blue"> to the suicide of three resident nuns.</a></p>
<p>The Communist Party of China views the Tibetan movement as a threat to its rule, alongside Uyghur, Falun Gong, advocates for an independent Taiwan and Hong Kong, and members of the democracy movement. Surveilling the highest governing body of the Central Tibetan Administration aligns with the overall interests of the government of China. However, connecting the malware development ecosystem and the flow of stolen information to a state-actor is an elusive task. With the data available we are unable to conclusively connect the Parliamentarian Operation to any specific actor or nation-state.</p>
<h1 class=" lh-solid mb3">Conclusions</h1>
<p class="mt0">Recent <a href="https://citizenlab.ca/2016/03/shifting-tactics/" class="hover-black link underline hover-bg-lightest-blue">Citizen Lab reports</a> have documented a trend away from the use of attachment-based malware operations targeting the Tibetan Diaspora. These changes may reflect malware operators shifting tactics in response to changes in the community, including education campaigns encouraging Tibetans <a href="https://www.cybersuperhero.net/safer-file-sharing/" class="hover-black link underline hover-bg-lightest-blue">not to use email attachments</a>, or perhaps also by more sophisticated attachment scanning by popular email providers.</p>
<p>The operation against the Tibetan Parliamentarians illustrates the continued use of malicious attachments in the form of documents bearing exploits. These exploits, while older, were used to deliver a malware payload which shows signs of a systematic technical adaptation designed to reduce the likelihood of signature based detection.</p>
<p>The developers of KeyBoy have made the minimum necessary technical changes required to avoid detection by signature-based antivirus, and yet retained &ldquo;old&rdquo; exploits because they likely continue to work their targets<i>.</i></p>
<p>For a community lacking an adequate level of human and financial resources, deployment of commercial (i.e.: non-free) antivirus solutions, updated releases of common office productivity software, and even software patches may be out of reach. Under such conditions, the use of exploits against older, patched, vulnerabilities becomes yet another iteration of an actor using &ldquo;<a href="https://www.johnscottrailton.com/security-for-the-high-risk-user/" class="hover-black link underline hover-bg-lightest-blue">just enough</a>&rdquo; sophistication to successfully exploit a target.</p>
<p>The operation against the Parliamentarians yields a clear example of this tactic. When the August operation failed to fully compromise the target group, the operators redeployed in October using a slightly newer, but still well-known and patched, exploit.</p>
<p>As we observe the evolution of strategies levied against the Tibetan Diaspora, the constant cat-and-mouse game embroiling this community becomes evident. While some behavioural adaptations have shown promise in reducing the threat, the operation against the Tibetan Parliament underscores the need for continued diligence and security awareness.</p>
<h1 class=" lh-solid mb3">Acknowledgments</h1>
<p class="mt0">Special thanks to Tibet Action Institute. Additional thanks to Jakub Dalek, PassiveTotal, VirusTotal, and TNG.</p>
<h1 class=" lh-solid mb3">Appendix A: Decoding KeyBoy Config</h1>
<p class="mt0">Recent versions of KeyBoy maintain encoded configuration data inside a file stored on disk. In the <code>20160509</code> sample used in the Tibetan Parliament campaign, this file was named <code>wab32res.dat</code>. The configuration file contains a 16 byte header followed by a number of bytes which are encoded using a novel algorithm. The 16 byte header stores an ascii character representation of the hexadecimal values corresponding to the size (in bytes) of the decoded config data, followed by the number of bytes containing encoded configuration data.</p>
<p>The sample under examination contained the following header, and <strong>Figure 7</strong> shows the raw configuration file:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">Size of config (in bytes) once decoded</td>
<td style="border: 1px solid black; padding: 10px;">Number of bytes in encoded config</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr><td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x5B</td>
</tr></tbody></table></figure></td>
<td style="border: 1px solid black; padding: 10px;">
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr><td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x00</td>
<td style="border: 1px solid black; padding: 10px;">0x4B</td>
</tr></tbody></table></figure></td>
</tr></tbody></table></figure>
<figure class="center mw-100 ba b--light-gray" style="width:670px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28403" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament.png" alt="Figure 7: Configuration file for sample under examination " width="670" height="138" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament.png 1250w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-300x62.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-768x159.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-1024x211.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-180x37.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-605x125.png 605w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_7_parliament-297x61.png 297w" sizes="(max-width: 670px) 100vw, 670px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 7: Configuration file for sample under examination</figcaption></figure>
<p>The configuration file used by this malware is encoded using what appears to be a custom schema. While some earlier versions of this backdoor used more simplified encoding techniques for the configuration data, newer versions have adopted a more involved algorithm.</p>
<p>At the heart of the decoding function is the use of a dynamically constructed lookup table containing sequences of bytes which represent the ASCII characters for the cleartext configuration data.</p>
<figure class="center mw-100 ba b--light-gray" style="width:500px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="size-full wp-image-28404" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament.png" alt="Figure 8: Construction of the base lookup table " width="231" height="248" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament.png 462w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament-279x300.png 279w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament-180x193.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament-317x340.png 317w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_8_parliament-185x199.png 185w" sizes="(max-width: 231px) 100vw, 231px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 8: Construction of the base lookup table</figcaption></figure>
<p>At the outset of the decoding function, a base lookup table is created containing 256 entries. This initial table can be thought of as an identity matrix, where, for each index, the lookup table contains the index as the stored value (see: <strong>Figure 8</strong>). For example:</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" align="center" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="padding: 10px;">LookupTable[0x0]</td>
<td style="padding: 10px;">&rarr;</td>
<td style="padding: 10px;">0x0</td>
</tr><tr class="striped--light-gray"><td style="padding: 10px;">LookupTable[0x1]</td>
<td style="padding: 10px;">&rarr;</td>
<td style="padding: 10px;">0x1</td>
</tr><tr class="striped--light-gray"><td style="padding: 10px;">&#8942;</td>
<td style="padding: 10px;"></td>
<td style="padding: 10px;">&#8942;</td>
</tr><tr class="striped--light-gray"><td style="padding: 10px;">LookupTable[0xFF]</td>
<td style="padding: 10px;">&rarr;</td>
<td style="padding: 10px;">0xFF</td>
</tr></tbody></table></figure><p>During the decoding of the configuration file, this table is expanded dynamically. Each iteration of the algorithm will populate the lookup table sequentially, beginning with index 0x102 (since the table index 0x101 is reserved).</p>
<h2 class=" lh-solid mb3">Algorithm Walkthrough</h2>
<p class="mt0">The algorithm has three basic steps:</p>
<ol><li style="font-weight: 400;" class="mt2">Obtain an index by decoding a value from the configuration file</li>
<li style="font-weight: 400;" class="mt2">Find the value in the lookup table corresponding to this index, and place this result in the memory buffer holding decoded configuration data</li>
<li style="font-weight: 400;" class="mt2">Generate a new value and insert it into the lookup table at the next available index</li>
</ol><h3 class=" lh-solid mb3">Step 1</h3>
<p class="mt0">This step requires the algorithm to obtain an index value from the configuration file. In order to obtain this index, a decoding function evaluates the data in the configuration file not as successive bytes, but as a series of integers calculated by considering consecutive sequences of 9-bit binary values.</p>
<p><strong>Figure 9</strong> provides a visual representation of this process. We can see that the first few indices being calculated by this decoder are hexadecimal values 0x100, 0x39, 0x38, and 0x37. The first value, 0x100, is a &lsquo;marker&rsquo; which denotes the beginning of the configuration data. The values 0x39, 0x38, and 0x37 are the first three indices used to obtain data from the lookup table.</p>
<figure class="center mw-100 ba b--light-gray" style="width:650px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28407" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament.png" alt="Figure 9: Step 1 in KeyBoy decoding algorithm. Indices are obtained by viewing the data in 9-bit &lsquo;windows&rsquo;" width="650" height="450" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament.png 1180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-300x208.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-768x532.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-1024x709.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-180x125.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-491x340.png 491w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_9_parliament-287x199.png 287w" sizes="(max-width: 650px) 100vw, 650px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 9: Step 1 in KeyBoy decoding algorithm. Indices are obtained by viewing the data in 9-bit &lsquo;windows&rsquo;</figcaption></figure>
<h3 class=" lh-solid mb3">Step 2</h3>
<p class="mt0">As mentioned above, the first 256 entries in the lookup table are created as an identity matrix, and thus the result of lookups for 0x39,0x38,0x37 would be:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
LookupTable[ 0x39 ] = 0x39 =&gt; &ldquo;9&rdquo; (ascii)<br>
LookupTable[ 0x38 ] = 0x38 =&gt; &ldquo;8&rdquo; (ascii)<br>
LookupTable[ 0x37 ] = 0x37 =&gt; &ldquo;7&rdquo; (ascii)<br></code></div>
<p>These values are then stored in memory as decoded bytes of configuration data.</p>
<h3 class=" lh-solid mb3">Step 3</h3>
<p class="mt0">After each iteration of calculating an index (step 1) and then obtaining the corresponding value from the lookup table (step 2), the algorithm will create a new entry in the lookup table at the next available index. The format of this new lookup table entry is simply the concatenation of the results of the previous lookup with the first byte of the current lookup (see: <strong>Figure 10</strong>).</p>
<figure class="center mw-100 ba b--light-gray" style="width:650px;"><div class="tc pa2 bg-white"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="wp-image-28408" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament.png" alt="Figure 10: Steps 2 &amp; 3 in the KeyBoy configuration decoding algorithm " width="650" height="599" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament.png 990w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament-300x276.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament-768x707.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament-180x166.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament-369x340.png 369w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_10_parliament-216x199.png 216w" sizes="(max-width: 650px) 100vw, 650px"></a></div><figcaption class="f5 pa2 bg-light-gray">Figure 10: Steps 2 &amp; 3 in the KeyBoy configuration decoding algorithm</figcaption></figure>
<p>So, again using the same example bytes along with <b>Figures 9</b> and <b>10</b> above, if the current iteration of the algorithm decoded the value 0x34 in step 1, and thus retrieved the value 0x34 = &lsquo;4&rsquo; in step 2, the newly formed lookup table entry would be:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
LookupTable[ 0x106 ] = [0x35,0x34] =&gt; &ldquo;54&rdquo;<br></code></div>
<p>Thus, if at some future point in the decoding process the index 0x106 was obtained in step 1, the output to the configuration data would be the two bytes [0x35,0x34] which have ascii representation &ldquo;54&rdquo;. This provides a method of data compression to the configuration file.</p>
<p>A Python script was created for the purpose of automating this configuration file decoding process. The output of this script when run against the configuration file used by the first of the two Parliamentarian operation samples yielded the following data:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
Identity Code: 9876543210<br>
C2 Host/IP #1: 45.125.12.147<br>
C2 Host/IP #2: 103.40.102.233<br>
C2 Host/IP #3: 45.125.12.147<br>
C2 Port #1: 443<br>
C2 Port #2: 443<br>
C2 Port #3: 443<br>
Password: tibetwoman<br>
Campaign ID: NNNN<br></code></div>
<h1 class=" lh-solid mb3">Appendix B: KeyBoy Samples</h1>
<h3 class=" lh-solid mb3">Version: P_20150313</h3>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Exploit Document:</b> <code>05b5cf94f07fee666eb086c91182ad25</code><br><b>Payload:</b> <code>0c7e55509e0b6d4277b3facf864af018</code><br><b>DLL Exports</b><br><code>Embedding 0x1000bfb0<br>
GetUP 0x1000c940<br>
SSSS 0x1000bc60<br>
StartWork 0x1000c570<br>
SvcMain 0x1000c430</code></div>
<h4 class=" lh-solid mb3">Installation</h4>
<p class="mt0">This sample was discovered inside a malicious PowerPoint slide show which carried lure content consistent with an Indian-nexus, and which was uploaded to VirusTotal in April 2015 using the filename <code>athirappalli.pps</code>. <a href="https://en.wikipedia.org/wiki/Athirappilly" class="hover-black link underline hover-bg-lightest-blue">Athirappilly</a> is a village in India known for its wildlife and waterfalls. The visual contents of the slide show are images of waterfalls, presumably from this village. This malicious <code>.pps</code> file was weaponized using (closely related to CVE-2014-4114 aka Sandworm, which we have previously <a href="https://citizenlab.ca/2015/06/targeted-attacks-against-tibetan-and-hong-kong-groups-exploiting-cve-2014-4114/" class="hover-black link underline hover-bg-lightest-blue">observed</a> this exploit used against the Tibetan community) to execute the following embedded DLL:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Name:</b> <code>SystemCertificates.ocx</code><br><b>Size:</b> <code>495616 bytes</code><br><b>Compile Time:</b> <code>13 Mar 2015 03:05:34 UTC</code><br><b>MD5:</b> <code>0c7e55509e0b6d4277b3facf864af018</code><br><b>SHA256:</b> <code>5395f709ef1ca64c57be367f9795b66b5775b6e73f57089386a85925cc0ec596</code></div>
<h4 class=" lh-solid mb3">Persistence</h4>
<p class="mt0">This DLL maintains persistence by setting the following registry entry in the <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Run key: SystemCertificates &rarr; "cmd /c start</code> Run <code>dll32.exe %APPDATA%\Microsoft\SystemCertificates\SystemCertificates.ocx, SSSS</code></p>
<p>This registry key is set via the Sandworm exploit, as the execution of an <code>.inf</code> file containing the following instructions are triggered:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
[DefaultInstall]<br>
CopyFiles = RxCopy<br>
AddReg = RxStart<br></code></div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
[RxCopy]<br>
..\..\Roaming\Microsoft\SystemCertificates\SystemCertificates.ocx, contact.pdf<br>
[RxStart]<br>
HKCU,Software\Microsoft\Windows\CurrentVersion\Run,SystemCertificates,,"cmd /c start Rundll32.exe %APPDATA%\Microsoft\SystemCertificates\SystemCertificates.ocx, SSSS"<br></code></div>
<p>In comparison with the prior generation of KeyBoy examined by Rapid7, this mechanism represents a change to registry based persistence from the previously used Windows service.</p>
<h4 class=" lh-solid mb3">Configuration</h4>
<p class="mt0">Using the algorithm presented in Appendix A, we were able to decode the configuration file used by this sample. Once decoded, the following information was obtained:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
Identity Code: IJUDHSDJFKJDE<br>
C2 Host/IP #1: www.about.jkub[.]com<br>
C2 Host/IP #2: www.eleven.mypop3[.]org<br>
C2 Host/IP #3: www.backus.myftp[.]name<br>
C2 Port #1:80<br>
C2 Port #2:80<br>
C2 Port #3:443<br>
Password:wariii<br>
Campaign ID:war </code></div>
<h4 class=" lh-solid mb3">Infrastructure</h4>
<figure class="center mw-100" style="min-width: 50%"><table style="" width="500px" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">C2 Host: www.about.jkub[.]com</td>
<td style="border: 1px solid black; padding: 10px;">Desc: Dynamic DNS provided by changeip.com</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;" colspan="2" align="center"><!-- subtable1 -->
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">Host</td>
<td style="border: 1px solid black; padding: 10px;">First Seen:</td>
<td style="border: 1px solid black; padding: 10px;">Last Seen:</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">175.213.49[.]6</td>
<td style="border: 1px solid black; padding: 10px;">2016-10-25</td>
<td style="border: 1px solid black; padding: 10px;">Current as of publication</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">45.32.47[.]148</td>
<td style="border: 1px solid black; padding: 10px;">2016-09-26</td>
<td style="border: 1px solid black; padding: 10px;">2016-10-24</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">157.7.84[.]81</td>
<td style="border: 1px solid black; padding: 10px;">2015-04-07</td>
<td style="border: 1px solid black; padding: 10px;">2015-04-21</td>
</tr></tbody></table></figure></td>
</tr></tbody></table></figure><p>&nbsp;</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" width="500px" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">C2 Host: www.eleven.mypop3[.]org</td>
<td style="border: 1px solid black; padding: 10px;">Desc: Dynamic DNS provided by changeip.com</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;" colspan="2" align="center"><!-- subtable2 -->
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">Host</td>
<td style="border: 1px solid black; padding: 10px;">First Seen:</td>
<td style="border: 1px solid black; padding: 10px;">Last Seen:</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">175.213.49[.]6</td>
<td style="border: 1px solid black; padding: 10px;">2016-10-25</td>
<td style="border: 1px solid black; padding: 10px;">Current as of publication</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">45.32.47[.]148</td>
<td style="border: 1px solid black; padding: 10px;">2016-09-26</td>
<td style="border: 1px solid black; padding: 10px;">2016-10-24</td>
</tr></tbody></table></figure></td>
</tr></tbody></table></figure><p>&nbsp;</p>
<figure class="center mw-100" style="min-width: 50%"><table style="" width="500px" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">C2 Host: www.backus.myftp[.]name</td>
<td style="border: 1px solid black; padding: 10px;">Desc: Dynamic DNS</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;" colspan="2" align="center"><!-- subtable3 -->
<figure class="center mw-100" style="min-width: 50%"><table style="" border="0" cellspacing="0" class=" ba b--light-gray"><tbody><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">Host</td>
<td style="border: 1px solid black; padding: 10px;">First Seen:</td>
<td style="border: 1px solid black; padding: 10px;">Last Seen:</td>
</tr><tr class="striped--light-gray"><td style="border: 1px solid black; padding: 10px;">192.241.149[.]43</td>
<td style="border: 1px solid black; padding: 10px;">2015-05-05</td>
<td style="border: 1px solid black; padding: 10px;">Current as of publication</td>
</tr></tbody></table></figure></td>
</tr></tbody></table></figure><h3 class=" lh-solid mb3">Version: 20151108</h3>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Exploit Document:</b> <code>8846d109b457a2ee44ddbf54d1cf7944</code><br><b>Dropper:</b> <code>8846d109b457a2ee44ddbf54d1cf7944</code><br><b>Payload:</b> <code>c5b5f01ba24d6c02636388809f44472e </code><br><b>Embedded 64bit:</b> <code>371bc132499f455f06fa80696db0df27</code><br><b>Payload DLL Exports</b><br><code>Install 0x100085a0<br>
SSSS 0x100081e0<br>
StartWork 0x100086a0<br>
SvcMain 0x10008fb0<br>
cfsUpdate 0x10008cb0<br></code></div>
<h4 class=" lh-solid mb3">Installation</h4>
<p class="mt0">This <code>.rtf</code> document, also exploiting CVE-2012-0158, was submitted to <a href="https://virustotal.com/en/file/ba442907f3218c8664bbecb47f915c4469340219e0f05af8f2d108d72659ff0f/analysis/" class="hover-black link underline hover-bg-lightest-blue">VirusTotal</a> in March 2016. The exploit triggers the execution of an embedded dropper, similar to the method observed in our initial sample described in Part 1.</p>
<p>This dropper creates three files on disk, each in the %localappdata% folder:</p>
<ol><li style="font-weight: 400;" class="mt2">cfs.dat &ndash; KeyBoy configuration file</li>
<li style="font-weight: 400;" class="mt2">cfsupdate.dal &ndash; KeyBoy payload DLL</li>
<li style="font-weight: 400;" class="mt2">desk.vbs &ndash; Windows script used for installation</li>
</ol><p>The Windows script file, desk.vbs, contained the following content:</p>
<p><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="aligncenter wp-image-28410" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament.png" alt="figure_11_parliament" width="600" height="58" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament.png 1281w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-300x29.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-768x74.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-1024x98.png 1024w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-180x17.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-605x58.png 605w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_11_parliament-297x29.png 297w" sizes="(max-width: 600px) 100vw, 600px"></a></p>
<p>The dropper executes this script file which subsequently launches the KeyBoy backdoor and sets persistence as described below.</p>
<p>Also noteworthy in this sample was the fact that this payload inspected the architecture of the victim PC to determine if it was 64 bit capable. If so, a 64 bit version of the payload was decoded from the data section of the cfsupdate.dat file using an XOR operation having key 0x90. This is very similar to the method described by Trend Micro in their <a href="http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-operation-tropic-trooper.pdf" class="hover-black link underline hover-bg-lightest-blue">report</a> on the TROJ_YAHOYAH malware.</p>
<p>Interestingly, the 64-bit module was packed using a known freeware binary packer. This is in contrast to the 32-bit versions of KeyBoy, none of which contained any binary protections whatsoever. Upon unpacking, the 64-bit version of this KeyBoy code was functionally identical to the 32-bit version.</p>
<h4 class=" lh-solid mb3">Leftover Code</h4>
<p class="mt0">Further illustrating the continued development and connections between samples are the leftover remnants from <code>20151108</code> existing in the <code>20160509</code> Parliamentarian sample. The Parliamentarian dropper contained references to the <code>Desk.vbs</code> script described above, yet this file and related content was not deployed or otherwise used in the <code>20160509</code> version.</p>
<h4 class=" lh-solid mb3">Persistence</h4>
<p class="mt0">Persistence is achieved through the WinLogon\Shell registry key, and is installed by the dropper&rsquo;s execution of the Install export from the KeyBoy DLL. This export creates the file <code>%localappdata%\Desktop.ini</code> as shown below, and installs it by launching the Windows regini.exe command:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon<br>
shell = explorer.exe,C:\Windows\system32\rundll32.exe "%LOCALAPPDATA%\cfs.dal" cfsUpdate<br></code></div>
<h4 class=" lh-solid mb3">Configuration</h4>
<p class="mt0">The configuration file used by this version of KeyBoy is written to disk as<code> %localappdata%\cfs.dat</code> by the dropper, similar to the behaviour of our <code>20160509</code> sample. This configuration file uses the newer encoding method outlined above and in Appendix A. Once decoded, the following information was obtained:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
Identity Code: 9876543210<br>
C2 Host/IP #1: 103.242.134[.]243<br>
C2 Host/IP #2: 103.242.134[.]243<br>
C2 Host/IP #3: 103.242.134[.]243<br>
C2 Port #1: 443<br>
C2 Port #2: 1234<br>
C2 Port #3: 1234<br>
Password: password8888<br>
Campaign ID: MyUser<br></code></div>
<h4 class=" lh-solid mb3">Possible Targeting</h4>
<p class="mt0">This malicious document embedded an empty decoy document to hide the exploitation of the vulnerability. We found however another interesting <a href="https://malwr.com/analysis/MmZjNjMyZjYxNWRiNDJhYzg0YzY5ZTQxYjYxNWM2NDE/" class="hover-black link underline hover-bg-lightest-blue">sample</a> with the exact same payload but with a decoy document&nbsp;presenting a petition to release a Tibetan activist:</p>
<p><a href="https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament.png" class="hover-black link underline hover-bg-lightest-blue"><img loading="lazy" class="aligncenter wp-image-28411" src="https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament.png" alt="figure_12_parliament" width="500" height="331" srcset="https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament.png 826w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament-300x199.png 300w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament-768x509.png 768w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament-180x119.png 180w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament-513x340.png 513w, https://citizenlab.ca/wp-content/uploads/2016/11/figure_12_parliament-297x197.png 297w" sizes="(max-width: 500px) 100vw, 500px"></a></p>
<h4 class=" lh-solid mb3">Infrastructure</h4>
<p class="mt0">This sample communicates with the following command and control server:</p>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>C2 Host:</b> <code>103.242.134[.]243</code><br><b>City:</b> <code>Hanshan</code><br><b>Country:</b> <code>China</code></div>
<h3 class=" lh-solid mb3">Version: 20160509 (alternate)</h3>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Exploit Document:</b> <code>beadf21b923600554b0ce54df42e78f5</code><br><b>Dropper:</b> <code>0b4d45db323f68b465ae052d3a872068</code><br><b>Payload:</b> <code>495adb1b9777002ecfe22aaf52fcee93</code><br><b>Payload DLL Exports</b><br><code>SSSS 0x100080b0<br>
SvcMain 0x10008b80<br>
cfsUpdate 0x10008880<br></code></div>
<p>During our research we encountered another sample of the <code>20160509</code> version of KeyBoy. This sample was also found to be deployed using the CVE-2012-0158 vulnerability. The malware payload was identical to our first Parliamentary sample outlined in Part 1, however the configuration file in this alternate sample was different.</p>
<h4 class=" lh-solid mb3">Configuration</h4>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
Identity Code: 9876543210<br>
C2 Host/IP #1: 116.193.154[.]69<br>
C2 Host/IP #2: 116.193.154[.]69<br>
C2 Host/IP #3: 116.193.154[.]69<br>
C2 Port #1:443<br>
C2 Port #2:80<br>
C2 Port #3:443<br>
Password:8888<br>
Campaign ID:8888<br></code></div>
<h4 class=" lh-solid mb3">Possible Targeting</h4>
<p class="mt0">The exploit document carrying this alternate KeyBoy configuration also used a decoy document which was displayed to the user after the exploit launched. This decoy carries content with a Tibetan nexus.</p>
<h4 class=" lh-solid mb3">Infrastructure</h4>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><code><br>
C2 Host: 116.193.154[.]69<br>
CNAME: 116-193-154-69.pacswitch.net<br></code></div>
<h1 class=" lh-solid mb3">Appendix D: IOCs and Links</h1>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>KeyBoy binaries</b><br><code>agewkassif: 087bffa8a570079948310dc9731c5709<br>
20160509: 495adb1b9777002ecfe22aaf52fcee93<br>
P_20150313: 0c7e55509e0b6d4277b3facf864af018<br>
20151108 (32bit): c5b5f01ba24d6c02636388809f44472e<br>
20151108 (64bit): 371bc132499f455f06fa80696db0df27<br></code></div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Droppers</b><br><code><br>
0b4d45db323f68b465ae052d3a872068<br>
23d284245e53ae4fe05c517d807ffccf<br>
98977426d544bd145979f65f0322ae30<br></code></div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>Exploit Documents</b><br><code><br>
8307e444cad98b1b59568ad2eba5f201 (used in August Parliamentary campaign)<br>
913b82ff8f090670fc6387e3a7bea12d (used in October Parliamentary campaign)<br>
05b5cf94f07fee666eb086c91182ad25<br>
8846d109b457a2ee44ddbf54d1cf7944<br>
beadf21b923600554b0ce54df42e78f5<br></code></div>
<div class="about-author pa3 br1 f5 lh-copy mv1 bg-washed-yellow ba b--mid-gray" style=""><b>C2 Hosts</b><br><code><br>
www.about.jkub[.]com<br>
www.eleven.mypop3[.]org<br>
www.backus.myftp[.]name<br>
tibetvoices[.]com<br>
103.242.134[.]243<br>
116.193.154[.]69<br>
103.40.102[.]233<br>
45.125.12[.]147<br></code></div>
<h1 class=" lh-solid mb3">Resources</h1>
<ul class="mt0"><li class="mt2"><a href="https://citizenlab.ca/wp-content/uploads/2016/11/keyboy-network-comm.pdf" class="hover-black link underline hover-bg-lightest-blue"> Keyboy Network Communication Encoding Details</a></li>
<li class="mt2"><a href="https://github.com/citizenlab/malware-indicators/blob/master/201611_KeyBoy/kb_configDecode.py" class="hover-black link underline hover-bg-lightest-blue">Configuration File Decoder</a></li>
<li class="mt2"><a href="https://github.com/citizenlab/malware-indicators/blob/master/201611_KeyBoy/kb_c2Decode.py" class="hover-black link underline hover-bg-lightest-blue">C2 Decoder</a></li>
<li class="mt2"><a href="https://github.com/citizenlab/malware-indicators/tree/master/201611_KeyBoy" class="hover-black link underline hover-bg-lightest-blue">YARA Signatures</a></li>
<li class="mt2"><a href="https://github.com/citizenlab/malware-indicators/tree/master/201611_KeyBoy" class="hover-black link underline hover-bg-lightest-blue">Indicators of Compromise</a></li>
</ul></body></html>
                </section>
                                <footer>



                </footer> 
              </article> 
						
						
			</section>
		</main>
			 <section class="mw9 center">
<div id="article-footer" role="complementary" class="bg-white bt b--light-silver f5 pv3 relative">
	<div class="absolute top-minus1 right-0 white bg-light-silver b pointer w2 pvs tc dn" id="scrollSidebarCloseBtn">
            X
     </div>
	<div class="flex justify-between">
				<div class="ph2"><div class="">Tags:</div><a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/china/" rel="tag">China</a>, <a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/espionage/" rel="tag">Espionage</a>, <a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/keyboy/" rel="tag">KeyBoy</a>, <a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/malware/" rel="tag">Malware</a>, <a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/tibet/" rel="tag">Tibet</a>, <a class="hover-black hover-bg-lightest-blue link underline" href="https://citizenlab.ca/tag/tropic-trooper/" rel="tag">Tropic Trooper</a></div><div class="dn db-ns"><span>Related:</span><div class="rp4wp-related-posts rp4wp-related-post">

		<ul class="rp4wp-posts-list">
		<li class="rp4wp-col rp4wp-col-first rp4wp-col-last">
	<div class="rp4wp_component rp4wp_component_title rp4wp_component_2"><a href="https://citizenlab.ca/2017/01/bill-marczak-co-authors-paper-social-engineering-attacks-government-opponents-target-perspectives/">Social Engineering Attacks on Government Opponents</a></div></li><li class="rp4wp-col rp4wp-col-first rp4wp-col-last">
	<div class="rp4wp_component rp4wp_component_title rp4wp_component_2"><a href="https://citizenlab.ca/2014/11/tibetan-translation-communities-risk-targeted-digital-threats-civil-society-report/">མི་མང་གི་ཚོགས་སྡེ་ཁག་ལ་རྒྱུན་མཐུད་པའི་གློག་ཀླད་ཀྱི་དྲ་འབུའི་རྒོལ་རྡུང་འཕྲད་བཞིན་པ།</a></div></li><li class="rp4wp-col rp4wp-col-first rp4wp-col-last">
	<div class="rp4wp_component rp4wp_component_title rp4wp_component_2"><a href="https://citizenlab.ca/2016/03/shifting-tactics/">Shifting Tactics: Tracking changes in years-long espionage campaign against Tibetans</a></div></li>	</ul>
	</div></div><div class="" style="flex: 0 0 3rem;"><div class="mb1 pl2 tl">Share:</div class="tl"><div><a class="dib pl2 pb1 w1-5" href="https://twitter.com/intent/tweet?text=Read%20%22It%E2%80%99s%20Parliamentary%3A%20KeyBoy%20and%20the%20targeting%20of%20the%20Tibetan%20Community%22%20by%20%40citizenlab%3A%20https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F" ><img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/brands/twitter.svg" class="w-100" alt="Twitter"/></a><a class="dib pl2 pb1 w1-5" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F" ><img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/brands/facebook.svg" class="w-100" alt="Facebook"/></a></div><div><a class="dib pl2 pb1 w1-5" href="whatsapp://send?text=Read%20%22It%E2%80%99s%20Parliamentary%3A%20KeyBoy%20and%20the%20targeting%20of%20the%20Tibetan%20Community%22%20by%20%3A%20https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F" data-action="share/whatsapp/share"><img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/brands/whatsapp.svg" class="w-100" alt="WhatsApp"/></a><a class="dib pl2 pb1 w1-5" href="mailto:?body=Read%20%22It%E2%80%99s%20Parliamentary%3A%20KeyBoy%20and%20the%20targeting%20of%20the%20Tibetan%20Community%22%20by%20The%20Citizen%20Lab%3A%20https%3A%2F%2Fcitizenlab.ca%2F2016%2F11%2Fparliament-keyboy%2F&subject=Read this by the Citizen Lab" ><img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/brands/email.svg" class="w-100" alt="Email"/></a></div></div>		</div>
</div>
</section>
<script src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/js/scroll-sidebar.js"></script>
</div>

<footer role="contentinfo" itemscope itemtype="http://schema.org/WPFooter" class="mw-12 center pa3 pv4-l ph6-l bg-lab-dark-brown white">
	<div class="mw7 center relative items-stretch flex-l justify-between">
		<nav role="navigation" class="border-box w-30-ns w-100 dib v-top">
			<h2 class="ttu mt0 mb2 f4">Research</h2>
			<div class="footer-links cf"><ul id="menu-research" class="mv0 f6-ns f4 b list pa0"><li id="menu-item-29711" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-29711"><a href="https://citizenlab.ca/category/research/targeted-threats/" class="lh-title mb2 db white b no-underline underline-hover">Targeted Threats</a></li>
<li id="menu-item-29709" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29709"><a href="https://citizenlab.ca/category/research/free-expression-online/" class="lh-title mb2 db white b no-underline underline-hover">Free Expression Online</a></li>
<li id="menu-item-29712" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29712"><a href="https://citizenlab.ca/category/research/transparency/" class="lh-title mb2 db white b no-underline underline-hover">Transparency and Accountability</a></li>
<li id="menu-item-29708" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29708"><a href="https://citizenlab.ca/category/research/app-privacy-and-security/" class="lh-title mb2 db white b no-underline underline-hover">App Privacy and Controls</a></li>
<li id="menu-item-29710" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29710"><a href="https://citizenlab.ca/category/research/global-research-network/" class="lh-title mb2 db white b no-underline underline-hover">Global Research Network</a></li>
<li id="menu-item-72386" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-72386"><a href="https://citizenlab.ca/category/research/tools-resources/" class="lh-title mb2 db white b no-underline underline-hover">Tools &#038; Resources</a></li>
<li id="menu-item-29713" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-29713"><a href="https://citizenlab.ca/publications/" class="lh-title mb2 db white b no-underline underline-hover">All Publications</a></li>
</ul></div>		</nav>
		<nav role="navigation" class="border-box w4-ns mt0-ns mt4 w-100 dib v-top">
			<h2 class="ttu mt0 mb2 f4 tl">News</h2>
			<div class="footer-links cf"><ul id="menu-news" class="mv0 f6-ns f4 b list pa0"><li id="menu-item-29714" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29714"><a href="https://citizenlab.ca/category/lab-news/mentions/" class="lh-title mb2 db white b no-underline underline-hover">In the Media</a></li>
<li id="menu-item-29715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29715"><a href="https://citizenlab.ca/category/lab-news/events/" class="lh-title mb2 db white b no-underline underline-hover">Events</a></li>
<li id="menu-item-29716" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-29716"><a href="https://citizenlab.ca/category/lab-news/opportunities/" class="lh-title mb2 db white b no-underline underline-hover">Opportunities</a></li>
<li id="menu-item-29717" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-29717"><a href="https://citizenlab.ca/newsletter/archives/" class="lh-title mb2 db white b no-underline underline-hover">Newsletter Archives</a></li>
</ul></div>		</nav>
		<nav role="navigation" class="border-box w-30-ns mt0-ns mt4 w-100 dib v-top">
			<h2 class="ttu mt0 mb2 f4">About</h2>
			<div class="footer-links cf"><ul id="menu-about" class="mv0 f6-ns f4 b list pa0"><li id="menu-item-29718" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-29718"><a href="https://citizenlab.ca/about/" class="lh-title mb2 db white b no-underline underline-hover">About the Citizen Lab</a></li>
<li id="menu-item-29720" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-29720"><a href="https://citizenlab.ca/people/" class="lh-title mb2 db white b no-underline underline-hover">People</a></li>
<li id="menu-item-68022" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-68022"><a href="https://citizenlab.ca/media/" class="lh-title mb2 db white b no-underline underline-hover">Media Resources</a></li>
<li id="menu-item-29721" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-29721"><a href="https://citizenlab.ca/teaching/" class="lh-title mb2 db white b no-underline underline-hover">Teaching</a></li>
<li id="menu-item-68345" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-68345"><a href="https://donate.utoronto.ca/give/show/84" class="lh-title mb2 db white b no-underline underline-hover">Donate</a></li>
</ul></div>
		</nav>
		</div>

		<!-- Main footer -->
		<div class="mw7 center mt4 relative pt3-ns bt-ns b--gray">
			<div class="flex-ns justify-between w-100">
				<div class="w-30-ns w-100 mb3 mr3-ns">
					<h2 class="ttu mt0 mb2 f4">Connect</h2>
						<div class="flex justify-between">
							<a class="dib pv1 dim" href="https://twitter.com/citizenlab"><img class="w1-5" src="https://citizenlab.ca/wp-content/plugins/basic-sharing/img/twitter-white.svg" alt="Twitter" /></a>

							<a class="dib pv1 dim" href="https://www.facebook.com/citizenlab.uoft"><img class="w1-5" src="https://citizenlab.ca/wp-content/plugins/basic-sharing/img/facebook-white.svg" alt="Facebook" /></a>
							
							<a class="dib pv1 dim" href="mailto:inquiries@citizenlab.ca"><img class="w1-5" src="https://citizenlab.ca/wp-content/plugins/basic-sharing/img/email-white.svg" alt="Email" /></a>
							<a class="dib pv1 dim" href="https://github.com/citizenlab"><img class="w1-5" src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/brands/github-white.svg" alt="Github" /></a>
						</div>
				</div>
				<div class="w-60-ns f6 w-100">
											<h2 class="f4 ttu mb2 mt3 mt0-ns">Newsletter</h2>
							
							<div id="text-3">			<div class="textwidget"><script>(function() {
	window.mc4wp = window.mc4wp || {
		listeners: [],
		forms: {
			on: function(evt, cb) {
				window.mc4wp.listeners.push(
					{
						event   : evt,
						callback: cb
					}
				);
			}
		}
	}
})();
</script><!-- Mailchimp for WordPress v4.8.3 - https://wordpress.org/plugins/mailchimp-for-wp/ --><form id="mc4wp-form-1" class="mc4wp-form mc4wp-form-29703" method="post" data-id="29703" data-name="" ><div class="mc4wp-form-fields"><input type="email" name="EMAIL" placeholder="Your email address" required class="dib pv1 mr2 mv1 lh-solid mw4"/><input type="submit" value="Sign up" class="link br1 b--none lh-solid ph3 pv2 mv1 mb2 dib black b bg-lab-orange hover-bg-black hover-white pointer"/></div><label style="display: none !important;">Leave this field empty if you're human: <input type="text" name="_mc4wp_honeypot" value="" tabindex="-1" autocomplete="off" /></label><input type="hidden" name="_mc4wp_timestamp" value="1621712311" /><input type="hidden" name="_mc4wp_form_id" value="29703" /><input type="hidden" name="_mc4wp_form_element_id" value="mc4wp-form-1" /><div class="mc4wp-response"></div></form><!-- / Mailchimp for WordPress Plugin -->
</div>
		</div>						
									</div>		
			</div>
		</div>
		
</footer>
			<div class="mw-12 center ph3 pv3 ph6-l white f6-ns f4 flex-ns items-center justify-between bg-lab-dark-brown bt b--gray">
				
												 <div class="mv0 dib">
							<div id="text-5">			<div class="textwidget"><p><a class="db white dim" href="https://citizenlab.ca/privacy/">Privacy Policy</a></p>
</div>
		</div>							</div>
																	 <div class="mv0 dib white ph3-l">
							<div id="text-4">			<div class="textwidget"><p>Unless otherwise noted this site and its contents are licensed under a <a class="white dim" href="https://creativecommons.org/licenses/by/2.5/ca/">Creative Commons Attribution 2.5 Canada</a> license.</p>
</div>
		</div>							</div>
											<div class="dib mv0 mt2 lh0 mw5">
								<a href="http://munkschool.utoronto.ca/" target="blank" style="flex-grow:1; flex-shrink:0">
										<img src="https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/images/MunkSchool-WHT.png" alt="Munk School of Global Affairs & Public Policy | University of Toronto" />
								</a>
						</div>
				
			</div>

<script>(function() {function maybePrefixUrlField() {
	if (this.value.trim() !== '' && this.value.indexOf('http') !== 0) {
		this.value = "http://" + this.value;
	}
}

var urlFields = document.querySelectorAll('.mc4wp-form input[type="url"]');
if (urlFields) {
	for (var j=0; j < urlFields.length; j++) {
		urlFields[j].addEventListener('blur', maybePrefixUrlField);
	}
}
})();</script><script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/bigfoot_footnotes/library/bigfoot.js' id='bigfoot-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/bigfoot_footnotes/library/bigfoot.min.js' id='bigfoot-min-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/bigfoot_footnotes/library/bigfoot-function.js' id='bigfoot-function-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/youtube-embed-plus/scripts/fitvids.min.js' id='__ytprefsfitvids__-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/js/search-menu.js' id='search-menu-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/themes/citizenlab-2.0.3/library/js/jquery-details/jquery.details.min.js' id='jquery-details-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-includes/js/wp-embed.min.js' id='wp-embed-js'></script>
<script type='text/javascript' src='https://citizenlab.ca/wp-content/plugins/mailchimp-for-wp/assets/js/forms.min.js' id='mc4wp-forms-api-js'></script>

</body>

</html> <!-- end of site. what a ride! -->
