
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-180x180.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" />
<link rel="alternate" hreflang="ja" href="https://unit42.paloaltonetworks.jp/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" />

	<!-- This site is optimized with the Yoast SEO plugin v15.2.1 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Analyzing OilRig&#039;s Ops Tempo from Testing to Weaponization to Delivery</title>
	<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<link rel="canonical" href="https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Analyzing OilRig&#039;s Ops Tempo from Testing to Weaponization to Delivery" />
	<meta property="og:description" content="Unit 42’s continued look into OilRig analyzes the group’s operational tempo, including testing, weaponization and attack delivery." />
	<meta property="og:url" content="https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" />
	<meta property="og:site_name" content="Unit42" />
	<meta property="article:published_time" content="2018-11-16T06:00:40+00:00" />
	<meta property="article:modified_time" content="2018-12-11T14:41:54+00:00" />
	<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" />
	<meta property="og:image:width" content="600" />
	<meta property="og:image:height" content="300" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="Robert Falcone">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="18 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://unit42.paloaltonetworks.com/#website","url":"https://unit42.paloaltonetworks.com/","name":"Unit42","description":"Palo Alto Networks","potentialAction":[{"@type":"SearchAction","target":"https://unit42.paloaltonetworks.com/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/#primaryimage","inLanguage":"en-US","url":"https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg","width":600,"height":300},{"@type":"WebPage","@id":"https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/#webpage","url":"https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/","name":"Analyzing OilRig's Ops Tempo from Testing to Weaponization to Delivery","isPartOf":{"@id":"https://unit42.paloaltonetworks.com/#website"},"primaryImageOfPage":{"@id":"https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/#primaryimage"},"datePublished":"2018-11-16T06:00:40+00:00","dateModified":"2018-12-11T14:41:54+00:00","author":{"@id":"https://unit42.paloaltonetworks.com/#/schema/person/9b513c1aa4fc24d8906475a0df1f2bda"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/"]}]},{"@type":"Person","@id":"https://unit42.paloaltonetworks.com/#/schema/person/9b513c1aa4fc24d8906475a0df1f2bda","name":"Robert Falcone","image":{"@type":"ImageObject","@id":"https://unit42.paloaltonetworks.com/#personlogo","inLanguage":"en-US","url":"https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg","caption":"Robert Falcone"}}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; Analyzing OilRig&#039;s Ops Tempo from Testing to Weaponization to Delivery Comments Feed" href="https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/feed/" />
<meta property="og:likes" content="3"/>
<meta property="og:readtime" content="15"/>
<meta property="og:views" content="22,936"/>
<meta property="og:date_created" content="November 16, 2018 at 8:00 AM"/>
<meta property="og:post_length" content="4428"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit42/"/>
<meta property="og:author" content="Robert Falcone"/>
<meta property="og:author" content="Kyle Wilhoit"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/robertfalcone/"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/kyle-wilhoit/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"Analyzing OilRig's Ops Tempo from Testing to Weaponization to Delivery","name":"Analyzing OilRig's Ops Tempo from Testing to Weaponization to Delivery","description":"Unit 42\u2019s continued look into OilRig analyzes the group\u2019s operational tempo, including testing, weaponization and attack delivery. ","url":"https:\/\/unit42.paloaltonetworks.com\/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery\/","datePublished":"November 16, 2018","articleBody":"Gaining insight into an adversary\u2019s operational tempo in the early phases of the attack lifecycle can be very difficult. Typically, there are far fewer data points available to analyze in the reconnaissance and weaponization phases for a researcher to use to determine how quickly an adversary operates prior to direct interaction with a target in the delivery phase. While continuing research on the August 2018 attacks on a middle eastern government that \u00a0delivered BONDUPDATER, Unit 42 researchers observed OilRig\u2019s testing activities and with high confidence links this testing to the creation of the weaponized delivery document used in this attack.\n\nClearly, OilRig incorporates a testing component within their development process, as we have previously observed OilRig performing testing activities on their delivery documents and their TwoFace webshells. This testing component often involves making small modifications to their delivery documents and submitting these files to online public anti-virus scanning tools to determine\u00a0the\u00a0maliciousness of a submitted file and to figure out how to evade these detections. Providing a free and quick anti-virus testing service, using these online scanners aids an attacker in understanding which anti-virus engine detects their malware, thus giving the attacker a metaphorical \u201cquality assurance service.\u201d\n\nTo determine OilRig\u2019s operational tempo, we compared the creation times of the files created during testing, the creation time of the delivery document and the time in which the spear-phishing email was sent in the attack. We found that OilRig began its testing activities just under 6 days prior to the targeted attack and performed three waves of testing attempts on August 20th, 21st, and 26th. The tester created the final test file less than 8 hours before the creation time of a delivery document, which was then delivered via a spear-phishing email 20 minutes later.\n\n&nbsp;\n\nOilRig\u2019s Testing Activities\u00a0\n\nWhile investigating recent attacks performed by the threat actor group OilRig using their new Bondupdater version, Unit 42 researchers searched for additional Microsoft Office documents used by OilRig\u00a0hoping to locate additional malware being used in other attacks during the same time period.\u00a0We focused on the functionality and pivoting off the original OilRig Microsoft documents found during our recent investigation.\n\nUnit 42 researchers found 11 additional samples that were submitted across several public anti-virus testing sites, as seen in Table 1.\u00a0These samples appeared to have been created by OilRig during their development and testing activities, all of which share many similarities with the delivery document used in the recent OilRig attack against a Middle Eastern government, N56.15.doc (7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00) that we have also included in Table 1. During this testing, we saw document filenames that contain the C2 we witnessed in the targeted attack above, specifically the filenames XLS-withyourface.xls\u00a0and\u00a0XLS-withyourface\u00a0\u2013 test.xls.\u00a0\u00a0The similarities in metadata, macro code, and the filenames containing the C2 domain name leads us to believe these files were in fact OilRig testing their code prior to use in the targeted attack that happened on August 26th.\u00a0It is interesting to note that while all the testing files were Microsoft Excel documents, the actual file used in the targeted attack was a Microsoft Word document.\n\n&nbsp;\n\n\n\nHash\nLast Modified\/Save Date\nAverage Detection Count on First Public Submission\nFilename\n\n\n6f522b1be1f2b6642c292bb3fb57f523ebedeb04f0d18efa2a283e79f3689a9f\n8\/20\/2018 19:30:13\n22\nXLS-withyourface.xls\n\n\n9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce\n8\/20\/2018 19:31:54\n16\nXLS-withyourface.xls\n\n\na5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e\n8\/20\/2018 19:38:51\n6\nXLS-withyourface.xls\n\n\n6719e80361950cdb10c4a4fcccc389c2a26eaab761c202870353fe65e8f954a3\n8\/21\/2018 6:24:52\n4\nXLS-withyourface - test.xls\n\n\n056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa\n8\/21\/2018 7:58:16\n18\nsss.xls\n\n\n216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576\n8\/21\/2018 8:03:22\n5\nsss.xls\n\n\n687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3\n8\/21\/2018 8:08:36\n17\nsss.xls\n\n\n364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56\n8\/21\/2018 8:18:36\n9\nsss.xls\n\n\n66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633\n8\/26\/2018 5:43:07\n11\nsss - Copy.xls\n\n\n70ff20f2e5c7fd90c6bfe92e28df585f711ee4090fc7669b3a9bd024c4e11702\n8\/26\/2018 5:45:04\n7\nsss - Copy.xls\n\n\n7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00\n8\/26\/2018 13:34:00\n38\nN56.15.doc\n\n\n\nTable 1 Files generated during testing activities and the document delivered in the related targeted attack\nThe metadata within the Microsoft Excel spreadsheets seen in Table 1 shows the OilRig developer began creating these testing\u00a0documents on August 20, six days prior to the related targeted attack. All of the testing activity performed by OilRig occurred prior to their attack on August 26th.\u00a0 When cross referencing the \u2018Last Modified Date\u2019 dates across the testing and attack activity, it is easy to draw a timeline of activity, as seen in the timeline in Figure 1.\n\n\nFigure 1\u00a0Timeline of Testing and Attack Activity\nOn August 20, 22 anti-virus engines detected the first iteration of\u00a0XLS-withyourface.xls\u00a0as malicious, as seen in the chart in Figure 2. Over the next seven minutes, the tester created two more samples whose detections lowered from 16 detections to six, respectively.\u00a0Ultimately, the\u00a0detection count was lowest early on August 21, still five days prior to the targeted attack. The timeline in Figure 1 shows a gap in testing activity between August 21st and August 26th, when the tester stopped their activities. However, they later continued by making modifications to the Excel document just prior to the attack on August 26th. The last iteration of testing occurring less than 8 hours before the creation time of the Word delivery document used in the targeted attack.\n\n\nFigure 2 Detection rate compared to the insertions and deletions that were performed in each iteration of testing\nThe chart in Figure 2 shows the detection rate of the file fell or rose as the tester modified the spreadsheet during each iteration of testing. These changes in detection rates allow the tester to determine if the modified portion of the file was causing detection. When analyzing this testing activity, we compared the number of changes performed in each iteration, specifically the number of lines inserted and deleted based on the GitHub file diff, to the number of detections to determine if the amount of changes had an obvious effect on the detection rate. Figure 2 shows that iterations 1 and 2, with only minimal changes, resulted in a massive drop in detections, whereas iterations 3 and 4, with a large number of changes, resulted in a small drop and large increase in detections.\n\nAt a high level, the quantity of changes is not necessarily important to the tester, rather the quality of the changes helps the tester lower the detection rate while providing information on how to evade these detections. An example of a quality change was the removal of the line of code that runs the dropped VBScript using \u201cwscript\u201d in Iteration 2, which lowered the detection rate from 16 to 6. Ultimately, the tester used the knowledge gained from these testing iterations to create a delivery document that was more difficult to detect and likely to result in a successful attack. For details on the changes made in each iteration, please reference the analysis in the Appendix.\n\n&nbsp;\n\nWhat Did OilRig Learn?\n\nDuring OilRig\u2019s development efforts, the actors were clearly learning and adapting their development techniques. We continually witnessed the attackers submit their files to testing services only to make changes and resubmit to determine the specific contents of the file that cause anti-virus detections. The OilRig actors used the knowledge learned in this process to develop a delivery document that would evade detection, thus increasing the chances of a successful attack.\n\nDoing a differential comparison between each of the documents, allowed Unit 42 researchers to watch each iteration of code, giving a unique perspective into not only how OilRig performed their testing, but also what the actors may have learned during their efforts to lower the detection of their delivery documents. While it\u2019s impossible for us to say for certain what OilRig learned ,we can make some assumptions as to what they likely learned:\n\n \tSeveral detections of the macro hinged on the generic call to the built-in Shell function to run a dropped VBScript.\n \tRunning commands in a hidden window (vbHide flag) using the Shell function results in additional detections than when using a visible window (vbNormalFocus flag).\n \tIncluding the string \u201cpowershell\u201d within the VBScript that the macro would write to the system caused several detections.\n \tUsing string obfuscation on the \u201cpowershell\u201d string and the \u201cwscript\u201d string within the command run using the Shell function would result in fewer detections.\n\n&nbsp;\n\nWhat Did We Learn?\n\nSimilar to the way OilRig learned to better circumvent detections, we as researchers also learned as we looked at each of the iterations. Providing us with learning opportunities helps us understand the threat actor\u2019s techniques and capabilities, as well as better pro-actively build protection mechanisms.\n\nWe learned that OilRig:\n\n \tMade changes to documents and quickly uploaded the file for testing, with an average of 33 seconds between the file creation times and the testing time.\n \tWas not concerned about maintaining the macro\u2019s functionality during testing efforts, as the changes made by the tester in many iterations made the macro no longer work as intended.\n \tWill change the functions to run dropped VBScripts, specifically in this case from the Shell object to the built-in Shell function.\n \tWill add sleep functionality in an attempt to evade sandboxes, specifically in this case using the Wait function.\n \tHas a preferred string obfuscation technique, which involves replacing a string with each character in hexadecimal form that are concatenated together.\n\nAfter performing this analysis, we believe the OilRig actors used the macro from the malicious Excel document as the basis for the malicious Word document we discussed in our blog. We believe with high confidence that this macro was used to create the delivery document based on the following similarities:\n\n \tUsed the same string obfuscation technique that represents a string by its individual hex values concatenated together, as this technique is present in both the testing Excel documents and the Word document used in OilRig\u2019s recent attack from our previous blog.\n \tObfuscated the \u201cpowershell\u201d and \u201ccmd.exe\u201d strings within the embedded VBScript using this string obfuscation technique, which was tested in Iteration 4 of these testing activities.\n \tObfuscated the command run by the built-in Shell function using this string obfuscation technique, which was tested in Iteration 8 of these testing activities.\n\nIt appears that OilRig actors modified the macro used in the testing activity to create the weaponized delivery document. The modifications involved adding a function named \u201cHGHG\u201d to save the obfuscated BONDUPDATER PowerShell script to a file. OilRig also changed the variable used to store the VBScript to a variable named \u201cA\u201d in the weaponized Word document instead of \u201cDDDD\u201d as witnessed in the testing Excel documents. Lastly, the actors removed the function \u201cAA\u201d from the macro, as this function displays a hidden spreadsheet that would contain the decoy content, which is specific to Excel and not needed for the Word document.\n\n&nbsp;\n\nConclusion\n\nAttackers and groups routinely use file and URL scanning services to help develop and modify their malware to evade detections. We were already familiar with OilRig\u2019s testing and development efforts as discussed in our previous blog, and we continually watch for changes to OilRig\u2019s development techniques to give us insight into their methods. Gaining this developmental insight sheds light on OilRig\u2019s advanced capabilities, giving us a more complete threat actor profile.\n\nClosely examining the development methodologies of attack groups gives researchers unique opportunities to develop an understanding of actor tools, tactics, and procedures. Comparison between what malware is eventually used in active campaigns versus in-development malware allows us to understand what adaptations and modifications were made to each iteration of malware. Additionally, witnessing specific functionality changes within the malware itself, we attempt to make correlations between the new and old functionality. We were also able to gain insight into OilRig\u2019s operational tempo by comparing the timestamps of files created during testing and the file delivered in an actual attack. We determined that OilRig began their testing activities 6 days prior to an attack, which ended 8 hours before the creation of the document that the actors delivered via a spear-phish email 20 minutes later.\n\nWhile OilRig remains active, Palo Alto Networks customers are protected from this threat in the following ways:\n\n \tAutoFocus customers can track these samples with the Bondupdater_Docs\n \tWildFire detects all current OilRig Bondupdater_Docs files with malicious verdicts.\n \tTraps blocks all of the files currently associated with Bondupdater_Docs\n\n\nAppendix\n\nThis appendix contains the analysis we performed on each iteration of testing. Before the analysis of each iteration, we have included some additional information about the files and the detection rate, as seen and described in Table 1.\n\n\n\nField\nDescription\n\n\nFiles\nThe SHA256 hashes of the two files we compared to determine the changes made\n\n\nFilenames\nThe filenames of the two files compared\n\n\nDelta\nThe time difference between the \u201cModified\u201d timestamp found within the metadata of each file\n\n\nPositives\nThe detection rate of the two files compared together, which provides an idea of how the changes in that testing iteration effected the overall detection\n\n\n\nTable 1 Additional data provided for each Iteration of testing\n\n&nbsp;\n\nThe analysis portion of each iteration includes a description of the changes made to the macro in the delivery document. These changes are also visualized in screenshots of diffs between the two files compared in that iteration. When looking at the diff screenshots, lines with a red background were removed from a file, while lines with a green background were added to the file.\n\n\nIteration 0\n\nThe first known file associated with this testing activity does not appear to be the original document created by the actor. We believe this is the case because this Excel spreadsheet contains a stream named __SRP_0 that appears to have artifacts from a previous version of this delivery document. The\u00a0 __SRP_0\u00a0 stream contains artifacts, specifically a series of base64 encoded strings that when decoded are almost an exact copy of the BONDUPDATER PowerShell payload named \u201cAppPool.ps1\u201d that was dropped by 7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00 discussed in our blog discussing OilRig\u2019s attack on a middle eastern government in August 2018. In Figure 2 below, we compared the decoded base64 strings from __SRP_0\u00a0\u00a0 to the \u201cAppPool.ps1\u201d file that was discussed in our previous blog, which shows the exact same content (including \u201cwithyourface[.]com\u201d C2) with the only differences being newlines and spaces.\n\n&nbsp;\n\n\nFigure 2 Comparison of previous BONDUPDATER payload with payload extracted from cached stream\nWhen we analyzed this specific sample, we noticed that the tester has changed the method in which the PowerShell payload is dropped to the system from the malicious Word document discussed in our blog. Instead of writing the AppPool.ps1 file from the macro, the macro in this malicious Excel document only writes the AppPool.vbs, which the macro will run using \u201cwscript\u201d. The VBScript is then responsible for writing AppPool.ps1 to the system, which is the main difference from the Word document\u2019s method discussed in our previously mentioned blog.\n\nAlso, it appears the tester removed the BONDUPDATER payload from the sample altogether, as the AppPool.vbs script uses an empty variable named \u201cmysrc\u201d that it would have used to store the base64 encoded payload, which it would decode and save to the AppPool.ps1 file.\n\nAs mentioned earlier, we believe this testing activity preceded the attack that used the Word delivery document discussed in our blog. We also believe that this was not the only round of testing performed by the threat group, as the BONDUPDATER tool existing in the __SRP_0\u00a0 stream suggests that the tester had created a prior document that contained the payload that was removed from this testing activity. It is possible that the tester had previously performed testing activities on the PowerShell payload and removed it to isolate their current testing activities on the macro portion of the delivery document.\n\n&nbsp;\n\nIteration 1\n\n\n\nFiles\n6f522b1be1f2b6642c292bb3fb57f523ebedeb04f0d18efa2a283e79f3689a9f .. 9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce\n\n\nFilenames\nXLS-withyourface.xls -&gt; XLS-withyourface.xls\n\n\nDelta\n1 minute 41 seconds\n\n\nPositives\n22 -&gt; 16\n\n\n\n&nbsp;\n\nIn this iteration, the tester made one simple change, which involved removing the string \u201cpowershell.exe\u201d from being written to the AppPool.vbs file. This change essentially breaks the installation process, as the VBScript would no longer be able to run the AppPool.ps1 run correctly; however, the tester made this change to determine if detection stemmed from this string. The diff in the screenshot in Figure 3 does not make the missing \u201cpowershell.exe\u201d string immediately apparent, however, if you look for \u201cShell0\u201d on line 24 you can see \u201cpowershell.exe -exec bypass\u201d in the left (red) text and \u201c -exec bypass\u201d in the right (green) text.\n\n\nFigure 3 Screenshot of diff between files related to Iteration 1\n&nbsp;\n\nIteration 2\n\n\n\nFiles\n9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce .. a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e\n\n\nFilenames\nXLS-withyourface.xls -&gt; XLS-withyourface.xls\n\n\nDelta\n6 minutes 57 seconds\n\n\nPositives\n16 -&gt; 6\n\n\n\n&nbsp;\n\nIn this iteration, the tester removed the line responsible for running the AppPool.vbs script using the wscript application. As you can see in Figure 4, the tester just removed the entire line of code and replaced it with a new line.\n\n&nbsp;\n\n\nFigure 4 Screenshot of diff between files related to Iteration 2\n&nbsp;\n\nIteration 3\n\n\n\nFiles\na5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e .. a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e\n\n\nFilenames\nXLS-withyourface.xls -&gt; XLS-withyourface.xls\n\n\nDelta\n10 hours 46 minutes 1 second\n\n\nPositives\n6 -&gt; 4\n\n\n\n&nbsp;\n\nIn this iteration, the tester made fairly significant changes to the macro. First, the tester introduced a line of code that would sleep for 10 seconds after creating the \u201cC:\\ProgramData\\WindowsAppPool\u201d folder and before writing the AppPool.vbs file to this folder, which can be seen in Figure 5 at line 12. The bottom of Figure 5 and continued into Figure 6 shows that the tester also added the base64 encoded BONDUPDATER PowerShell payload to the DDDD variable instead of the VBScript seen in previous versions of this macro. The base64 encoded BONDUPDATER included here is the exact same payload in the first testing sample\u2019s cached __SRP_0 stream mentioned in Iteration 0. Figure 7 also shows that the tester removed the line that set the Shell0 variable to contain the \u201cwscript.shell\u201d object that it would theoretically use to run the VBScript.\n\n&nbsp;\n\n\nFigure 5 Screenshot of diff between files related to Iteration 3 showing sleep code and other objects added\n&nbsp;\n\n\nFigure 6 Screenshot of diff between files related to Iteration 3 showing changes to variable used to store VBScript\n&nbsp;\n\n\nFigure 7 Screenshot of diff between files related to Iteration 3 showing removal of the \u2018wscript.shell\u2019 object\n&nbsp;\n\nIteration 4\n\n\n\nFiles\n6719e80361950cdb10c4a4fcccc389c2a26eaab761c202870353fe65e8f954a3 .. 056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa\n\n\nFilenames\nXLS-withyourface.xls -&gt; sss.xls\n\n\nDelta\n1 hour 33 minutes 24 seconds\n\n\nPositives\n4 -&gt; 18\n\n\n\n&nbsp;\n\nIn this iteration, the tester replaces the base64 encoded PowerShell script in the macro with the VBScript that it replaced in the previous iteration. The tester also removed some lines of code that instantiated the \u201cScripting.FileSystemObject\u201d and \u201cWscript.Shell\u201d objects (line 17 and 18 in Figure 8).\n\n\nFigure 8 Screenshot of diff between files related to Iteration 4 showing VBScript added back to the macro\n&nbsp;\n\nIt appears that the tester reintroduced the VBScript to the macro, albeit with slight modification. The two modifications to the VBScript stored in the DDDD variable come in the form of obfuscating two of the strings within the script, specifically the \u201cpowershell\u201d (line 24 in Figure 9) and \u201ccmd.exe\u201d (line 25 in Figure 9) strings. Instead, both of these strings were constructed one character at a time using the hexadecimal value for each character and concatenated together. For instance, the\u00a0 \u201cpowershell\u201d string was replaced with the following:\nChr(CLng(\"&amp;H70\")) &amp; Chr(CLng(\"&amp;H6f\")) &amp; Chr(CLng(\"&amp;H77\")) &amp; \nChr(CLng(\"&amp;H65\")) &amp; Chr(CLng(\"&amp;H72\")) &amp; Chr(CLng(\"&amp;H73\")) &amp; \nChr(CLng(\"&amp;H68\")) &amp; Chr(CLng(\"&amp;H65\")) &amp; Chr(CLng(\"&amp;H6c\")) &amp; \nChr(CLng(\"&amp;H6c\"))\n\nThe tester also added a line (line 29 in Figure 9) that uses the built-in Shell function to run the \u201cAppPool.vbs\u201d script using the wscript application. The tester used the \u201cvbHide\u201d flag in the call to the Shell function, which will run the command in a hidden window.\n\n\nFigure 9 Screenshot of diff between files related to Iteration 4 showing string obfuscation and use of the built-in Shell function\n&nbsp;\n\nIteration 5\n\n\n\n\nFiles\n056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa -&gt; \u00a0216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576\n\n\nFilenames\nsss.xls -&gt; sss.xls\n\n\nDelta\n5 minutes 6 seconds\n\n\nPositives\n18 -&gt; 5\n\n\n\n&nbsp;\n\nIn this iteration, the tester removes the call to the built-in Shell function that runs the \u201cAppPool.vbs\u201d script using wscript that they introduced in the previous iteration. Figure 10 shows that the tester removed the code on line 29 by replacing it with an empty line.\n\n&nbsp;\n\n\nFigure 10 Screenshot of diff between files related to Iteration 5 showing removal the call to the Shell function\n&nbsp;\n\nIteration 6\n\n\n\n\nFiles\n216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576 -&gt; 687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3\n\n\nFilenames\nsss.xls -&gt; sss.xls\n\n\nDelta\n5 minutes 14 seconds\n\n\nPositives\n5 -&gt; 17\n\n\n\n&nbsp;\n\nIn this iteration, the tester reintroduces the call to the built-in Shell function that they removed in the prior iteration. However, the tester did not include the command to run by omitting the string to run the \u201cAppPool.vbs\u201d script using wscript. Figure 11 shows that the call to the Shell function has a blank command parameter. The detection rate increased considerably, which suggests that the detection rate was not based on the command itself, rather detection stemmed on the generic call to the built-in Shell function.\n\n\nFigure 11 Screenshot of diff between files related to Iteration 6 showing the use of an empty command in the Shell function\n&nbsp;\n\nIteration\n\n\n\n\nFiles\n687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3 \u00a0-&gt; 364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56\n\n\nFilenames\nsss.xls -&gt; sss.xls\n\n\nDelta\n10 minutes\n\n\nPositives\n17 -&gt; 9\n\n\n\n&nbsp;\n\nIn this iteration, the tester reintroduces the command to run the \u201cAppPool.vbs\u201d script using wscript to the call to the built-in Shell function, as seen in Figure 12. However, this time the tester uses the \u201cvbNormalFocus\u201d flag instead of the \u201cvbHide\u201d flag, which runs the command in a visible command prompt window. This change lowers the detection rate by 8, which suggests that the use of the \u201cvbHide\u201d flag within the Shell function was considered malicious by several vendors.\nFigure 12 Screenshot of diff between files related to Iteration 7 showing use of a visible window when running command\n&nbsp;\n\nIteration 8\n\n\n\n\nFiles\n364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56 \u00a0-&gt; 66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633\n\n\nFilenames\nsss.xls -&gt; sss - Copy.xls\n\n\nDelta\n4 days 21 hours 24 minutes 31 seconds\n\n\nPositives\n9 -&gt; 11\n\n\n\n&nbsp;\n\nThis iteration of testing was performed well after the previous iteration with the newly generated file being created almost 5 days after its predecessor. This large delta in file creation times could suggest a new round of testing activities; however, the filename for this newly generated file is \u201csss - Copy.xls\u201d while the previous file was named \u201csss.xls\u201d. Comparing these two filenames suggests that the tester may have copied the file generated in the previous iteration to use as a basis for this current iteration of testing. Due to the filenames and the changes made to the macros in these two documents, we are treating this activity as part of the ongoing testing efforts.\n\nIn this iteration, the tester made a few changes to multiple portions of the macro. First, the tester removed the line of code that would have the macro sleep for 10 seconds, which was first introduced in iteration 3. Figure 13 shows the removal of this line of code, which uses the \u201cApplication.Wait\u201d function to sleep for 10 seconds.\n\n\nFigure 13 Screenshot of diff between files related to Iteration 8 showing removal of the sleep functionality\n\u00a0\n\nThe next modification made by the tester involved obfuscating the string \u201cwscript \u201c within the command run within the Shell function. The tester uses the same string obfuscation technique used in previous iterations by replacing the string with each character in hexadecimal form concatenated together. Figure 14 shows\u00a0 the obfuscated string \u201cChr(CLng(\"&amp;H77\")) &amp; Chr(CLng(\"&amp;H73\")) &amp; Chr(CLng(\"&amp;H63\")) &amp; Chr(CLng(\"&amp;H72\")) &amp; Chr(CLng(\"&amp;H69\")) &amp; Chr(CLng(\"&amp;H70\")) &amp; Chr(CLng(\"&amp;H74\")) &amp; Chr(CLng(\"&amp;H20\"))\u201d used to represent \u201cwscript \u201c.\n\nFigure 14 also shows the tester changed the variable name used to store the ActiveSheet object that represents the current Excel worksheet. The tester changed this variable name from \u201csh\u201d to \u201cSh\u201d (line 41), which the tester also changed in each preceding line (lines 43, 45 and 47) when using the object.\n\n\nFigure 14 Screenshot of diff between files related to Iteration 8 showing use of string obfuscation on command and modified variable name\n&nbsp;\n\nIteration 9\n\n\n\nFiles\n66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633 \u00a0-&gt; 70ff20f2e5c7fd90c6bfe92e28df585f711ee4090fc7669b3a9bd024c4e11702\n\n\nFilenames\nsss - Copy.xls -&gt; sss - Copy.xls\n\n\nDelta\n1 minute 57 seconds\n\n\nPositives\n11 -&gt; 7\n\n\n\n&nbsp;\n\nIn the last iteration of testing, the tester removes the entire line of code used to call the Shell function used to call the \u201cAppPool.vbs\u201d script that included the obfuscated \u201cwscript\u201d string. Figure 15 shows that the tester merely removed the entire line and did not replace it with any code, which suggests that the macro would never run the VBScript file that it saves to the system.\n\n\nFigure 15 Screenshot of diff between files related to Iteration 9 showing removal of the Shell command\n\u00a0","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2018\/04\/unit42-blog-600x300-150x150.jpg","width":150,"height":150},"author":[{"@type":"Person","name":"Robert Falcone"},{"@type":"Person","name":"Kyle Wilhoit"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.2.4' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='application/json' id="wpp-json">
{"sampling_active":0,"sampling_rate":100,"ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":94331,"token":"ca80e59221","lang":0,"debug":0}
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp.min.js?ver=5.2.4'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.4.3'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=94331' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.4.3 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>

  <body class="post-template-default single single-post postid-94331 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/">
            <!--<img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" />-->
            <img src="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/images/svg/unit42-logo-white.svg" class="attachment-full size-full" alt="Unit42 Logo"  width="150" height="35"/>
        </a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>


  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">Analyzing OilRig's Ops Tempo from Testing to Weaponization to Delivery</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-94331 entry-meta">
				
				
				<span class="post-views-count">22,936</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'94331','like')"><i class="ui ui-2"></i><span class="ml-5">3</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 15</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/share?text=Analyzing+OilRig%27s+Ops+Tempo+from+Testing+to+Weaponization+to+Delivery&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery%2F" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery%2F&title=Analyzing+OilRig%27s+Ops+Tempo+from+Testing+to+Weaponization+to+Delivery&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/robertfalcone/" title="Posts by Robert Falcone" class="author url fn" rel="author">Robert Falcone</a> and <a href="https://unit42.paloaltonetworks.com/author/kyle-wilhoit/" title="Posts by Kyle Wilhoit" class="author url fn" rel="author">Kyle Wilhoit</a>        </p>
        <p><time datetime="2018-11-16T06:00:40+00:00">November 16, 2018 at 8:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/bondupdater/" rel="tag">BONDUPDATER</a>, <a href="https://unit42.paloaltonetworks.com/tag/oilrig/" rel="tag">OilRig</a>, <a href="https://unit42.paloaltonetworks.com/tag/testing/" rel="tag">Testing</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="600" height="300" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg" class="attachment-single size-single wp-post-image" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300.jpg 600w, https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300-300x150.jpg 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2018/04/unit42-blog-600x300-370x185.jpg 370w" sizes="(max-width: 600px) 100vw, 600px" />            </figure>
                    <p class="wpml-ls-statics-post_translations wpml-ls">This post is also available in: 
    <span class="wpml-ls-slot-post_translations wpml-ls-item wpml-ls-item-ja wpml-ls-first-item wpml-ls-last-item wpml-ls-item-legacy-post-translations"><a href="https://unit42.paloaltonetworks.jp/unit42-analyzing-oilrigs-ops-tempo-testing-weaponization-delivery/" class="wpml-ls-link"><span class="wpml-ls-native" lang="ja">日本語</span><span class="wpml-ls-display"><span class="wpml-ls-bracket"> (</span>Japanese<span class="wpml-ls-bracket">)</span></span></a></span></p><p>Gaining insight into an adversary’s operational tempo in the early phases of the attack lifecycle can be very difficult. Typically, there are far fewer data points available to analyze in the reconnaissance and weaponization phases for a researcher to use to determine how quickly an adversary operates prior to direct interaction with a target in the delivery phase. While continuing research on the <a href="https://blog.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">August 2018 attacks on a middle eastern government</a> that  delivered BONDUPDATER, Unit 42 researchers observed OilRig’s testing activities and with high confidence links this testing to the creation of the weaponized delivery document used in this attack.</p>
<p>Clearly, OilRig incorporates a testing component within their development process, as we have previously observed OilRig performing <a href="https://blog.paloaltonetworks.com/2017/04/unit42-oilrig-actors-provide-glimpse-development-testing-efforts/">testing activities on their delivery documents</a> and their <a href="https://blog.paloaltonetworks.com/2017/12/unit42-oilrig-performs-tests-twoface-webshell/">TwoFace webshells</a>. This testing component often involves making small modifications to their delivery documents and submitting these files to online public anti-virus scanning tools to determine the maliciousness of a submitted file and to figure out how to evade these detections. Providing a free and quick anti-virus testing service, using these online scanners aids an attacker in understanding which anti-virus engine detects their malware, thus giving the attacker a metaphorical “quality assurance service.”</p>
<p>To determine OilRig’s operational tempo, we compared the creation times of the files created during testing, the creation time of the delivery document and the time in which the spear-phishing email was sent in the attack. We found that OilRig began its testing activities just under 6 days prior to the targeted attack and performed three waves of testing attempts on August 20th, 21<sup>st</sup>, and 26th. The tester created the final test file less than 8 hours before the creation time of a delivery document, which was then delivered via a spear-phishing email 20 minutes later.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">OilRig’s Testing Activities </span></p>
<p>While investigating recent attacks performed by the threat actor group OilRig using their new Bondupdater <a href="https://blog.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">version</a>, Unit 42 researchers searched for additional Microsoft Office documents used by OilRig hoping to locate additional malware being used in other attacks during the same time period. We focused on the functionality and pivoting off the original OilRig Microsoft documents found during our recent investigation.</p>
<p>Unit 42 researchers found 11 additional samples that were submitted across several public anti-virus testing sites, as seen in Table 1. These samples appeared to have been created by OilRig during their development and testing activities, all of which share many similarities with the delivery document used in the recent OilRig attack against a Middle Eastern government, N56.15.doc (7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00) that we have also included in Table 1. During this testing, we saw document filenames that contain the C2 we witnessed in the targeted attack above, specifically the filenames XLS-withyourface.xls and XLS-withyourface – test.xls.  The similarities in metadata, macro code, and the filenames containing the C2 domain name leads us to believe these files were in fact OilRig testing their code prior to use in the targeted attack that happened on August 26th. It is interesting to note that while all the testing files were Microsoft Excel documents, the actual file used in the targeted attack was a Microsoft Word document.</p>
<p>&nbsp;</p>
<table width="624">
<tbody>
<tr>
<td width="156"><strong>Hash</strong></td>
<td width="156"><strong>Last Modified/Save Date</strong></td>
<td width="156"><strong>Average Detection Count on First Public Submission</strong></td>
<td width="156"><strong>Filename</strong></td>
</tr>
<tr>
<td width="156">6f522b1be1f2b6642c292bb3fb57f523ebedeb04f0d18efa2a283e79f3689a9f</td>
<td width="156">8/20/2018 19:30:13</td>
<td width="156">22</td>
<td width="156">XLS-withyourface.xls</td>
</tr>
<tr>
<td width="156">9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce</td>
<td width="156">8/20/2018 19:31:54</td>
<td width="156">16</td>
<td width="156">XLS-withyourface.xls</td>
</tr>
<tr>
<td width="156">a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e</td>
<td width="156">8/20/2018 19:38:51</td>
<td width="156">6</td>
<td width="156">XLS-withyourface.xls</td>
</tr>
<tr>
<td width="156">6719e80361950cdb10c4a4fcccc389c2a26eaab761c202870353fe65e8f954a3</td>
<td width="156">8/21/2018 6:24:52</td>
<td width="156">4</td>
<td width="156">XLS-withyourface - test.xls</td>
</tr>
<tr>
<td width="156">056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa</td>
<td width="156">8/21/2018 7:58:16</td>
<td width="156">18</td>
<td width="156">sss.xls</td>
</tr>
<tr>
<td width="156">216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576</td>
<td width="156">8/21/2018 8:03:22</td>
<td width="156">5</td>
<td width="156">sss.xls</td>
</tr>
<tr>
<td width="156">687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3</td>
<td width="156">8/21/2018 8:08:36</td>
<td width="156">17</td>
<td width="156">sss.xls</td>
</tr>
<tr>
<td width="156">364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56</td>
<td width="156">8/21/2018 8:18:36</td>
<td width="156">9</td>
<td width="156">sss.xls</td>
</tr>
<tr>
<td width="156">66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633</td>
<td width="156">8/26/2018 5:43:07</td>
<td width="156">11</td>
<td width="156">sss - Copy.xls</td>
</tr>
<tr>
<td width="156">70ff20f2e5c7fd90c6bfe92e28df585f711ee4090fc7669b3a9bd024c4e11702</td>
<td width="156">8/26/2018 5:45:04</td>
<td width="156">7</td>
<td width="156">sss - Copy.xls</td>
</tr>
<tr>
<td width="156">7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00</td>
<td width="156">8/26/2018 13:34:00</td>
<td width="156">38</td>
<td width="156">N56.15.doc</td>
</tr>
</tbody>
</table>
<p style="text-align: center;"><em>Table 1 Files generated during testing activities and the document delivered in the related targeted attack</em></p>
<p>The metadata within the Microsoft Excel spreadsheets seen in Table 1 shows the OilRig developer began creating these testing documents on August 20, six days prior to the related targeted attack. All of the testing activity performed by OilRig occurred prior to their attack on August 26th.  When cross referencing the ‘Last Modified Date’ dates across the testing and attack activity, it is easy to draw a timeline of activity, as seen in the timeline in Figure 1.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/g2.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95349 " src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/g2.png" alt="" width="1149" height="642" /></a></p>
<p style="text-align: center;"><em>Figure 1 Timeline of Testing and Attack Activity</em></p>
<p>On August 20, 22 anti-virus engines detected the first iteration of XLS-withyourface.xls as malicious, as seen in the chart in Figure 2. Over the next seven minutes, the tester created two more samples whose detections lowered from 16 detections to six, respectively. Ultimately, the detection count was lowest early on August 21, still five days prior to the targeted attack. The timeline in Figure 1 shows a gap in testing activity between August 21st and August 26th, when the tester stopped their activities. However, they later continued by making modifications to the Excel document just prior to the attack on August 26<sup>th</sup>. The last iteration of testing occurring less than 8 hours before the creation time of the Word delivery document used in the targeted attack.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/line_bar_chart.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95363 " src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/line_bar_chart.png" alt="" width="1016" height="638" /></a></p>
<p style="text-align: center;"><em>Figure 2 Detection rate compared to the insertions and deletions that were performed in each iteration of testing</em></p>
<p>The chart in Figure 2 shows the detection rate of the file fell or rose as the tester modified the spreadsheet during each iteration of testing. These changes in detection rates allow the tester to determine if the modified portion of the file was causing detection. When analyzing this testing activity, we compared the number of changes performed in each iteration, specifically the number of lines inserted and deleted based on the GitHub file diff, to the number of detections to determine if the amount of changes had an obvious effect on the detection rate. Figure 2 shows that iterations 1 and 2, with only minimal changes, resulted in a massive drop in detections, whereas iterations 3 and 4, with a large number of changes, resulted in a small drop and large increase in detections.</p>
<p>At a high level, the quantity of changes is not necessarily important to the tester, rather the quality of the changes helps the tester lower the detection rate while providing information on how to evade these detections. An example of a quality change was the removal of the line of code that runs the dropped VBScript using “wscript” in Iteration 2, which lowered the detection rate from 16 to 6. Ultimately, the tester used the knowledge gained from these testing iterations to create a delivery document that was more difficult to detect and likely to result in a successful attack. For details on the changes made in each iteration, please reference the analysis in the Appendix.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">What Did OilRig Learn?</span></p>
<p>During OilRig’s development efforts, the actors were clearly learning and adapting their development techniques. We continually witnessed the attackers submit their files to testing services only to make changes and resubmit to determine the specific contents of the file that cause anti-virus detections. The OilRig actors used the knowledge learned in this process to develop a delivery document that would evade detection, thus increasing the chances of a successful attack.</p>
<p>Doing a differential comparison between each of the documents, allowed Unit 42 researchers to watch each iteration of code, giving a unique perspective into not only how OilRig performed their testing, but also what the actors may have learned during their efforts to lower the detection of their delivery documents. While it’s impossible for us to say for certain what OilRig learned ,we can make some assumptions as to what they likely learned:</p>
<ul>
<li>Several detections of the macro hinged on the generic call to the built-in Shell function to run a dropped VBScript.</li>
<li>Running commands in a hidden window (vbHide flag) using the Shell function results in additional detections than when using a visible window (vbNormalFocus flag).</li>
<li>Including the string “powershell” within the VBScript that the macro would write to the system caused several detections.</li>
<li>Using string obfuscation on the “powershell” string and the “wscript” string within the command run using the Shell function would result in fewer detections.</li>
</ul>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">What Did We Learn?</span></p>
<p>Similar to the way OilRig learned to better circumvent detections, we as researchers also learned as we looked at each of the iterations. Providing us with learning opportunities helps us understand the threat actor’s techniques and capabilities, as well as better pro-actively build protection mechanisms.</p>
<p>We learned that OilRig:</p>
<ul>
<li>Made changes to documents and quickly uploaded the file for testing, with an average of 33 seconds between the file creation times and the testing time.</li>
<li>Was not concerned about maintaining the macro’s functionality during testing efforts, as the changes made by the tester in many iterations made the macro no longer work as intended.</li>
<li>Will change the functions to run dropped VBScripts, specifically in this case from the Shell object to the built-in Shell function.</li>
<li>Will add sleep functionality in an attempt to evade sandboxes, specifically in this case using the Wait function.</li>
<li>Has a preferred string obfuscation technique, which involves replacing a string with each character in hexadecimal form that are concatenated together.</li>
</ul>
<p>After performing this analysis, we believe the OilRig actors used the macro from the malicious Excel document as the basis for the malicious Word document we discussed in our <a href="https://blog.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">blog</a>. We believe with high confidence that this macro was used to create the delivery document based on the following similarities:</p>
<ul>
<li>Used the same string obfuscation technique that represents a string by its individual hex values concatenated together, as this technique is present in both the testing Excel documents and the Word document used in OilRig’s recent attack from our previous blog.</li>
<li>Obfuscated the “powershell” and “cmd.exe” strings within the embedded VBScript using this string obfuscation technique, which was tested in Iteration 4 of these testing activities.</li>
<li>Obfuscated the command run by the built-in Shell function using this string obfuscation technique, which was tested in Iteration 8 of these testing activities.</li>
</ul>
<p>It appears that OilRig actors modified the macro used in the testing activity to create the weaponized delivery document. The modifications involved adding a function named “HGHG” to save the obfuscated BONDUPDATER PowerShell script to a file. OilRig also changed the variable used to store the VBScript to a variable named “A” in the weaponized Word document instead of “DDDD” as witnessed in the testing Excel documents. Lastly, the actors removed the function “AA” from the macro, as this function displays a hidden spreadsheet that would contain the decoy content, which is specific to Excel and not needed for the Word document.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Conclusion</span></p>
<p>Attackers and groups routinely use file and URL scanning services to help develop and modify their malware to evade detections. We were already familiar with OilRig’s testing and development efforts as discussed in our previous <a href="https://blog.paloaltonetworks.com/2017/04/unit42-oilrig-actors-provide-glimpse-development-testing-efforts/">blog</a>, and we continually watch for changes to OilRig’s development techniques to give us insight into their methods. Gaining this developmental insight sheds light on OilRig’s advanced capabilities, giving us a more complete threat actor profile.</p>
<p>Closely examining the development methodologies of attack groups gives researchers unique opportunities to develop an understanding of actor tools, tactics, and procedures. Comparison between what malware is eventually used in active campaigns versus in-development malware allows us to understand what adaptations and modifications were made to each iteration of malware. Additionally, witnessing specific functionality changes within the malware itself, we attempt to make correlations between the new and old functionality. We were also able to gain insight into OilRig’s operational tempo by comparing the timestamps of files created during testing and the file delivered in an actual attack. We determined that OilRig began their testing activities 6 days prior to an attack, which ended 8 hours before the creation of the document that the actors delivered via a spear-phish email 20 minutes later.</p>
<p>While OilRig remains active, Palo Alto Networks customers are protected from this threat in the following ways:</p>
<ul>
<li>AutoFocus customers can track these samples with the <a href="https://autofocus.paloaltonetworks.com/#/tag/Unit42.Bondupdater_Docs">Bondupdater_Docs</a></li>
<li>WildFire detects all current OilRig Bondupdater_Docs files with malicious verdicts.</li>
<li>Traps blocks all of the files currently associated with Bondupdater_Docs</li>
</ul>
<p><span style="font-size: 18pt;"><br />
Appendix</span></p>
<p>This appendix contains the analysis we performed on each iteration of testing. Before the analysis of each iteration, we have included some additional information about the files and the detection rate, as seen and described in Table 1.</p>
<table width="631">
<tbody>
<tr>
<td width="88"><strong>Field</strong></td>
<td width="543"><strong>Description</strong></td>
</tr>
<tr>
<td width="88">Files</td>
<td width="543">The SHA256 hashes of the two files we compared to determine the changes made</td>
</tr>
<tr>
<td width="88">Filenames</td>
<td width="543">The filenames of the two files compared</td>
</tr>
<tr>
<td width="88">Delta</td>
<td width="543">The time difference between the “Modified” timestamp found within the metadata of each file</td>
</tr>
<tr>
<td width="88">Positives</td>
<td width="543">The detection rate of the two files compared together, which provides an idea of how the changes in that testing iteration effected the overall detection</td>
</tr>
</tbody>
</table>
<p><em>Table 1 Additional data provided for each Iteration of testing</em></p>
<p>&nbsp;</p>
<p>The analysis portion of each iteration includes a description of the changes made to the macro in the delivery document. These changes are also visualized in screenshots of diffs between the two files compared in that iteration. When looking at the diff screenshots, lines with a red background were removed from a file, while lines with a green background were added to the file.</p>
<p><span style="font-size: 18pt;"><br />
Iteration 0</span></p>
<p>The first known file associated with this testing activity does not appear to be the original document created by the actor. We believe this is the case because this Excel spreadsheet contains a stream named __SRP_0 that appears to have artifacts from a previous version of this delivery document. The  __SRP_0  stream contains artifacts, specifically a series of base64 encoded strings that when decoded are almost an exact copy of the BONDUPDATER PowerShell payload named “AppPool.ps1” that was dropped by 7cbad6b3f505a199d6766a86b41ed23786bbb99dab9cae6c18936afdc2512f00 discussed in our <a href="https://blog.paloaltonetworks.com/2018/09/unit42-oilrig-uses-updated-bondupdater-target-middle-eastern-government/">blog discussing OilRig’s attack on a middle eastern government in August 2018</a>. In Figure 2 below, we compared the decoded base64 strings from __SRP_0   to the “AppPool.ps1” file that was discussed in our previous blog, which shows the exact same content (including “withyourface[.]com” C2) with the only differences being newlines and spaces.</p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/filemerge.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95376 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/filemerge.png" alt="" width="1208" height="266" /></a></p>
<p style="text-align: center;"><em>Figure 2 Comparison of previous BONDUPDATER payload with payload extracted from cached stream</em></p>
<p>When we analyzed this specific sample, we noticed that the tester has changed the method in which the PowerShell payload is dropped to the system from the malicious Word document discussed in our blog. Instead of writing the AppPool.ps1 file from the macro, the macro in this malicious Excel document only writes the AppPool.vbs, which the macro will run using “wscript”. The VBScript is then responsible for writing AppPool.ps1 to the system, which is the main difference from the Word document’s method discussed in our previously mentioned blog.</p>
<p>Also, it appears the tester removed the BONDUPDATER payload from the sample altogether, as the AppPool.vbs script uses an empty variable named “mysrc” that it would have used to store the base64 encoded payload, which it would decode and save to the AppPool.ps1 file.</p>
<p>As mentioned earlier, we believe this testing activity preceded the attack that used the Word delivery document discussed in our blog. We also believe that this was not the only round of testing performed by the threat group, as the BONDUPDATER tool existing in the __SRP_0  stream suggests that the tester had created a prior document that contained the payload that was removed from this testing activity. It is possible that the tester had previously performed testing activities on the PowerShell payload and removed it to isolate their current testing activities on the macro portion of the delivery document.</p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 1</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">6f522b1be1f2b6642c292bb3fb57f523ebedeb04f0d18efa2a283e79f3689a9f .. 9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">XLS-withyourface.xls -&gt; XLS-withyourface.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">1 minute 41 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">22 -&gt; 16</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester made one simple change, which involved removing the string “powershell.exe” from being written to the AppPool.vbs file. This change essentially breaks the installation process, as the VBScript would no longer be able to run the AppPool.ps1 run correctly; however, the tester made this change to determine if detection stemmed from this string. The diff in the screenshot in Figure 3 does not make the missing “powershell.exe” string immediately apparent, however, if you look for “Shell0” on line 24 you can see “powershell.exe -exec bypass” in the left (red) text and “ -exec bypass” in the right (green) text.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure3_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95456 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure3_full.png" alt="" width="1016" height="416" /></a></p>
<p style="text-align: center;"><em>Figure 3 Screenshot of diff between files related to Iteration 1</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 2</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">9b6ebc44e4452d8c53c21b0fdd8311bac10dc672309b67d7f214fbd2a08962ce .. a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">XLS-withyourface.xls -&gt; XLS-withyourface.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">6 minutes 57 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">16 -&gt; 6</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester removed the line responsible for running the AppPool.vbs script using the wscript application. As you can see in Figure 4, the tester just removed the entire line of code and replaced it with a new line.</p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure4_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95469 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure4_full.png" alt="" width="1004" height="136" /></a></p>
<p style="text-align: center;"><em>Figure 4 Screenshot of diff between files related to Iteration 2</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 3</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e .. a5bec7573b743932329b794042f38571dd91731ae50757317bdaf9e820ec8d5e</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">XLS-withyourface.xls -&gt; XLS-withyourface.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">10 hours 46 minutes 1 second</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">6 -&gt; 4</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester made fairly significant changes to the macro. First, the tester introduced a line of code that would sleep for 10 seconds after creating the “C:\ProgramData\WindowsAppPool” folder and before writing the AppPool.vbs file to this folder, which can be seen in Figure 5 at line 12. The bottom of Figure 5 and continued into Figure 6 shows that the tester also added the base64 encoded BONDUPDATER PowerShell payload to the DDDD variable instead of the VBScript seen in previous versions of this macro. The base64 encoded BONDUPDATER included here is the exact same payload in the first testing sample’s cached __SRP_0 stream mentioned in Iteration 0. Figure 7 also shows that the tester removed the line that set the Shell0 variable to contain the “wscript.shell” object that it would theoretically use to run the VBScript.</p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure5_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95482 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure5_full.png" alt="" width="1013" height="591" /></a></p>
<p style="text-align: center;"><em>Figure 5 Screenshot of diff between files related to Iteration 3 showing sleep code and other objects added</em></p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure6_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95495 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure6_full.png" alt="" width="1014" height="641" /></a></p>
<p style="text-align: center;"><em>Figure 6 Screenshot of diff between files related to Iteration 3 showing changes to variable used to store VBScript</em></p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure7_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95508 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure7_full.png" alt="" width="1010" height="134" /></a></p>
<p style="text-align: center;"><em>Figure 7 Screenshot of diff between files related to Iteration 3 showing removal of the ‘wscript.shell’ object</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 4</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">6719e80361950cdb10c4a4fcccc389c2a26eaab761c202870353fe65e8f954a3 .. 056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">XLS-withyourface.xls -&gt; sss.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">1 hour 33 minutes 24 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">4 -&gt; 18</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester replaces the base64 encoded PowerShell script in the macro with the VBScript that it replaced in the previous iteration. The tester also removed some lines of code that instantiated the “Scripting.FileSystemObject” and “Wscript.Shell” objects (line 17 and 18 in Figure 8).</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/oilrig_9.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-94423 " src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/oilrig_9.png" alt="" width="916" height="740" /></a></p>
<p style="text-align: center;"><em>Figure 8 Screenshot of diff between files related to Iteration 4 showing VBScript added back to the macro</em></p>
<p>&nbsp;</p>
<p>It appears that the tester reintroduced the VBScript to the macro, albeit with slight modification. The two modifications to the VBScript stored in the DDDD variable come in the form of obfuscating two of the strings within the script, specifically the “powershell” (line 24 in Figure 9) and “cmd.exe” (line 25 in Figure 9) strings. Instead, both of these strings were constructed one character at a time using the hexadecimal value for each character and concatenated together. For instance, the  “powershell” string was replaced with the following:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b3d962bc9987172675" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Chr(CLng("&amp;H70")) &amp; Chr(CLng("&amp;H6f")) &amp; Chr(CLng("&amp;H77")) &amp; 
Chr(CLng("&amp;H65")) &amp; Chr(CLng("&amp;H72")) &amp; Chr(CLng("&amp;H73")) &amp; 
Chr(CLng("&amp;H68")) &amp; Chr(CLng("&amp;H65")) &amp; Chr(CLng("&amp;H6c")) &amp; 
Chr(CLng("&amp;H6c"))</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b3d962bc9987172675-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b3d962bc9987172675-2">2</div><div class="crayon-num" data-line="crayon-60a9b3d962bc9987172675-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b3d962bc9987172675-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b3d962bc9987172675-1"><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H70"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H6f"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H77"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b3d962bc9987172675-2"><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H65"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H72"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H73"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b3d962bc9987172675-3"><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H68"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H65"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H6c"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b3d962bc9987172675-4"><span class="crayon-e">Chr</span><span class="crayon-sy">(</span><span class="crayon-e">CLng</span><span class="crayon-sy">(</span><span class="crayon-s">"&amp;H6c"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>The tester also added a line (line 29 in Figure 9) that uses the built-in Shell function to run the “AppPool.vbs” script using the wscript application. The tester used the “vbHide” flag in the call to the Shell function, which will run the command in a hidden window.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure8_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95521 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure8_full.png" alt="" width="1009" height="817" /></a></p>
<p style="text-align: center;"><em>Figure 9 Screenshot of diff between files related to Iteration 4 showing string obfuscation and use of the built-in Shell function</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 5<br />
</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">056ffc13a7a2e944f7ab8c99ea9a2d1b429bbafa280eb2043678aa8b259999aa -&gt;  216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">sss.xls -&gt; sss.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">5 minutes 6 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">18 -&gt; 5</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester removes the call to the built-in Shell function that runs the “AppPool.vbs” script using wscript that they introduced in the previous iteration. Figure 10 shows that the tester removed the code on line 29 by replacing it with an empty line.</p>
<p>&nbsp;</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure10_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95534 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure10_full.png" alt="" width="1013" height="142" /></a></p>
<p style="text-align: center;"><em>Figure 10 Screenshot of diff between files related to Iteration 5 showing removal the call to the Shell function</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 6<br />
</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">216ffed357b5fe4d71848c79f77716e9ecebdd010666cdb9edaadf7a8c9ec576 -&gt; 687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">sss.xls -&gt; sss.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">5 minutes 14 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">5 -&gt; 17</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester reintroduces the call to the built-in Shell function that they removed in the prior iteration. However, the tester did not include the command to run by omitting the string to run the “AppPool.vbs” script using wscript. Figure 11 shows that the call to the Shell function has a blank command parameter. The detection rate increased considerably, which suggests that the detection rate was not based on the command itself, rather detection stemmed on the generic call to the built-in Shell function.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure11_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95442 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure11_full.png" alt="" width="1011" height="115" /></a></p>
<p style="text-align: center;"><span style="font-size: 10pt;"><em>Figure 11 Screenshot of diff between files related to Iteration 6 showing the use of an empty command in the Shell function</em></span></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration<br />
</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">687027d966667780ab786635b0d4274b651f27d99717c5ba95e139e94ef114c3  -&gt; 364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">sss.xls -&gt; sss.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">10 minutes</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">17 -&gt; 9</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In this iteration, the tester reintroduces the command to run the “AppPool.vbs” script using wscript to the call to the built-in Shell function, as seen in Figure 12. However, this time the tester uses the “vbNormalFocus” flag instead of the “vbHide” flag, which runs the command in a visible command prompt window. This change lowers the detection rate by 8, which suggests that the use of the “vbHide” flag within the Shell function was considered malicious by several vendors.</p>
<p style="text-align: center;"><span style="font-size: 18pt;"><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure12_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95429 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure12_full.png" alt="" width="1010" height="139" /></a></span><em>Figure 12 Screenshot of diff between files related to Iteration 7 showing use of a visible window when running command</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 8<br />
</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">364e2884251c151a29071a5975ca0076405a8cc2bab8da3e784491632ec07f56  -&gt; 66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">sss.xls -&gt; sss - Copy.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">4 days 21 hours 24 minutes 31 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">9 -&gt; 11</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>This iteration of testing was performed well after the previous iteration with the newly generated file being created almost 5 days after its predecessor. This large delta in file creation times could suggest a new round of testing activities; however, the filename for this newly generated file is “sss - Copy.xls” while the previous file was named “sss.xls”. Comparing these two filenames suggests that the tester may have copied the file generated in the previous iteration to use as a basis for this current iteration of testing. Due to the filenames and the changes made to the macros in these two documents, we are treating this activity as part of the ongoing testing efforts.</p>
<p>In this iteration, the tester made a few changes to multiple portions of the macro. First, the tester removed the line of code that would have the macro sleep for 10 seconds, which was first introduced in iteration 3. Figure 13 shows the removal of this line of code, which uses the “Application.Wait” function to sleep for 10 seconds.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure13_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95416 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure13_full.png" alt="" width="1016" height="160" /></a></p>
<p style="text-align: center;"><em>Figure 13 Screenshot of diff between files related to Iteration 8 showing removal of the sleep functionality</em></p>
<p><strong> </strong></p>
<p>The next modification made by the tester involved obfuscating the string “wscript “ within the command run within the Shell function. The tester uses the same string obfuscation technique used in previous iterations by replacing the string with each character in hexadecimal form concatenated together. Figure 14 shows  the obfuscated string “Chr(CLng("&amp;H77")) &amp; Chr(CLng("&amp;H73")) &amp; Chr(CLng("&amp;H63")) &amp; Chr(CLng("&amp;H72")) &amp; Chr(CLng("&amp;H69")) &amp; Chr(CLng("&amp;H70")) &amp; Chr(CLng("&amp;H74")) &amp; Chr(CLng("&amp;H20"))” used to represent “wscript “.</p>
<p>Figure 14 also shows the tester changed the variable name used to store the ActiveSheet object that represents the current Excel worksheet. The tester changed this variable name from “sh” to “Sh” (line 41), which the tester also changed in each preceding line (lines 43, 45 and 47) when using the object.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure14_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95403 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure14_full.png" alt="" width="1014" height="494" /></a></p>
<p style="text-align: center;"><em>Figure 14 Screenshot of diff between files related to Iteration 8 showing use of string obfuscation on command and modified variable name</em></p>
<p>&nbsp;</p>
<p><span style="font-size: 18pt;">Iteration 9</span></p>
<table>
<tbody>
<tr>
<td width="312"><strong>Files</strong></td>
<td width="312">66d678b097a2245f60f3d95bb608f3958aa0f5f19ca7e5853f38ea79885b9633  -&gt; 70ff20f2e5c7fd90c6bfe92e28df585f711ee4090fc7669b3a9bd024c4e11702</td>
</tr>
<tr>
<td width="312"><strong>Filenames</strong></td>
<td width="312">sss - Copy.xls -&gt; sss - Copy.xls</td>
</tr>
<tr>
<td width="312"><strong>Delta</strong></td>
<td width="312">1 minute 57 seconds</td>
</tr>
<tr>
<td width="312"><strong>Positives</strong></td>
<td width="312">11 -&gt; 7</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>In the last iteration of testing, the tester removes the entire line of code used to call the Shell function used to call the “AppPool.vbs” script that included the obfuscated “wscript” string. Figure 15 shows that the tester merely removed the entire line and did not replace it with any code, which suggests that the macro would never run the VBScript file that it saves to the system.</p>
<p><a href="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure15_full.png" rel="wpdevart_lightbox"><img class="aligncenter wp-image-95390 size-full" src="https://blog.paloaltonetworks.com/wp-content/uploads/2018/11/figure15_full.png" alt="" width="1007" height="210" /></a></p>
<p style="text-align: center;"><em>Figure 15 Screenshot of diff between files related to Iteration 9 showing removal of the Shell command</em></p>
<p><span style="font-size: 18pt;"> </span></p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" name="emailFormMask" value="">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>


        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2021 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
    <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","enable_video_popuping":"enable","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
